


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Re-scan until fit achieves desired confidence &mdash; NSLS-II Software Documentation  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Streaming Tomographic Reconstruction" href="live_recon.html" />
    <link rel="prev" title="A Minimal CSV writer for data collection" href="csv_writer.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> NSLS-II Software Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../architecture-overview.html">Event-Based Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cookbook (Examples)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="count_with_table.html">Simply ‘count’ a detector</a></li>
<li class="toctree-l2"><a class="reference internal" href="simulation-mode.html">Inspect or rehearse a plan (“simulation mode”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="adaptive-steps.html">Use scans with adaptive step sizes</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_in_grid.html">Scan a grid around each sample in a grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="csv_writer.html">A Minimal CSV writer for data collection</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Re-scan until fit achieves desired confidence</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#problem">Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#approach">Approach</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-solution">Example Solution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="live_recon.html">Streaming Tomographic Reconstruction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../remote-access.html">Remote Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sandbox.html">Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">History of Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conda.html">Software Deployment with Conda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fresh-installation.html">Installation at a Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Recommended Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internal_index.html">Internal Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment_docs.html">NSLS-II Deployment Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meetings/index.html">Meetings</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto">caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/suitcase">suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://scikit-beam.github.io/scikit-beam">scikit-beam</a></li>
</ul>
<p class="caption"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/wishlist/issues">Wish List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NSLS-II Software Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Cookbook (Examples)</a> &raquo;</li>
        
      <li>Re-scan until fit achieves desired confidence</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/cookbook/adaptive_fitting.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Click <a class="reference internal" href="#sphx-glr-download-cookbook-adaptive-fitting-py"><span class="std std-ref">here</span></a> to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="re-scan-until-fit-achieves-desired-confidence">
<span id="sphx-glr-cookbook-adaptive-fitting-py"></span><h1>Re-scan until fit achieves desired confidence<a class="headerlink" href="#re-scan-until-fit-achieves-desired-confidence" title="Permalink to this headline">¶</a></h1>
<div class="section" id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h2>
<p>Scan a peak and, in real time, fit Gaussian model to the data. Repeatedly
re-scan the same region until the uncertainty in the Gaussian width parameter,
sigma, is below some threshold.</p>
</div>
<div class="section" id="approach">
<h2>Approach<a class="headerlink" href="#approach" title="Permalink to this headline">¶</a></h2>
<p>Use <code class="xref py py-func docutils literal notranslate"><span class="pre">bluesky.callbacks.LiveFit()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">bluesky.callbacks.LiveFitPlot()</span></code> to perform and
visualize a non-linear least-squared fit.</p>
<p>Normally we would use <code class="xref py py-func docutils literal notranslate"><span class="pre">plans.scan()</span></code> to perform the 1D scan. In this case,
we need something more sophisticated to incorporate adaptive logic that
continues the scan until the fit attains sufficient confidence in sigma. We
write our scan logic using the lower-level plans <code class="xref py py-func docutils literal notranslate"><span class="pre">bluesky.plans.abs_set()</span></code> and
<code class="xref py py-func docutils literal notranslate"><span class="pre">bluesky.plans.trigger_and_read()</span></code>.</p>
</div>
<div class="section" id="example-solution">
<h2>Example Solution<a class="headerlink" href="#example-solution" title="Permalink to this headline">¶</a></h2>
<img alt="../_images/sphx_glr_adaptive_fitting_001.png" class="sphx-glr-single-img" src="../_images/sphx_glr_adaptive_fitting_001.png" />
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">import</span> <span class="nn">bluesky.plans</span> <span class="kn">as</span> <span class="nn">bp</span>
<span class="kn">import</span> <span class="nn">bluesky.preprocessors</span> <span class="kn">as</span> <span class="nn">bpp</span>
<span class="kn">import</span> <span class="nn">bluesky.plan_stubs</span> <span class="kn">as</span> <span class="nn">bps</span>
<span class="kn">import</span> <span class="nn">bluesky.callbacks</span> <span class="kn">as</span> <span class="nn">bc</span>
<span class="kn">import</span> <span class="nn">bluesky.utils</span> <span class="kn">as</span> <span class="nn">bu</span>
<span class="kn">from</span> <span class="nn">ophyd.sim</span> <span class="kn">import</span> <span class="n">motor</span><span class="p">,</span> <span class="n">SynGauss</span>
<span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">RunEngine</span>

<span class="c1"># Do this if running the example interactively;</span>
<span class="c1"># skip it when building the documentation.</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">if</span> <span class="s1">&#39;BUILDING_DOCS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">bluesky.utils</span> <span class="kn">import</span> <span class="n">install_qt_kicker</span>  <span class="c1"># for notebooks, qt -&gt; nb</span>
    <span class="n">install_qt_kicker</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

<span class="n">noisy_det</span> <span class="o">=</span> <span class="n">SynGauss</span><span class="p">(</span><span class="s1">&#39;noisy_det&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                     <span class="n">noise</span><span class="o">=</span><span class="s1">&#39;poisson&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">({})</span>


<span class="k">def</span> <span class="nf">errorbar</span><span class="p">(</span><span class="n">lmfit_result</span><span class="p">,</span> <span class="n">param_name</span><span class="p">):</span>
    <span class="c1"># width of 95% conf interfal:</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">lmfit_result</span><span class="o">.</span><span class="n">conf_interval</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ci</span><span class="p">[</span><span class="n">param_name</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ci</span><span class="p">[</span><span class="n">param_name</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">)</span>
<span class="n">guess</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
         <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>


<span class="k">def</span> <span class="nf">scan_gaussian</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">err_thresh</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">main_detector</span> <span class="o">=</span> <span class="n">detectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">main_motor_field</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">LiveFit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">main_detector</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">main_motor_field</span><span class="p">},</span> <span class="n">guess</span><span class="p">)</span>
    <span class="n">lfp</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">LiveFitPlot</span><span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">LivePlot</span><span class="p">(</span><span class="n">main_detector</span><span class="p">,</span> <span class="n">main_motor_field</span><span class="p">,</span>
                     <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="nd">@bpp.subs_decorator</span><span class="p">([</span><span class="n">lfp</span><span class="p">,</span> <span class="n">lp</span><span class="p">])</span>
    <span class="nd">@bpp.stage_decorator</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">motor</span><span class="p">])</span>
    <span class="nd">@bpp.run_decorator</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">plan</span><span class="p">():</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
                <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">abs_set</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">motor</span><span class="p">])</span>
                <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">()</span>

            <span class="n">err</span> <span class="o">=</span> <span class="n">errorbar</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">err_thresh</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">yield from</span> <span class="n">plan</span><span class="p">()</span>


<span class="n">RE</span><span class="p">(</span><span class="n">scan_gaussian</span><span class="p">([</span><span class="n">noisy_det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()))</span>
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 1 minutes  0.407 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-cookbook-adaptive-fitting-py">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" download="" href="../_downloads/5f8032569b515624e9fa1f44f6751099/adaptive_fitting.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">adaptive_fitting.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" download="" href="../_downloads/67b7e2e318e880e002f77507a829b156/adaptive_fitting.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">adaptive_fitting.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="live_recon.html" class="btn btn-neutral float-right" title="Streaming Tomographic Reconstruction" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="csv_writer.html" class="btn btn-neutral" title="A Minimal CSV writer for data collection" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>