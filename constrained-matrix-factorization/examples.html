<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Examples &mdash; Constrained Matrix Factorization 0.1.2.post6+geb8ade7 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tips and Tricks" href="tips-and-tricks.html" />
    <link rel="prev" title="Wrappers and Companion Agents" href="companions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Constrained Matrix Factorization
          </a>
              <div class="version">
                0.1.2.post6+geb8ade7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="nativeCMF.html">Using Native Constrained NMF</a></li>
<li class="toctree-l1"><a class="reference internal" href="companions.html">Wrappers and Companion Agents</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fixing-weights-in-a-toy-problem">Fixing weights in a “toy” problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fixing-components-in-a-toy-problem">Fixing components in a “toy” problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fixing-components-in-variable-temperature-batio3-data">Fixing components in variable temperature BaTiO<sub>3</sub> data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fixing-components-when-you-re-unsure-of-how-many-components-to-use">Fixing components when you’re unsure of how many components to use</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tips-and-tricks.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="min_versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Constrained Matrix Factorization</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Examples</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/examples.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h1>
<p>A suite of example scripts are provided in <code class="code docutils literal notranslate"><span class="pre">example_output</span></code> to reproduce the  results of <a class="reference external" href="https://arxiv.org/abs/2104.00864">this paper</a>.
To access these examples, clone the github repository.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> cmf_env/bin/activate
$ git clone https://github.com/nsls-ii/constrained-matrix-factorization
$ <span class="nb">cd</span> constrained-matrix-factorization/example_scripts
$ python EXAMPLE_NAME
</pre></div>
</div>
<section id="fixing-weights-in-a-toy-problem">
<h2>Fixing weights in a “toy” problem<a class="headerlink" href="#fixing-weights-in-a-toy-problem" title="Permalink to this headline">¶</a></h2>
<p>Fixing weights has been identified as a desired use case, highlighting the challenge of retaining physically relevant
components from NMF even when the weights are known <em>a priori</em>.
This is a common situation in diffraction studies of variable composition or phase mixing, where complementary
experimental information (preparation conditions or spectroscopy) may indicate the concentration of individual phases
without specifying the diffraction patterns of the phases.
We considered a continuous mixture of two Gaussian functions,
where noise is added both to the composition and to the final function.</p>
<p>Run the following to produce 2 figures in  <code class="code docutils literal notranslate"><span class="pre">example_output</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python fixing_weights.py
</pre></div>
</div>
<figure class="align-center align-default" id="id1">
<img alt="_images/standard_weights.png" src="_images/standard_weights.png" />
<figcaption>
<p><span class="caption-text">Without constraining weights, the model over-fits the data, and misses the magnitude of the components.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-center align-default" id="id2">
<img alt="_images/constrained_weights.png" src="_images/constrained_weights.png" />
<figcaption>
<p><span class="caption-text">By constraining weights, the model adequately fits the data, and captures the magnitude of the components.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The core functionality is achieved with this code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ideal_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]))</span>
<span class="p">)</span>
<span class="n">input_W</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ideal_weights</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
<span class="n">nmf</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span>
    <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
    <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">initial_weights</span><span class="o">=</span><span class="n">input_W</span><span class="p">,</span>
    <span class="n">fix_weights</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_W</span><span class="p">))],</span>
<span class="p">)</span>
<span class="n">nmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">beta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fixing-components-in-a-toy-problem">
<h2>Fixing components in a “toy” problem<a class="headerlink" href="#fixing-components-in-a-toy-problem" title="Permalink to this headline">¶</a></h2>
<p>Prior knowledge of the components of a material is an even more common use case.
We first show a purposefully complicated example combining an overlapping Lorentzian, Gaussian, and Box function linearly
mixed with non-monotonically varying weights.</p>
<p>Run the following to produce 2 figures in  <code class="code docutils literal notranslate"><span class="pre">example_output</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python fixing_components.py
</pre></div>
</div>
<figure class="align-center align-default" id="id3">
<img alt="_images/standard_components.png" src="_images/standard_components.png" />
<figcaption>
<p><span class="caption-text">Without further constraints beyond non-negativity, the model cannot capture the complexity of the data.
It fails to produce a meaningful reconstruction, useful components, nor meaningful weights.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-center align-default" id="id4">
<img alt="_images/constrained_components.png" src="_images/constrained_components.png" />
<figcaption>
<p><span class="caption-text">With prior knowledge of the components, the model adequately fits the data,
and captures the varying magnitude of the weights.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The core functionality is achieved with this code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">constrained_nmf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">components</span><span class="p">):</span>
    <span class="n">input_H</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">component</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span>
    <span class="p">]</span>
    <span class="n">nmf</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">initial_components</span><span class="o">=</span><span class="n">input_H</span><span class="p">,</span>
        <span class="n">fix_components</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_H</span><span class="p">))],</span>
    <span class="p">)</span>
    <span class="n">nmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">beta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nmf</span>
</pre></div>
</div>
</section>
<section id="fixing-components-in-variable-temperature-batio3-data">
<h2>Fixing components in variable temperature BaTiO<sub>3</sub> data<a class="headerlink" href="#fixing-components-in-variable-temperature-batio3-data" title="Permalink to this headline">¶</a></h2>
<p>A common challenge at the beamline is detecting phase transitions during an experiment across a state variable.</p>
<p>The following example will take a variable temperature dataset to produce 5 figures in <code class="code docutils literal notranslate"><span class="pre">example_output</span></code>, with the
core result shown below.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python bto.py
</pre></div>
</div>
<figure class="align-center align-default" id="id5">
<img alt="_images/BaTiO.png" src="_images/BaTiO.png" />
<figcaption>
<p><span class="caption-text">By using constraints drawn from a variable temperature dataset, we assume that the pure phases (read components)
of BaTiO$_3$ will exist as prominent members of the dataset. This assumption allows for the automatic detection of
phase transitions in this complicated material.</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>This example uses some helpful utilities from <code class="code docutils literal notranslate"><span class="pre">cmf.nmf</span></code>:</p>
<ul>
<li><dl class="py function">
<dt class="sig sig-object py" id="constrainedmf.nmf.utils.sweep_components">
<span class="sig-prename descclassname"><span class="pre">constrainedmf.nmf.utils.</span></span><span class="sig-name descname"><span class="pre">sweep_components</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">X</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_max</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_min</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">2</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/constrainedmf/nmf/utils.html#sweep_components"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#constrainedmf.nmf.utils.sweep_components" title="Permalink to this definition">¶</a></dt>
<dd><p>Sweeps over all values of n_components and returns a plot of losses vs n_components</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>X</strong><span class="classifier">Tensor</span></dt><dd></dd>
<dt><strong>n_max</strong><span class="classifier">int</span></dt><dd><p>Max n in search, default X.shape[0]</p>
</dd>
<dt><strong>n_min</strong><span class="classifier">int</span></dt><dd><p>Min n in search, default 2</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>fig, axes</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</li>
<li><dl class="py function">
<dt class="sig sig-object py" id="constrainedmf.nmf.utils.iterative_nmf">
<span class="sig-prename descclassname"><span class="pre">constrainedmf.nmf.utils.</span></span><span class="sig-name descname"><span class="pre">iterative_nmf</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">NMFClass</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">X</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_components</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">beta</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alpha</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tol</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1e-08</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_iter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1000</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/constrainedmf/nmf/utils.html#iterative_nmf"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#constrainedmf.nmf.utils.iterative_nmf" title="Permalink to this definition">¶</a></dt>
<dd><p>Utility for performing NMF on a stream of data along a common state variable
(Temperature or composition), that coincides with the data ordering.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>NMFClass</strong><span class="classifier">class</span></dt><dd><p>Child class of NMFBase</p>
</dd>
<dt><strong>X</strong><span class="classifier">Tensor</span></dt><dd><p>Data to perform NMF on</p>
</dd>
<dt><strong>n_components</strong><span class="classifier">int</span></dt><dd><p>Number of components for NMF</p>
</dd>
<dt><strong>beta</strong><span class="classifier">int</span></dt><dd><p>Beta for determining loss function</p>
</dd>
<dt><strong>alpha</strong><span class="classifier">float</span></dt><dd><p>Alpha for determining regularization. Default 0.0 is no regularization.</p>
</dd>
<dt><strong>tol</strong><span class="classifier">float</span></dt><dd><p>Optimization tolerance</p>
</dd>
<dt><strong>max_iter</strong><span class="classifier">int</span></dt><dd><p>Maximum optimization iterations</p>
</dd>
<dt><strong>kwargs</strong><span class="classifier">dict</span></dt><dd><p>Passed to intialization of NMF</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>nmfs</strong><span class="classifier">list of NMF instances</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</li>
</ul>
</section>
<section id="fixing-components-when-you-re-unsure-of-how-many-components-to-use">
<h2>Fixing components when you’re unsure of how many components to use<a class="headerlink" href="#fixing-components-when-you-re-unsure-of-how-many-components-to-use" title="Permalink to this headline">¶</a></h2>
<p>When unsure of how many components to consider, it is customary to use the “elbow method” and consider an inflection
point in the curve comparing reconstruction loss vs the number of components. This can be extracted from the
<code class="code docutils literal notranslate"><span class="pre">constrainedmf.nmf.utils.sweep_components</span></code> function. However, because the CMF approach is lightweight, it
can be worth while to run parallel instances and allow the expert or scientific user to interpret the results.</p>
<p>In the following dataset, there is a discontinuous transition, and a set of well structured components that very similar.
Because NMF does not have translational invariance, a physical phenomena (thermal expansion) which causes your data to
shift will be compensated by NMF casting multiple components to describe the end members of the translation. Although this
is imperfect behavior, it is predictable behavior and shown in the degenerate components in the 3, 4, and 5 component analysis below.</p>
<p>The following example will take a molten salt dataset to produce many figures in <code class="code docutils literal notranslate"><span class="pre">example_output</span></code>, with the
summary result shown below. The set of figures show the iterative results of increasing the number of constraints for
a given number of components (3, 4, and 5):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python molten_salt.py
</pre></div>
</div>
<figure class="align-center align-default" id="id6">
<img alt="_images/molten_salts_xrd_summary.png" src="_images/molten_salts_xrd_summary.png" />
<figcaption>
<p><span class="caption-text">Automated constrained NMF was run using 3-5 components asynchronously on the molten salt dataset.
The learned components for the (a) 3, (c) 4, and (e) 5 component decompostions provide insight into thermal expansion,
and phases present during the temperature ramp.
The learned weights for the  (b) 3, (d) 4, and (f) 5 component decompositions demonstrate the second-order phase
transition, the characteristic response to thermal expansion, and persistence of a solid phase after 400 K.</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="companions.html" class="btn btn-neutral float-left" title="Wrappers and Companion Agents" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tips-and-tricks.html" class="btn btn-neutral float-right" title="Tips and Tricks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Brookhaven National Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>