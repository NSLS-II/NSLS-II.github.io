


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Deploying New Environments &mdash; NSLS-II Software Documentation  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Upgrading Beamlines" href="upgrading-beamlines.html" />
    <link rel="prev" title="Re-syncing Conda" href="resyncing-conda.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> NSLS-II Software Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../architecture-overview.html">Event-Based Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cookbook/index.html">Cookbook (Examples)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote-access.html">Remote Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sandbox.html">Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">History of Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conda.html">Software Deployment with Conda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fresh-installation.html">Installation at a Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Recommended Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internal_index.html">Internal Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../deployment_docs.html">NSLS-II Deployment Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../deployment_docs.html#components">Components</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../deployment_docs.html#deployment-procedures">Deployment Procedures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="releasing-software.html">Releasing Software</a></li>
<li class="toctree-l3"><a class="reference internal" href="resyncing-conda.html">Re-syncing Conda</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Deploying New Environments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-the-metapackages">Updating the Metapackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-environments">Defining Environments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploying-the-environments">Deploying the Environments</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="upgrading-beamlines.html">Upgrading Beamlines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../deployment_docs.html#incident-reports">Incident Reports</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../meetings/index.html">Meetings</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto">caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/suitcase">suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://scikit-beam.github.io/scikit-beam">scikit-beam</a></li>
</ul>
<p class="caption"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/wishlist/issues">Wish List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NSLS-II Software Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../deployment_docs.html">NSLS-II Deployment Documentation</a> &raquo;</li>
        
      <li>Deploying New Environments</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/deployment/updating-metapackages.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deploying-new-environments">
<h1>Deploying New Environments<a class="headerlink" href="#deploying-new-environments" title="Permalink to this headline">¶</a></h1>
<p>This section describes how to define and deploy a new software (conda)
environment to beamlines. We typically do this during the downtime between
operating cycles. In the future, as cycles become longer and the deployment
process becomes more streamlined, we will probably also deploy “patch releases”
during maintenance windows in the middle of an operating cycle.</p>
<p>Deploying the environment just makes it <em>available</em>; it does not actually
affect beamline operations; i.e. the default behavior of <code class="docutils literal notranslate"><span class="pre">bsui</span></code> is
unchanged. We’ll address that in the next section.</p>
<p>See <a class="reference internal" href="../conda.html"><span class="doc">Software Deployment with Conda</span></a> for background on the function and location of the
components involved here.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>We will update the requirements list in the <strong>metapackages</strong>, a human-friendly
specification of our direct requirements. From the metapackages we will
generate <strong>environment files</strong>, an explicit, pinned specification of all the
requirements including indirect dependencies. The environment files will serve
as the canonical definition of software environments.</p>
</div>
<div class="section" id="updating-the-metapackages">
<h2>Updating the Metapackages<a class="headerlink" href="#updating-the-metapackages" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Update the requirements listed in the <code class="docutils literal notranslate"><span class="pre">analysis</span></code> and <code class="docutils literal notranslate"><span class="pre">collection</span></code>
metapackages. Also update any beamline-specific metapackages if the
beamlines’ requirements have changed.</li>
<li>Notice that certain requirements have minimum versions specified to ensure
that conda resolves the right version. We do this selectively (not on _all_
packages) to reduce the maintenace burden. Update these specifiers as
needed.</li>
<li>Finally, when you are ready to publish the new metapackages, submit a PR
that bumps the version numbers in the recipes. The metapackages have the
versioning scheme <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">year</span> <span class="pre">}}C{{</span> <span class="pre">cycle</span> <span class="pre">}}.{{</span> <span class="pre">version</span> <span class="pre">}}</span></code>, such as
<code class="docutils literal notranslate"><span class="pre">2018C3.0</span></code>.  The <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">version</span> <span class="pre">}}</span></code> is used for mid-cycle patch rollouts.</li>
</ol>
<p>As with <a class="reference internal" href="releasing-software.html"><span class="doc">software releases</span></a>, the builder
will detect the change and make the new metapackage available on the conda
server.</p>
<div class="section" id="revoking-a-bad-metapackage">
<h3>Revoking a Bad Metapackage<a class="headerlink" href="#revoking-a-bad-metapackage" title="Permalink to this headline">¶</a></h3>
<p>We often discover a mistake in a metapackage shortly after publishing it. If
the metapackage has already been deployed to beamlines, it should not be
deleted; instead a new version should be released. But if we catch the error
early, during deployment, we remove the bad metapackage and re-publish under
the same version number.</p>
<ol class="arabic">
<li><p class="first">Delete the package from the public conda channel. Visit
<a class="reference external" href="https://anaconda.org/lightsource2-tag/analysis/files">https://anaconda.org/lightsource2-tag/analysis/files</a> and/or
<a class="reference external" href="https://anaconda.org/lightsource2-tag/collection/files">https://anaconda.org/lightsource2-tag/collection/files</a>. Log in. Delete the
offending files.</p>
</li>
<li><p class="first">Delete the package from the internal conda channel: ssh to <code class="docutils literal notranslate"><span class="pre">alexandria</span></code>
(which is inside the Controls network) and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo rm -f /www/conda/nsls2-tag/linux-64/analysis-XXX-0.tar.bz2
sudo rm -f /www/conda/nsls2-tag/linux-64/collection-XXX-0.tar.bz2
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">XXX</span></code> is a version like <code class="docutils literal notranslate"><span class="pre">2018C3.0</span></code>.</p>
</li>
</ol>
<p>The order is important because the “mirroring” agent that copies packages from
the public conda channel to the internal one can undo your work! To avoid this,
we deleted the external/public copy first.</p>
</div>
</div>
<div class="section" id="defining-environments">
<h2>Defining Environments<a class="headerlink" href="#defining-environments" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to any server on the Controls network that has conda installed (e.g
xf23id1-srv1)</p>
</li>
<li><p class="first">Create an analysis environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda create -y -p /tmp/analysis-YYYY-X.V <span class="nv">analysis</span><span class="o">=</span>YYYYCX.V --override-channels -c defaults -c nsls2-tag
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">YYYYCX.V</span></code> is a version like <code class="docutils literal notranslate"><span class="pre">2018C3.0</span></code>. This resolves the
specifications encoded in the metapackage into a specific set of packages.</p>
</li>
<li><p class="first">Export the set of packages into an environment file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda env <span class="nb">export</span> -p /tmp/analysis-YYYY-X.V -f ~/analysis-YYYY-X.V.yml
</pre></div>
</div>
</li>
<li><p class="first">Repeat the above, substituting <code class="docutils literal notranslate"><span class="pre">collection</span></code> for <code class="docutils literal notranslate"><span class="pre">analysis</span></code>.</p>
</li>
<li><p class="first">Manually edit the files to delete the <code class="docutils literal notranslate"><span class="pre">prefix:</span> <span class="pre">/tmp/...</span></code> entry and to sort
the <code class="docutils literal notranslate"><span class="pre">dependencies:</span></code> section alphabetically. This makes it easier to
compare diffs.</p>
</li>
</ol>
<p>We don’t bother creating environments out of the other, beamline-specific
metapackages, purely to save time and effort. This means they are less strictly
defined and not as perfectly reproducible as the base <code class="docutils literal notranslate"><span class="pre">analysis</span></code> and
<code class="docutils literal notranslate"><span class="pre">collection</span></code> environments. In the future this could be made practical through
automation.</p>
</div>
<div class="section" id="deploying-the-environments">
<h2>Deploying the Environments<a class="headerlink" href="#deploying-the-environments" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Copy the environment files into the <code class="docutils literal notranslate"><span class="pre">beamline_envs</span></code> Ansible role.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> playbooks/roles/beamline_envs/files
scp &lt;host&gt;:~/analysis-YYYY-X.V.yml .
scp &lt;host&gt;:~/collection-YYYY-X.V.yml .
</pre></div>
</div>
</li>
<li><p class="first">We typically keep the two newest environments in <code class="docutils literal notranslate"><span class="pre">beamline_envs/files</span></code> and
move anything else to <code class="docutils literal notranslate"><span class="pre">beamline_envs/archived</span></code>. The old environments will
thus not be deployed to new systems, but they remain easy to discover and
reference.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git mv &lt;old environment file&gt; ../archived
</pre></div>
</div>
</li>
<li><p class="first">Commit the changes and open a pull request against the playbooks repository.</p>
</li>
<li><p class="first">Use ansible to copy the environment file onto all beamline workstations and
servers and create an environment from it. Start by testing it on one
beamline using <code class="docutils literal notranslate"><span class="pre">--limit=02-ID</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i production beamlines.yml -bkK --limit<span class="o">=</span><span class="m">02</span>-ID
</pre></div>
</div>
<p>If that completes successfully, log into the machine and check that the
environment can be activated and that the expected versions of a couple
libraries are importable.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda activate analysis-YYYY-X.V
python
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bluesky</span>
<span class="n">bluesky</span><span class="o">.</span><span class="n">__version__</span>  <span class="c1"># Check that you get the right version.</span>
</pre></div>
</div>
<p>If all looks good, deploy to all machines.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i production beamlines.yml -bkK
</pre></div>
</div>
<p>Keep a record of any failures.  The most common failure mode is a server
being temporarily offline or inaccessible on the network. When that happens,
try again later, using <code class="docutils literal notranslate"><span class="pre">--limit</span></code> to target the missed machines.</p>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="upgrading-beamlines.html" class="btn btn-neutral float-right" title="Upgrading Beamlines" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="resyncing-conda.html" class="btn btn-neutral" title="Re-syncing Conda" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>