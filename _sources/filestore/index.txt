.. ipython:: python
   :suppress:

   import pandas as pd
   df = pd.DataFrame({'letters': list('abcde')})
   df.to_csv('example.csv', index=False)


**************************
Introduction to File Store
**************************

What is File Store?
===================

File Store is an interface to stored data. Here's how it works.

#. You (or your hardware) save data wherever you want, whenever you want, in
   whatever format makes sense for your application.
#. At some point, you notify File Store about this data. You provide two pieces
   of information.
   
   #. How to access and open the file (or, generically, "resource")
   #. How to retrieve a given piece of data in that file

#. File Store gives you a token, a unique identifier, which you can use to
   retrieve each piece of data.

This admittedly abstract way of doing things has some powerful advantages.

* *Any* file format is supported, and retrieved data always comes back as a
  simple numpy array.
* It does not matter whether pieces of data are stored in one file or in many
  separate files.
* File Store does not get between the detector and the storage. It is
  not in the business of storing data; you merely *tell it about the data*, and
  you may do so before, during, or after the data is actually created or
  stored.


The following examples illustrate how this works in practice. For a detailed
discussion of the format of File Store storage, see
:ref:`filestore-format`.


Example 1: Retrieving Lines from a CSV File
===========================================

Suppose my detector just saved a data file called ``example.csv``.

.. ipython:: python

   !cat example.csv

First, decide how fine-grained your access to the data should be. Would you
always want the whole file, or would like to be able to request data from
each line individually? Or each pair of lines? The "unit" of data is
completely flexible; it can be anything from a scalar to an N-dimensional
volume.

For this example, suppose we want to retrieve individual lines of data.

Write a Handler
---------------

A Handler is a class with two required methods,
an `__init__` that accesses a file and a `__call__` that returns nuggets of
data from that file. In our case, since we want to access individual lines of
the file, `__call__` will return a line's worth of data.

.. ipython:: python

   class CSVLineHandler(object):
        "Read data stored as lines in a text file."
        def __init__(self, filename):
            "Each instance of a Handler accesses a given file."
            self.file = open(filename)
            self.contents = self.file.readlines()
        def __call__(self, line_no):
            "Get a piece of data."
            return self.contents[line_no]


Make a Record of the Data
-------------------------

During data collection, we make a record of this file by calling
``insert_resource``. When you read "resource," you can think "file", but
other resources are also possible. Handlers can access URLs, URIs, or
even generate their results on the fly with no reference to external
information (e.g., synthetic testing data).

The arguments to ``insert_resource`` are a nickname for the handler,
which can be any string, and the arguments needed by
``__init__`` above to locate and open the file.

.. ipython:: python

   from filestore.api import insert_resource, insert_datum
   resource_id = insert_resource('csv', 'example.csv')

Now, we create a record for each piece of data we'd like to retrieve. We
assign each one a unique ID, which we can use later to retrieve it.
   
The arguments here are the ``resource_id`` returned by ``insert_resource``
above, the unique ID we'll use to retrieve each piece of data, and finally the
arguments needed by ``__call__`` to read that that data from the file. In our
case, ``__call__`` needs just one argument, ``line_no``.

.. ipython:: python

   insert_datum(resource_id, 'some_id1', {'line_no': 1})
   insert_datum(resource_id, 'some_id2', {'line_no': 2})
   insert_datum(resource_id, 'some_id3', {'line_no': 3})
   insert_datum(resource_id, 'some_id4', {'line_no': 4})
   insert_datum(resource_id, 'some_id5', {'line_no': 5})

The Payoff: Retrieving Data Is Dead Simple
------------------------------------------

When we called ``insert_resource``, we recorded the nickname ``'csv'``. To read
that data, we have to associate ``'csv'`` and our Handler, ``CSVLineHandler``, like
so.

.. ipython:: python

   from filestore.api import register_handler
   register_handler('csv', CSVLineHandler)

Finally, we are ready to retrieve that data. All we need is the unique ID.

.. ipython:: python

   from filestore.api import retrieve
   retrieve('some_id2')

File Store now knows to use the ``CSVLineHandler`` class, it knows to instantiate it
with ``example.csv``, and it knows to call it with the argument ``line_no=2``.

.. ipython:: python
   :suppress:

   !rm example.csv
