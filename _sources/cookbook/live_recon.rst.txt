.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_cookbook_live_recon.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_cookbook_live_recon.py:


Streaming Tomographic Reconstruction
************************************

Problem
-------

Reconstruct a 2D cross-section of a sample from projections, as if it were
rotated in place in front of a strip detector.

This example uses the library `tomopy <https://tomopy.readthedocs.io>`_.

Approach
--------

Create a simulated detector coupled to a simulated motor, standing in for the
strip detector and the rotating sample holder. Scan the motor from zero to pi,
and use tomopy to generate simulated projections of a sample at several angles.
This provides our simulated dataset.

Now, use tomopy to reconstruct the sample "density" from these projections.
To give tomopy live access to the data, wrap it in a class that acts as a
bluesky callback, an interface between tomopy and bluesky's document model.

Also make a callback for visualizing the projections side by side (a sinogram).

Example Solution
----------------



.. image:: /cookbook/images/sphx_glr_live_recon_001.png
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    +-----------+------------+------------+----------------+
    |   seq_num |       time |      angle | angle_setpoint |
    +-----------+------------+------------+----------------+
    |         1 | 17:41:47.0 |      0.000 |          0.000 |
    |         2 | 17:41:47.7 |      0.035 |          0.035 |
    |         3 | 17:41:48.3 |      0.071 |          0.071 |
    |         4 | 17:41:49.0 |      0.106 |          0.106 |
    |         5 | 17:41:49.6 |      0.141 |          0.141 |
    |         6 | 17:41:50.2 |      0.176 |          0.176 |
    |         7 | 17:41:50.9 |      0.212 |          0.212 |
    |         8 | 17:41:51.5 |      0.247 |          0.247 |
    |         9 | 17:41:52.2 |      0.282 |          0.282 |
    |        10 | 17:41:52.8 |      0.318 |          0.318 |
    |        11 | 17:41:53.4 |      0.353 |          0.353 |
    |        12 | 17:41:54.1 |      0.388 |          0.388 |
    |        13 | 17:41:54.7 |      0.424 |          0.424 |
    |        14 | 17:41:55.4 |      0.459 |          0.459 |
    |        15 | 17:41:56.0 |      0.494 |          0.494 |
    |        16 | 17:41:56.6 |      0.529 |          0.529 |
    |        17 | 17:41:57.3 |      0.565 |          0.565 |
    |        18 | 17:41:57.9 |      0.600 |          0.600 |
    |        19 | 17:41:58.6 |      0.635 |          0.635 |
    |        20 | 17:41:59.2 |      0.671 |          0.671 |
    |        21 | 17:41:59.8 |      0.706 |          0.706 |
    |        22 | 17:42:00.5 |      0.741 |          0.741 |
    |        23 | 17:42:01.1 |      0.777 |          0.777 |
    |        24 | 17:42:01.7 |      0.812 |          0.812 |
    |        25 | 17:42:02.4 |      0.847 |          0.847 |
    |        26 | 17:42:03.0 |      0.882 |          0.882 |
    |        27 | 17:42:03.7 |      0.918 |          0.918 |
    |        28 | 17:42:04.3 |      0.953 |          0.953 |
    |        29 | 17:42:05.0 |      0.988 |          0.988 |
    |        30 | 17:42:05.6 |      1.024 |          1.024 |
    |        31 | 17:42:06.2 |      1.059 |          1.059 |
    |        32 | 17:42:06.9 |      1.094 |          1.094 |
    |        33 | 17:42:07.5 |      1.130 |          1.130 |
    |        34 | 17:42:08.2 |      1.165 |          1.165 |
    |        35 | 17:42:08.8 |      1.200 |          1.200 |
    |        36 | 17:42:09.5 |      1.235 |          1.235 |
    |        37 | 17:42:10.1 |      1.271 |          1.271 |
    |        38 | 17:42:10.7 |      1.306 |          1.306 |
    |        39 | 17:42:11.4 |      1.341 |          1.341 |
    |        40 | 17:42:12.0 |      1.377 |          1.377 |
    |        41 | 17:42:12.6 |      1.412 |          1.412 |
    |        42 | 17:42:13.3 |      1.447 |          1.447 |
    |        43 | 17:42:13.9 |      1.483 |          1.483 |
    |        44 | 17:42:14.5 |      1.518 |          1.518 |
    |        45 | 17:42:15.2 |      1.553 |          1.553 |
    |        46 | 17:42:15.8 |      1.588 |          1.588 |
    |        47 | 17:42:16.5 |      1.624 |          1.624 |
    |        48 | 17:42:17.1 |      1.659 |          1.659 |
    |        49 | 17:42:17.7 |      1.694 |          1.694 |
    +-----------+------------+------------+----------------+
    |   seq_num |       time |      angle | angle_setpoint |
    +-----------+------------+------------+----------------+
    |        50 | 17:42:18.4 |      1.730 |          1.730 |
    |        51 | 17:42:19.0 |      1.765 |          1.765 |
    |        52 | 17:42:19.7 |      1.800 |          1.800 |
    |        53 | 17:42:20.3 |      1.836 |          1.836 |
    |        54 | 17:42:21.0 |      1.871 |          1.871 |
    |        55 | 17:42:21.6 |      1.906 |          1.906 |
    |        56 | 17:42:22.3 |      1.941 |          1.941 |
    |        57 | 17:42:22.9 |      1.977 |          1.977 |
    |        58 | 17:42:23.5 |      2.012 |          2.012 |
    |        59 | 17:42:24.2 |      2.047 |          2.047 |
    |        60 | 17:42:24.8 |      2.083 |          2.083 |
    |        61 | 17:42:25.5 |      2.118 |          2.118 |
    |        62 | 17:42:26.1 |      2.153 |          2.153 |
    |        63 | 17:42:26.8 |      2.189 |          2.189 |
    |        64 | 17:42:27.4 |      2.224 |          2.224 |
    |        65 | 17:42:28.1 |      2.259 |          2.259 |
    |        66 | 17:42:28.7 |      2.294 |          2.294 |
    |        67 | 17:42:29.5 |      2.330 |          2.330 |
    |        68 | 17:42:30.2 |      2.365 |          2.365 |
    |        69 | 17:42:30.8 |      2.400 |          2.400 |
    |        70 | 17:42:31.5 |      2.436 |          2.436 |
    |        71 | 17:42:32.2 |      2.471 |          2.471 |
    |        72 | 17:42:32.8 |      2.506 |          2.506 |
    |        73 | 17:42:33.5 |      2.542 |          2.542 |
    |        74 | 17:42:34.1 |      2.577 |          2.577 |
    |        75 | 17:42:34.7 |      2.612 |          2.612 |
    |        76 | 17:42:35.4 |      2.647 |          2.647 |
    |        77 | 17:42:36.0 |      2.683 |          2.683 |
    |        78 | 17:42:36.7 |      2.718 |          2.718 |
    |        79 | 17:42:37.3 |      2.753 |          2.753 |
    |        80 | 17:42:37.9 |      2.789 |          2.789 |
    |        81 | 17:42:38.6 |      2.824 |          2.824 |
    |        82 | 17:42:39.2 |      2.859 |          2.859 |
    |        83 | 17:42:39.9 |      2.895 |          2.895 |
    |        84 | 17:42:40.5 |      2.930 |          2.930 |
    |        85 | 17:42:41.2 |      2.965 |          2.965 |
    |        86 | 17:42:41.9 |      3.000 |          3.000 |
    |        87 | 17:42:42.5 |      3.036 |          3.036 |
    |        88 | 17:42:43.2 |      3.071 |          3.071 |
    |        89 | 17:42:43.8 |      3.106 |          3.106 |
    |        90 | 17:42:44.5 |      3.142 |          3.142 |
    +-----------+------------+------------+----------------+
    generator scan ['a558b5f9'] (scan num: 1)




|


.. code-block:: default

    import glob
    import imageio
    import skimage
    import matplotlib.pyplot as plt
    import numpy as np

    import tomopy

    import bluesky.plans as bp
    from bluesky import RunEngine
    from bluesky.callbacks import LiveTable, CallbackBase
    from bluesky.utils import install_qt_kicker
    from ophyd import Device, Signal, Component as Cpt
    from ophyd.sim import SynAxis, NullStatus

    L = 64
    D = int(np.ceil(L * 2**0.5))  # diagonal
    obj = tomopy.cameraman(L)
    orig_obj = np.copy(obj)
    # obj = tomopy.checkerboard(L)
    # obj = tomopy.baboon(L)
    # obj = tomopy.lena(L)

    class TomoDet(Device):
        image = Cpt(Signal)
        def trigger(self):
            super().trigger()
            self.image.put(tomopy.project(obj, angle.read()['angle']['value']))
            return NullStatus()

    det = TomoDet(name='det')
    angle = SynAxis(name='angle')

    RE = RunEngine({})

    # Do this if running the example interactively;
    # skip it when building the documentation.
    import os
    if 'BUILDING_DOCS' not in os.environ:
        from bluesky.utils import install_qt_kicker  # for notebooks, qt -> nb
        install_qt_kicker()
        plt.ion()
        angle._fake_sleep = 0.001  # simulate slow motor movement


    class LiveRecon(CallbackBase):
        SMALL = 1e-6

        def __init__(self, name, x, y, ax=None, **recon_kwargs):
            if ax is None:
                ax = plt.gca()
            ax.set_title('Reconstruction using Tomopy')
            ax.set_xlabel('x')
            ax.set_ylabel('y')
            self.im = ax.imshow(np.zeros((y, x)), origin='upper')
            recon_kwargs.setdefault('num_gridx', x)
            recon_kwargs.setdefault('num_gridy', y)
            self._name = name
            self._x, self._y = x, y
            self._recon_kwargs = recon_kwargs

        def start(self, doc):
            self._partial = self.SMALL * np.ones((self._y, self._x))

        def event(self, doc):
            data = doc['data'][self._name]
            angle = doc['data']['angle']
            self._partial = tomopy.recon(data, angle, **self._recon_kwargs,
                                         init_recon=self._partial)
            self.im.set_data(self._partial)
            self.im.set_clim((np.min(self._partial), np.max(self._partial)))
            self.im.figure.canvas.draw_idle()


    class LiveSinogram(CallbackBase):
        def __init__(self, name, width, ax=None):
            if ax is None:
                ax = plt.gca()
            ax.set_title('Sinogram')
            ax.set_xlabel('sequence number')
            ax.set_ylabel('detector position')
            self.im = ax.imshow(np.zeros((1, width)), aspect='auto')
            ax.figure.colorbar(self.im, ax=ax)
            self._name = name
            self._width = width

        def start(self, doc):
            self._cache = []

        def event(self, doc):
            self._cache.append(doc['data'][self._name][0][0])
            arr = np.asarray(self._cache)
            self.im.set_data(arr.T)
            self.im.set_extent((0, len(self._cache), 0, self._width))
            self.im.set_clim((arr.min(), arr.max()))
            self.im.figure.canvas.draw_idle()


    class LiveRotation(CallbackBase):
        def __init__(self, x, y, ax=None):
            if ax is None:
                ax = plt.gca()
            ax.axis('off')
            self.ax = ax
            self.im = ax.imshow(np.zeros((y, x)), origin='upper')
            self.im.set_clim((orig_obj[0].min(), orig_obj[0].max()))

        def event(self, doc):
            angle = doc['data']['angle'] * 180 / np.pi
            self.ax.set_title(f'Angle: {angle:.2f}°')
            rotated = skimage.transform.rotate(orig_obj[0], angle, resize=False)
            self.im.set_data(rotated)
            self.im.figure.canvas.draw_idle()


    class LiveSaving(CallbackBase):
        def __init__(self, fig=None):
            self._fig = fig

        def event(self, doc):
            angle = doc['data']['angle']
            if self._fig:
                self._fig.savefig(f'recon_{angle:3.3f}.png')


    fig, (ax1, ax2, ax3) = plt.subplots(1, 3, figsize=(18, 6))

    lt = LiveTable([angle])
    ls = LiveSinogram(f'{det.name}_image', D, ax=ax1)
    lrt = LiveRotation(L, L, ax=ax2)
    lr = LiveRecon(f'{det.name}_image', L, L, algorithm='art', ax=ax3)
    lsv = LiveSaving(fig=fig)

    RE(bp.scan([det], angle, 0, np.pi, 90), [lt, ls, lr, lrt, lsv])

    with imageio.get_writer('recon.gif', mode='I') as writer:
        for fn in sorted(glob.glob('recon_*.png')):
            image = imageio.imread(fn)
            writer.append_data(image)


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 1 minutes  10.882 seconds)


.. _sphx_glr_download_cookbook_live_recon.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: live_recon.py <live_recon.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: live_recon.ipynb <live_recon.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.readthedocs.io>`_
