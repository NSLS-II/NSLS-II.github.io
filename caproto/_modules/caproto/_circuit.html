

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>caproto._circuit &mdash; caproto 0.6.0+3.ga4c4818.dirty documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/doctr-versions-menu.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> caproto
          

          
          </a>

          
            
            
              <div class="version">
                0.6.0+3.ga4c4818.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install Caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">EPICS Clients and Servers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../clients.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../records.html">Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../servers.html">Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shark.html">Shark (pcap/tcpdump parsing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../loggers.html">Logging</a></li>
</ul>
<p class="caption"><span class="caption-text">Channel Access Sans I/O</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../basics.html">Writing Your Own Channel Access Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Core API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto/bench/#/">Performance Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../protocol-compliance.html">Details of our Protocol Compliance for CA Nerds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Caproto-in-a-box</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">caproto</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>caproto._circuit</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for caproto._circuit</h1><div class="highlight"><pre>
<span></span><span class="c1"># This module defines classes that encapsulate key abstractions in</span>
<span class="c1"># Channel Access: Channels and VirtualCircuits. Each VirtualCircuit is a</span>
<span class="c1"># companion to a TCP socket managed by a higher-level client or server</span>
<span class="c1"># implementation, updating its state in response to incoming and outgoing TCP</span>
<span class="c1"># bytestreams. Each Channel belongs to a circuit, and tracks state particular</span>
<span class="c1"># to that Channel. A ClientChannel provides convenience methods for composing</span>
<span class="c1"># Requests; a ServerChannel provides convenience methods for composing</span>
<span class="c1"># Responses.</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">._commands</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AccessRightsResponse</span><span class="p">,</span> <span class="n">CreateChFailResponse</span><span class="p">,</span>
                        <span class="n">ClearChannelRequest</span><span class="p">,</span> <span class="n">ClearChannelResponse</span><span class="p">,</span>
                        <span class="n">ClientNameRequest</span><span class="p">,</span> <span class="n">CreateChanRequest</span><span class="p">,</span>
                        <span class="n">CreateChanResponse</span><span class="p">,</span> <span class="n">EventAddRequest</span><span class="p">,</span> <span class="n">EventAddResponse</span><span class="p">,</span>
                        <span class="n">EventCancelRequest</span><span class="p">,</span> <span class="n">EventCancelResponse</span><span class="p">,</span>
                        <span class="n">HostNameRequest</span><span class="p">,</span> <span class="n">ReadNotifyRequest</span><span class="p">,</span>
                        <span class="n">ReadRequest</span><span class="p">,</span> <span class="n">ReadNotifyResponse</span><span class="p">,</span> <span class="n">ReadResponse</span><span class="p">,</span>
                        <span class="n">SearchResponse</span><span class="p">,</span> <span class="n">ServerDisconnResponse</span><span class="p">,</span>
                        <span class="n">VersionRequest</span><span class="p">,</span> <span class="n">VersionResponse</span><span class="p">,</span> <span class="n">WriteNotifyRequest</span><span class="p">,</span>
                        <span class="n">WriteNotifyResponse</span><span class="p">,</span> <span class="n">WriteRequest</span><span class="p">,</span>
                        <span class="n">read_from_bytestream</span><span class="p">,)</span>
<span class="kn">from</span> <span class="nn">._state</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ChannelState</span><span class="p">,</span> <span class="n">CircuitState</span><span class="p">,</span> <span class="n">get_exception</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">._utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">CLIENT</span><span class="p">,</span> <span class="n">SERVER</span><span class="p">,</span> <span class="n">NEED_DATA</span><span class="p">,</span> <span class="n">DISCONNECTED</span><span class="p">,</span> <span class="n">CaprotoKeyError</span><span class="p">,</span>
                     <span class="n">CaprotoValueError</span><span class="p">,</span> <span class="n">CaprotoRuntimeError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">,</span>
                     <span class="n">CaprotoTypeError</span><span class="p">,</span>
                     <span class="n">parse_channel_filter</span><span class="p">,</span> <span class="n">parse_record_field</span><span class="p">,</span>
                     <span class="n">ChannelFilter</span><span class="p">,</span> <span class="n">ThreadsafeCounter</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">._dbr</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ChannelType</span><span class="p">,</span> <span class="n">SubscriptionType</span><span class="p">,</span> <span class="n">field_types</span><span class="p">,</span> <span class="n">native_type</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">._constants</span> <span class="kn">import</span> <span class="n">DEFAULT_PROTOCOL_VERSION</span>
<span class="kn">from</span> <span class="nn">._log</span> <span class="kn">import</span> <span class="n">ComposableLogAdapter</span>
<span class="kn">from</span> <span class="nn">._status</span> <span class="kn">import</span> <span class="n">CAStatus</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;VirtualCircuit&#39;</span><span class="p">,</span> <span class="s1">&#39;ClientChannel&#39;</span><span class="p">,</span> <span class="s1">&#39;ServerChannel&#39;</span><span class="p">,</span>
           <span class="s1">&#39;extract_address&#39;</span><span class="p">)</span>

<span class="n">STRING_ENCODING</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CAPROTO_STRING_ENCODING&#39;</span><span class="p">,</span> <span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="VirtualCircuit"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit">[docs]</a><span class="k">class</span> <span class="nc">VirtualCircuit</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object encapulating the state of one CA client--server connection.</span>

<span class="sd">    It is a companion to a TCP socket managed by the user. All data</span>
<span class="sd">    received over the socket should be passed to :meth:`recv`. Any data sent</span>
<span class="sd">    over the socket should first be passed through :meth:`send`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    our_role : CLIENT or SERVER</span>
<span class="sd">    address : tuple</span>
<span class="sd">        ``(host, port)`` as a string and an integer respectively</span>
<span class="sd">    priority : integer or None</span>
<span class="sd">        May be used by the server to prioritize requests when under high</span>
<span class="sd">        load. Lowest priority is 0; highest is 99.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">our_role</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span>
                 <span class="n">protocol_version</span><span class="o">=</span><span class="n">DEFAULT_PROTOCOL_VERSION</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_role</span> <span class="o">=</span> <span class="n">our_role</span>
        <span class="k">if</span> <span class="n">our_role</span> <span class="ow">is</span> <span class="n">CLIENT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">their_role</span> <span class="o">=</span> <span class="n">SERVER</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">their_role</span> <span class="o">=</span> <span class="n">CLIENT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_address</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># map cid to Channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels_sid</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># map sid to Channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ioids</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># map ioid to Channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># map subscriptionid to EventAdd command</span>
        <span class="c1"># map subscriptionid to EventAdd command as we wait for them to die</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_cancel_commands</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># There are only used by the convenience methods, to auto-generate ids.</span>
        <span class="k">if</span> <span class="n">our_role</span> <span class="ow">is</span> <span class="n">CLIENT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_channel_id_counter</span> <span class="o">=</span> <span class="n">ThreadsafeCounter</span><span class="p">(</span>
                <span class="n">dont_clash_with</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_channel_id_counter</span> <span class="o">=</span> <span class="n">ThreadsafeCounter</span><span class="p">(</span>
                <span class="n">dont_clash_with</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channels_sid</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ioid_counter</span> <span class="o">=</span> <span class="n">ThreadsafeCounter</span><span class="p">(</span><span class="n">dont_clash_with</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ioids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_counter</span> <span class="o">=</span> <span class="n">ThreadsafeCounter</span><span class="p">(</span>
            <span class="n">dont_clash_with</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_role</span> <span class="ow">is</span> <span class="n">CLIENT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoRuntimeError</span><span class="p">(</span><span class="s2">&quot;Client-side VirtualCircuit requires a &quot;</span>
                                      <span class="s2">&quot;non-None priority at initialization &quot;</span>
                                      <span class="s2">&quot;time.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">protocol_version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span>

    <span class="nd">@priority</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
        <span class="c1"># A server-side circuit does not get to know its priority until after</span>
        <span class="c1"># instantiation, so we need a setter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="c1"># The logger_name includes the priority so we have to set it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;caproto.circ&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Peer host name&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Port number&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;VirtualCircuit host=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">!r}</span><span class="s2"> port=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;our_role=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="si">}</span><span class="s2">&gt; logger_name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoRuntimeError</span><span class="p">(</span><span class="s2">&quot;This VirtualCircuit has not received a &quot;</span>
                                      <span class="s2">&quot;VersionRequest and does not know its &quot;</span>
                                      <span class="s2">&quot;priority. Therefore, it does not yet &quot;</span>
                                      <span class="s2">&quot;have a key.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span>  <span class="c1"># a unique identifier</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">))</span>

<div class="viewcode-block" id="VirtualCircuit.send"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">commands</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert one or more high-level Commands into buffers of bytes that may</span>
<span class="sd">        be broadcast together in one TCP packet. Update our internal</span>
<span class="sd">        state machine.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *commands :</span>
<span class="sd">            any number of :class:`Message` objects</span>
<span class="sd">        extra : dict or None</span>
<span class="sd">            Used for logging purposes. This is merged into the ``extra``</span>
<span class="sd">            parameter passed to the logger to provide information like ``&#39;pv&#39;``</span>
<span class="sd">            to the logger.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        buffers_to_send : list</span>
<span class="sd">            list of buffers to send over a socket</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffers_to_send</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;their_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                <span class="s1">&#39;our_address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_address</span><span class="p">,</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;---&gt;&gt;&gt;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">)}</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
            <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
            <span class="n">buffers_to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">memoryview</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
            <span class="n">buffers_to_send</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">buffers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buffers_to_send</span></div>

<div class="viewcode-block" id="VirtualCircuit.recv"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit.recv">[docs]</a>    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">buffers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse commands from buffers received over TCP.</span>

<span class="sd">        When the caller is ready to process the commands, each command should</span>
<span class="sd">        first be passed to :meth:`VirtualCircuit.process_command` to validate</span>
<span class="sd">        it against the protocol and update the VirtualCircuit&#39;s state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *buffers :</span>
<span class="sd">            any number of bytes-like buffers</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ``(commands, num_bytes_needed)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_received</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">byteslike</span><span class="p">)</span> <span class="k">for</span> <span class="n">byteslike</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">)</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_received</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Zero-length recv; sending disconnect notification&#39;</span><span class="p">)</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DISCONNECTED</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">commands</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
             <span class="n">command</span><span class="p">,</span>
             <span class="n">num_bytes_needed</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_from_bytestream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">their_role</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NEED_DATA</span><span class="p">:</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Less than a full command&#39;s worth of bytes are cached. Wait</span>
                <span class="c1"># for more bytes to come in before continuing parsing.</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">commands</span><span class="p">,</span> <span class="n">num_bytes_needed</span></div>

<div class="viewcode-block" id="VirtualCircuit.process_command"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit.process_command">[docs]</a>    <span class="k">def</span> <span class="nf">process_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update internal state machine and raise if protocol is violated.</span>

<span class="sd">        Received commands should be passed through here before any additional</span>
<span class="sd">        processing by a server or client layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">their_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_process_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All commands go through here.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        role : ``CLIENT`` or ``SERVER``</span>
<span class="sd">        command : Message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="n">DISCONNECTED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">EventAddResponse</span><span class="p">):</span>
            <span class="c1"># well, this is dirty...</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_cancel_commands</span> <span class="ow">and</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">payload_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ev_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_cancel_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># EventCancelResponse messages never get sent,</span>
                    <span class="c1"># instead we get sent EventAddResponse with 0</span>
                    <span class="c1"># payload.  This means we can have the following</span>
                    <span class="c1"># race condition:</span>

                    <span class="c1">#  -&gt; cancel request</span>
                    <span class="c1">#  &lt;- an update that really is an 0 length array</span>
                    <span class="c1">#  &lt;- the cancel response</span>

                    <span class="c1"># where the real update is treated as the</span>
                    <span class="c1"># EventCancelResponse.  Thus, if get</span>
                    <span class="c1"># EventCancelResponse or EventAddResponse which is</span>
                    <span class="c1"># not associated with an active subscription but</span>
                    <span class="c1"># has 0 payload, just drop it on the floor and</span>
                    <span class="c1"># move on.</span>
                    <span class="k">return</span>
                <span class="c1"># Otherwise, transmute the Command to a EventCancelResponse.</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">EventCancelResponse</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span>
                                              <span class="n">ev_add</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span>
                                              <span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">,</span>
                                              <span class="n">command</span><span class="o">.</span><span class="n">data_count</span><span class="p">)</span>

        <span class="c1"># Filter for Commands that are pertinent to a specific Channel, as</span>
        <span class="c1"># opposed to the Circuit as a whole:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">ClearChannelRequest</span><span class="p">,</span> <span class="n">ClearChannelResponse</span><span class="p">,</span>
                                <span class="n">CreateChanRequest</span><span class="p">,</span> <span class="n">CreateChanResponse</span><span class="p">,</span>
                                <span class="n">CreateChFailResponse</span><span class="p">,</span> <span class="n">AccessRightsResponse</span><span class="p">,</span>
                                <span class="n">ReadNotifyRequest</span><span class="p">,</span> <span class="n">ReadNotifyResponse</span><span class="p">,</span>
                                <span class="n">ReadRequest</span><span class="p">,</span> <span class="n">ReadResponse</span><span class="p">,</span>
                                <span class="n">WriteNotifyRequest</span><span class="p">,</span> <span class="n">WriteNotifyResponse</span><span class="p">,</span>
                                <span class="n">WriteRequest</span><span class="p">,</span>
                                <span class="n">EventAddRequest</span><span class="p">,</span> <span class="n">EventAddResponse</span><span class="p">,</span>
                                <span class="n">EventCancelRequest</span><span class="p">,</span> <span class="n">EventCancelResponse</span><span class="p">,</span>
                                <span class="n">ServerDisconnResponse</span><span class="p">,)):</span>
            <span class="c1"># Identify which Channel this Command is referring to. We have to</span>
            <span class="c1"># do this in one of a couple different ways depenending on the</span>
            <span class="c1"># Command.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">ReadNotifyRequest</span><span class="p">,</span> <span class="n">WriteNotifyRequest</span><span class="p">,</span>
                                    <span class="n">WriteRequest</span><span class="p">,</span> <span class="n">ReadRequest</span><span class="p">,</span>
                                    <span class="n">EventAddRequest</span><span class="p">)):</span>
                <span class="c1"># Identify the Channel based on its sid.</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">sid</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_sid</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Unknown Channel sid </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">sid</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">ReadNotifyResponse</span><span class="p">,</span> <span class="n">ReadResponse</span><span class="p">,</span>
                                      <span class="n">WriteNotifyResponse</span><span class="p">)):</span>
                <span class="c1"># Identify the Channel based on its ioid.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ioids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">ioid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Unknown Channel ioid </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">ioid</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">EventCancelRequest</span><span class="p">,)):</span>
                <span class="c1"># Identify the Channel based on its subscriptionid</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">event_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Unrecognized subscriptionid </span><span class="si">{!r}</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">))</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_sid</span><span class="p">[</span><span class="n">event_add</span><span class="o">.</span><span class="n">sid</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">EventAddResponse</span><span class="p">,</span> <span class="n">EventCancelResponse</span><span class="p">)):</span>
                <span class="c1"># Identify the Channel based on its subscriptionid</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">event_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">payload_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="k">return</span>

                    <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;Unrecognized subscriptionid </span><span class="si">{!r}</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">))</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_sid</span><span class="p">[</span><span class="n">event_add</span><span class="o">.</span><span class="n">sid</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">CreateChanRequest</span><span class="p">):</span>
                <span class="c1"># A Channel instance for this cid may already exist.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">_class</span> <span class="o">=</span> <span class="p">{</span><span class="n">CLIENT</span><span class="p">:</span> <span class="n">ClientChannel</span><span class="p">,</span>
                              <span class="n">SERVER</span><span class="p">:</span> <span class="n">ServerChannel</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">]</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="n">_class</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># In all other cases, the Command gives us a cid.</span>
                <span class="n">cid</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">cid</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>

            <span class="c1"># Do some additional validation on commands related to an existing</span>
            <span class="c1"># subscription.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">EventAddResponse</span><span class="p">,</span> <span class="n">EventCancelRequest</span><span class="p">,</span>
                                    <span class="n">EventCancelResponse</span><span class="p">)):</span>
                <span class="c1"># Verify data_type matches the one in the original request.</span>
                <span class="n">event_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">event_add</span><span class="o">.</span><span class="n">data_type</span> <span class="o">!=</span> <span class="n">command</span><span class="o">.</span><span class="n">data_type</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;The data_type in </span><span class="si">{!r}</span><span class="s2"> does not match the &quot;</span>
                              <span class="s2">&quot;data_type in the original EventAddRequest &quot;</span>
                              <span class="s2">&quot;for this subscriptionid, </span><span class="si">{!r}</span><span class="s2">.&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">event_add</span><span class="o">.</span><span class="n">data_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">EventAddResponse</span><span class="p">,)):</span>
                <span class="c1"># Verify data_count matches the one in the original request.</span>
                <span class="c1"># NOTE The docs say that EventCancelRequest should echo the</span>
                <span class="c1"># original data_count too, but in fact it seems to be 0.</span>
                <span class="n">event_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event_add</span><span class="o">.</span><span class="n">data_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                        <span class="n">event_add</span><span class="o">.</span><span class="n">data_count</span> <span class="o">!=</span> <span class="n">command</span><span class="o">.</span><span class="n">data_count</span><span class="p">):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;The data_count in </span><span class="si">{!r}</span><span class="s2"> does not match the &quot;</span>
                              <span class="s2">&quot;data_count in the original EventAddRequest &quot;</span>
                              <span class="s2">&quot;for this subscriptionid, </span><span class="si">{!r}</span><span class="s2">.&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">event_add</span><span class="o">.</span><span class="n">data_count</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">EventCancelRequest</span><span class="p">,</span> <span class="n">EventCancelResponse</span><span class="p">)):</span>
                <span class="c1"># Verify sid matches the one in the original request.</span>
                <span class="n">event_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">event_add</span><span class="o">.</span><span class="n">sid</span> <span class="o">!=</span> <span class="n">command</span><span class="o">.</span><span class="n">sid</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;The sid in </span><span class="si">{!r}</span><span class="s2"> does not match the sid in &quot;</span>
                              <span class="s2">&quot;in the original EventAddRequest for this &quot;</span>
                              <span class="s2">&quot;subscriptionid, </span><span class="si">{!r}</span><span class="s2">.&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">event_add</span><span class="o">.</span><span class="n">sid</span><span class="p">))</span>

            <span class="c1"># Update the state machine of the pertinent Channel.</span>
            <span class="c1"># If this is not a valid command, the state machine will raise</span>
            <span class="c1"># here. Stash the state transitions in a local var and run the</span>
            <span class="c1"># callbacks at the end.</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">process_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

            <span class="c1"># If we got this far, the state machine has validated this Command.</span>
            <span class="c1"># Update other Channel and Circuit state.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">AccessRightsResponse</span><span class="p">):</span>
                <span class="n">chan</span><span class="o">.</span><span class="n">access_rights</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">access_rights</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">CreateChanResponse</span><span class="p">):</span>
                <span class="n">chan</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">sid</span>
                <span class="n">chan</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels_sid</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">ServerDisconnResponse</span><span class="p">,</span>
                                      <span class="n">ClearChannelResponse</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels_sid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
                <span class="c1"># put in list comprehension (not generator) to not change</span>
                <span class="c1"># the size while iterating</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ioids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">chan</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ioids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">ReadNotifyRequest</span><span class="p">,</span> <span class="n">ReadRequest</span><span class="p">,</span>
                                      <span class="n">WriteNotifyRequest</span><span class="p">)):</span>
                <span class="c1"># Stash the ioid for later reference.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ioids</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">ioid</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">EventAddRequest</span><span class="p">):</span>
                <span class="c1"># We will use the info in this command later to validate that</span>
                <span class="c1"># {EventAddResponse, EventCancelRequest, EventCancelResponse}</span>
                <span class="c1"># send or received in the future are valid.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">EventCancelRequest</span><span class="p">):</span>
                <span class="c1"># If we see a cancel request, note that so we know to interpret</span>
                <span class="c1"># the next EventAddResponse with an empty payload as an</span>
                <span class="c1"># EventCancelResponse.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_cancel_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">EventCancelResponse</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_add_commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_cancel_commands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">)</span>
            <span class="c1"># We are done. Run the Channel state change callbacks.</span>
            <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
                <span class="n">chan</span><span class="o">.</span><span class="n">state_changed</span><span class="p">(</span><span class="o">*</span><span class="n">transition</span><span class="p">)</span>

        <span class="c1"># Otherwise, this Command affects the state of this circuit, not a</span>
        <span class="c1"># specific Channel. Run the circuit&#39;s state machine.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">process_command_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">process_command_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">their_role</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">VersionRequest</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">priority</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">!=</span> <span class="n">command</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">err</span><span class="p">(</span><span class="s2">&quot;priority </span><span class="si">{}</span><span class="s2"> does not match previously set priority &quot;</span>
                          <span class="s2">&quot;of </span><span class="si">{}</span><span class="s2"> for this circuit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">))</span>
            <span class="n">protocol_version</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span> <span class="n">command</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">protocol_version</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">chan</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">protocol_version</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">VersionResponse</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Per the specification:</span>
                <span class="c1"># &quot;In CA &lt; 4.11, Message does not include minor version number</span>
                <span class="c1"># (it is always 0) and is interpreted as an echo command that</span>
                <span class="c1"># carries no data. Version exchange is performed immediately</span>
                <span class="c1"># after [channel creation].&quot;</span>
                <span class="k">return</span>
            <span class="n">protocol_version</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span> <span class="n">command</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">protocol_version</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">chan</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">protocol_version</span>

<div class="viewcode-block" id="VirtualCircuit.disconnect"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notify all channels on this circuit that they are disconnected.</span>

<span class="sd">        Clients should call this method when a TCP connection is lost.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DISCONNECTED</span></div>

<div class="viewcode-block" id="VirtualCircuit.new_channel_id"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit.new_channel_id">[docs]</a>    <span class="k">def</span> <span class="nf">new_channel_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Return a valid value for a cid or sid.&quot;</span>
        <span class="c1"># Return the next sequential unused id. Wrap back to 0 on overflow.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_id_counter</span><span class="p">()</span></div>

<div class="viewcode-block" id="VirtualCircuit.new_subscriptionid"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit.new_subscriptionid">[docs]</a>    <span class="k">def</span> <span class="nf">new_subscriptionid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is used by the convenience methods to obtain an unused integer ID.</span>
<span class="sd">        It does not update any important state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_counter</span><span class="p">()</span></div>

<div class="viewcode-block" id="VirtualCircuit.new_ioid"><a class="viewcode-back" href="../../api.html#caproto.VirtualCircuit.new_ioid">[docs]</a>    <span class="k">def</span> <span class="nf">new_ioid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is used by the convenience methods to obtain an unused integer ID.</span>
<span class="sd">        It does not update any important state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ioid_counter</span><span class="p">()</span></div></div>


<span class="k">class</span> <span class="nc">_BaseChannel</span><span class="p">:</span>
    <span class="c1"># Base class for ClientChannel and ServerChannel, which add convenience</span>
    <span class="c1"># methods for composing requests and repsponses, respectively. All of the</span>
    <span class="c1"># important code is here in the base class.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">circuit</span><span class="p">,</span> <span class="n">cid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">string_encoding</span><span class="o">=</span><span class="n">STRING_ENCODING</span><span class="p">):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;their_address&#39;</span><span class="p">:</span> <span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">our_role</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">ComposableLogAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;caproto.ch&#39;</span><span class="p">),</span> <span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">protocol_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span> <span class="o">=</span> <span class="n">string_encoding</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">parse_record_field</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">modifiers</span>
        <span class="k">if</span> <span class="n">modifiers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_filter</span> <span class="o">=</span> <span class="n">parse_channel_filter</span><span class="p">(</span><span class="n">modifiers</span><span class="o">.</span><span class="n">filter_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_filter</span> <span class="o">=</span> <span class="n">ChannelFilter</span><span class="p">(</span>
                <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbnd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="n">circuit</span>
        <span class="k">if</span> <span class="n">cid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">new_channel_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">ChannelState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
        <span class="c1"># These will be set when the circuit processes CreateChanResponse.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">native_data_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">native_data_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_rights</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> cid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;sid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="si">}</span><span class="s2"> data_type=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">native_data_type</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;logger_name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cached EventAdd commands for this channel&#39;s active subscriptions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">event_add_commands</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">sid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_fill_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">):</span>
        <span class="c1"># Boilerplate used in many convenience methods</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Replace `None` default arg with actual default value.</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">native_data_type</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># For example, if data_type is &#39;time&#39;, look up the &#39;time&#39; type</span>
            <span class="c1"># corresponding to this channel&#39;s native data type.</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">field_types</span><span class="p">[</span><span class="n">data_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="bp">self</span><span class="o">.</span><span class="n">native_data_type</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
                <span class="n">data_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">native_data_count</span>
        <span class="k">return</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span>

    <span class="k">def</span> <span class="nf">state_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;State changed callback for subclass usage&#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">process_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">CreateChanResponse</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">native_data_type</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">data_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">native_data_count</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">data_count</span>

        <span class="n">transitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">our_role</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">their_role</span><span class="p">):</span>
            <span class="n">initial_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">process_command_type</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">CaprotoError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="k">raise</span>

            <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>
            <span class="c1"># Assemble arguments needed by state_changed, to be called later.</span>
            <span class="k">if</span> <span class="n">initial_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">new_state</span><span class="p">:</span>
                <span class="n">transition</span> <span class="o">=</span> <span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
                <span class="n">transitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transitions</span>


<div class="viewcode-block" id="ClientChannel"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel">[docs]</a><span class="k">class</span> <span class="nc">ClientChannel</span><span class="p">(</span><span class="n">_BaseChannel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object encapsulating the state of the EPICS Channel on a Client.</span>

<span class="sd">    A ClientChannel may be created in one of two ways:</span>
<span class="sd">    (1) The user instantiates a ClientChannel with a name, server address,</span>
<span class="sd">    priority, and optional cid. The server address and priority are used to</span>
<span class="sd">    assign the ClientChannel to a VirtualCircuit. If no cid is given, a unique</span>
<span class="sd">    one is allocated by the VirtualCircuit.</span>
<span class="sd">    (2) A VirtualCircuit processes a CreateChanRequest that refers to a cid</span>
<span class="sd">    that it has not yet seen. A ClientChannel will be automatically</span>
<span class="sd">    instantiated with the name and cid indicated that command and the address</span>
<span class="sd">    and priority of that VirtualCircuit. It can be accessed in the circuit&#39;s</span>
<span class="sd">    ``channels`` attribute.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        Channnel name (PV)</span>
<span class="sd">    circuit : VirtualCircuit</span>
<span class="sd">    cid : integer, optional</span>
<span class="sd">    string_encoding : string</span>
<span class="sd">        Default is &#39;latin-1&#39; or value of ``CAPROTO_STRING_ENCODING``</span>
<span class="sd">        environment variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ClientChannel.version"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.version">[docs]</a>    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`VersionRequest`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        priority : integer, optional</span>
<span class="sd">            May be used by the server to prioritize requests when under high</span>
<span class="sd">            load. Lowest priority is 0; highest is 99. Default is 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">VersionRequest</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span>
                                 <span class="n">priority</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.host_name"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.host_name">[docs]</a>    <span class="k">def</span> <span class="nf">host_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`HostNameRequest`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        host_name : string</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        HostNameRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">HostNameRequest</span><span class="p">(</span><span class="n">host_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.client_name"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.client_name">[docs]</a>    <span class="k">def</span> <span class="nf">client_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`ClientNameRequest`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        client_name : string, optional</span>
<span class="sd">            defaults to output of ``getpass.getuser()``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ClientNameRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">ClientNameRequest</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.create"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`CreateChanRequest`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CreateChanRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">CreateChanRequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.clear"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`ClearChannelRequest`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ClearChannelRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">ClearChannelRequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.read"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ioid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">notify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`ReadRequest` or :class:`ReadNotifyRequest`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">            Requested Channel Access data type. Default is the channel&#39;s</span>
<span class="sd">            native data type, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_type`.</span>
<span class="sd">        data_count : integer, optional</span>
<span class="sd">            Requested number of values. Default is the channel&#39;s native data</span>
<span class="sd">            count, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_count`.</span>
<span class="sd">        ioid : integer, optional</span>
<span class="sd">            Input/output ID. If None, one is generated.</span>
<span class="sd">        notify : boolean, optional</span>
<span class="sd">            True by default. If True, send a ``ReadNotifyRequest`` instead of</span>
<span class="sd">            a ``ReadRequest``. Note that ``ReadRequest`` has been deprecated by</span>
<span class="sd">            Channel Access in 3.13 and is not well-supported by caproto.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ReadNotifyRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_defaults</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ioid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ioid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">new_ioid</span><span class="p">()</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">ReadNotifyRequest</span> <span class="k">if</span> <span class="n">notify</span> <span class="k">else</span> <span class="n">ReadRequest</span>
        <span class="n">command</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">ioid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.write"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">ioid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`WriteRequest or `:class:`WriteNotifyRequest`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : tuple, ``numpy.ndarray``, ``array.array``, or bytes</span>
<span class="sd">        data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">            Requested Channel Access data type. Default is the channel&#39;s</span>
<span class="sd">            native data type, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_type`.</span>
<span class="sd">        data_count : integer, optional</span>
<span class="sd">            Requested number of values. Default is the channel&#39;s native data</span>
<span class="sd">            count, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_count`.</span>
<span class="sd">        metadata : ``ctypes.BigEndianStructure`` or tuple</span>
<span class="sd">            Status and control metadata for the values</span>
<span class="sd">        ioid : integer, optional</span>
<span class="sd">            Input/output ID. If None, one is generated.</span>
<span class="sd">        notify : boolean, optional</span>
<span class="sd">            False by default. If True, send a ``WriteNotifyRequest`` instead of</span>
<span class="sd">            a ``WriteRequest``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WriteNotifyRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_defaults</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">native_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">CHAR</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ioid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ioid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">new_ioid</span><span class="p">()</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">WriteNotifyRequest</span> <span class="k">if</span> <span class="n">notify</span> <span class="k">else</span> <span class="n">WriteRequest</span>
        <span class="n">command</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">ioid</span><span class="p">,</span>
                      <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.subscribe"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">subscriptionid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`EventAddRequest`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">            Requested Channel Access data type. Default is the channel&#39;s</span>
<span class="sd">            native data type, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_type`.</span>
<span class="sd">        data_count : integer, optional</span>
<span class="sd">            Requested number of values. Default is the channel&#39;s native data</span>
<span class="sd">            count, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_count`.</span>
<span class="sd">        subscriptionid : integer, optional</span>
<span class="sd">        low : number</span>
<span class="sd">            Default is 0.</span>
<span class="sd">        high : number</span>
<span class="sd">            Default is 0.</span>
<span class="sd">        to : number</span>
<span class="sd">            Default is 0.</span>
<span class="sd">        mask :</span>
<span class="sd">            Default is None, which resolves to:</span>
<span class="sd">            ``(SubscriptionType.DBE_VALUE | ``</span>
<span class="sd">            `` SubscriptionType.DBE_ALARM | ``</span>
<span class="sd">            `` SubscriptionType.DBE_PROPERTY)``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventAddRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_defaults</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span> <span class="o">|</span>
                    <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_ALARM</span> <span class="o">|</span>
                    <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_PROPERTY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subscriptionid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subscriptionid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">new_subscriptionid</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">EventAddRequest</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span>
                                  <span class="n">subscriptionid</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ClientChannel.unsubscribe"><a class="viewcode-back" href="../../api.html#caproto.ClientChannel.unsubscribe">[docs]</a>    <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriptionid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`EventAddRequest`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subscriptionid : integer</span>
<span class="sd">            The ``subscriptionid`` that was originally sent in the</span>
<span class="sd">            corresponding :class:`EventAddRequest`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventAddRequest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">event_add_commands</span><span class="p">[</span><span class="n">subscriptionid</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoKeyError</span><span class="p">(</span><span class="s2">&quot;No current subscription has id </span><span class="si">{!r}</span><span class="s2">&quot;</span>
                                  <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscriptionid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">event_add</span><span class="o">.</span><span class="n">sid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span><span class="s2">&quot;This subscription is for a different &quot;</span>
                                    <span class="s2">&quot;Channel.&quot;</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">EventCancelRequest</span><span class="p">(</span><span class="n">event_add</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span>
                                     <span class="n">subscriptionid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div></div>


<div class="viewcode-block" id="ServerChannel"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel">[docs]</a><span class="k">class</span> <span class="nc">ServerChannel</span><span class="p">(</span><span class="n">_BaseChannel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A server-side Channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        Channnel name (PV)</span>
<span class="sd">    circuit : VirtualCircuit</span>
<span class="sd">    cid : integer, optional</span>
<span class="sd">    string_encoding : string</span>
<span class="sd">        Default is &#39;latin-1&#39; or value of ``CAPROTO_STRING_ENCODING``</span>
<span class="sd">        environment variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ServerChannel.version"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.version">[docs]</a>    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`VersionResponse`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">VersionResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.create"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">native_data_type</span><span class="p">,</span> <span class="n">native_data_count</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`CreateChanResponse`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        native_data_type : a ChannelType or corresponding integer ID, optional</span>
<span class="sd">            Default Channel Access data type.</span>
<span class="sd">        native_data_count : integer</span>
<span class="sd">            Default number of values</span>
<span class="sd">        sid : integer</span>
<span class="sd">            server-allocated sid</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CreateChanResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">CreateChanResponse</span><span class="p">(</span><span class="n">native_data_type</span><span class="p">,</span> <span class="n">native_data_count</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.create_fail"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.create_fail">[docs]</a>    <span class="k">def</span> <span class="nf">create_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`CreateChFailResponse`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CreateChFailResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">CreateChFailResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.read"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ioid</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
             <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`ReadResponse` or :class:`ReadNotifyResponse`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : tuple, ``numpy.ndarray``, ``array.array``, or bytes</span>
<span class="sd">        ioid : integer</span>
<span class="sd">        data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">            Requested Channel Access data type. Default is the channel&#39;s</span>
<span class="sd">            native data type, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_type`.</span>
<span class="sd">        data_count : integer, optional</span>
<span class="sd">            Requested number of values. Default is the channel&#39;s native data</span>
<span class="sd">            count, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_count`.</span>
<span class="sd">        status : integer, optional</span>
<span class="sd">            Default is 1 (success).</span>
<span class="sd">        metadata : ``ctypes.BigEndianStructure`` or tuple</span>
<span class="sd">            Status and control metadata for the values</span>
<span class="sd">        notify : boolean, optional</span>
<span class="sd">            True by default. If True, send a ``ReadNotifyRequest`` instead of</span>
<span class="sd">            a ``ReadRequest``. Note that ``ReadRequest`` has been deprecated by</span>
<span class="sd">            Channel Access in 3.13 and is not well-supported by caproto.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ReadResponse or ReadNotifyResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_defaults</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">)</span>
        <span class="c1"># TODO: Un-comment this to make the server symmetric with the channel.</span>
        <span class="c1"># Some work is needed to integrate it with the server/ChannelData.</span>
        <span class="c1"># if native_type(data_type) != ChannelType.CHAR:</span>
        <span class="c1">#     if not isinstance(data, Iterable) or isinstance(data, (str, bytes)):</span>
        <span class="c1">#         data = [data]</span>
        <span class="c1">#     if len(data) and isinstance(data[0], str):</span>
        <span class="c1">#         data = [val.encode(self.string_encoding) for val in data]</span>
        <span class="c1"># elif len(data) and isinstance(data[0], str):</span>
        <span class="c1">#     data = data.encode(self.string_encoding)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">ReadNotifyResponse</span> <span class="k">if</span> <span class="n">notify</span> <span class="k">else</span> <span class="n">ReadResponse</span>
        <span class="n">command</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ioid</span><span class="p">,</span>
                      <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.write"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ioid</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`WriteNotifyResponse`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ioid : integer</span>
<span class="sd">        data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">            Requested Channel Access data type. Default is the channel&#39;s</span>
<span class="sd">            native data type, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_type`.</span>
<span class="sd">        data_count : integer, optional</span>
<span class="sd">            Requested number of values. Default is the channel&#39;s native data</span>
<span class="sd">            count, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_count`.</span>
<span class="sd">        status : integer, optional</span>
<span class="sd">            Default is 1 (success).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WriteNotifyResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_defaults</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">WriteNotifyResponse</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ioid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.subscribe"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">subscriptionid</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">CAStatus</span><span class="o">.</span><span class="n">ECA_NEWCONN</span><span class="p">,</span>
                  <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`EventAddResponse`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : tuple, ``numpy.ndarray``, ``array.array``, or bytes</span>
<span class="sd">        subscriptionid : integer</span>
<span class="sd">        data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">            Requested Channel Access data type. Default is the channel&#39;s</span>
<span class="sd">            native data type, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_type`.</span>
<span class="sd">        data_count : integer, optional</span>
<span class="sd">            Requested number of values. Default is the channel&#39;s native data</span>
<span class="sd">            count, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_count`.</span>
<span class="sd">        status : CAStatus or corresponding integer code</span>
<span class="sd">            Default is ``CAStatus.ECA_NEWCONN``</span>
<span class="sd">        metadata : ``ctypes.BigEndianStructure`` or tuple</span>
<span class="sd">            Status and control metadata for the values</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventAddResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_defaults</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">EventAddResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                                   <span class="n">subscriptionid</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.unsubscribe"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.unsubscribe">[docs]</a>    <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriptionid</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`EventCancelResponse`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subscriptionid : integer</span>
<span class="sd">        data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">            Requested Channel Access data type. Default is the channel&#39;s</span>
<span class="sd">            native data type, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">            :attr:`native_data_type`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventCancelResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_defaults</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">EventCancelResponse</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">subscriptionid</span><span class="p">,</span>
                                      <span class="n">data_count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.clear"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`ClearChannelResponse`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ClearChannelResposne</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">ClearChannelResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="ServerChannel.disconnect"><a class="viewcode-back" href="../../api.html#caproto.ServerChannel.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a valid :class:`ServerDisconnResponse`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ServerDisconnResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">ServerDisconnResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span></div></div>


<span class="k">def</span> <span class="nf">extract_address</span><span class="p">(</span><span class="n">search_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the (host, port) from a SearchResponse.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">search_response</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SearchResponse</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CaprotoTypeError</span><span class="p">(</span><span class="s2">&quot;expected SearchResponse, not </span><span class="si">{!r}</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">search_response</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">search_response</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">parameter1</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">:</span>
        <span class="c1"># The CA spec tells us that this sentinel value means we</span>
        <span class="c1"># should fall back to using the address of the sender of</span>
        <span class="c1"># the UDP datagram.</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">search_response</span><span class="o">.</span><span class="n">sender_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">search_response</span><span class="o">.</span><span class="n">ip</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">search_response</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017, Daniel Allan

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>