

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>caproto.sync.client &mdash; caproto 0.5.2+0.g65eb636.dirty documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> caproto
          

          
          </a>

          
            
            
              <div class="version">
                0.5.2+0.g65eb636.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Install Caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">EPICS Clients and Servers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../clients.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../records.html">Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../servers.html">Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../shark.html">Shark (pcap/tcpdump parsing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../loggers.html">Logging</a></li>
</ul>
<p class="caption"><span class="caption-text">Channel Access Sans I/O</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html">Writing Your Own Channel Access Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Core API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto/bench/#/">Performance Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../protocol-compliance.html">Details of our Protocol Compliance for CA Nerds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../containers.html">Caproto-in-a-box</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">caproto</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>caproto.sync.client</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for caproto.sync.client</h1><div class="highlight"><pre>
<span></span><span class="c1"># This module contains a synchronous implementation of a Channel Access client</span>
<span class="c1"># as three top-level functions: read, write, subscribe. They are comparatively</span>
<span class="c1"># simple and naive, with no caching or concurrency, and therefore less</span>
<span class="c1"># performant but more robust.</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">selectors</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>  <span class="c1"># just to make callback processing thread-safe</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">import</span> <span class="nn">caproto</span> <span class="k">as</span> <span class="nn">ca</span>
<span class="kn">from</span> <span class="nn">.._dbr</span> <span class="kn">import</span> <span class="p">(</span><span class="n">field_types</span><span class="p">,</span> <span class="n">ChannelType</span><span class="p">,</span> <span class="n">native_type</span><span class="p">,</span> <span class="n">SubscriptionType</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.._utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">adapt_old_callback_signature</span><span class="p">,</span>
                      <span class="n">ErrorResponseReceived</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">,</span> <span class="n">CaprotoTimeoutError</span><span class="p">,</span>
                      <span class="n">get_environment_variables</span><span class="p">,</span> <span class="n">safe_getsockname</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.repeater</span> <span class="kn">import</span> <span class="n">spawn_repeater</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="s1">&#39;subscribe&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;interrupt&#39;</span><span class="p">,</span>
           <span class="s1">&#39;read_write_read&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;caproto.ctx&#39;</span><span class="p">)</span>

<span class="n">CA_SERVER_PORT</span> <span class="o">=</span> <span class="mi">5064</span>  <span class="c1"># just a default</span>

<span class="c1"># Make a dict to hold our tcp sockets.</span>
<span class="n">sockets</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">global_circuits</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">_permission_to_block</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mutable state shared by block and interrupt</span>


<span class="c1"># Convenience functions that do both transport and caproto validation/ingest.</span>
<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">pv_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">pv_name</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">buffers_to_send</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
    <span class="n">sockets</span><span class="p">[</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">(</span><span class="n">buffers_to_send</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="n">circuit</span><span class="p">):</span>
    <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">sockets</span><span class="p">[</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
    <span class="n">commands</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">bytes_received</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">process_command</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">commands</span>


<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1"># Set Broadcaster log level to match our logger.</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Broadcaster</span><span class="p">(</span><span class="n">our_role</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">client_address</span> <span class="o">=</span> <span class="n">safe_getsockname</span><span class="p">(</span><span class="n">udp_sock</span><span class="p">)</span>

    <span class="c1"># Send registration request to the repeater</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Registering with the Channel Access repeater.&#39;</span><span class="p">)</span>
    <span class="n">bytes_to_send</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">RepeaterRegisterRequest</span><span class="p">())</span>

    <span class="n">repeater_port</span> <span class="o">=</span> <span class="n">get_environment_variables</span><span class="p">()[</span><span class="s1">&#39;EPICS_CA_REPEATER_PORT&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">ca</span><span class="o">.</span><span class="n">get_address_list</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">udp_sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">bytes_to_send</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">repeater_port</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ca</span><span class="o">.</span><span class="n">CaprotoNetworkError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send to </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">repeater_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching for </span><span class="si">%r</span><span class="s2">....&quot;</span><span class="p">,</span> <span class="n">pv_name</span><span class="p">)</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ca</span><span class="o">.</span><span class="n">VersionRequest</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DEFAULT_PROTOCOL_VERSION</span><span class="p">),</span>
        <span class="n">ca</span><span class="o">.</span><span class="n">SearchRequest</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DEFAULT_PROTOCOL_VERSION</span><span class="p">))</span>
    <span class="n">bytes_to_send</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="o">*</span><span class="n">commands</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;CLIENT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;our_address&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">client_address</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;---&gt;&gt;&gt;&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send_search</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">ca</span><span class="o">.</span><span class="n">get_address_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">host</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">specified_port</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">specified_port</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CA_SERVER_PORT</span><span class="p">)</span>
            <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;their_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="n">b</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> commands </span><span class="si">%d</span><span class="s1">B&#39;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytes_to_send</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">udp_sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">bytes_to_send</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">dest</span>
                <span class="k">raise</span> <span class="n">ca</span><span class="o">.</span><span class="n">CaprotoNetworkError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send to </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="k">def</span> <span class="nf">check_timeout</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">retry_at</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">retry_at</span><span class="p">:</span>
            <span class="n">send_search</span><span class="p">()</span>
            <span class="n">retry_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="n">retry_timeout</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoTimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timed out while awaiting a response &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;from the search for </span><span class="si">{</span><span class="n">pv_name</span><span class="si">!r}</span><span class="s2">. Search &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;requests were sent to this address list: &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ca</span><span class="o">.</span><span class="n">get_address_list</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># Initial search attempt</span>
    <span class="n">send_search</span><span class="p">()</span>

    <span class="c1"># Await a search response, and keep track of registration status</span>
    <span class="n">retry_timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">/</span> <span class="nb">max</span><span class="p">((</span><span class="n">max_retries</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">retry_at</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">retry_timeout</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">orig_timeout</span> <span class="o">=</span> <span class="n">udp_sock</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">()</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">retry_timeout</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bytes_received</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">udp_sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">MAX_UDP_RECV</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="n">check_timeout</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="n">check_timeout</span><span class="p">()</span>

            <span class="n">commands</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">bytes_received</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">process_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SearchResponse</span><span class="p">)</span> <span class="ow">and</span> <span class="n">command</span><span class="o">.</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">address</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">extract_address</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%r</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pv_name</span><span class="p">,</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">address</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># None of the commands we have seen are a reply to our request.</span>
                <span class="c1"># Receive more data.</span>
                <span class="k">continue</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">orig_timeout</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_channel</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;caproto.ch&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">pv_name</span><span class="p">})</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">circuit</span> <span class="o">=</span> <span class="n">global_circuits</span><span class="p">[(</span><span class="n">address</span><span class="p">,</span> <span class="n">priority</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

        <span class="n">circuit</span> <span class="o">=</span> <span class="n">global_circuits</span><span class="p">[(</span><span class="n">address</span><span class="p">,</span> <span class="n">priority</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">VirtualCircuit</span><span class="p">(</span>
            <span class="n">our_role</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">,</span>
            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">)</span>

    <span class="n">chan</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">ClientChannel</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">circuit</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sockets</span><span class="p">:</span>
        <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                                                         <span class="n">timeout</span><span class="p">)</span>
        <span class="n">circuit</span><span class="o">.</span><span class="n">our_address</span> <span class="o">=</span> <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
            <span class="c1"># Initialize our new TCP-based CA connection with a VersionRequest.</span>
            <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">VersionRequest</span><span class="p">(</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DEFAULT_PROTOCOL_VERSION</span><span class="p">),</span>
                <span class="n">pv_name</span><span class="p">)</span>
            <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">host_name</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()))</span>
            <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">client_name</span><span class="p">(</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()))</span>
        <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">create</span><span class="p">(),</span> <span class="n">pv_name</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CaprotoTimeoutError</span><span class="p">(</span><span class="s2">&quot;Timeout while awaiting channel &quot;</span>
                                          <span class="s2">&quot;creation.&quot;</span><span class="p">)</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&lt;&lt;---&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;our_address&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">our_address</span><span class="p">,</span>
                    <span class="s1">&#39;their_address&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
                    <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">command</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">DISCONNECTED</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CaprotoError</span><span class="p">(</span><span class="s1">&#39;Disconnected during initialization&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Channel connected.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">global_circuits</span><span class="p">[(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">priority</span><span class="p">)]</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">chan</span>


<span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">notify</span><span class="p">,</span> <span class="n">force_int_enums</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">log</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Detected native data_type </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">native_data_type</span><span class="p">)</span>
    <span class="n">ntype</span> <span class="o">=</span> <span class="n">native_type</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">native_data_type</span><span class="p">)</span>  <span class="c1"># abundance of caution</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ntype</span> <span class="ow">is</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">ENUM</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">data_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">force_int_enums</span><span class="p">)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Changing requested data_type to STRING.&quot;</span><span class="p">)</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">STRING</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="n">notify</span><span class="p">)</span>
    <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoTimeoutError</span><span class="p">(</span><span class="s2">&quot;Timeout while awaiting reading.&quot;</span><span class="p">)</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&lt;&lt;---&#39;</span><span class="p">,</span>
                <span class="s1">&#39;our_address&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">our_address</span><span class="p">,</span>
                <span class="s1">&#39;their_address&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
                <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">ReadResponse</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">ReadNotifyResponse</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">ioid</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">ioid</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">command</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">ErrorResponse</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ErrorResponseReceived</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">DISCONNECTED</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CaprotoError</span><span class="p">(</span><span class="s1">&#39;Disconnected while waiting for &#39;</span>
                                   <span class="s1">&#39;read response&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="read"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.read">[docs]</a><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">force_int_enums</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repeater</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a Channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pv_name : str</span>
<span class="sd">        The PV name to read from</span>
<span class="sd">    data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">        Request specific data type or a class of data types, matched to the</span>
<span class="sd">        channel&#39;s native data type. Default is Channel&#39;s native data type.</span>
<span class="sd">    timeout : float, optional</span>
<span class="sd">        Default is 1 second.</span>
<span class="sd">    priority : 0, optional</span>
<span class="sd">        Virtual Circuit priority. Default is 0, lowest. Highest is 99.</span>
<span class="sd">    notify : boolean, optional</span>
<span class="sd">        Send a ReadNotifyRequest instead of a ReadRequest. True by default.</span>
<span class="sd">    force_int_enums : boolean, optional</span>
<span class="sd">        Retrieve enums as integers. (Default is strings.)</span>
<span class="sd">    repeater : boolean, optional</span>
<span class="sd">        Spawn a Channel Access Repeater process if the port is available.</span>
<span class="sd">        True default, as the Channel Access spec stipulates that well-behaved</span>
<span class="sd">        clients should do this.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    response : ReadResponse or ReadNotifyResponse</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Get the value of a Channel named &#39;simple:A&#39;.</span>

<span class="sd">    &gt;&gt;&gt; read(&#39;simple:A&#39;).data</span>
<span class="sd">    array([1], dtype=int32)</span>

<span class="sd">    Request a richer Channel Access data type that includes the timestamp, and</span>
<span class="sd">    access the timestamp.</span>

<span class="sd">    &gt;&gt;&gt; read(&#39;cat&#39;, data_type=&#39;time&#39;).metadata.timestmap</span>
<span class="sd">    1570622339.042392</span>

<span class="sd">    A convenience method is provided for access the timestamp as a Python</span>
<span class="sd">    datetime object.</span>

<span class="sd">    &gt;&gt;&gt; read(&#39;cat&#39; data_type=&#39;time&#39;).metadata.stamp.as_datetime()</span>
<span class="sd">    datetime.datetime(2019, 10, 9, 11, 58, 59, 42392)</span>

<span class="sd">    The requested data type may also been given as a specific Channel Access</span>
<span class="sd">    type</span>

<span class="sd">    &gt;&gt;&gt; from caproto import ChannelType</span>
<span class="sd">    &gt;&gt;&gt; read(&#39;cat&#39;, data_type=ChannelType.CTRL_FLOAT).metadata</span>
<span class="sd">    DBR_CTRL_FLOAT(</span>
<span class="sd">        status=&lt;AlarmStatus.NO_ALARM: 0&gt;,</span>
<span class="sd">        severity=&lt;AlarmSeverity.NO_ALARM: 0&gt;,</span>
<span class="sd">        upper_disp_limit=0.0,</span>
<span class="sd">        lower_disp_limit=0.0,</span>
<span class="sd">        upper_alarm_limit=0.0,</span>
<span class="sd">        upper_warning_limit=0.0,</span>
<span class="sd">        lower_warning_limit=0.0,</span>
<span class="sd">        lower_alarm_limit=0.0,</span>
<span class="sd">        upper_ctrl_limit=0.0,</span>
<span class="sd">        lower_ctrl_limit=0.0,</span>
<span class="sd">        precision=0,</span>
<span class="sd">        units=b&#39;&#39;)</span>

<span class="sd">    or the corresponding integer identifer</span>

<span class="sd">    &gt;&gt;&gt; read(&#39;cat&#39;, data_type=30).metadata</span>
<span class="sd">    DBR_CTRL_FLOAT(</span>
<span class="sd">    status=&lt;AlarmStatus.NO_ALARM: 0&gt;,</span>
<span class="sd">    severity=&lt;AlarmSeverity.NO_ALARM: 0&gt;,</span>
<span class="sd">    upper_disp_limit=0.0,</span>
<span class="sd">    lower_disp_limit=0.0,</span>
<span class="sd">    upper_alarm_limit=0.0,</span>
<span class="sd">    upper_warning_limit=0.0,</span>
<span class="sd">    lower_warning_limit=0.0,</span>
<span class="sd">    lower_alarm_limit=0.0,</span>
<span class="sd">    upper_ctrl_limit=0.0,</span>
<span class="sd">    lower_ctrl_limit=0.0,</span>
<span class="sd">    precision=0,</span>
<span class="sd">    units=b&#39;&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">repeater</span><span class="p">:</span>
        <span class="c1"># As per the EPICS spec, a well-behaved client should start a</span>
        <span class="c1"># caproto-repeater that will continue running after it exits.</span>
        <span class="n">spawn_repeater</span><span class="p">()</span>
    <span class="n">udp_sock</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">bcast_socket</span><span class="p">()</span>
    <span class="c1"># Must bind or getsocketname() will raise on Windows.</span>
    <span class="c1"># See https://github.com/caproto/caproto/issues/514.</span>
    <span class="n">udp_sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">chan</span> <span class="o">=</span> <span class="n">make_channel</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="n">notify</span><span class="p">,</span>
                     <span class="n">force_int_enums</span><span class="o">=</span><span class="n">force_int_enums</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">:</span>
                <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">clear</span><span class="p">(),</span> <span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">global_circuits</span><span class="p">[(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">priority</span><span class="p">)]</span></div>


<div class="viewcode-block" id="subscribe"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.subscribe">[docs]</a><span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define a subscription.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pv_name : string</span>
<span class="sd">        The PV name to subscribe to</span>
<span class="sd">    priority : integer, optional</span>
<span class="sd">        Used by the server to triage subscription responses when under high</span>
<span class="sd">        load. 0 is lowest; 99 is highest.</span>
<span class="sd">    data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">        Request specific data type or a class of data types, matched to the</span>
<span class="sd">        channel&#39;s native data type. Default is Channel&#39;s native data type.</span>
<span class="sd">    data_count : integer, optional</span>
<span class="sd">        Requested number of values. Default is the channel&#39;s native data</span>
<span class="sd">        count, which can be checked in the Channel&#39;s attribute</span>
<span class="sd">        :attr:`native_data_count`.</span>
<span class="sd">    low, high, to : float, optional</span>
<span class="sd">        deprecated by Channel Access, not yet implemented by caproto</span>
<span class="sd">    mask :  SubscriptionType, optional</span>
<span class="sd">        Subscribe to selective updates.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Define a subscription on the ``random_walk:x`` PV.</span>

<span class="sd">    &gt;&gt;&gt; sub = subscribe(&#39;random_walk:x&#39;)</span>

<span class="sd">    Add one or more user-defined callbacks to process responses.</span>

<span class="sd">    &gt;&gt;&gt; def f(sub, response):</span>
<span class="sd">    ...     print(repsonse.data)</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; sub.add_callback(f)</span>

<span class="sd">    Activate the subscription and process incoming responses.</span>

<span class="sd">    &gt;&gt;&gt; sub.block()</span>

<span class="sd">    This is a blocking operation in the sync client. (To do this on a</span>
<span class="sd">    background thread, use the threading client.) Interrupt using Ctrl+C or</span>
<span class="sd">    by calling :meth:`sub.interrupt()` from another thread.</span>

<span class="sd">    The subscription may be reactivated by calling ``sub.block()`` again.</span>

<span class="sd">    To process multiple subscriptions at once, use the *function*</span>
<span class="sd">    :func:`block`, which takes one or more Subscriptions as arguments.</span>

<span class="sd">    &gt;&gt;&gt; block(sub1, sub2)</span>

<span class="sd">    There is also an :func:`interrupt` function, which is merely an alias to</span>
<span class="sd">    the method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Subscription</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_count</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span>
                        <span class="n">to</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="interrupt"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.interrupt">[docs]</a><span class="k">def</span> <span class="nf">interrupt</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Signal to :func:`block` to stop blocking. Idempotent.</span>

<span class="sd">    This obviously cannot be called interactively while blocked;</span>
<span class="sd">    it is intended to be called from another thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_permission_to_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="block"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.block">[docs]</a><span class="k">def</span> <span class="nf">block</span><span class="p">(</span><span class="o">*</span><span class="n">subscriptions</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">force_int_enums</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="n">repeater</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Activate one or more subscriptions and process incoming responses.</span>

<span class="sd">    Use Ctrl+C (SIGINT) to escape, or from another thread, call</span>
<span class="sd">    :func:`interrupt()`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *subscriptions : Subscriptions</span>
<span class="sd">        The list of subscriptions.</span>
<span class="sd">    duration : float, optional</span>
<span class="sd">        How many seconds to run for. Run forever (None) by default.</span>
<span class="sd">    timeout : float, optional</span>
<span class="sd">        Default is 1 second. This is not the same as `for`; this is the timeout</span>
<span class="sd">        for failure in the event of no connection.</span>
<span class="sd">    force_int_enums : boolean, optional</span>
<span class="sd">        Retrieve enums as integers. (Default is strings.)</span>
<span class="sd">    repeater : boolean, optional</span>
<span class="sd">        Spawn a Channel Access Repeater process if the port is available.</span>
<span class="sd">        True default, as the Channel Access spec stipulates that well-behaved</span>
<span class="sd">        clients should do this.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Activate subscription(s) and block while they process updates.</span>

<span class="sd">    &gt;&gt;&gt; sub1 = subscribe(&#39;cat&#39;)</span>
<span class="sd">    &gt;&gt;&gt; sub1 = subscribe(&#39;dog&#39;)</span>
<span class="sd">    &gt;&gt;&gt; block(sub1, sub2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_permission_to_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">object</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">duration</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">repeater</span><span class="p">:</span>
        <span class="c1"># As per the EPICS spec, a well-behaved client should start a</span>
        <span class="c1"># caproto-repeater that will continue running after it exits.</span>
        <span class="n">spawn_repeater</span><span class="p">()</span>
    <span class="n">loggers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subscriptions</span><span class="p">:</span>
        <span class="n">loggers</span><span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;caproto.ch&#39;</span><span class="p">),</span>
                                                     <span class="p">{</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">pv_name</span><span class="p">})</span>
    <span class="n">udp_sock</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">bcast_socket</span><span class="p">()</span>
    <span class="c1"># Must bind or getsocketname() will raise on Windows.</span>
    <span class="c1"># See https://github.com/caproto/caproto/issues/514.</span>
    <span class="n">udp_sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subscriptions</span><span class="p">:</span>
            <span class="n">pv_name</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">pv_name</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">make_channel</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Subscribe to all the channels.</span>
        <span class="n">sub_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span><span class="p">,</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">loggers</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Detected native data_type </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span>
                                     <span class="n">chan</span><span class="o">.</span><span class="n">native_data_type</span><span class="p">)</span>

            <span class="c1"># abundance of caution</span>
            <span class="n">ntype</span> <span class="o">=</span> <span class="n">field_types</span><span class="p">[</span><span class="s1">&#39;native&#39;</span><span class="p">][</span><span class="n">chan</span><span class="o">.</span><span class="n">native_data_type</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">ntype</span> <span class="ow">is</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">ENUM</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">force_int_enums</span><span class="p">)):</span>
                <span class="n">ntype</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">STRING</span>
            <span class="n">time_type</span> <span class="o">=</span> <span class="n">field_types</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">ntype</span><span class="p">]</span>
            <span class="c1"># Adjust the timeout during monitoring.</span>
            <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">loggers</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Subscribing with data_type </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span>
                                     <span class="n">time_type</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">data_type</span><span class="o">=</span><span class="n">time_type</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">sub</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">sub_ids</span><span class="p">[(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sub</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Subscribed. Building socket selector.&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">circuits</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span> <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="n">selectors</span><span class="o">.</span><span class="n">DefaultSelector</span><span class="p">()</span>
            <span class="n">sock_to_circuit</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">circuits</span><span class="p">:</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">sockets</span><span class="p">[</span><span class="n">circuit</span><span class="p">]</span>
                <span class="n">sock_to_circuit</span><span class="p">[</span><span class="n">sock</span><span class="p">]</span> <span class="o">=</span> <span class="n">circuit</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">selectors</span><span class="o">.</span><span class="n">EVENT_READ</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Continuing until SIGINT is received....&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">events</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">deadline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">deadline</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deadline reached.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_permission_to_block</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Interrupted via &quot;</span>
                                 <span class="s2">&quot;caproto.sync.client.interrupt().&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">selector_key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                    <span class="n">circuit</span> <span class="o">=</span> <span class="n">sock_to_circuit</span><span class="p">[</span><span class="n">selector_key</span><span class="o">.</span><span class="n">fileobj</span><span class="p">]</span>
                    <span class="n">commands</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">ErrorResponse</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">ErrorResponseReceived</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">DISCONNECTED</span><span class="p">:</span>
                            <span class="c1"># TODO Re-connect.</span>
                            <span class="k">raise</span> <span class="n">CaprotoError</span><span class="p">(</span><span class="s2">&quot;Disconnected&quot;</span><span class="p">)</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="n">sub_ids</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">circuit</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">subscriptionid</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">sub</span><span class="p">:</span>
                            <span class="n">sub</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Received SIGINT. Closing.&#39;</span><span class="p">)</span>
            <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_permission_to_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">:</span>
                    <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">clear</span><span class="p">(),</span> <span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Reinstate the timeout for channel cleanup.</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">global_circuits</span><span class="p">[(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">priority</span><span class="p">)]</span></div>


<span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">notify</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Detected native data_type </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">native_data_type</span><span class="p">)</span>
    <span class="c1"># abundance of caution</span>
    <span class="n">ntype</span> <span class="o">=</span> <span class="n">field_types</span><span class="p">[</span><span class="s1">&#39;native&#39;</span><span class="p">][</span><span class="n">chan</span><span class="o">.</span><span class="n">native_data_type</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ntype</span> <span class="ow">is</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">ENUM</span><span class="p">):</span>
        <span class="c1"># Change data_type to STRING if data contains string-like data, or</span>
        <span class="c1"># iterable of string-like data</span>
        <span class="n">stringy_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">stringy_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">stringy_data</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">stringy_data</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Will write to ENUM as data_type STRING.&quot;</span><span class="p">)</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">STRING</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing.&quot;</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">chan</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="n">notify</span><span class="p">,</span>
                     <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
    <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">notify</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CaprotoTimeoutError</span><span class="p">(</span><span class="s2">&quot;Timeout while awaiting write reply.&quot;</span><span class="p">)</span>

            <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&lt;&lt;---&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;our_address&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">our_address</span><span class="p">,</span>
                    <span class="s1">&#39;their_address&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
                    <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;bytesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">WriteNotifyResponse</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">command</span><span class="o">.</span><span class="n">ioid</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">ioid</span><span class="p">):</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">command</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">ErrorResponse</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ErrorResponseReceived</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">command</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">DISCONNECTED</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CaprotoError</span><span class="p">(</span><span class="s1">&#39;Disconnected while waiting for &#39;</span>
                                       <span class="s1">&#39;write response&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">break</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="write"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.write">[docs]</a><span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
          <span class="n">repeater</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write to a Channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pv_name : str</span>
<span class="sd">        The PV name to write to</span>
<span class="sd">    data : str, bytes, int, or float or any Iterable of these</span>
<span class="sd">        Value(s) to write.</span>
<span class="sd">    notify : boolean, optional</span>
<span class="sd">        Request notification of completion and wait for it. False by default.</span>
<span class="sd">    data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">        Write as specific data type. Default is inferred from input.</span>
<span class="sd">    metadata : ``ctypes.BigEndianStructure`` or tuple</span>
<span class="sd">        Status and control metadata for the values</span>
<span class="sd">    timeout : float, optional</span>
<span class="sd">        Default is 1 second.</span>
<span class="sd">    priority : 0, optional</span>
<span class="sd">        Virtual Circuit priority. Default is 0, lowest. Highest is 99.</span>
<span class="sd">    repeater : boolean, optional</span>
<span class="sd">        Spawn a Channel Access Repeater process if the port is available.</span>
<span class="sd">        True default, as the Channel Access spec stipulates that well-behaved</span>
<span class="sd">        clients should do this.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    initial, final : tuple of ReadNotifyResponse objects</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Write the value 5 to a Channel named &#39;simple:A&#39;.</span>

<span class="sd">    &gt;&gt;&gt; write(&#39;simple:A&#39;, 5)  # returns None</span>

<span class="sd">    Request notification of completion (&quot;put completion&quot;) and wait for it.</span>
<span class="sd">    &gt;&gt;&gt; write(&#39;cat&#39;, 5, notify=True)  # blocks until complete, then returns:</span>
<span class="sd">    WriteNotifyResponse(</span>
<span class="sd">    data_type=&lt;ChannelType.LONG: 5&gt;,</span>
<span class="sd">    data_count=1,</span>
<span class="sd">    status=CAStatusCode(</span>
<span class="sd">    name=&#39;ECA_NORMAL&#39;, code=0, code_with_severity=1,</span>
<span class="sd">    severity=&lt;CASeverity.SUCCESS: 1&gt;,</span>
<span class="sd">    success=1, defunct=False,</span>
<span class="sd">    description=&#39;Normal successful completion&#39;),</span>
<span class="sd">    ioid=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">repeater</span><span class="p">:</span>
        <span class="c1"># As per the EPICS spec, a well-behaved client should start a</span>
        <span class="c1"># caproto-repeater that will continue running after it exits.</span>
        <span class="n">spawn_repeater</span><span class="p">()</span>

    <span class="n">udp_sock</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">bcast_socket</span><span class="p">()</span>
    <span class="c1"># Must bind or getsocketname() will raise on Windows.</span>
    <span class="c1"># See https://github.com/caproto/caproto/issues/514.</span>
    <span class="n">udp_sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">chan</span> <span class="o">=</span> <span class="n">make_channel</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_write</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">notify</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">:</span>
                <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">clear</span><span class="p">(),</span> <span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">global_circuits</span><span class="p">[(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">priority</span><span class="p">)]</span></div>


<div class="viewcode-block" id="read_write_read"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.read_write_read">[docs]</a><span class="k">def</span> <span class="nf">read_write_read</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">read_data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">force_int_enums</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repeater</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write to a Channel, but sandwich the write between to reads.</span>

<span class="sd">    This is what the command-line utilities ``caproto-put`` and ``caput`` do.</span>
<span class="sd">    Notice that if you want the second reading to reflect the written value,</span>
<span class="sd">    you should pass the parameter ``notify=True``. (This is also true of</span>
<span class="sd">    ``caproto-put``/``caput``, which needs the ``-c`` argument to behave the</span>
<span class="sd">    way you might expect it to behave.)</span>

<span class="sd">    This is provided as a separate function in order to support ``caproto-put``</span>
<span class="sd">    efficiently. Making separate calls to :func:`read` and :func:`write` would</span>
<span class="sd">    re-create a connection redundantly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pv_name : str</span>
<span class="sd">        The PV name to write/read/write</span>
<span class="sd">    data : str, bytes, int, or float or any Iterable of these</span>
<span class="sd">        Value to write.</span>
<span class="sd">    notify : boolean, optional</span>
<span class="sd">        Request notification of completion and wait for it. False by default.</span>
<span class="sd">    read_data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">        Request specific data type.</span>
<span class="sd">    write_data_type : {&#39;native&#39;, &#39;status&#39;, &#39;time&#39;, &#39;graphic&#39;, &#39;control&#39;} or ChannelType or int ID, optional</span>
<span class="sd">        Write as specific data type. Default is inferred from input.</span>
<span class="sd">    metadata : ``ctypes.BigEndianStructure`` or tuple</span>
<span class="sd">        Status and control metadata for the values</span>
<span class="sd">    timeout : float, optional</span>
<span class="sd">        Default is 1 second.</span>
<span class="sd">    priority : 0, optional</span>
<span class="sd">        Virtual Circuit priority. Default is 0, lowest. Highest is 99.</span>
<span class="sd">    force_int_enums : boolean, optional</span>
<span class="sd">        Retrieve enums as integers. (Default is strings.)</span>
<span class="sd">    repeater : boolean, optional</span>
<span class="sd">        Spawn a Channel Access Repeater process if the port is available.</span>
<span class="sd">        True default, as the Channel Access spec stipulates that well-behaved</span>
<span class="sd">        clients should do this.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    initial, write_response, final : tuple of response</span>

<span class="sd">    The middle response comes from the write, and it will be ``None`` unless</span>
<span class="sd">    ``notify=True``.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Write the value 5 to a Channel named &#39;simple:A&#39;.</span>

<span class="sd">    &gt;&gt;&gt; read_write_read(&#39;cat&#39;, 5)  # returns initial, None, final</span>

<span class="sd">    Request notification of completion (&quot;put completion&quot;) and wait for it.</span>

<span class="sd">    &gt;&gt;&gt; read_write_read(&#39;cat&#39;, 5, notify=True)  # initial, WriteNotifyResponse, final</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">repeater</span><span class="p">:</span>
        <span class="c1"># As per the EPICS spec, a well-behaved client should start a</span>
        <span class="c1"># caproto-repeater that will continue running after it exits.</span>
        <span class="n">spawn_repeater</span><span class="p">()</span>

    <span class="n">udp_sock</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">bcast_socket</span><span class="p">()</span>
    <span class="c1"># Must bind or getsocketname() will raise on Windows.</span>
    <span class="c1"># See https://github.com/caproto/caproto/issues/514.</span>
    <span class="n">udp_sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">chan</span> <span class="o">=</span> <span class="n">make_channel</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">udp_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="n">_read</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">read_data_type</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">force_int_enums</span><span class="o">=</span><span class="n">force_int_enums</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_write</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">write_data_type</span><span class="p">,</span> <span class="n">notify</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">_read</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">read_data_type</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">force_int_enums</span><span class="o">=</span><span class="n">force_int_enums</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chan</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ca</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">:</span>
                <span class="n">send</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">clear</span><span class="p">(),</span> <span class="n">chan</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">sockets</span><span class="p">[</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">global_circuits</span><span class="p">[(</span><span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">chan</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">priority</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">initial</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">final</span></div>


<div class="viewcode-block" id="Subscription"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.Subscription">[docs]</a><span class="k">class</span> <span class="nc">Subscription</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object encapsulates state related to a Subscription.</span>

<span class="sd">    See the :func:`subscribe` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv_name</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span> <span class="o">|</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_ALARM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv_name</span> <span class="o">=</span> <span class="n">pv_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">data_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_count</span> <span class="o">=</span> <span class="n">data_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

        <span class="c1"># This is related to back-compat for user callbacks that have the old</span>
        <span class="c1"># signature, f(response).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wrapper_weakrefs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="Subscription.block"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.Subscription.block">[docs]</a>    <span class="k">def</span> <span class="nf">block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">force_int_enums</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">repeater</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate one or more subscriptions and process incoming responses.</span>

<span class="sd">        Use Ctrl+C (SIGINT) to escape, or from another thread, call</span>
<span class="sd">        :meth:`interrupt()`.</span>

<span class="sd">        Convenience alias for the top-level function :func:`block`, which may</span>
<span class="sd">        be used to process multiple Subscriptions concurrently.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        duration : float, optional</span>
<span class="sd">            How many seconds to run for. Run forever (None) by default.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            Default is 1 second. This is not the same as `for`; this is the</span>
<span class="sd">            timeout for failure in the event of no connection.</span>
<span class="sd">        force_int_enums : boolean, optional</span>
<span class="sd">            Retrieve enums as integers. (Default is strings.)</span>
<span class="sd">        repeater : boolean, optional</span>
<span class="sd">            Spawn a Channel Access Repeater process if the port is available.</span>
<span class="sd">            True default, as the Channel Access spec stipulates that</span>
<span class="sd">            well-behaved clients should do this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
              <span class="n">force_int_enums</span><span class="o">=</span><span class="n">force_int_enums</span><span class="p">,</span>
              <span class="n">repeater</span><span class="o">=</span><span class="n">repeater</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subscription.interrupt"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.Subscription.interrupt">[docs]</a>    <span class="k">def</span> <span class="nf">interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signal to block() to stop blocking. Idempotent.</span>

<span class="sd">        This obviously cannot be called interactively while blocked;</span>
<span class="sd">        it is intended to be called from another thread.</span>
<span class="sd">        This method is a convenience alias for the top-level function</span>
<span class="sd">        :func:`interrupt`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interrupt</span><span class="p">()</span></div>

<div class="viewcode-block" id="Subscription.add_callback"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.Subscription.add_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a callback to receive responses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : callable</span>
<span class="sd">            Expected signature: ``func(sub, response)``.</span>

<span class="sd">            The signature ``func(response)`` is also supported for</span>
<span class="sd">            backward-compatibility but will issue warnings. Support will be</span>
<span class="sd">            removed in a future release of caproto.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        token : int</span>
<span class="sd">            Integer token that can be passed to :meth:`remove_callback`.</span>

<span class="sd">        .. versionchanged:: 0.5.0</span>

<span class="sd">           Changed the expected signature of ``func`` from ``func(response)``</span>
<span class="sd">           to ``func(sub, response)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">adapt_old_callback_signature</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__wrapper_weakrefs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">removed</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">cb_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: strong reference to non-instance methods?</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_lock</span><span class="p">:</span>
            <span class="n">cb_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callback_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">cb_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="k">return</span> <span class="n">cb_id</span></div>

<div class="viewcode-block" id="Subscription.remove_callback"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.Subscription.remove_callback">[docs]</a>    <span class="k">def</span> <span class="nf">remove_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove callback using token that was returned by :meth:`add_callback`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cb_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subscription.process"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.Subscription.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the callbacks on a response.</span>

<span class="sd">        This is used internally by :func:`block()`, generally not called by the</span>
<span class="sd">        user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_lock</span><span class="p">:</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">cb_id</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="n">ref</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb_id</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">remove_id</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">remove_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subscription.clear"><a class="viewcode-back" href="../../../sync-client.html#caproto.sync.client.Subscription.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all callbacks. If currently blocking, interrupt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interrupt</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cb_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">cb_id</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017, Daniel Allan

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>