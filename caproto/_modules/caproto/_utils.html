

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>caproto._utils &mdash; caproto 0.5.1b1+19.g04264bb.dirty documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> caproto
          

          
          </a>

          
            
            
              <div class="version">
                0.5.1b1+19.g04264bb.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install Caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">EPICS Clients and Servers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../clients.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../records.html">Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../servers.html">Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shark.html">Shark (pcap/tcpdump parsing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../loggers.html">Logging</a></li>
</ul>
<p class="caption"><span class="caption-text">Channel Access Sans I/O</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../basics.html">Writing Your Own Channel Access Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Core API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto/bench/#/">Performance Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../protocol-compliance.html">Details of our Protocol Compliance for CA Nerds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Caproto-in-a-box</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">caproto</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>caproto._utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for caproto._utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># This module includes all exceptions raised by caproto, sentinel objects used</span>
<span class="c1"># throughout the package (see detailed comment below), various network-related</span>
<span class="c1"># helper functions, and other miscellaneous utilities.</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">._version</span> <span class="kn">import</span> <span class="n">get_versions</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">get_versions</span><span class="p">()[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
    <span class="kn">import</span> <span class="nn">termios</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">termios</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># fcntl is unavailale on windows</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">netifaces</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">netifaces</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># noqa F822</span>
    <span class="s1">&#39;adapt_old_callback_signature&#39;</span><span class="p">,</span>
    <span class="s1">&#39;apply_arr_filter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ChannelFilter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_environment_variables&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_address_list&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_server_address_list&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_beacon_address_list&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_netifaces_addresses&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ensure_bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;random_ports&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bcast_socket&#39;</span><span class="p">,</span>
    <span class="s1">&#39;buffer_list_slice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;incremental_buffer_list_slice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;send_all&#39;</span><span class="p">,</span>
    <span class="s1">&#39;async_send_all&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parse_record_field&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parse_channel_filter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;batch_requests&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ProtocolError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LocalProtocolError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RemoteProtocolError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoTimeoutError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoKeyError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoAttributeError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoNotImplementedError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoValueError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoTypeError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoConversionError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoRuntimeError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CaprotoNetworkError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ErrorResponseReceived&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SendAllRetry&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RecordModifiers&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RecordModifier&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RecordAndField&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ThreadsafeCounter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;__version__&#39;</span><span class="p">,</span>
    <span class="c1"># sentinels dynamically defined and added to globals() below</span>
    <span class="s1">&#39;CLIENT&#39;</span><span class="p">,</span> <span class="s1">&#39;SERVER&#39;</span><span class="p">,</span> <span class="s1">&#39;RESPONSE&#39;</span><span class="p">,</span> <span class="s1">&#39;REQUEST&#39;</span><span class="p">,</span> <span class="s1">&#39;NEED_DATA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SEND_SEARCH_REQUEST&#39;</span><span class="p">,</span> <span class="s1">&#39;AWAIT_SEARCH_RESPONSE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SEND_SEARCH_RESPONSE&#39;</span><span class="p">,</span> <span class="s1">&#39;SEND_VERSION_REQUEST&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AWAIT_VERSION_RESPONSE&#39;</span><span class="p">,</span> <span class="s1">&#39;SEND_VERSION_RESPONSE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SEND_CREATE_CHAN_REQUEST&#39;</span><span class="p">,</span> <span class="s1">&#39;AWAIT_CREATE_CHAN_RESPONSE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SEND_CREATE_CHAN_RESPONSE&#39;</span><span class="p">,</span> <span class="s1">&#39;CONNECTED&#39;</span><span class="p">,</span> <span class="s1">&#39;MUST_CLOSE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CLOSED&#39;</span><span class="p">,</span> <span class="s1">&#39;IDLE&#39;</span><span class="p">,</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;DISCONNECTED&#39;</span><span class="p">)</span>


<span class="c1"># This module defines sentinels used in the state machine and elsewhere, such</span>
<span class="c1"># as NEED_DATA, CLIENT, SERVER, AWAITING_SEARCH_RESPONSE, etc.</span>
<span class="c1"># It also defines some custom Exceptions.</span>

<span class="k">class</span> <span class="nc">_SimpleReprEnum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">_SimpleReprEnum</span><span class="p">):</span>
    <span class="n">CLIENT</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">SERVER</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">_SimpleReprEnum</span><span class="p">):</span>
    <span class="n">RESPONSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">REQUEST</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">States</span><span class="p">(</span><span class="n">_SimpleReprEnum</span><span class="p">):</span>
    <span class="n">SEND_SEARCH_REQUEST</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AWAIT_SEARCH_RESPONSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">SEND_SEARCH_RESPONSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">SEND_VERSION_REQUEST</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AWAIT_VERSION_RESPONSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">SEND_VERSION_RESPONSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">SEND_CREATE_CHAN_REQUEST</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">AWAIT_CREATE_CHAN_RESPONSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">SEND_CREATE_CHAN_RESPONSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">CONNECTED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">MUST_CLOSE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">CLOSED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">IDLE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">DISCONNECTED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="c1"># Special old &#39;sentinel&#39; for needing more data</span>
    <span class="n">NEED_DATA</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ConversionDirection</span><span class="p">(</span><span class="n">_SimpleReprEnum</span><span class="p">):</span>
    <span class="n">FROM_WIRE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">TO_WIRE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>


<span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="p">{</span><span class="n">token</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_enum</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
     <span class="k">for</span> <span class="n">_enum</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Role</span><span class="p">,</span> <span class="n">Direction</span><span class="p">,</span> <span class="n">States</span><span class="p">]</span>
     <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">_enum</span><span class="p">)</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
     <span class="p">})</span>


<span class="k">class</span> <span class="nc">CaprotoError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="c1"># All exceptions raised by this codebase inherit from this.</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">ProtocolError</span><span class="p">(</span><span class="n">CaprotoError</span><span class="p">):</span>
    <span class="c1"># Any error resulting from sending or receiving a command will raise (a</span>
    <span class="c1"># subclass of) this error and never any other error.</span>
    <span class="o">...</span>


<div class="viewcode-block" id="LocalProtocolError"><a class="viewcode-back" href="../../api.html#caproto.LocalProtocolError">[docs]</a><span class="k">class</span> <span class="nc">LocalProtocolError</span><span class="p">(</span><span class="n">ProtocolError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    You tried to do something that caproto thinks is illegal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span></div>


<div class="viewcode-block" id="RemoteProtocolError"><a class="viewcode-back" href="../../api.html#caproto.RemoteProtocolError">[docs]</a><span class="k">class</span> <span class="nc">RemoteProtocolError</span><span class="p">(</span><span class="n">ProtocolError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Your remote peer tried to do something that caproto thinks is illegal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span></div>


<span class="k">class</span> <span class="nc">ValidationError</span><span class="p">(</span><span class="n">CaprotoError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Could not parse into valid command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoTimeoutError</span><span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoAttributeError</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoKeyError</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoNotImplementedError</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoValueError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoConversionError</span><span class="p">(</span><span class="n">CaprotoValueError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoEnvironmentSetupError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">FilterValidationError</span><span class="p">(</span><span class="n">CaprotoValueError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoTypeError</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoRuntimeError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CaprotoNetworkError</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">ErrorResponseReceived</span><span class="p">(</span><span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="n">_ENVIRONMENT_DEFAULTS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">EPICS_CA_ADDR_LIST</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">EPICS_CA_AUTO_ADDR_LIST</span><span class="o">=</span><span class="s1">&#39;YES&#39;</span><span class="p">,</span>
    <span class="n">EPICS_CA_CONN_TMO</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
    <span class="n">EPICS_CA_BEACON_PERIOD</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
    <span class="n">EPICS_CA_REPEATER_PORT</span><span class="o">=</span><span class="mi">5065</span><span class="p">,</span>
    <span class="n">EPICS_CA_SERVER_PORT</span><span class="o">=</span><span class="mi">5064</span><span class="p">,</span>
    <span class="n">EPICS_CA_MAX_ARRAY_BYTES</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span>
    <span class="n">EPICS_CA_MAX_SEARCH_PERIOD</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">EPICS_TS_MIN_WEST</span><span class="o">=</span><span class="mi">360</span><span class="p">,</span>
    <span class="n">EPICS_CAS_SERVER_PORT</span><span class="o">=</span><span class="mi">5064</span><span class="p">,</span>
    <span class="n">EPICS_CAS_AUTO_BEACON_ADDR_LIST</span><span class="o">=</span><span class="s1">&#39;YES&#39;</span><span class="p">,</span>
    <span class="n">EPICS_CAS_BEACON_ADDR_LIST</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">EPICS_CAS_BEACON_PERIOD</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
    <span class="n">EPICS_CAS_BEACON_PORT</span><span class="o">=</span><span class="mi">5065</span><span class="p">,</span>
    <span class="n">EPICS_CAS_INTF_ADDR_LIST</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">EPICS_CAS_IGNORE_ADDR_LIST</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_environment_variables</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get a dictionary of known EPICS environment variables&#39;&#39;&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">default_value</span> <span class="ow">in</span> <span class="n">_ENVIRONMENT_DEFAULTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">type_of_env_var</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default_value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_of_env_var</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoEnvironmentSetupError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Environment variable </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> misconfigured: &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ex</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_split_address_list</span><span class="p">(</span><span class="n">addr_list</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Split an address list string into individual items&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">addr</span> <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">addr_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">addr</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">get_manually_specified_beacon_addresses</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get a list of addresses, as configured by EPICS_CA_ADDR_LIST&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">_split_address_list</span><span class="p">(</span>
        <span class="n">get_environment_variables</span><span class="p">()[</span><span class="s1">&#39;EPICS_CAS_BEACON_ADDR_LIST&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">get_manually_specified_client_addresses</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get a list of addresses, as configured by EPICS_CA_ADDR_LIST&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">_split_address_list</span><span class="p">(</span>
        <span class="n">get_environment_variables</span><span class="p">()[</span><span class="s1">&#39;EPICS_CA_ADDR_LIST&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">get_address_list</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get channel access client address list based on environment variables</span>

<span class="sd">    If the address list is set to be automatic, the network interfaces will be</span>
<span class="sd">    scanned and used to determine the broadcast addresses available.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">get_environment_variables</span><span class="p">()</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="n">get_manually_specified_client_addresses</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">addresses</span> <span class="ow">and</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;EPICS_CA_AUTO_ADDR_LIST&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="c1"># Custom address list specified, and EPICS_CA_AUTO_ADDR_LIST=NO</span>
        <span class="n">auto_addr_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No addresses configured or EPICS_CA_AUTO_ADDR_LIST=YES</span>
        <span class="k">if</span> <span class="n">netifaces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">auto_addr_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bcast</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">bcast</span> <span class="ow">in</span> <span class="n">get_netifaces_addresses</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auto_addr_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">addresses</span> <span class="o">+</span> <span class="n">auto_addr_list</span>


<span class="k">def</span> <span class="nf">get_server_address_list</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get the server interfaces based on environment variables</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of interfaces</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">intf_addrs</span> <span class="o">=</span> <span class="n">get_environment_variables</span><span class="p">()[</span><span class="s1">&#39;EPICS_CAS_INTF_ADDR_LIST&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">intf_addrs</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">strip_port</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">addr</span><span class="p">:</span>
            <span class="n">addr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">specified_port</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Port specified in EPICS_CAS_INTF_ADDR_LIST was ignored.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">addr</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">strip_port</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">_split_address_list</span><span class="p">(</span><span class="n">intf_addrs</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">get_beacon_address_list</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get channel access beacon address list based on environment variables</span>

<span class="sd">    If the address list is set to be automatic, the network interfaces will be</span>
<span class="sd">    scanned and used to determine the broadcast addresses available.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    addr_list : list of (addr, beacon_port)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">get_environment_variables</span><span class="p">()</span>
    <span class="n">auto_addr_list</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;EPICS_CAS_AUTO_BEACON_ADDR_LIST&#39;</span><span class="p">]</span>
    <span class="n">addr_list</span> <span class="o">=</span> <span class="n">get_manually_specified_beacon_addresses</span><span class="p">()</span>
    <span class="n">beacon_port</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;EPICS_CAS_BEACON_PORT&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_addr_port</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">addr</span><span class="p">:</span>
            <span class="n">addr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">specified_port</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">specified_port</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">beacon_port</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">addr_list</span> <span class="ow">and</span> <span class="n">auto_addr_list</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="c1"># Custom address list and EPICS_CAS_AUTO_BEACON_ADDR_LIST=NO</span>
        <span class="n">auto_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">auto_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">beacon_port</span><span class="p">)]</span>

    <span class="c1"># Custom address list and EPICS_CAS_AUTO_BEACON_ADDR_LIST=YES</span>
    <span class="k">return</span> <span class="n">addr_list</span> <span class="o">+</span> <span class="n">auto_list</span>


<span class="k">def</span> <span class="nf">get_netifaces_addresses</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get a list of addresses + broadcast using netifaces</span>

<span class="sd">    Yields (address, broadcast_address)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">netifaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CaprotoRuntimeError</span><span class="p">(</span><span class="s1">&#39;netifaces unavailable&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iface</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">interfaces</span><span class="p">():</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">iface</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">AF_INET</span> <span class="ow">in</span> <span class="n">interface</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">af_inet_info</span> <span class="ow">in</span> <span class="n">interface</span><span class="p">[</span><span class="n">netifaces</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">]:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="n">af_inet_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;addr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">peer</span> <span class="o">=</span> <span class="n">af_inet_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peer&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">broadcast</span> <span class="o">=</span> <span class="n">af_inet_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;broadcast&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">broadcast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">broadcast</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">peer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">broadcast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">broadcast</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">peer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ensure_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encode string as bytes with null terminator. Bytes pass through.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># be sure to include a null terminator</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CaprotoTypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expected str or bytes, got </span><span class="si">{</span><span class="n">s</span><span class="si">!r}</span><span class="s2"> of type &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">random_ports</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">try_first</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield `num` random port numbers, optionally `try_first`.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">try_first</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">try_first</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">49152</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bcast_socket</span><span class="p">(</span><span class="n">socket_module</span><span class="o">=</span><span class="n">socket</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a socket and configure it for UDP broadcast.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    socket_module: module, optional</span>
<span class="sd">        Default is the built-in :mod:`socket` module, but anything with the</span>
<span class="sd">        same interface may be used, such as :mod:`curio.socket`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket_module</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket_module</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket_module</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket_module</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket_module</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="c1"># WIN32_TODO: trio compatibility</span>
        <span class="kn">import</span> <span class="nn">socket</span> <span class="k">as</span> <span class="nn">system_socket</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket_module</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                        <span class="n">system_socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># sock.setsockopt(socket_module.SOL_SOCKET,</span>
        <span class="c1">#                 system_socket.SO_EXCLUSIVEADDRUSE, 1)</span>

    <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket_module</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket_module</span><span class="o">.</span><span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># for BSD/Darwin only</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">socket_module</span><span class="o">.</span><span class="n">SO_REUSEPORT</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket_module</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket_module</span><span class="o">.</span><span class="n">SO_REUSEPORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sock</span>


<span class="k">if</span> <span class="s1">&#39;pypy&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">implementation</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_cast_buffers_to_byte</span><span class="p">(</span><span class="n">buffers</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">target_type</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">target_type</span><span class="p">))</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_cast_buffers_to_byte</span><span class="p">(</span><span class="n">buffers</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">memoryview</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">buffer_list_slice</span><span class="p">(</span><span class="o">*</span><span class="n">buffers</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="s1">&#39;Helper function for slicing a list of buffers&#39;</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span><span class="s1">&#39;Negative offset&#39;</span><span class="p">)</span>

    <span class="n">buffers</span> <span class="o">=</span> <span class="n">_cast_buffers_to_byte</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">bufidx</span><span class="p">,</span> <span class="n">buf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buffers</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">-=</span> <span class="n">start</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="p">)</span> <span class="o">+</span> <span class="n">buffers</span><span class="p">[</span><span class="n">bufidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>

    <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span><span class="s1">&#39;Offset beyond end of buffers &#39;</span>
                            <span class="s1">&#39;(total length=</span><span class="si">{}</span><span class="s1"> offset=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">incremental_buffer_list_slice</span><span class="p">(</span><span class="o">*</span><span class="n">buffers</span><span class="p">):</span>
    <span class="s1">&#39;Incrementally slice a list of buffers&#39;</span>
    <span class="n">buffers</span> <span class="o">=</span> <span class="n">_cast_buffers_to_byte</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">)</span>
    <span class="n">total_sent</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">total_sent</span> <span class="o">&lt;</span> <span class="n">total_size</span><span class="p">:</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">buffers</span>
        <span class="n">total_sent</span> <span class="o">+=</span> <span class="n">sent</span>
        <span class="k">if</span> <span class="n">total_sent</span> <span class="o">==</span> <span class="n">total_size</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">buffers</span> <span class="o">=</span> <span class="n">buffer_list_slice</span><span class="p">(</span><span class="o">*</span><span class="n">buffers</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">sent</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SendAllRetry</span><span class="p">(</span><span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">send_all</span><span class="p">(</span><span class="n">buffers_to_send</span><span class="p">,</span> <span class="n">send_func</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Incrementally slice a list of buffers, and send it using `send_func`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    buffers_to_send : (buffer1, buffer2, ...)</span>
<span class="sd">        Buffers are expected to be memoryviews or similar</span>
<span class="sd">    send_func : callable</span>
<span class="sd">        Function to call with list of buffers to send</span>
<span class="sd">        Expected to return number of bytes sent or raise SendAllRetry otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">buffers_to_send</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">incremental_buffer_list_slice</span><span class="p">(</span><span class="o">*</span><span class="n">buffers_to_send</span><span class="p">)</span>

    <span class="c1"># prime the generator</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">buffers_to_send</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sent</span> <span class="o">=</span> <span class="n">send_func</span><span class="p">(</span><span class="n">buffers_to_send</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">buffers_to_send</span> <span class="o">=</span> <span class="n">buffers_to_send</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">buffers_to_send</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">except</span> <span class="n">SendAllRetry</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">buffers_to_send</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># finished sending</span>
            <span class="k">break</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">async_send_all</span><span class="p">(</span><span class="n">buffers_to_send</span><span class="p">,</span> <span class="n">async_send_func</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Incrementally slice a list of buffers, and send it using `send_func`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    buffers_to_send : (buffer1, buffer2, ...)</span>
<span class="sd">        Buffers are expected to be memoryviews or similar</span>
<span class="sd">    async_send_func : callable</span>
<span class="sd">        Async function to call with list of buffers to send</span>
<span class="sd">        Expected to return number of bytes sent or raise SendAllRetry otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">buffers_to_send</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">incremental_buffer_list_slice</span><span class="p">(</span><span class="o">*</span><span class="n">buffers_to_send</span><span class="p">)</span>
    <span class="c1"># prime the generator</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">buffers_to_send</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sent</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_send_func</span><span class="p">(</span><span class="n">buffers_to_send</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">buffers_to_send</span> <span class="o">=</span> <span class="n">buffers_to_send</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">buffers_to_send</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">SendAllRetry</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">buffers_to_send</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># finished sending</span>
            <span class="k">break</span>


<span class="n">RecordAndField</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RecordAndField&#39;</span><span class="p">,</span>
                            <span class="p">[</span><span class="s1">&#39;record_dot_field&#39;</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;field&#39;</span><span class="p">,</span> <span class="s1">&#39;modifiers&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">RecordModifiers</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Flag</span><span class="p">):</span>
    <span class="n">long_string</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">filter_timestamp</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">filter_deadband</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">filter_array</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">filter_synchronize</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>


<span class="n">RecordModifier</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RecordModifier&#39;</span><span class="p">,</span>
                            <span class="p">[</span><span class="s1">&#39;modifiers&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">parse_record_field</span><span class="p">(</span><span class="n">pvname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Parse a record[.FIELD][{FILTER}]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    RecordAndField(record_dot_field, record, field, modifiers)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pvname</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RecordAndField</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">pvname</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">record</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">pvname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
        <span class="n">field</span><span class="p">,</span> <span class="n">filter_</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">field</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">RecordModifiers</span><span class="o">.</span><span class="n">filtered</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
        <span class="c1"># valid case of &quot;{record}.&quot;</span>
        <span class="k">return</span> <span class="n">RecordAndField</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">filter_</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">filter_</span> <span class="o">=</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="n">filter_</span>
            <span class="n">modifiers</span> <span class="o">=</span> <span class="n">RecordModifiers</span><span class="o">.</span><span class="n">filtered</span>
        <span class="k">elif</span> <span class="s1">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">filter_</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">filter_</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">filter_</span>
            <span class="n">modifiers</span> <span class="o">=</span> <span class="n">RecordModifiers</span><span class="o">.</span><span class="n">filtered</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">modifiers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">modifiers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">modifiers</span> <span class="o">|=</span> <span class="n">RecordModifiers</span><span class="o">.</span><span class="n">long_string</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modifiers</span> <span class="o">=</span> <span class="n">RecordModifiers</span><span class="o">.</span><span class="n">long_string</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># NOTE: VAL is equated to &#39;record&#39; at a higher level than this.</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="n">record_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">record</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">record_field</span> <span class="o">=</span> <span class="n">record</span>

    <span class="k">if</span> <span class="n">modifiers</span><span class="p">:</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">RecordModifier</span><span class="p">(</span><span class="n">modifiers</span><span class="p">,</span> <span class="n">filter_</span><span class="o">=</span><span class="n">filter_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">RecordAndField</span><span class="p">(</span><span class="n">record_field</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>


<span class="n">ChannelFilter</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ChannelFilter&#39;</span><span class="p">,</span> <span class="s1">&#39;ts dbnd arr sync&#39;</span><span class="p">)</span>
<span class="c1"># TimestampFilter is just True or None, no need for namedtuple.</span>
<span class="n">DeadbandFilter</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;DeadbandFilter&#39;</span><span class="p">,</span> <span class="s1">&#39;m d&#39;</span><span class="p">)</span>
<span class="n">ArrayFilter</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ArrayFilter&#39;</span><span class="p">,</span> <span class="s1">&#39;s i e&#39;</span><span class="p">)</span>
<span class="n">SyncFilter</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SyncFilter&#39;</span><span class="p">,</span> <span class="s1">&#39;m s&#39;</span><span class="p">)</span>

<span class="n">sync_modes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;while&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;unless&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">parse_channel_filter</span><span class="p">(</span><span class="n">filter_text</span><span class="p">):</span>
    <span class="s2">&quot;Parse and validate filter_text into a ChannelFilter.&quot;</span>
    <span class="c1"># https://epics.anl.gov/base/R3-15/5-docs/filters.html</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ChannelFilter</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dbnd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># If there is a shorthand array filter, that is the only filter allowed, so</span>
    <span class="c1"># we parse that and return, shortcircuiting the rest.</span>
    <span class="k">if</span> <span class="n">filter_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filter_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">parse_arr_shorthand_filter</span><span class="p">(</span><span class="n">filter_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ChannelFilter</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dbnd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">arr</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filter_</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">filter_text</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unable to parse channel filter text as JSON: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="c1"># If there is a shorthand sync filter, that is the only filter allowed.</span>
    <span class="c1"># Rewrite the filter to expand the shorthand and go through the normal</span>
    <span class="c1"># codepath.</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="n">sync_modes</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">filter_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">intersection</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found shorthand sync filter key </span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">intersection</span><span class="p">))</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This must be the only key if present but additional keys &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;were found: </span><span class="si">{</span><span class="n">filter_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="o">=</span> <span class="n">filter_</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">filter_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sync&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">}}</span>
    <span class="n">valid_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ts&#39;</span><span class="p">,</span> <span class="s1">&#39;arr&#39;</span><span class="p">,</span> <span class="s1">&#39;sync&#39;</span><span class="p">,</span> <span class="s1">&#39;dbnd&#39;</span><span class="p">}</span>
    <span class="n">filter_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">filter_</span><span class="p">)</span>
    <span class="n">invalid_keys</span> <span class="o">=</span> <span class="n">filter_keys</span> <span class="o">-</span> <span class="n">valid_filters</span>
    <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported filters: </span><span class="si">{</span><span class="n">invalid_keys</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Validate and normalize the filter, expanding &quot;shorthand&quot; notation and</span>
    <span class="c1"># applying defaults.</span>
    <span class="k">return</span> <span class="n">ChannelFilter</span><span class="p">(</span><span class="n">arr</span><span class="o">=</span><span class="n">parse_arr_filter</span><span class="p">(</span><span class="n">filter_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arr&#39;</span><span class="p">)),</span>
                         <span class="n">dbnd</span><span class="o">=</span><span class="n">parse_dbnd_filter</span><span class="p">(</span><span class="n">filter_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dbnd&#39;</span><span class="p">)),</span>
                         <span class="n">ts</span><span class="o">=</span><span class="n">parse_ts_filter</span><span class="p">(</span><span class="n">filter_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">)),</span>
                         <span class="n">sync</span><span class="o">=</span><span class="n">parse_sync_filter</span><span class="p">(</span><span class="n">filter_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sync&#39;</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">parse_arr_shorthand_filter</span><span class="p">(</span><span class="n">filter_text</span><span class="p">):</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">filter_text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">elem</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elem</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">ArrayFilter</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">ArrayFilter</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">ArrayFilter</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="o">=</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="o">=</span><span class="n">elements</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">arr</span>


<span class="k">def</span> <span class="nf">parse_ts_filter</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Empty object means &#39;true&#39; according to the spec:</span>
    <span class="c1"># https://epics.anl.gov/base/R3-15/3-docs/filters.html</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="p">{}:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># We&#39;ll accept `true` and any other truth-y value also....</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_dbnd_filter</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;rel&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
        <span class="n">invalid_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;rel&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported keys in &#39;dbnd&#39;: </span><span class="si">{</span><span class="n">invalid_keys</span><span class="si">}</span><span class="s2">. When &#39;rel&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;shorthand is used, no other keys may be used.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DeadbandFilter</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="s1">&#39;rel&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s1">&#39;abs&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
        <span class="n">invalid_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;abs&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported keys in &#39;dbnd&#39;: </span><span class="si">{</span><span class="n">invalid_keys</span><span class="si">}</span><span class="s2">. When &#39;abs&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;shorthand is used, no other keys may be used.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DeadbandFilter</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;abs&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">invalid_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;dm&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported keys in &#39;dbnd&#39;: </span><span class="si">{</span><span class="n">invalid_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;md&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;dbnd&#39; must include &#39;rel&#39; or &#39;abs&#39; or both &#39;d&#39; and &#39;m&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Found keys </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DeadbandFilter</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]),</span> <span class="n">d</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">parse_arr_filter</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">invalid_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;sie&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported keys in &#39;arr&#39;: &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">invalid_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ArrayFilter</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                       <span class="n">i</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                       <span class="n">e</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">parse_sync_filter</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;sync&#39; must include both &#39;m&#39; and &#39;s&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Found keys </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sync_modes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported mode in &#39;sync&#39;: &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">FilterValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported type in &#39;sync&#39;: &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;value &#39;s&#39; must be a string. &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SyncFilter</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">apply_arr_filter</span><span class="p">(</span><span class="n">arr_filter</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="c1"># Apply array Channel Filter.</span>
    <span class="k">if</span> <span class="n">arr_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">values</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">arr_filter</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">arr_filter</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">arr_filter</span><span class="o">.</span><span class="n">i</span>
    <span class="c1"># Cope with CA slice conventions being different from</span>
    <span class="c1"># Python&#39;s. It specifies an interval closed on both ends,</span>
    <span class="c1"># whereas Python&#39;s open open on the right end.</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">step</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">batch_requests</span><span class="p">(</span><span class="n">request_iter</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Batch a set of items with length, thresholded on sum of item length</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    batch : collections.deque</span>
<span class="sd">        Batch of items from request_iter, where:</span>
<span class="sd">            sum(len(b) for b in batch) &lt; max_length</span>
<span class="sd">        NOTE: instance of deque is reused, cleared at each iteration</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">request_iter</span><span class="p">:</span>
        <span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">+</span> <span class="n">_len</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">batch</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">_len</span>
    <span class="k">if</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">batch</span>


<span class="k">class</span> <span class="nc">ThreadsafeCounter</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;A thread-safe counter with a couple features:</span>

<span class="sd">    1. Loops around at 2 ** 16</span>
<span class="sd">    2. Optionally ensures no clashing with existing IDs</span>

<span class="sd">    Note: if necessary, use the counter lock to keep the dont_clash_with object</span>
<span class="sd">    in sync.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">MAX_ID</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dont_clash_with</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dont_clash_with</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dont_clash_with</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">initial_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dont_clash_with</span> <span class="o">=</span> <span class="n">dont_clash_with</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;Get next ID, wrapping around at 2**16, ensuring no clashes&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">while</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dont_clash_with</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_ID</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_ID</span> <span class="k">else</span> <span class="n">value</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">or</span> <span class="n">fcntl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">socket_bytes_available</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">default_buffer_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>  <span class="c1"># noqa</span>
                               <span class="n">available_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># No support for fcntl/termios on win32</span>
        <span class="k">return</span> <span class="n">default_buffer_size</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">socket_bytes_available</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">default_buffer_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
                               <span class="n">available_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return bytes available to receive on socket</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sock : socket.socket</span>
<span class="sd">        default_buffer_size : int, optional</span>
<span class="sd">            Default recv buffer size, should the platform not support the call or</span>
<span class="sd">            the call fails for unknown reasons</span>
<span class="sd">        available_buffer : array.array, optional</span>
<span class="sd">            Array used for call to fcntl; can be specified to avoid reallocating</span>
<span class="sd">            many times</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">available_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">available_buffer</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">FIONREAD</span><span class="p">,</span> <span class="n">available_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="n">available_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">default_buffer_size</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">default_buffer_size</span><span class="p">)</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">named_temporary_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;NamedTemporaryFile wrapper that works around issues in windows&#39;&#39;&#39;</span>
    <span class="c1"># See: https://bugs.python.org/issue14243</span>

    <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
    <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">f</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ShowVersionAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
    <span class="c1"># a special action that allows the usage --version to override</span>
    <span class="c1"># any &#39;required args&#39; requirements, the same way that --help does</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">option_strings</span><span class="p">,</span>
                 <span class="n">dest</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">,</span>
                 <span class="n">default</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">,</span>
                 <span class="n">help</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">option_strings</span><span class="o">=</span><span class="n">option_strings</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">safe_getsockname</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call sock.getsockname() and, on Windows, return (&#39;0.0.0.0&#39;, 0) if an error is raised.</span>

<span class="sd">    This is a workaround to a critical issue affecting Windows. A better</span>
<span class="sd">    solution should be found but requires more discussion. See</span>
<span class="sd">    https://github.com/caproto/caproto/issues/514</span>
<span class="sd">    and issues/PRs linked from there.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="c1"># This is what the Linux OS returns for a unconnected socket that has</span>
        <span class="c1"># not yet been sent from.</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">adapt_old_callback_signature</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">weakref_set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If func has signature func(response), wrap in signature func(sub, response)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func: callable</span>
<span class="sd">        Expected signature ``f(response)`` or ``f(sub, response)``</span>
<span class="sd">    weakref_set: set</span>
<span class="sd">        Will be used to store state.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    func: callable</span>
<span class="sd">        Signature ``f(sub, response)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle func with signature func(respons) for back-compat.</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Does this function accept two positional arguments?</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The signature of a subscription callback is now expected to &quot;</span>
            <span class="s2">&quot;be func(sub, response). The signature func(response) is &quot;</span>
            <span class="s2">&quot;supported, but support will be removed in a future release &quot;</span>
            <span class="s2">&quot;of caproto.&quot;</span><span class="p">)</span>
        <span class="n">raw_func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">raw_func_weakref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">raw_func</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
            <span class="c1"># Avoid closing over raw_func itself here or it will never be</span>
            <span class="c1"># garbage collected.</span>
            <span class="n">raw_func</span> <span class="o">=</span> <span class="n">raw_func_weakref</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">raw_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Do nothing with sub because the user-provided func cannot</span>
                <span class="c1"># accept it.</span>
                <span class="n">raw_func</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c1"># Ensure func does not get garbage collected until raw_func does.</span>
        <span class="k">def</span> <span class="nf">called_when_raw_func_is_released</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="c1"># The point of this function is to hold one hard ref to func</span>
            <span class="c1"># until raw_func is garbage collected.</span>
            <span class="n">func</span>
            <span class="c1"># Clean up after ourselves.</span>
            <span class="n">weakref_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">raw_func</span><span class="p">,</span> <span class="n">called_when_raw_func_is_released</span><span class="p">)</span>
        <span class="c1"># Hold a hard reference to w. Its callback removes it from this set.</span>
        <span class="n">weakref_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Daniel Allan

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>