

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>caproto.pva.server.magic &mdash; caproto 0.6.0+126.g0ef3919e documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/doctr-versions-menu.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> caproto
          

          
          </a>

          
            
            
              <div class="version">
                0.6.0+126.g0ef3919e
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Install Caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">EPICS Clients and Servers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../clients.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../records.html">Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../servers.html">Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../shark.html">Shark (pcap/tcpdump parsing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../loggers.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cookiecutter.html">IOC Template Cookiecutter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../own_docs.html">Writing Your Own Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Channel Access Sans I/O</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html">Writing Your Own Channel Access Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">Core API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">pvAccess</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pva/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pva/clients.html">Synchronous Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pva/iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pva/api.html">PVAccess API</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto/bench/#/">Performance Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../protocol-compliance.html">Details of our Protocol Compliance for CA Nerds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release-notes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../containers.html">Caproto-in-a-box</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">caproto</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>caproto.pva.server.magic</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for caproto.pva.server.magic</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PVAGroup-based server code. It&#39;s a big magical - maybe not in a good way...</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">contextvars</span> <span class="kn">import</span> <span class="n">ContextVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="n">pva</span>
<span class="kn">from</span> <span class="nn">.._dataclass</span> <span class="kn">import</span> <span class="n">get_pv_structure</span><span class="p">,</span> <span class="n">pva_dataclass</span>
<span class="kn">from</span> <span class="nn">.._normative</span> <span class="kn">import</span> <span class="p">(</span><span class="n">NTScalarArrayBoolean</span><span class="p">,</span> <span class="n">NTScalarArrayFloat64</span><span class="p">,</span>
                          <span class="n">NTScalarArrayInt64</span><span class="p">,</span> <span class="n">NTScalarArrayString</span><span class="p">,</span>
                          <span class="n">NTScalarBoolean</span><span class="p">,</span> <span class="n">NTScalarFloat64</span><span class="p">,</span> <span class="n">NTScalarInt64</span><span class="p">,</span>
                          <span class="n">NTScalarString</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">AuthOperation</span><span class="p">,</span> <span class="n">DataWrapperBase</span>

<span class="n">module_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AuthenticationError"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.AuthenticationError">[docs]</a><span class="k">class</span> <span class="nc">AuthenticationError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="o">...</span></div>


<div class="viewcode-block" id="DatabaseDefinitionError"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.DatabaseDefinitionError">[docs]</a><span class="k">class</span> <span class="nc">DatabaseDefinitionError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="o">...</span></div>


<span class="k">class</span> <span class="nc">SignatureDefinitionError</span><span class="p">(</span><span class="n">DatabaseDefinitionError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">expand_macros</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">macros</span><span class="p">):</span>
    <span class="s1">&#39;Expand a PV name with Python {format-style} macros&#39;</span>
    <span class="k">return</span> <span class="n">pv</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">macros</span><span class="p">)</span>


<div class="viewcode-block" id="verify_getter"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.verify_getter">[docs]</a><span class="k">def</span> <span class="nf">verify_getter</span><span class="p">(</span><span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">get</span><span class="p">:</span> <span class="n">callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">callable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Verify a getter&#39;s call signature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">get</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span><span class="s1">&#39;required async def get&#39;</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">get</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">: Invalid signature for getter </span><span class="si">{</span><span class="n">get</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">get</span></div>


<div class="viewcode-block" id="verify_putter"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.verify_putter">[docs]</a><span class="k">def</span> <span class="nf">verify_putter</span><span class="p">(</span><span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">put</span><span class="p">:</span> <span class="n">callable</span><span class="p">,</span>
                  <span class="o">*</span><span class="p">,</span>
                  <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">callable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Verify a putter&#39;s call signature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">put</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span><span class="s1">&#39;required async def put&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">read_only</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span>
            <span class="s1">&#39;Read-only signal cannot have putter&#39;</span>
        <span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">put</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;write_update&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">: Invalid signature for putter </span><span class="si">{</span><span class="n">put</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">put</span></div>


<div class="viewcode-block" id="verify_rpc_call"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.verify_rpc_call">[docs]</a><span class="k">def</span> <span class="nf">verify_rpc_call</span><span class="p">(</span><span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">call</span><span class="p">:</span> <span class="n">callable</span><span class="p">,</span>
                    <span class="o">*</span><span class="p">,</span>
                    <span class="n">read_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">callable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Verify an RPC call handler&#39;s signature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">call</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span><span class="s1">&#39;required async def call&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">read_only</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span>
            <span class="s1">&#39;Read-only signal cannot have an RPC call&#39;</span>
        <span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">: Invalid signature for RPC call </span><span class="si">{</span><span class="n">call</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">call</span></div>


<div class="viewcode-block" id="verify_startup"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.verify_startup">[docs]</a><span class="k">def</span> <span class="nf">verify_startup</span><span class="p">(</span><span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">callable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Verify a startup method&#39;s call signature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span><span class="s1">&#39;required async def method&#39;</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;async_lib&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">: Invalid signature for startup </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">method</span></div>


<div class="viewcode-block" id="verify_shutdown"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.verify_shutdown">[docs]</a><span class="k">def</span> <span class="nf">verify_shutdown</span><span class="p">(</span><span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">callable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Verify a shutdown method&#39;s call signature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span><span class="s1">&#39;required async def method&#39;</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;async_lib&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureDefinitionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">: Invalid signature for shutdown </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">method</span></div>


<div class="viewcode-block" id="DataclassOverlayInstance"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.DataclassOverlayInstance">[docs]</a><span class="k">class</span> <span class="nc">DataclassOverlayInstance</span><span class="p">:</span>
    <span class="n">_reserved</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;_struct_&#39;</span><span class="p">,</span> <span class="s1">&#39;_instance_&#39;</span><span class="p">,</span> <span class="s1">&#39;_children_&#39;</span><span class="p">,</span> <span class="s1">&#39;_root_&#39;</span><span class="p">,</span> <span class="s1">&#39;_changes_&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_prefix_&#39;</span><span class="p">,</span> <span class="s1">&#39;_owner_&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_changes_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_children_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_instance_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_prefix_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_root_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_struct_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_owner_</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_struct_</span> <span class="o">=</span> <span class="n">get_pv_structure</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_children_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_struct_</span><span class="o">.</span><span class="n">children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner_</span> <span class="o">=</span> <span class="n">owner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changes_</span> <span class="o">=</span> <span class="n">changes</span> <span class="k">if</span> <span class="n">changes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_root_</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_root_</span> <span class="ow">or</span> <span class="n">parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prefix_</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_prefix_</span> <span class="o">+</span> <span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_root_</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prefix_</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changes_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="o">...</span>

        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;_pva_struct_&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changes_</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_changes_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sub_overlay</span> <span class="o">=</span> <span class="n">DataclassOverlayInstance</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_owner_</span><span class="p">,</span>
                <span class="n">changes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_changes_</span><span class="p">[</span><span class="n">attr</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_overlay</span>
            <span class="k">return</span> <span class="n">sub_overlay</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved</span><span class="p">:</span>
            <span class="c1"># For initialization-related things</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changes_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># with self._change_lock_:</span>
            <span class="c1"># TODO fix rejection of entire sub-structure</span>
            <span class="c1"># this breaks it entirely</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_changes_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="WriteUpdate"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.WriteUpdate">[docs]</a><span class="k">class</span> <span class="nc">WriteUpdate</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">owner</span><span class="p">,</span>
                 <span class="n">overlay</span><span class="p">:</span> <span class="n">DataclassOverlayInstance</span><span class="p">,</span>
                 <span class="n">changes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">owner</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="n">owner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">overlay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span> <span class="o">=</span> <span class="n">changes</span>  <span class="c1"># overlay._changes_</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;WriteUpdate for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="si">}</span><span class="s1"> changes=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: deep copy would be appropriate; or just trust the caller :(</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">changes</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="WriteUpdate.accept"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.WriteUpdate.accept">[docs]</a>    <span class="k">def</span> <span class="nf">accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accept only the provided keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
            <span class="c1"># accept() -&gt; reject</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">add_accepted</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">accepted</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
            <span class="n">part</span><span class="p">,</span> <span class="o">*</span><span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
                <span class="c1"># warn? error?</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accepted</span><span class="p">:</span>
                    <span class="n">accepted</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">return</span> <span class="n">add_accepted</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">part</span><span class="p">],</span> <span class="n">accepted</span><span class="p">[</span><span class="n">part</span><span class="p">],</span> <span class="n">parts</span><span class="p">)</span>
            <span class="n">accepted</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>

        <span class="n">accepted_changes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">add_accepted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="p">,</span> <span class="n">accepted_changes</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

        <span class="c1"># TODO: this is pretty inefficient and bad</span>
        <span class="c1"># TODO: accessing the overlay after this can fail in nested structs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_changes_</span> <span class="o">=</span> <span class="n">accepted_changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span> <span class="o">=</span> <span class="n">accepted_changes</span></div>

<div class="viewcode-block" id="WriteUpdate.reject"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.WriteUpdate.reject">[docs]</a>    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reject the provided keys, accepting the remainder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
            <span class="c1"># reject() -&gt; reject all</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_changes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">remove_rejected</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
            <span class="n">part</span><span class="p">,</span> <span class="o">*</span><span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
                <span class="c1"># warn? error?</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">remove_rejected</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">part</span><span class="p">],</span> <span class="n">parts</span><span class="p">)</span>

            <span class="n">changes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">remove_rejected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_changes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span></div></div>


<span class="k">def</span> <span class="nf">_method_or_fallback</span><span class="p">(</span><span class="n">group</span><span class="p">:</span> <span class="s1">&#39;PVAGroup&#39;</span><span class="p">,</span>
                        <span class="n">user_specified_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">callable</span><span class="p">],</span>
                        <span class="n">fallback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">callable</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">user_specified_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">user_specified_method</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fallback</span>


<span class="c1"># These context variables are pretty magical in their own right:</span>
<span class="c1">#   * The following context variable holds a DataclassOverlayInstance in each</span>
<span class="c1">#     &quot;context&quot;</span>
<span class="c1">#   * The context is defined below in `GroupDataWrapper`</span>
<span class="c1">#   * When one uses `async with GroupDataWrapper()`, it calls `__aenter__` and</span>
<span class="c1">#     generates a new context and context variable</span>
<span class="c1">#   * When that context exits, `__aexit__` is called, and `GroupDataWrapper`</span>
<span class="c1">#     can find the correct overlay that relates to the given context by way of</span>
<span class="c1">#     retrieving the context variable.</span>
<span class="c1"># More here: https://docs.python.org/3/library/contextvars.html</span>
<span class="n">_overlays_context_var</span> <span class="o">=</span> <span class="n">ContextVar</span><span class="p">(</span><span class="s1">&#39;overlays&#39;</span><span class="p">)</span>
<span class="n">_overlays_context_var</span><span class="p">:</span> <span class="n">ContextVar</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DataclassOverlayInstance</span><span class="p">]]</span>


<div class="viewcode-block" id="GroupDataWrapper"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.GroupDataWrapper">[docs]</a><span class="k">class</span> <span class="nc">GroupDataWrapper</span><span class="p">(</span><span class="n">DataWrapperBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base class to wrap dataclasses and support caproto-pva&#39;s server API.</span>

<span class="sd">    Two easy methods are provided for writing multiple changes to a data</span>
<span class="sd">    structure in one block.</span>

<span class="sd">    .. code::</span>

<span class="sd">        async with group.prop as prop:</span>
<span class="sd">            prop.attr1 = 1</span>
<span class="sd">            prop.attr2 = 2</span>

<span class="sd">    .. code::</span>

<span class="sd">        async with group.prop(changes={&#39;attr1&#39;: 1}) as prop:</span>
<span class="sd">            prop.attr2 = 2</span>

<span class="sd">    When the context manager exits, the values written will be committed</span>
<span class="sd">    and sent out over pvAccess.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The associated name of the data.</span>

<span class="sd">    data : PvaStruct</span>
<span class="sd">        The dataclass holding the data.</span>

<span class="sd">    group : PVAGroup</span>
<span class="sd">        The group associated with the data.</span>

<span class="sd">    prop : pvaproperty</span>
<span class="sd">        The group&#39;s property which help in binding user hooks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">write_update_class</span> <span class="o">=</span> <span class="n">WriteUpdate</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">group</span><span class="p">:</span> <span class="s1">&#39;PVAGroup&#39;</span><span class="p">,</span>
                 <span class="n">prop</span><span class="p">:</span> <span class="s1">&#39;pvaproperty&#39;</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_read</span> <span class="o">=</span> <span class="n">_method_or_fallback</span><span class="p">(</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">group_read</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_write</span> <span class="o">=</span> <span class="n">_method_or_fallback</span><span class="p">(</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">_put</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">group_write</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_call</span> <span class="o">=</span> <span class="n">_method_or_fallback</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">_call</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_startup</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_startup</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span>
                <span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_shutdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_shutdown</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_shutdown</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span>
                <span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">overlay</span> <span class="o">=</span> <span class="n">DataclassOverlayInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                           <span class="n">changes</span><span class="o">=</span><span class="n">changes</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">overlay</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">overlay</span><span class="o">.</span><span class="n">_changes_</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For more information on this, see `_overlays_context_var` above.</span>
        <span class="n">overlays</span> <span class="o">=</span> <span class="n">_overlays_context_var</span><span class="o">.</span><span class="n">get</span><span class="p">({})</span>
        <span class="n">_overlays_context_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">overlays</span><span class="p">)</span>

        <span class="c1"># Nesting of these blocks is not yet supported</span>
        <span class="n">overlay</span> <span class="o">=</span> <span class="n">DataclassOverlayInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">overlays</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlay</span>
        <span class="k">return</span> <span class="n">overlay</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">overlays</span> <span class="o">=</span> <span class="n">_overlays_context_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">overlay</span><span class="p">:</span> <span class="n">DataclassOverlayInstance</span> <span class="o">=</span> <span class="n">overlays</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">overlay</span><span class="o">.</span><span class="n">_changes_</span><span class="p">)</span>

<div class="viewcode-block" id="GroupDataWrapper.authorize"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.GroupDataWrapper.authorize">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">operation</span><span class="p">:</span> <span class="n">AuthOperation</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                        <span class="n">authorization</span><span class="p">,</span>
                        <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate `operation`, given `authorization` information.</span>

<span class="sd">        In the event of successful authorization, a dataclass defining the data</span>
<span class="sd">        contained here must be returned.</span>

<span class="sd">        In the event of a failed authorization, `AuthenticationError` or</span>
<span class="sd">        similar should be raised.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AuthenticationError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">authorization</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ca&#39;</span><span class="p">:</span>
            <span class="c1"># user = authorization[&#39;data&#39;].user</span>
            <span class="c1"># if user != &#39;klauer&#39;:</span>
            <span class="c1">#     raise AuthenticationError(f&#39;No, {user}.&#39;)</span>
            <span class="o">...</span>
        <span class="k">elif</span> <span class="n">authorization</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">}:</span>
            <span class="o">...</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span></div>

<div class="viewcode-block" id="GroupDataWrapper.read"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.GroupDataWrapper.read">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A read request.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="p">()</span> <span class="k">as</span> <span class="n">overlay</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_read</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span></div>

<div class="viewcode-block" id="GroupDataWrapper.write"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.GroupDataWrapper.write">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">pva</span><span class="o">.</span><span class="n">DataWithBitSet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A write request.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="p">(</span><span class="n">changes</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="n">overlay</span><span class="p">:</span>
            <span class="n">write_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_update_class</span><span class="p">(</span>
                <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="n">overlay</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="n">update</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_write</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">write_update</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupDataWrapper.call"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.GroupDataWrapper.call">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">pva</span><span class="o">.</span><span class="n">PVRequest</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pva</span><span class="o">.</span><span class="n">FieldDescAndData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An rpc-call request.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="p">()</span> <span class="k">as</span> <span class="n">overlay</span><span class="p">:</span>
            <span class="c1"># TODO: update state or not?</span>
            <span class="c1"># is_nturi = type(data).__name__.startswith(&#39;epics:nt/NTURI:&#39;)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_call</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div></div>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">PvapropertyHooks</span><span class="p">:</span>
    <span class="n">get</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">callable</span><span class="p">]</span>
    <span class="n">put</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">callable</span><span class="p">]</span>
    <span class="n">startup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">callable</span><span class="p">]</span>
    <span class="n">shutdown</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">callable</span><span class="p">]</span>
    <span class="n">call</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">callable</span><span class="p">]</span>


<div class="viewcode-block" id="pvaproperty"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.pvaproperty">[docs]</a><span class="k">class</span> <span class="nc">pvaproperty</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A property-like descriptor for specifying a PV in a `PVGroup`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    get : async callable, optional</span>
<span class="sd">        Called when PV is read through channel access</span>

<span class="sd">    put : async callable, optional</span>
<span class="sd">        Called when PV is written to through channel access</span>

<span class="sd">    startup : async callable, optional</span>
<span class="sd">        Called at start of server; a hook for initialization and background</span>
<span class="sd">        processing</span>

<span class="sd">    shutdown : async callable, optional</span>
<span class="sd">        Called at shutdown of server; a hook for cleanup</span>

<span class="sd">    value : pva dataclass or instance</span>
<span class="sd">        The initial value - either an instantiated pva dataclass.</span>

<span class="sd">    name : str, optional</span>
<span class="sd">        The PV name (defaults to the attribute name of the pvaproperty)</span>

<span class="sd">    alarm_group : str, optional</span>
<span class="sd">        The alarm group the PV should be attached to</span>

<span class="sd">    read_only : bool, optional</span>
<span class="sd">        Read-only PV over channel access</span>

<span class="sd">    doc : str, optional</span>
<span class="sd">        Docstring associated with the property</span>

<span class="sd">    **cls_kwargs :</span>
<span class="sd">        Keyword arguments for the dataclass.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    attr : str</span>
<span class="sd">        The attribute name of the pvaproperty.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">get</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">put</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shutdown</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">call</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alarm_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">cls_kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># to be set later</span>

        <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">get</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get</span> <span class="o">=</span> <span class="n">get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_put</span> <span class="o">=</span> <span class="n">put</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startup</span> <span class="o">=</span> <span class="n">startup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span> <span class="o">=</span> <span class="n">shutdown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call</span> <span class="o">=</span> <span class="n">call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alarm_group</span> <span class="o">=</span> <span class="n">alarm_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span> <span class="o">=</span> <span class="n">read_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_kwargs</span> <span class="o">=</span> <span class="n">cls_kwargs</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Descriptor method: get the pvaproperty instance from a group.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># `class.pvaproperty`</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">attr_pvdb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Descriptor method: set the pvaproperty instance in a group.&quot;&quot;&quot;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">attr_pvdb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Descriptor method: delete the pvaproperty instance from a group.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="n">instance</span><span class="o">.</span><span class="n">attr_pvdb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Descriptor method: auto-called to set the attribute name.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The pvname suffix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">read_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the pvaproperty read-only?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cls_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Keyword arguments to use on creation of the value instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls_kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The default value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

<div class="viewcode-block" id="pvaproperty.getter"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.pvaproperty.getter">[docs]</a>    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Usually used as a decorator, this sets the ``getter`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get</span> <span class="o">=</span> <span class="n">verify_getter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="n">get</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="pvaproperty.putter"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.pvaproperty.putter">[docs]</a>    <span class="k">def</span> <span class="nf">putter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">put</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Usually used as a decorator, this sets the ``putter`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_put</span> <span class="o">=</span> <span class="n">verify_putter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">put</span><span class="o">=</span><span class="n">put</span><span class="p">,</span>
                                  <span class="n">read_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="pvaproperty.startup"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.pvaproperty.startup">[docs]</a>    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startup</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Usually used as a decorator, this sets ``startup`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startup</span> <span class="o">=</span> <span class="n">verify_startup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">startup</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="pvaproperty.shutdown"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.pvaproperty.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shutdown</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Usually used as a decorator, this sets ``shutdown`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span> <span class="o">=</span> <span class="n">verify_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">shutdown</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="pvaproperty.call"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.pvaproperty.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Usually used as a decorator, this sets the RPC ``call`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call</span> <span class="o">=</span> <span class="n">verify_rpc_call</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">call</span><span class="o">=</span><span class="n">call</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All user-defined hooks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PvapropertyHooks</span><span class="p">(</span>
            <span class="n">get</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">,</span>
            <span class="n">put</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_put</span><span class="p">,</span>
            <span class="n">startup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_startup</span><span class="p">,</span>
            <span class="n">shutdown</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span><span class="p">,</span>
            <span class="n">call</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">put</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shutdown</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Handles use case: pvaproperty(**info)(getter, putter, startup).</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;TODO&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PVAGroupMeta"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.PVAGroupMeta">[docs]</a><span class="k">class</span> <span class="nc">PVAGroupMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="s1">&#39;Metaclass that finds all pvaproperties&#39;</span>
<div class="viewcode-block" id="PVAGroupMeta.find_pvaproperties"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.PVAGroupMeta.find_pvaproperties">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_pvaproperties</span><span class="p">(</span><span class="n">dct</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pvaproperty</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;_pvs_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

        <span class="c1"># Propagate any PVs from base classes</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_pvs_&#39;</span><span class="p">):</span>
                <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;_pvs_&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">base</span><span class="o">.</span><span class="n">_pvs_</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">metacls</span><span class="o">.</span><span class="n">find_pvaproperties</span><span class="p">(</span><span class="n">dct</span><span class="p">):</span>
            <span class="n">module_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;class </span><span class="si">%s</span><span class="s1"> pvaproperty attr </span><span class="si">%s</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">prop</span>
            <span class="p">)</span>
            <span class="n">pvs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

        <span class="c1"># Ensure group_read/group_write are valid before proceeding:</span>
        <span class="n">verify_getter</span><span class="p">(</span><span class="s1">&#39;group_read&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">group_read</span><span class="p">)</span>
        <span class="n">verify_putter</span><span class="p">(</span><span class="s1">&#39;group_write&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">group_write</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span></div>


<div class="viewcode-block" id="PVAGroup"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.PVAGroup">[docs]</a><span class="k">class</span> <span class="nc">PVAGroup</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">PVAGroupMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class which groups a set of PVs for a high-level caproto server</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prefix : str</span>
<span class="sd">        Prefix for all PVs in the group.</span>

<span class="sd">    macros : dict, optional</span>
<span class="sd">        Dictionary of macro name to value.</span>

<span class="sd">    parent : PVGroup, optional</span>
<span class="sd">        Parent PVGroup.</span>

<span class="sd">    name : str, optional</span>
<span class="sd">        Name for the group, defaults to the class name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_wrapper_class_</span> <span class="o">=</span> <span class="n">GroupDataWrapper</span>

    <span class="n">type_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">:</span> <span class="n">NTScalarInt64</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">:</span> <span class="n">NTScalarFloat64</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">:</span> <span class="n">NTScalarString</span><span class="p">,</span>
        <span class="nb">bool</span><span class="p">:</span> <span class="n">NTScalarBoolean</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">array_type_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">:</span> <span class="n">NTScalarArrayInt64</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">:</span> <span class="n">NTScalarArrayFloat64</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">:</span> <span class="n">NTScalarArrayString</span><span class="p">,</span>
        <span class="nb">bool</span><span class="p">:</span> <span class="n">NTScalarArrayBoolean</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span> <span class="o">=</span> <span class="n">macros</span> <span class="k">if</span> <span class="n">macros</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>  <span class="c1"># expand_macros(prefix, self.macros)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvdb</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_pvdb</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_pvname</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create logger name from parent or from module class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                     <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span>
                     <span class="k">else</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">log_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">name</span>
            <span class="n">parent_log_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="k">if</span> <span class="n">log_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">parent_log_prefix</span><span class="p">):</span>
                <span class="n">log_name</span> <span class="o">=</span> <span class="n">log_name</span><span class="p">[</span><span class="n">parent_log_prefix</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>

        <span class="c1"># Instantiate the logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">log_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_pvdb</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_instantiate_value_from_pvaproperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pva</span><span class="o">.</span><span class="n">is_pva_dataclass_instance</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pva</span><span class="o">.</span><span class="n">is_pva_dataclass</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="c1"># TODO: not sure i like this: may be removed</span>
            <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="o">**</span><span class="n">prop</span><span class="o">.</span><span class="n">cls_kwargs</span><span class="p">)</span>

        <span class="c1"># Also preliminary array/scalar checks:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_type_map</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="o">**</span><span class="n">prop</span><span class="o">.</span><span class="n">cls_kwargs</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_map</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">prop</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">prop</span><span class="o">.</span><span class="n">cls_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prop</span><span class="p">:</span> <span class="n">pvaproperty</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_value_from_pvaproperty</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
        <span class="n">pvname</span> <span class="o">=</span> <span class="n">expand_macros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">)</span>
        <span class="n">wrapped_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_class_</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">pvname</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">)</span>

        <span class="n">previous_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous_definition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatabaseDefinitionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s1"> defined multiple times: now in attr: </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1"> &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;originally: </span><span class="si">{</span><span class="n">previous_definition</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="c1"># full pvname -&gt; wrapped data instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvdb</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapped_data</span>

        <span class="c1"># attribute -&gt; PV instance mapping for quick access by pvaproperty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_pvdb</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapped_data</span>

        <span class="c1"># and a convenient map of attr -&gt; pvname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_pvname</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvname</span>
        <span class="k">return</span> <span class="n">wrapped_data</span>

    <span class="k">def</span> <span class="nf">_create_pvdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;Create the PV database for all pvaproperties&#39;</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvs_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_pv</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>

<div class="viewcode-block" id="PVAGroup.group_read"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.PVAGroup.group_read">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">group_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="s1">&#39;Generic read called for channels without `get` defined&#39;</span></div>

<div class="viewcode-block" id="PVAGroup.group_write"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.PVAGroup.group_write">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">group_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">update</span><span class="p">:</span> <span class="n">WriteUpdate</span><span class="p">):</span>
        <span class="s1">&#39;Generic write called for channels without `put` defined&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;group_write: </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ServerRPC"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.ServerRPC">[docs]</a><span class="k">class</span> <span class="nc">ServerRPC</span><span class="p">(</span><span class="n">PVAGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper group for supporting ``pvlist`` and other introspection tools.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ServerRPC.HelpInfo"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.ServerRPC.HelpInfo">[docs]</a>    <span class="nd">@pva_dataclass</span>
    <span class="k">class</span> <span class="nc">HelpInfo</span><span class="p">:</span>
        <span class="c1"># TODO: technically epics:nt/NTScalar</span>
        <span class="n">value</span><span class="p">:</span> <span class="nb">str</span></div>

<div class="viewcode-block" id="ServerRPC.ChannelListing"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.ServerRPC.ChannelListing">[docs]</a>    <span class="nd">@pva_dataclass</span>
    <span class="k">class</span> <span class="nc">ChannelListing</span><span class="p">:</span>
        <span class="c1"># TODO: technically epics:nt/NTScalarArray</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></div>

<div class="viewcode-block" id="ServerRPC.ServerInfo"><a class="viewcode-back" href="../../../../pva/api.html#caproto.pva.server.magic.ServerRPC.ServerInfo">[docs]</a>    <span class="nd">@pva_dataclass</span>
    <span class="k">class</span> <span class="nc">ServerInfo</span><span class="p">:</span>
        <span class="c1"># responseHandlers.cpp</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">implLang</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">process</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">startTime</span><span class="p">:</span> <span class="nb">str</span></div>

    <span class="c1"># This is the special</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">pvaproperty</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">ServerInfo</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">server_instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_instance</span> <span class="o">=</span> <span class="n">server_instance</span>

    <span class="nd">@server</span><span class="o">.</span><span class="n">call</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Some awf... nice normative type stuff comes through here (NTURI):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RPC call data is: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Scheme: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Query: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Path: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Echo back the query value, if available:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">op</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Malformed request (expected .query.op)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;help&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">HelpInfo</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;Me too&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;info&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ServerInfo</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;channels&#39;</span><span class="p">:</span>
            <span class="n">pvnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_instance</span><span class="o">.</span><span class="n">pvdb</span><span class="p">))</span>
            <span class="n">pvnames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ChannelListing</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">pvnames</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Daniel Allan

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>