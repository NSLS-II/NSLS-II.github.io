

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Logging &mdash; caproto 0.5.2+5.g3822942.dirty documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Writing Your Own Channel Access Client" href="basics.html" />
    <link rel="prev" title="Shark (pcap/tcpdump parsing)" href="shark.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> caproto
          

          
          </a>

          
            
            
              <div class="version">
                0.5.2+5.g3822942.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install Caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">EPICS Clients and Servers</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="clients.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="records.html">Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="servers.html">Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="shark.html">Shark (pcap/tcpdump parsing)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Logging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#command-line-tools">Command-line tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-examples">Basic Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#log-warnings">Log warnings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maximum-verbosity">Maximum verbosity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#log-to-a-file">Log to a file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-by-pv-address-or-role">Filter by PV, Address, or Role</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#caproto-s-logging-related-api">Caproto’s Logging-Related API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Loggers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extra-context-in-logrecords">Extra Context in LogRecords</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filters">Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#formatter">Formatter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#global-handler">Global Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-example">Advanced Example</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Channel Access Sans I/O</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Writing Your Own Channel Access Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Core API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto/bench/#/">Performance Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="protocol-compliance.html">Details of our Protocol Compliance for CA Nerds</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-notes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">Caproto-in-a-box</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">caproto</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Logging</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/loggers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="logging">
<span id="loggers"></span><h1>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h1>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 0.4.0: </span>Caproto’s use of Python logging framework has been completely reworked to
follow Python’s documented best practices for libraries.</p>
</div>
<p>Caproto uses Python’s logging framework, which enables sophisticated log
management. Users who are familiar with that framework or who need to route
logs to multiple destinations may wish to skip ahead to <a class="reference internal" href="#logger-api"><span class="std std-ref">Caproto’s Logging-Related API</span></a>. But
for common simple cases, including viewing logs in the terminal or writing them
to a file, the next section illustrates streamlined, copy/paste-able examples.</p>
<div class="section" id="command-line-tools">
<h2>Command-line tools<a class="headerlink" href="#command-line-tools" title="Permalink to this headline">¶</a></h2>
<p>Caproto’s commandline tools, including both the clients (e.g.  <code class="docutils literal notranslate"><span class="pre">caproto-get</span></code>)
and the server modules (<code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">-m</span> <span class="pre">caproto.ioc_examples.*</span></code>), accept <code class="docutils literal notranslate"><span class="pre">-v</span></code>
and <code class="docutils literal notranslate"><span class="pre">-vvv</span></code> to control log verbosity.</p>
</div>
<div class="section" id="basic-examples">
<h2>Basic Examples<a class="headerlink" href="#basic-examples" title="Permalink to this headline">¶</a></h2>
<p>In scripts or interactive sessions, the convenience function
<a class="reference internal" href="#caproto.config_caproto_logging" title="caproto.config_caproto_logging"><code class="xref py py-func docutils literal notranslate"><span class="pre">config_caproto_logging()</span></code></a> can address common use cases succinctly. An
equivalent configuration can be achieved using the standard Python logging
interface.</p>
<div class="section" id="log-warnings">
<h3>Log warnings<a class="headerlink" href="#log-warnings" title="Permalink to this headline">¶</a></h3>
<p>This is the recommended standard setup for interactive use.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">caproto</span> <span class="kn">import</span> <span class="n">config_caproto_logging</span>
<span class="n">config_caproto_logging</span><span class="p">()</span>
</pre></div>
</div>
<p>It will display log records of <code class="docutils literal notranslate"><span class="pre">WARNING</span></code> level or higher in the terminal
(standard out) with a formatting tailored to caproto.</p>
</div>
<div class="section" id="maximum-verbosity">
<h3>Maximum verbosity<a class="headerlink" href="#maximum-verbosity" title="Permalink to this headline">¶</a></h3>
<p>This will display all Channel Access commands sent or received, comprising a
complete account of the Channel Access traffic handled by caproto.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">caproto</span> <span class="kn">import</span> <span class="n">config_caproto_logging</span>
<span class="n">config_caproto_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We strongly recommend setting levels on <em>handlers</em> not on <em>loggers</em>.
In previous versions of caproto, we recommended adjusting the level on the
<em>logger</em>, as in <code class="docutils literal notranslate"><span class="pre">some_pv.log.setLevel('DEBUG')</span></code>. We now recommended
that you <em>avoid</em> setting levels on loggers because it would affect all
handlers downstream, potentially inhibiting some other part of the program
from collecting the records it wants to collect.</p>
</div>
</div>
<div class="section" id="log-to-a-file">
<h3>Log to a file<a class="headerlink" href="#log-to-a-file" title="Permalink to this headline">¶</a></h3>
<p>This will direct all log messages to a file instead of the terminal (standard
out).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">caproto</span> <span class="kn">import</span> <span class="n">config_caproto_logging</span>
<span class="n">config_caproto_logging</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s1">&#39;/tmp/caproto.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="filter-by-pv-address-or-role">
<h3>Filter by PV, Address, or Role<a class="headerlink" href="#filter-by-pv-address-or-role" title="Permalink to this headline">¶</a></h3>
<p>To debug a particular issue, it is often convenient to focus on log records
related to a specific PV, address, or role (CLIENT or SERVER). To add filters,
you will need a reference to a handler. Typically, you will want to set the
handler to <code class="docutils literal notranslate"><span class="pre">'DEBUG'</span></code> or <code class="docutils literal notranslate"><span class="pre">'INFO'</span></code>. Capture its return value in a variable.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">handler</span> <span class="o">=</span> <span class="n">config_caproto_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can later access the current caproto global handler at any point by using
<a class="reference internal" href="#caproto.get_handler" title="caproto.get_handler"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_handler()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">caproto</span> <span class="kn">import</span> <span class="n">get_handler</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">get_handler</span><span class="p">()</span>
</pre></div>
</div>
<p>Several easy-to-use filters allow users to very specifically customize logging,
based on one or more of the following:</p>
<ol class="arabic">
<li><p>Show only records related to specific PVs—or partial PVs with a <code class="docutils literal notranslate"><span class="pre">*</span></code>
wildcard.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">caproto</span> <span class="kn">import</span> <span class="n">PVFilter</span>

<span class="n">handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">PVFilter</span><span class="p">(</span><span class="s1">&#39;random_walk:*&#39;</span><span class="p">,</span> <span class="s1">&#39;simple:B&#39;</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>Show only records related to specific hosts or addresses.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">caproto</span> <span class="kn">import</span> <span class="n">AddressFilter</span>

<span class="c1"># Multiple ways to specify:</span>
<span class="n">handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">AddressFilter</span><span class="p">(</span><span class="s1">&#39;10.2.227.105&#39;</span><span class="p">))</span>  <span class="c1"># host (all ports)</span>
<span class="n">handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">AddressFilter</span><span class="p">(</span><span class="s1">&#39;10.2.227.105:59384&#39;</span><span class="p">))</span>  <span class="c1"># host:port</span>
<span class="n">handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">AddressFilter</span><span class="p">((</span><span class="s1">&#39;10.2.227.105&#39;</span><span class="p">,</span> <span class="mi">59384</span><span class="p">))</span>  <span class="c1"># equivalent</span>
</pre></div>
</div>
</li>
<li><p>In special situations (usually testing) one process may be acting as client
and server, and it may be useful to filter by role (<code class="docutils literal notranslate"><span class="pre">'CLIENT'</span></code> or
<code class="docutils literal notranslate"><span class="pre">'SERVER'</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">caproto</span> <span class="kn">import</span> <span class="n">RoleFilter</span>

<span class="n">handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">RoleFilter</span><span class="p">(</span><span class="s1">&#39;CLIENT&#39;</span><span class="p">))</span>
</pre></div>
</div>
</li>
</ol>
<p>Note that if multiple filters are added to the same handler, they are composed
using “logical AND” by Python’s logging framework. See the section on
<a class="reference internal" href="#logging-filters"><span class="std std-ref">Filters</span></a> below for more information or composing filters or
writing complex filters.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In the examples above we add filters to handlers, as in
<code class="docutils literal notranslate"><span class="pre">handler.addFilter(...)</span></code>. The Python logging framework also allows filters
to be added to <em>loggers</em>, as in <code class="docutils literal notranslate"><span class="pre">some_pv.log.addFilter(...)</span></code>. But we
recommend that you <em>avoid</em> adding filters to loggers because it would affect
all handlers downstream, potentially inhibiting some other part of the
program from collecting the records it wants to collect.</p>
</div>
</div>
</div>
<div class="section" id="caproto-s-logging-related-api">
<span id="logger-api"></span><h2>Caproto’s Logging-Related API<a class="headerlink" href="#caproto-s-logging-related-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Loggers<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Here is the complete list of loggers used by caproto.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'caproto'</span></code> — the logger to which all caproto records propagate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'caproto.ch'</span></code> — INFO-logs changes to channel connection state on all
channels; DEBUG-logs read/write requests and read/write/event responses for
the threading client (other async clients TODO)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'caproto.circ'</span></code> — DEBUG-logs commands sent and received over TCP</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'caproto.bcast'</span></code> — logs command sent and received over UDP</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'caproto.bcast.search'</span></code> — logs search-related commands</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'caproto.ctx'</span></code> – logs updates from Contexts, such (on the client side)
how many search requests are still awaiting replies and (on the server side)
the number of connected clients and performance metrics when under load</p></li>
</ul>
<p>Certain objects in the caproto API, including Context, VirtualCircuits,
Broadcasters, and PVs, have a <code class="docutils literal notranslate"><span class="pre">log</span></code> attribute, referencing a
<a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.Logger" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">logging.Logger</span></code></a> or a <a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.LoggerAdapter" title="(in Python v3.8)"><code class="xref py py-class docutils literal notranslate"><span class="pre">logging.LoggerAdapter</span></code></a> that
encapsulates one of the loggers above with some context-specific information,
enumerated below.</p>
</div>
<div class="section" id="extra-context-in-logrecords">
<h3>Extra Context in LogRecords<a class="headerlink" href="#extra-context-in-logrecords" title="Permalink to this headline">¶</a></h3>
<p>The records issued by caproto’s loggers may have some or all of the following
attributes, as applicable:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pv</span></code> — PV name</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">our_address</span></code> — local interface, given as <code class="docutils literal notranslate"><span class="pre">(host,</span> <span class="pre">port)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">their_address</span></code> — address of peer, given as <code class="docutils literal notranslate"><span class="pre">(host,</span> <span class="pre">port)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">direction</span></code> — indicating whether the message is being sent or received</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">role</span></code> — <code class="docutils literal notranslate"><span class="pre">'CLIENT'</span></code> or <code class="docutils literal notranslate"><span class="pre">'SERVER'</span></code></p></li>
</ul>
</div>
<div class="section" id="filters">
<span id="logging-filters"></span><h3>Filters<a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h3>
<p>Python’s logging framework supports using simple functions as filters, as in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_filter</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s1">&#39;pv&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">pv</span> <span class="o">==</span> <span class="s1">&#39;simple:A&#39;</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="n">handler</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">my_filter</span><span class="p">)</span>
</pre></div>
</div>
<p>An <em>ad hoc</em> function such as the above is the best approach for complex
filtering. But for simple filtering by PV, address, or role, caproto provides
built-in filters. Note the functionality of the <code class="docutils literal notranslate"><span class="pre">level</span></code> and <code class="docutils literal notranslate"><span class="pre">exclusive</span></code>
arguments, explained below, which aim to support composition of multiple
filters.:</p>
<dl class="py class">
<dt id="caproto.PVFilter">
<em class="property">class </em><code class="sig-prename descclassname">caproto.</code><code class="sig-name descname">PVFilter</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">names</span></em>, <em class="sig-param"><span class="n">level</span><span class="o">=</span><span class="default_value">'WARNING'</span></em>, <em class="sig-param"><span class="n">exclusive</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/caproto/_log.html#PVFilter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caproto.PVFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>Block any message that is lower than certain level except it related to target
pvs. You have option to choose whether env, config and misc message is exclusive
or not.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>names</strong><span class="classifier">string or list of string</span></dt><dd><p>PVs list which will be filtered in.</p>
</dd>
<dt><strong>level</strong><span class="classifier">str or int</span></dt><dd><p>Represents the “barrier height” of this filter: any records with a
levelno greater than or equal to this will always pass through. Default
is ‘WARNING’. Python log level names or their corresponding integers
are accepted.</p>
</dd>
<dt><strong>exclusive</strong><span class="classifier">bool</span></dt><dd><p>If True, records for which this filter is “not applicable” (i.e. the
relevant extra context is not present) will be blocked. False by
default.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>passes</strong><span class="classifier">bool</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="caproto.AddressFilter">
<em class="property">class </em><code class="sig-prename descclassname">caproto.</code><code class="sig-name descname">AddressFilter</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">addresses_list</span></em>, <em class="sig-param"><span class="n">level</span><span class="o">=</span><span class="default_value">'WARNING'</span></em>, <em class="sig-param"><span class="n">exclusive</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/caproto/_log.html#AddressFilter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caproto.AddressFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>Block any message that is lower than certain level except it related to target
addresses. You have option to choose whether env, config and misc message is
exclusive or not.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>addresses_list</strong><span class="classifier">list of address. address is a tuple of (host_str, port_val)</span></dt><dd><p>Addresses list which will be filtered in.</p>
</dd>
<dt><strong>level</strong><span class="classifier">str or int</span></dt><dd><p>Represents the “barrier height” of this filter: any records with a
levelno greater than or equal to this will always pass through. Default
is ‘WARNING’. Python log level names or their corresponding integers
are accepted.</p>
</dd>
<dt><strong>exclusive</strong><span class="classifier">bool</span></dt><dd><p>If True, records for which this filter is “not applicable” (i.e. the
relevant extra context is not present) will be blocked. False by
default.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>passes</strong><span class="classifier">bool</span></dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="caproto.RoleFilter">
<em class="property">class </em><code class="sig-prename descclassname">caproto.</code><code class="sig-name descname">RoleFilter</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">role</span></em>, <em class="sig-param"><span class="n">level</span><span class="o">=</span><span class="default_value">'WARNING'</span></em>, <em class="sig-param"><span class="n">exclusive</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/caproto/_log.html#RoleFilter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caproto.RoleFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>Block any message that is lower than certain level except it related to target
role. You have option to choose whether env, config and misc message is
exclusive or not</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>role</strong><span class="classifier">‘CLIENT’ or ‘SERVER’</span></dt><dd><p>Role of the local machine.</p>
</dd>
<dt><strong>level</strong><span class="classifier">str or int</span></dt><dd><p>Represents the “barrier height” of this filter: any records with a
levelno greater than or equal to this will always pass through. Default
is ‘WARNING’. Python log level names or their corresponding integers
are accepted.</p>
</dd>
<dt><strong>exclusive</strong><span class="classifier">bool</span></dt><dd><p>If True, records for which this filter is “not applicable” (i.e. the
relevant extra context is not present) will be blocked. False by
default.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>passes: bool</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="formatter">
<h3>Formatter<a class="headerlink" href="#formatter" title="Permalink to this headline">¶</a></h3>
<dl class="py class">
<dt id="caproto.LogFormatter">
<em class="property">class </em><code class="sig-prename descclassname">caproto.</code><code class="sig-name descname">LogFormatter</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fmt</span><span class="o">=</span><span class="default_value">'%(color)s[%(levelname)1.1s %(asctime)s %(module)12s:%(lineno)d]%(end_color)s %(message)s'</span></em>, <em class="sig-param"><span class="n">datefmt</span><span class="o">=</span><span class="default_value">'%y%m%d %H:%M:%S'</span></em>, <em class="sig-param"><span class="n">style</span><span class="o">=</span><span class="default_value">'%'</span></em>, <em class="sig-param"><span class="n">color</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">colors</span><span class="o">=</span><span class="default_value">{10: 4, 20: 2, 30: 3, 40: 1}</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/caproto/_log.html#LogFormatter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caproto.LogFormatter" title="Permalink to this definition">¶</a></dt>
<dd><p>Log formatter for caproto records.</p>
<p>Adapted from the log formatter used in Tornado.
Key features of this formatter are:</p>
<ul class="simple">
<li><p>Color support when logging to a terminal that supports it.</p></li>
<li><p>Timestamps on every log line.</p></li>
<li><p>Includes extra record attributes (pv, our_address, their_address,
direction, role) when present.</p></li>
</ul>
</dd></dl>

</div>
<div class="section" id="global-handler">
<h3>Global Handler<a class="headerlink" href="#global-handler" title="Permalink to this headline">¶</a></h3>
<p>Following Python’s recommendation, caproto does not install any handlers at
import time, but it provides a function to set up a basic useful configuration
in one line, similar to Python’s <a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.basicConfig" title="(in Python v3.8)"><code class="xref py py-func docutils literal notranslate"><span class="pre">logging.basicConfig()</span></code></a> but with some
additional options—and scoped to the <code class="docutils literal notranslate"><span class="pre">'caproto'</span></code> logger with caproto’s
<a class="reference internal" href="#caproto.LogFormatter" title="caproto.LogFormatter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LogFormatter</span></code></a>. It streamlines common use cases without interfering with
more sophisticated use cases.</p>
<dl class="py function">
<dt id="caproto.config_caproto_logging">
<code class="sig-prename descclassname">caproto.</code><code class="sig-name descname">config_caproto_logging</code><span class="sig-paren">(</span><em class="sig-param">file=&lt;_io.TextIOWrapper name='&lt;stdout&gt;' mode='w' encoding='UTF-8'&gt;</em>, <em class="sig-param">datefmt='%H:%M:%S'</em>, <em class="sig-param">color=True</em>, <em class="sig-param">level='WARNING'</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/caproto/_log.html#config_caproto_logging"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caproto.config_caproto_logging" title="Permalink to this definition">¶</a></dt>
<dd><p>Set a new handler on the <code class="docutils literal notranslate"><span class="pre">logging.getLogger('caproto')</span></code> logger.</p>
<p>If this is called more than once, the handler from the previous invocation
is removed (if still present) and replaced.</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>file</strong><span class="classifier">object with <code class="docutils literal notranslate"><span class="pre">write</span></code> method or filename string</span></dt><dd><p>Default is <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code>.</p>
</dd>
<dt><strong>datefmt</strong><span class="classifier">string</span></dt><dd><p>Date format. Default is <code class="docutils literal notranslate"><span class="pre">'%H:%M:%S'</span></code>.</p>
</dd>
<dt><strong>color</strong><span class="classifier">boolean</span></dt><dd><p>Use ANSI color codes. True by default.</p>
</dd>
<dt><strong>level</strong><span class="classifier">str or int</span></dt><dd><p>Python logging level, given as string or corresponding integer.
Default is ‘WARNING’.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><strong>handler</strong><span class="classifier">logging.Handler</span></dt><dd><p>The handler, which has already been added to the ‘caproto’ logger.</p>
</dd>
</dl>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>Log to a file.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">config_caproto_logging</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s1">&#39;/tmp/what_is_happening.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Include the date along with the time. (The log messages will always include
microseconds, which are configured separately, not as part of ‘datefmt’.)</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">config_caproto_logging</span><span class="p">(</span><span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Turn off ANSI color codes.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">config_caproto_logging</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Increase verbosity: show level INFO or higher.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">config_caproto_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt id="caproto.get_handler">
<code class="sig-prename descclassname">caproto.</code><code class="sig-name descname">get_handler</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/caproto/_log.html#get_handler"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caproto.get_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the handler configured by the most recent call to <a class="reference internal" href="#caproto.config_caproto_logging" title="caproto.config_caproto_logging"><code class="xref py py-func docutils literal notranslate"><span class="pre">config_caproto_logging()</span></code></a>.</p>
<p>If <a class="reference internal" href="#caproto.config_caproto_logging" title="caproto.config_caproto_logging"><code class="xref py py-func docutils literal notranslate"><span class="pre">config_caproto_logging()</span></code></a> has not yet been called, this returns <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd></dl>

</div>
</div>
<div class="section" id="advanced-example">
<h2>Advanced Example<a class="headerlink" href="#advanced-example" title="Permalink to this headline">¶</a></h2>
<p>The flow of log event information in loggers and handlers is illustrated in the
following diagram:</p>
<img alt="https://docs.python.org/3/_images/logging_flow.png" src="https://docs.python.org/3/_images/logging_flow.png" />
<p>For further reference, see the Python 3 logging howto:
<a class="reference external" href="https://docs.python.org/3/howto/logging.html#logging-flow">https://docs.python.org/3/howto/logging.html#logging-flow</a></p>
<p>As an illustrative example, we will set up two handlers using the Python
logging framework directly, ignoring caproto’s convenience function.</p>
<p>Suppose we set up a handler aimed at a file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;caproto.log&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And another aimed at <a class="reference external" href="https://www.elastic.co/products/logstash">Logstash</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logstash</span>  <span class="c1"># requires python-logstash package</span>
<span class="n">logstash_handler</span> <span class="o">=</span> <span class="n">logstash</span><span class="o">.</span><span class="n">TCPLogstashHandler</span><span class="p">(</span><span class="o">&lt;</span><span class="n">host</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">port</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>We can attach the handlers to the caproto logger, to which all log records
created by caproto propagate:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;caproto&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logstash_handler</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_filter</span><span class="p">)</span>
</pre></div>
</div>
<p>We can set the verbosity of each handler. Suppose want maximum verbosity in the
file but only medium verbosity in logstash.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logstash_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
<span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And suppose that we only want the file to receive records related to PV that
being with ‘xyz’. We can add a filter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">file_handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">PVFilter</span><span class="p">(</span><span class="s1">&#39;xyz*&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The filter does not interfere with the <code class="docutils literal notranslate"><span class="pre">logstash_handler</span></code> in any way.
Finally, ensure that “effective level” of <code class="docutils literal notranslate"><span class="pre">logger</span></code> is at least as verbose as
the most verbose handler—in this case, <code class="docutils literal notranslate"><span class="pre">'DEBUG'</span></code>. By default, at import,
its level is not set</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>

<span class="gp">In [2]: </span><span class="s1">&#39;NOTSET&#39;</span>
</pre></div>
</div>
<p>and so it inherits the level of Python’s default
“handler of last resort,” <a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.lastResort" title="(in Python v3.8)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">logging.lastResort</span></code></a>, which is <code class="docutils literal notranslate"><span class="pre">'WARNING'</span></code>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">())</span>

<span class="gp">In [4]: </span><span class="s1">&#39;WARNING&#39;</span>
</pre></div>
</div>
<p>In this case we should set it to <code class="docutils literal notranslate"><span class="pre">'DEBUG'</span></code>, to match the most verbose level
of the handler we have added.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This makes DEBUG-level records <em>available</em> to all handlers. Our logstash
handler, set to <code class="docutils literal notranslate"><span class="pre">'INFO'</span></code>, will filter out DEBUG-level records.</p>
<p>To globally disable the generation of any log records at or below a certain
verbosity, which may be helpful for optimising performance, Python provides
<a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.disable" title="(in Python v3.8)"><code class="xref py py-func docutils literal notranslate"><span class="pre">logging.disable()</span></code></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="basics.html" class="btn btn-neutral float-right" title="Writing Your Own Channel Access Client" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="shark.html" class="btn btn-neutral float-left" title="Shark (pcap/tcpdump parsing)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017, Daniel Allan

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>