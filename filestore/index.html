
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Introduction to File Store &mdash; NSLS-II Controls Docs 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bnl-styles.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="NSLS-II Controls Docs 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="NSLS-II Beamline Controls Architecture" href="../arch/arch.html" />
    <link rel="prev" title="Installation" href="../install.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          NSLS-II Controls Docs</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../ophyd/cli_api.html">Command line interface to Ophyd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ophyd/scan_api.html">Step Scan Interface to Ophyd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyolog/pyolog.html">Simple Python Interface to The Olog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../broker/basics.html">DataBroker Basics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">Introduction to File Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch/arch.html">NSLS-II Beamline Controls Architecture</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Introduction to File Store</a><ul>
<li><a class="reference internal" href="#what-is-file-store">What is File Store?</a></li>
<li><a class="reference internal" href="#example-1-retrieving-lines-from-a-csv-file">Example 1: Retrieving Lines from a CSV File</a><ul>
<li><a class="reference internal" href="#write-a-handler">Write a Handler</a></li>
<li><a class="reference internal" href="#make-a-record-of-the-data">Make a Record of the Data</a></li>
<li><a class="reference internal" href="#the-payoff-retrieving-data-is-dead-simple">The Payoff: Retrieving Data Is Dead Simple</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-2-retrieving-datasets-from-an-hdf5-file">Example 2: Retrieving Datasets from an HDF5 File</a><ul>
<li><a class="reference internal" href="#id1">Write a Handler</a></li>
<li><a class="reference internal" href="#id2">Make a Record of the Data</a></li>
<li><a class="reference internal" href="#retrieve-the-data">Retrieve the Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-3-retrieving-portions-of-datasets-from-an-hdf5-file">Example 3: Retrieving Portions of Datasets from an HDF5 File</a><ul>
<li><a class="reference internal" href="#id3">Write a Handler</a></li>
<li><a class="reference internal" href="#id4">Make a Record of the Data</a></li>
<li><a class="reference internal" href="#id5">Retrieve the Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-4-retrieving-the-moon-phase">Example 4: Retrieving the Moon Phase</a><ul>
<li><a class="reference internal" href="#id6">Write a Handler</a></li>
<li><a class="reference internal" href="#id7">Make a Record of the Data</a></li>
<li><a class="reference internal" href="#retrieve-data">Retrieve Data</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../install.html" title="Previous Chapter: Installation"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Installation</span>
    </a>
  </li>
  <li>
    <a href="../arch/arch.html" title="Next Chapter: NSLS-II Beamline Controls Architecture"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">NSLS-II Beamline... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/filestore/index.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="introduction-to-file-store">
<h1>Introduction to File Store<a class="headerlink" href="#introduction-to-file-store" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-file-store">
<h2>What is File Store?<a class="headerlink" href="#what-is-file-store" title="Permalink to this headline">¶</a></h2>
<p>File Store is an interface to stored data. Here&#8217;s how it works.</p>
<ol class="arabic simple">
<li>You (or your hardware) save data wherever you want, whenever you want, in
whatever format makes sense for your application.</li>
<li>At some point, you notify File Store about this data. You provide two pieces
of information.<ol class="arabic">
<li>How to access and open the file (or, generically, &#8220;resource&#8221;)</li>
<li>How to retrieve a given piece of data in that file</li>
</ol>
</li>
<li>File Store gives you a token, a unique identifier, which you can use to
retrieve each piece of data.</li>
</ol>
<p>This admittedly abstract way of doing things has some powerful advantages.</p>
<ul class="simple">
<li><em>Any</em> file format is supported, and retrieved data always comes back as a
simple numpy array.</li>
<li>It does not matter whether pieces of data are stored in one file or in many
separate files.</li>
<li>File Store does not get between the detector and the storage. It is
not in the business of storing data; you merely <em>tell it about the data</em>, and
you may do so before, during, or after the data is actually created or
stored.</li>
</ul>
<p>The following examples illustrate how this works in practice. For a detailed
discussion of the format of File Store storage, see
<a class="reference internal" href="../arch/filestore-format.html#filestore-format"><em>Format of File Store Entries</em></a>.</p>
</div>
<div class="section" id="example-1-retrieving-lines-from-a-csv-file">
<h2>Example 1: Retrieving Lines from a CSV File<a class="headerlink" href="#example-1-retrieving-lines-from-a-csv-file" title="Permalink to this headline">¶</a></h2>
<p>Suppose my detector just saved a data file called <tt class="docutils literal"><span class="pre">example.csv</span></tt>.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [1]: </span><span class="o">!</span>cat example.csv
<span class="go">letters</span>
<span class="go">a</span>
<span class="go">b</span>
<span class="go">c</span>
<span class="go">d</span>
<span class="go">e</span>
</pre></div>
</div>
<p>First, decide how fine-grained your access to the data should be. Would you
always want the whole file, or would like to be able to request data from
each line individually? Or each pair of lines? The &#8220;unit&#8221; of data is
completely flexible; it can be anything from a scalar to an N-dimensional
volume.</p>
<p>For this example, suppose we want to retrieve individual lines of data.</p>
<div class="section" id="write-a-handler">
<h3>Write a Handler<a class="headerlink" href="#write-a-handler" title="Permalink to this headline">¶</a></h3>
<p>A Handler is a class with two required methods,
an <tt class="docutils literal"><span class="pre">__init__</span></tt> that accesses a file and a <tt class="docutils literal"><span class="pre">__call__</span></tt> that returns nuggets of
data from that file. In our case, since we want to access individual lines of
the file, <tt class="docutils literal"><span class="pre">__call__</span></tt> will return a line&#8217;s worth of data.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [2]: </span><span class="k">class</span> <span class="nc">CSVLineHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ...: </span>     <span class="s">&quot;Read data stored as lines in a text file.&quot;</span>
<span class="gp">   ...: </span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="gp">   ...: </span>         <span class="s">&quot;Each instance of a Handler accesses a given file.&quot;</span>
<span class="gp">   ...: </span>         <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="gp">   ...: </span>         <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="gp">   ...: </span>     <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_no</span><span class="p">):</span>
<span class="gp">   ...: </span>         <span class="s">&quot;Get a piece of data.&quot;</span>
<span class="gp">   ...: </span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">line_no</span><span class="p">]</span>
<span class="gp">   ...: </span>
</pre></div>
</div>
</div>
<div class="section" id="make-a-record-of-the-data">
<h3>Make a Record of the Data<a class="headerlink" href="#make-a-record-of-the-data" title="Permalink to this headline">¶</a></h3>
<p>During data collection, we make a record of this file by calling
<tt class="docutils literal"><span class="pre">insert_resource</span></tt>. When you read &#8220;resource,&#8221; you can think &#8220;file&#8221;, but
other resources are also possible. Handlers can access URLs, URIs, or
even generate their results on the fly with no reference to external
information (e.g., synthetic testing data).</p>
<p>The arguments to <tt class="docutils literal"><span class="pre">insert_resource</span></tt> are a nickname for the handler,
which can be any string, and the arguments needed by
<tt class="docutils literal"><span class="pre">__init__</span></tt> above to locate and open the file.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [3]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">insert_resource</span><span class="p">,</span> <span class="n">insert_datum</span>

<span class="gp">In [4]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">insert_resource</span><span class="p">(</span><span class="s">&#39;csv&#39;</span><span class="p">,</span> <span class="s">&#39;example.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we create a record for each piece of data we&#8217;d like to retrieve. We
assign each one a unique ID, which we can use later to retrieve it.</p>
<p>The arguments here are the <tt class="docutils literal"><span class="pre">resource_id</span></tt> returned by <tt class="docutils literal"><span class="pre">insert_resource</span></tt>
above, the unique ID we&#8217;ll use to retrieve each piece of data, and finally the
arguments needed by <tt class="docutils literal"><span class="pre">__call__</span></tt> to read that that data from the file. In our
case, <tt class="docutils literal"><span class="pre">__call__</span></tt> needs just one argument, <tt class="docutils literal"><span class="pre">line_no</span></tt>.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [5]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id1&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="gh">Out[5]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [6]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id2&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="gh">Out[6]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [7]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id3&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="gh">Out[7]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [8]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id4&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
<span class="gh">Out[8]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [9]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id5&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="gh">Out[9]: </span><span class="go">&lt;Datum: Datum object&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="the-payoff-retrieving-data-is-dead-simple">
<h3>The Payoff: Retrieving Data Is Dead Simple<a class="headerlink" href="#the-payoff-retrieving-data-is-dead-simple" title="Permalink to this headline">¶</a></h3>
<p>When we called <tt class="docutils literal"><span class="pre">insert_resource</span></tt>, we recorded the nickname <tt class="docutils literal"><span class="pre">'csv'</span></tt>. To read
that data, we have to associate <tt class="docutils literal"><span class="pre">'csv'</span></tt> and our Handler, <tt class="docutils literal"><span class="pre">CSVLineHandler</span></tt>, like
so.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [10]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">register_handler</span>

<span class="gp">In [11]: </span><span class="n">register_handler</span><span class="p">(</span><span class="s">&#39;csv&#39;</span><span class="p">,</span> <span class="n">CSVLineHandler</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we are ready to retrieve that data. All we need is the unique ID.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [12]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">retrieve</span>

<span class="gp">In [13]: </span><span class="n">retrieve</span><span class="p">(</span><span class="s">&#39;some_id2&#39;</span><span class="p">)</span>
<span class="gh">Out[13]: </span><span class="go">&#39;b\n&#39;</span>
</pre></div>
</div>
<p>File Store now knows to use the <tt class="docutils literal"><span class="pre">CSVLineHandler</span></tt> class, it knows to instantiate it
with <tt class="docutils literal"><span class="pre">example.csv</span></tt>, and it knows to call it with the argument <tt class="docutils literal"><span class="pre">line_no=2</span></tt>.</p>
</div>
</div>
<div class="section" id="example-2-retrieving-datasets-from-an-hdf5-file">
<h2>Example 2: Retrieving Datasets from an HDF5 File<a class="headerlink" href="#example-2-retrieving-datasets-from-an-hdf5-file" title="Permalink to this headline">¶</a></h2>
<p>Suppose 5x5 images are stored as Datasets in an HDF5 file.
<tt class="docutils literal"><span class="pre">'A'</span></tt>, <tt class="docutils literal"><span class="pre">'B'</span></tt>, <tt class="docutils literal"><span class="pre">'C'</span></tt>.</p>
<div class="section" id="id1">
<h3>Write a Handler<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [14]: </span><span class="kn">import</span> <span class="nn">h5py</span>

<span class="gp">In [15]: </span><span class="k">class</span> <span class="nc">HDF5DatasetHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Make a Record of the Data<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [16]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">insert_resource</span><span class="p">,</span> <span class="n">insert_datum</span>

<span class="gp">In [17]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">insert_resource</span><span class="p">(</span><span class="s">&#39;hdf5-by-dataset&#39;</span><span class="p">,</span> <span class="s">&#39;example.h5&#39;</span><span class="p">)</span>

<span class="gp">In [18]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id10&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;A&#39;</span><span class="p">})</span>
<span class="gh">Out[18]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [19]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id11&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;B&#39;</span><span class="p">})</span>
<span class="gh">Out[19]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [20]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id12&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;C&#39;</span><span class="p">})</span>
<span class="gh">Out[20]: </span><span class="go">&lt;Datum: Datum object&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieve-the-data">
<h3>Retrieve the Data<a class="headerlink" href="#retrieve-the-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [21]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">register_handler</span><span class="p">,</span> <span class="n">retrieve</span>

<span class="gp">In [22]: </span><span class="n">register_handler</span><span class="p">(</span><span class="s">&#39;hdf5-by-dataset&#39;</span><span class="p">,</span> <span class="n">HDF5DatasetHandler</span><span class="p">)</span>

<span class="gp">In [23]: </span><span class="n">retrieve</span><span class="p">(</span><span class="s">&#39;some_id11&#39;</span><span class="p">)</span>
<span class="gh">Out[23]: </span><span class="go"></span>
<span class="go">array([[9, 5, 5, 5, 2],</span>
<span class="go">       [7, 6, 2, 0, 4],</span>
<span class="go">       [7, 4, 2, 8, 0],</span>
<span class="go">       [7, 8, 7, 0, 8],</span>
<span class="go">       [4, 5, 5, 3, 0]])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="example-3-retrieving-portions-of-datasets-from-an-hdf5-file">
<h2>Example 3: Retrieving Portions of Datasets from an HDF5 File<a class="headerlink" href="#example-3-retrieving-portions-of-datasets-from-an-hdf5-file" title="Permalink to this headline">¶</a></h2>
<p>Suppose several 5x5 images are stored as a single Nx5x5 Dataset in an HDF5
file. The Dataset is named <tt class="docutils literal"><span class="pre">'my-dataset-name</span></tt>.</p>
<div class="section" id="id3">
<h3>Write a Handler<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [24]: </span><span class="kn">import</span> <span class="nn">h5py</span>

<span class="gp">In [25]: </span><span class="k">class</span> <span class="nc">HDF5DatasetSliceHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_no</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">frame_no</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Make a Record of the Data<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Each 5x5 frame get a separate record.</p>
<p>Notice that, in this example, <tt class="docutils literal"><span class="pre">__init__</span></tt> requires more than just the
filename. Additional arguments, in this case <tt class="docutils literal"><span class="pre">dataset_name</span></tt>, are passed
in a dictionary.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [26]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">insert_resource</span><span class="p">,</span> <span class="n">insert_datum</span>

<span class="gp">In [27]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">insert_resource</span><span class="p">(</span><span class="s">&#39;hdf5-slice-single-dataset&#39;</span><span class="p">,</span> <span class="s">&#39;example.h5&#39;</span><span class="p">,</span>
<span class="gp">   ....: </span>                              <span class="nb">dict</span><span class="p">(</span><span class="n">dataset_name</span><span class="o">=</span><span class="s">&#39;my-dataset-name&#39;</span><span class="p">))</span>
<span class="gp">   ....: </span>

<span class="gp">In [28]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id20&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;frame_no&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="gh">Out[28]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [29]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id21&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;frame_no&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="gh">Out[29]: </span><span class="go">&lt;Datum: Datum object&gt;</span>

<span class="gp">In [30]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id22&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;frame_no&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="gh">Out[30]: </span><span class="go">&lt;Datum: Datum object&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>Retrieve the Data<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [31]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">register_handler</span><span class="p">,</span> <span class="n">retrieve</span>

<span class="gp">In [32]: </span><span class="n">register_handler</span><span class="p">(</span><span class="s">&#39;hdf5-slice-single-dataset&#39;</span><span class="p">,</span> <span class="n">HDF5DatasetSliceHandler</span><span class="p">)</span>

<span class="gp">In [33]: </span><span class="n">retrieve</span><span class="p">(</span><span class="s">&#39;some_id21&#39;</span><span class="p">)</span>
<span class="gh">Out[33]: </span><span class="go"></span>
<span class="go">array([[8, 8, 0],</span>
<span class="go">       [7, 4, 4],</span>
<span class="go">       [9, 4, 7],</span>
<span class="go">       [7, 4, 7],</span>
<span class="go">       [3, 7, 4]])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="example-4-retrieving-the-moon-phase">
<h2>Example 4: Retrieving the Moon Phase<a class="headerlink" href="#example-4-retrieving-the-moon-phase" title="Permalink to this headline">¶</a></h2>
<p>This example illustrates the general power of File Store, beyond reading
simple files. Any &#8220;resource,&#8221; include a web-based data source, can be
accessed with a Handler.</p>
<div class="section" id="id6">
<h3>Write a Handler<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>When we retrieve data from this handler, it builds a URL that requests the
weather forcast (or historical record) from the web service forecast.io.
From this data it extracts the phase of the moon at a given time.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [34]: </span><span class="kn">import</span> <span class="nn">requests</span>

<span class="gp">In [35]: </span><span class="kn">import</span> <span class="nn">json</span>

<span class="gp">In [36]: </span><span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://api.forecast.io/forecast/{api_key}/{lat},{long},{time}&quot;</span>

<span class="gp">In [37]: </span><span class="n">api_key</span> <span class="o">=</span> <span class="s">&quot;1378698e5711b504f22b32eb1a40d23a&quot;</span>

<span class="gp">In [38]: </span><span class="k">class</span> <span class="nc">MoonPhaseHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="s">&quot;This handler does not require a filename.&quot;</span>
<span class="gp">   ....: </span>        <span class="k">pass</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="n">text</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="gp">   ....: </span>                                       <span class="n">time</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">)))</span><span class="o">.</span><span class="n">text</span>
<span class="gp">   ....: </span>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;daily&#39;</span><span class="p">][</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;moonPhase&#39;</span><span class="p">]</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>Make a Record of the Data<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Notably, in this case, we are making a record of data that we haven&#8217;t seen yet.
The data itself will only be obtained for the first time when it retrieved.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [39]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">insert_resource</span><span class="p">,</span> <span class="n">insert_datum</span>

<span class="gp">In [40]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">insert_resource</span><span class="p">(</span><span class="s">&#39;moon&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Let&#8217;s register a piece of data giving today&#8217;s moon phase.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [41]: </span><span class="kn">import</span> <span class="nn">time</span>

<span class="gp">In [42]: </span><span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="gp">In [43]: </span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&#39;some_id31&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
<span class="gh">Out[43]: </span><span class="go">&lt;Datum: Datum object&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieve-data">
<h3>Retrieve Data<a class="headerlink" href="#retrieve-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [44]: </span><span class="kn">from</span> <span class="nn">filestore.api</span> <span class="kn">import</span> <span class="n">register_handler</span><span class="p">,</span> <span class="n">retrieve</span>

<span class="gp">In [45]: </span><span class="n">register_handler</span><span class="p">(</span><span class="s">&#39;moon&#39;</span><span class="p">,</span> <span class="n">MoonPhaseHandler</span><span class="p">)</span>

<span class="gp">In [46]: </span><span class="n">retrieve</span><span class="p">(</span><span class="s">&#39;some_id31&#39;</span><span class="p">)</span>
<span class="gh">Out[46]: </span><span class="go">0.71</span>
</pre></div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, Stuart B. Wilkins.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>