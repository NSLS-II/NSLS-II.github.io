


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Releases and Deployment &mdash; NSLS-II Software Documentation  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/gallery.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="NSLS-II Software Documentation  documentation" href="index.html"/>
        <link rel="up" title="Internal Notes" href="internal_index.html"/>
        <link rel="next" title="Design Requirements" href="requirements.html"/>
        <link rel="prev" title="Installation" href="install.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> NSLS-II Software Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture-overview.html">Event-Based Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="cookbook/index.html">Cookbook (Examples)</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="remote-access.html">Remote Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="sandbox.html">Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History of Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="conda.html">Software Deployment with Conda</a></li>
<li class="toctree-l1"><a class="reference internal" href="fresh-installation.html">Installation at a Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Recommended Resources</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="internal_index.html">Internal Notes</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="internal_index.html#out-of-date">Out of date</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Releases and Deployment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-release-version">Creating a Release Version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-an-untagged-commit">Building an Untagged Commit</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="requirements.html">Design Requirements</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/amostra">amostra</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/datamuxer">datamuxer</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/suitcase">suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://scikit-beam.github.io/scikit-beam">scikit-beam</a></li>
</ul>
<p class="caption"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/wishlist/issues">Wish List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NSLS-II Software Documentation</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="internal_index.html">Internal Notes</a> &raquo;</li>
        
      <li>Releases and Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/deployment-howto.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="releases-and-deployment">
<h1>Releases and Deployment<a class="headerlink" href="#releases-and-deployment" title="Permalink to this headline">¶</a></h1>
<div class="section" id="creating-a-release-version">
<h2>Creating a Release Version<a class="headerlink" href="#creating-a-release-version" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Decide what the new new version number will be</li>
<li>Write release notes / collapse whats_new and api_changes folders</li>
<li>Create a new commit, version bumping as needed. Commit
message should be truncated release notes.</li>
<li>Create annotated tag on release commit, text should be truncated release
notes.  Tag format is <cite>vX.Y.Z</cite></li>
<li>Create new commit version bumping back to dev version pattern as needed</li>
<li>Check to make sure everything looks right</li>
<li>Push to master branch</li>
<li>Push tag</li>
<li>Create new conda recipe in conda-prescriptions/releases, updating
as needed</li>
<li>Use build server or beamline computer to build conda package</li>
<li>Upload to proper internal binstar organization(s)</li>
<li>Rebuild (all) the docs</li>
</ol>
<div class="section" id="decide-on-version-number">
<h3>Decide on version number<a class="headerlink" href="#decide-on-version-number" title="Permalink to this headline">¶</a></h3>
<p>We are using <a class="reference external" href="http://semver.org/">semantic versioning</a> guidelines and <span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0440"><strong>PEP 440</strong></a>.  Each
tagged version number is of the form <code class="docutils literal"><span class="pre">vMajor.Minor.Patch</span></code>.  Roughly,
versions bumping the <code class="docutils literal"><span class="pre">Major</span></code> version can make backwards incompatible
API changes, versions bumping <code class="docutils literal"><span class="pre">Minor</span></code> can add backwards-compatible
new features and versions bumping <code class="docutils literal"><span class="pre">Patch</span></code> can make
backwards-compatible bug fixes.  Bumping a version component re-sets
everything to the right to 0.</p>
<p>PEP440 defines a way of adding qualifiers to a version string to
ensure proper sorting of development releases.  The rules are quite
general and specify how to sort multiply-stacked pre- and post-
releases.  We will only be using a very simple case and all of our
development releases should look like <code class="docutils literal"><span class="pre">vX.Y.Z.postN+gHEXVAL</span></code> which
say that this the <code class="docutils literal"><span class="pre">N</span></code> commit after release <code class="docutils literal"><span class="pre">vX.Y.Z</span></code> and with the
git SHA1 <code class="docutils literal"><span class="pre">HEXVAL</span></code>.  This should mostly be dealt with automatically
by the build tools.</p>
<p>In the future we may have the need to do release candidates.</p>
</div>
<div class="section" id="release-notes-api-changes">
<h3>Release notes/ API changes<a class="headerlink" href="#release-notes-api-changes" title="Permalink to this headline">¶</a></h3>
<p>The release notes should be a succinct document which
summarizes the accumulated changes since the last version.
It is particularly important to document <strong>all</strong> API changes.</p>
<p>Each repository should have a folder in the docs directory for new
features (<code class="file docutils literal"><span class="pre">whats_new</span></code>) and for API changes (<code class="file docutils literal"><span class="pre">api_changes</span></code>).
Collect all of the files into this folder into the top-level
<code class="file docutils literal"><span class="pre">*.rst</span></code>.</p>
<p>An abbreviated version of the release notes will go in the release
commit message and the tag annotation.</p>
</div>
<div class="section" id="version-bump-release-commit">
<h3>Version bump / Release commit<a class="headerlink" href="#version-bump-release-commit" title="Permalink to this headline">¶</a></h3>
<p>On the branch you plan to cut the release off do the version bumping
as needed.  Currently this requires changing</p>
<ul class="simple">
<li>version number in <code class="docutils literal"><span class="pre">setup.py</span></code></li>
<li><code class="docutils literal"><span class="pre">__version__</span></code> in <code class="docutils literal"><span class="pre">__init__.py</span></code></li>
</ul>
<p>This will be simplified if/when we adopt <code class="docutils literal"><span class="pre">versioneer</span></code>.</p>
<p>The commit message should look something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>REL : v0.1.0

This releases fixes a number of bugs in the Aardvark
and adds new features to whizbang class.

Bugs fixed:
  - Aardvarks can eat ants again
  - tunnels no longer list to the left

Features added:
  - Color of <span class="sb">``</span>whizbang<span class="sb">``</span> explosion is now tunable
</pre></div>
</div>
</div>
<div class="section" id="create-tag">
<h3>Create Tag<a class="headerlink" href="#create-tag" title="Permalink to this headline">¶</a></h3>
<p>Create an annotated tag on the release commit. The annotation should
match that of the commit you are tagging.</p>
</div>
<div class="section" id="version-bump-back-to-dev-versions">
<h3>Version bump back to dev versions<a class="headerlink" href="#version-bump-back-to-dev-versions" title="Permalink to this headline">¶</a></h3>
<p>Bump the version in <code class="file docutils literal"><span class="pre">setup.py</span></code> and <code class="file docutils literal"><span class="pre">__init__.py</span></code> to
<code class="docutils literal"><span class="pre">v.X.Y.Z.post0</span></code>.  This step can be eliminated if/when we adopt
<code class="docutils literal"><span class="pre">versioneer</span></code>.</p>
</div>
<div class="section" id="check-your-work">
<h3>Check your work<a class="headerlink" href="#check-your-work" title="Permalink to this headline">¶</a></h3>
<p>Take some time to consider what you have just done and make sure
everything looks right.  Run some local tests, install off the tagged
commit to make sure the versions are OK.  Run the tests locally.  Make
sure that the dev version of the conda package still builds.</p>
<p>Once a tag is made public it can not be taken back!</p>
</div>
<div class="section" id="push-everything">
<h3>Push everything<a class="headerlink" href="#push-everything" title="Permalink to this headline">¶</a></h3>
<p>Push the branch with your new commits and the tag up to the canonical
repository.</p>
</div>
<div class="section" id="create-conda-recipe-for-release">
<h3>Create conda recipe for release<a class="headerlink" href="#create-conda-recipe-for-release" title="Permalink to this headline">¶</a></h3>
<p>In <a class="reference external" href="https://github.com/NSLS-II/conda-prescriptions">conda-prescriptions</a> create a new recipe
in <code class="file docutils literal"><span class="pre">releases/project/vX.Y.Z</span></code>.  This is most easily done by
copying and updating the recipe from the previous version.  You will
need to update at least the <code class="docutils literal"><span class="pre">version</span></code> string and the <code class="docutils literal"><span class="pre">git_rev</span></code>.
In addition you may need to update the imports that are tested and the
dependencies if they have changed between versions.</p>
</div>
<div class="section" id="build-and-upload-new-binaries">
<h3>Build and upload new binaries<a class="headerlink" href="#build-and-upload-new-binaries" title="Permalink to this headline">¶</a></h3>
<p>Use either the <cite>binstar build server &lt;binstar_build&gt;</cite> or by using
<code class="docutils literal"><span class="pre">conda</span> <span class="pre">build</span></code> on one of the beamline computers to build the conda
package off of your newly created recipe.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> conda-prescriptions
conda build releases/project/vX.Y.Z
</pre></div>
</div>
<p>Before uploading this file to the internal binstar you should make
sure it installs locally.  Once you are satisfied that everything
is working correctly, upload it to the internal binstar</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>binstar upload <span class="sb">`</span>conda build releases/project/vX.Y.Z --output<span class="sb">`</span> -u USER
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">USER</span></code> is the user or organization you want to upload the
binary to.  To upload to more than one beamline either simply run
the above command more than once, or use <code class="docutils literal"><span class="pre">binstar</span></code> to move
the files between organizations</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>binstar copy --to-owner USER2 USER1/project/vX.Y.Z
</pre></div>
</div>
</div>
<div class="section" id="rebuild-all-of-the-documentation">
<h3>Rebuild all of the documentation<a class="headerlink" href="#rebuild-all-of-the-documentation" title="Permalink to this headline">¶</a></h3>
<p>Rebuild both the project specific documentation and the overall
NSLS-II documentation and push to the correct github.io locations.</p>
</div>
</div>
<div class="section" id="building-an-untagged-commit">
<h2>Building an Untagged Commit<a class="headerlink" href="#building-an-untagged-commit" title="Permalink to this headline">¶</a></h2>
<p>It is possible to build and upload a conda package from an untagged
commit.  The recipes in the project repositories are set up so that
the version reported to conda will be the last tag with
<cite>.postN+gHEXVAL</cite> appended to the end.  This will allow conda to
correctly sort versions so long as all of the builds are off of the same
branch.  However, these binaries should only be deployed to beamlines
in exceptional circumstances.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="requirements.html" class="btn btn-neutral float-right" title="Design Requirements" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>