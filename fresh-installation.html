


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Installation at a Beamline &mdash; NSLS-II Software Documentation  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Recommended Resources" href="resources.html" />
    <link rel="prev" title="Software Deployment with Conda" href="conda.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> NSLS-II Software Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture-overview.html">Event-Based Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="cookbook/index.html">Cookbook (Examples)</a></li>
<li class="toctree-l1"><a class="reference internal" href="remote-access.html">Remote Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="sandbox.html">Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History of Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="conda.html">Software Deployment with Conda</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation at a Beamline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#new-beamline">New Beamline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-services">Install Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-conda-environments">Create Conda Environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-scripts">Install Scripts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-new-ipython-profile">Create New IPython Profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-beamline-github-organization">Create a Beamline GitHub Organization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-the-olog">Configure the Olog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#essential-configuration">Essential Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integration-with-bluesky">Integration with Bluesky</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integration-with-ophyd">Integration with Ophyd</a></li>
<li class="toctree-l4"><a class="reference internal" href="#olog-ipython-magics">Olog IPython “Magics”</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#new-workstation-for-data-collection-or-analysis">New Workstation for Data Collection or Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#new-user">New User</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#one-time-configuration">One-time configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convenience-script-bsui">Convenience Script <code class="docutils literal notranslate"><span class="pre">bsui</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-user-environments">Custom User Environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-or-updating-shared-root-environments">Creating or Updating Shared (Root) Environments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installing-on-a-personal-computer">Installing on a Personal Computer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Recommended Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal_index.html">Internal Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="meetings/index.html">Meetings</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto">caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/suitcase">suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://scikit-beam.github.io/scikit-beam">scikit-beam</a></li>
</ul>
<p class="caption"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/wishlist/issues">Wish List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NSLS-II Software Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Installation at a Beamline</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/fresh-installation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="installation-at-a-beamline">
<span id="bl-installation"></span><h1>Installation at a Beamline<a class="headerlink" href="#installation-at-a-beamline" title="Permalink to this headline">¶</a></h1>
<div class="section" id="new-beamline">
<h2>New Beamline<a class="headerlink" href="#new-beamline" title="Permalink to this headline">¶</a></h2>
<div class="section" id="install-services">
<h3>Install Services<a class="headerlink" href="#install-services" title="Permalink to this headline">¶</a></h3>
<p>These are instructions are one-time setup for a new beamline. If you are
configuring a new machine at a beamline that already has the software installed
one at least one machine, skip to the next section.</p>
<ol class="arabic simple">
<li>On some dedicated server (the standard choice is <code class="docutils literal notranslate"><span class="pre">*-ca1</span></code>) apply the puppet
class that installs mongo 3.x some dedicated server and start the mongo
daemon.</li>
</ol>
</div>
<div class="section" id="create-conda-environments">
<h3>Create Conda Environments<a class="headerlink" href="#create-conda-environments" title="Permalink to this headline">¶</a></h3>
<p>A puppet class should install conda into <code class="docutils literal notranslate"><span class="pre">/opt/conda</span></code> on machines designated
<code class="docutils literal notranslate"><span class="pre">*-srv*</span></code> (“server”) or <code class="docutils literal notranslate"><span class="pre">*-ws*</span></code> (“workstation”) as soon as they are on the
NSLS-II network and have a puppet client configured and running. It should also be
noted that there are some special cases where other ‘classes’ of machine also receive
the installation (i.e. on some <code class="docutils literal notranslate"><span class="pre">-ca*</span></code> and <code class="docutils literal notranslate"><span class="pre">-gpu*</span></code> machines).  Puppet should also
create an empty directory, <code class="docutils literal notranslate"><span class="pre">/opt/conda_envs</span></code> for root-controlled conda environments.
The configuration in <code class="docutils literal notranslate"><span class="pre">/opt/conda/.condarc</span></code> designates this location as the second
place conda should look for environments, after <code class="docutils literal notranslate"><span class="pre">~/conda_envs</span></code>.</p>
<p>Environments for data collection and data anlysis should be installed into
<code class="docutils literal notranslate"><span class="pre">/opt/conda_envs</span></code>. In the second operating cycle of 2018, the commands to do
this were:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo conda create -p /opt/conda_envs/collection-2018-2.1 -c nsls2-tag -y collection
sudo conda create -p /opt/conda_envs/analysis-2018-2.1 -c nsls2-tag -y analysis
fix_conda_privileges.sh
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">collection-2018-2.1</span></code> and <code class="docutils literal notranslate"><span class="pre">analysis-2018-2.1</span></code> are the names of conda
metapackages and the names of the environments (under <code class="docutils literal notranslate"><span class="pre">/opt/conda_envs</span></code>)
where these metapackages are installed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The structure of the enviroment name version numbering is
<code class="docutils literal notranslate"><span class="pre">year-cycle.micro</span></code>. For example, in the second beam operating cycle of
2018, version <code class="docutils literal notranslate"><span class="pre">2018-2.0</span></code> was released, followed by <code class="docutils literal notranslate"><span class="pre">2018-2.1</span></code> with some
bug-fixes.</p>
</div>
</div>
<div class="section" id="install-scripts">
<h3>Install Scripts<a class="headerlink" href="#install-scripts" title="Permalink to this headline">¶</a></h3>
<p>Two convenience scripts, <code class="docutils literal notranslate"><span class="pre">fix_conda_privileges.sh</span></code> and <code class="docutils literal notranslate"><span class="pre">bsui</span></code> should be
installed in <code class="docutils literal notranslate"><span class="pre">/usr/local/bin</span></code>, also by puppet.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">fix_conda_privileges.sh</span></code> works around a bug in conda wherein users cannot
properly access root-installed conda packages. It should be run after
creating or updating and conda environments in <code class="docutils literal notranslate"><span class="pre">/opt/conda_envs</span></code>, as shown
above.</li>
<li><code class="docutils literal notranslate"><span class="pre">bsui</span></code> is a shortcut script that activates a conda environment and starts
IPython with the ‘collection’ profile.</li>
</ul>
</div>
<div class="section" id="create-new-ipython-profile">
<h3>Create New IPython Profile<a class="headerlink" href="#create-new-ipython-profile" title="Permalink to this headline">¶</a></h3>
<p>At NSLS-II we use IPython profiles to run startup scripts for user convenience.</p>
<p>Profiles are stored in (or soft-linked) from <code class="docutils literal notranslate"><span class="pre">~/.ipython</span></code> in the user profile
of individual users or shared beamline accounts.</p>
<p>The standard profile is called “collection,” and the startup scripts are
located in <code class="docutils literal notranslate"><span class="pre">~/.ipython/profile_collection/startup/</span></code>.</p>
<p>If this beamline does not yet have an IPython profile for data collection
under version control, create one. Start IPython with this command, and
then exit.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ipython --profile<span class="o">=</span>collection
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The official IPython documentation has more information on
<a class="reference external" href="https://ipython.org/ipython-doc/dev/config/intro.html#profiles">IPython profiles</a></p>
</div>
</div></blockquote>
<p>The above command created new directores and some files under
<code class="docutils literal notranslate"><span class="pre">~/.ipython/profile_collection</span></code>. We add startup files by writing Python
scripts in the subdirectory <code class="docutils literal notranslate"><span class="pre">startup/</span></code> in this profile directory.</p>
<p>This is a example IPython profile startup file. Replace <code class="docutils literal notranslate"><span class="pre">YOUR_HOST</span></code> with the
server where the mongo daemon is running.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make ophyd listen to pyepics.</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">setup_ophyd</span>
<span class="n">setup_ophyd</span><span class="p">()</span>

<span class="c1"># Connect to metadatastore and filestore.</span>
<span class="kn">from</span> <span class="nn">metadatastore.mds</span> <span class="kn">import</span> <span class="n">MDS</span><span class="p">,</span> <span class="n">MDSRO</span>
<span class="kn">from</span> <span class="nn">filestore.fs</span> <span class="kn">import</span> <span class="n">FileStoreRO</span>
<span class="kn">from</span> <span class="nn">databroker</span> <span class="kn">import</span> <span class="n">Broker</span>
<span class="n">mds_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR</span> <span class="n">HOST</span><span class="o">&gt;</span><span class="p">,</span>
              <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">27017</span><span class="p">,</span>
              <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;metadatastore-production-v1&#39;</span><span class="p">,</span>
              <span class="s1">&#39;timezone&#39;</span><span class="p">:</span> <span class="s1">&#39;US/Eastern&#39;</span><span class="p">}</span>
<span class="n">fs_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">YOUR</span> <span class="n">HOST</span><span class="o">&gt;</span><span class="p">,</span>
             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">27017</span><span class="p">,</span>
             <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;filestore-production-v1&#39;</span><span class="p">,</span>
<span class="n">mds</span> <span class="o">=</span> <span class="n">MDS</span><span class="p">(</span><span class="n">mds_config</span><span class="p">)</span>
<span class="n">mds_readonly</span> <span class="o">=</span> <span class="n">MDSRO</span><span class="p">(</span><span class="n">mds_config</span><span class="p">)</span>
<span class="n">fs_readonly</span> <span class="o">=</span> <span class="n">FileStoreRO</span><span class="p">(</span><span class="n">fs_config</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Broker</span><span class="p">(</span><span class="n">mds_readonly</span><span class="p">,</span> <span class="n">fs_readonly</span><span class="p">)</span>

<span class="c1"># Subscribe metadatastore to documents.</span>
<span class="c1"># If this is removed, data is not saved to metadatastore.</span>
<span class="kn">from</span> <span class="nn">bluesky.global_state</span> <span class="kn">import</span> <span class="n">gs</span>
<span class="n">gs</span><span class="o">.</span><span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">)</span>

<span class="c1"># Import matplotlib and put it in interactive mode.</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

<span class="c1"># Make plots update live while scans run.</span>
<span class="kn">from</span> <span class="nn">bluesky.utils</span> <span class="kn">import</span> <span class="n">install_qt_kicker</span>
<span class="n">install_qt_kicker</span><span class="p">()</span>

<span class="c1"># Optional: set any metadata that rarely changes.</span>
<span class="c1"># RE.md[&#39;beamline_id&#39;] = &#39;YOUR_BEAMLINE_HERE&#39;</span>

<span class="c1"># convenience imports</span>
<span class="kn">from</span> <span class="nn">ophyd.commands</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bluesky.callbacks</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bluesky.spec_api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bluesky.global_state</span> <span class="kn">import</span> <span class="n">gs</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">resume</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">RE</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">RE</span>  <span class="c1"># convenience alias</span>

<span class="c1"># Uncomment the following lines to turn on verbose messages for debugging.</span>
<span class="c1"># import logging</span>
<span class="c1"># ophyd.logger.setLevel(logging.DEBUG)</span>
<span class="c1"># logging.basicConfig(level=logging.DEBUG)</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-beamline-github-organization">
<h3>Create a Beamline GitHub Organization<a class="headerlink" href="#create-a-beamline-github-organization" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Create a username on github.com if you don’t have one. Create a new
organization with the name NSLS-II-XXX where XXX is the three-letter
beamline abbreviation (e.g., ISS). Create a new repository in this
organization named <code class="docutils literal notranslate"><span class="pre">profile_colletion</span></code>.</li>
<li>Make the new IPython profile a git repository.</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/.ipython/profile_collection
git init
git add startup/
git commmit -m <span class="s2">&quot;initial commit&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Upload the <code class="docutils literal notranslate"><span class="pre">profile_collection</span></code> git repository to GitHub. Be sure to edit
the command below to replace NSLS-II-XXX with the name of your organization.</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git remote add upstream https://github.com/NSLS-II-XXX/profile_collection.git
git push -u upstream master
</pre></div>
</div>
</div>
<div class="section" id="configure-the-olog">
<h3>Configure the Olog<a class="headerlink" href="#configure-the-olog" title="Permalink to this headline">¶</a></h3>
<div class="section" id="essential-configuration">
<h4>Essential Configuration<a class="headerlink" href="#essential-configuration" title="Permalink to this headline">¶</a></h4>
<p>pyOlog requires a configuration file to specify the connection
settings. As root, create a file at <code class="docutils literal notranslate"><span class="pre">/etc/pyOlog.conf</span></code> with the following
contents.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">beamline</span><span class="o">&gt;-</span><span class="n">log</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">nsls2</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">8181</span><span class="o">/</span><span class="n">Olog</span>
<span class="n">logbooks</span> <span class="o">=</span> <span class="n">Commissioning</span>   <span class="c1"># use the name of an existing logbook</span>
<span class="n">username</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span>
<span class="n">password</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">password</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;beamline&gt;</span></code> is the designation formatted like <code class="docutils literal notranslate"><span class="pre">xf23id1</span></code>.</p>
</div>
<div class="section" id="integration-with-bluesky">
<h4>Integration with Bluesky<a class="headerlink" href="#integration-with-bluesky" title="Permalink to this headline">¶</a></h4>
<p>Bluesky automatically logs basic scan information at the start of a
scan. (All of this information is strictly a subset of what is
also stored in metadatastore – this is just a convenience.)</p>
<p>Back in an IPython profile startup file, add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pyOlog</span> <span class="k">import</span> <span class="n">SimpleOlogClient</span>
<span class="kn">from</span> <span class="nn">bluesky.callbacks.olog</span> <span class="k">import</span> <span class="n">logbook_cb_factory</span>

<span class="c1"># Set up the logbook. This configures bluesky&#39;s summaries of</span>
<span class="c1"># data acquisition (scan type, ID, etc.).</span>

<span class="n">LOGBOOKS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Data Acquisition&#39;</span><span class="p">]</span>  <span class="c1"># list of logbook names to publish to</span>
<span class="n">simple_olog_client</span> <span class="o">=</span> <span class="n">SimpleOlogClient</span><span class="p">()</span>
<span class="n">generic_logbook_func</span> <span class="o">=</span> <span class="n">simple_olog_client</span><span class="o">.</span><span class="n">log</span>
<span class="n">configured_logbook_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">generic_logbook_func</span><span class="p">,</span> <span class="n">logbooks</span><span class="o">=</span><span class="n">LOGBOOKS</span><span class="p">)</span>

<span class="n">cb</span> <span class="o">=</span> <span class="n">logbook_cb_factory</span><span class="p">(</span><span class="n">configured_logbook_func</span><span class="p">)</span>
<span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="integration-with-ophyd">
<h4>Integration with Ophyd<a class="headerlink" href="#integration-with-ophyd" title="Permalink to this headline">¶</a></h4>
<p>Ophyd has as <code class="docutils literal notranslate"><span class="pre">log_pos</span></code> method that writes the current position of all
positioners into the log. To enable this, add the following to an IPython
profile startup file, add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is for ophyd.commands.get_logbook, which simply looks for</span>
<span class="c1"># a variable called &#39;logbook&#39; in the global IPython namespace.</span>
<span class="n">logbook</span> <span class="o">=</span> <span class="n">simple_olog_client</span>
</pre></div>
</div>
<p>The log entires will be written into the logbook specified in
<code class="docutils literal notranslate"><span class="pre">.pyOlog.conf</span></code> (in our example, “Commissioning”), not the logbook
used by bluesky (in our example, “Data Acquisition”).</p>
</div>
<div class="section" id="olog-ipython-magics">
<h4>Olog IPython “Magics”<a class="headerlink" href="#olog-ipython-magics" title="Permalink to this headline">¶</a></h4>
<p>“Magics” are special IPython commands (not part of Python itself). They
begin with %. There are two IPython magics for conveniently writing to
the Olog.</p>
<ul class="simple">
<li>Type <code class="docutils literal notranslate"><span class="pre">%logit</span></code> to quickly type a text log entry.</li>
<li>Type <code class="docutils literal notranslate"><span class="pre">%grabit</span></code>, select an area of the screen to capture, and type in a
text caption.</li>
</ul>
<p>These require their own special configuration. In the profile directory, such
as <code class="docutils literal notranslate"><span class="pre">~/.ipython/profile_collection</span></code>, edit the file <code class="docutils literal notranslate"><span class="pre">ipython_config.py</span></code>.</p>
<p>Add the line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">InteractiveShellApp</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pyOlog.cli.ipy&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The log entires will be written into the logbook specified in
<code class="docutils literal notranslate"><span class="pre">.pyOlog.conf</span></code> (in our example, “Commissioning”), not the logbook
used by bluesky (in our example, “Data Acquisition”).</p>
</div>
</div>
</div>
<div class="section" id="new-workstation-for-data-collection-or-analysis">
<h2>New Workstation for Data Collection or Analysis<a class="headerlink" href="#new-workstation-for-data-collection-or-analysis" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Verify that the conda puppet class has been applied by checking that the
<code class="docutils literal notranslate"><span class="pre">conda</span></code> binary is available at <code class="docutils literal notranslate"><span class="pre">/opt/conda/bin</span></code>. This should happen
automatically on machines designated <code class="docutils literal notranslate"><span class="pre">*-srv*</span></code> (“server”) or <code class="docutils literal notranslate"><span class="pre">*-ws*</span></code>
(“workstation”) as soon as they are on the NSLS-II network and working with
puppet.</li>
<li>Create configuration files for metadatastore and filestore. As root user,
compose two new files. The <code class="docutils literal notranslate"><span class="pre">hostname</span></code> should be the host where the mongo
service running (conventionally, the <code class="docutils literal notranslate"><span class="pre">*-ca1</span></code> machine, as noted above).</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/metadatastore.yml</span>
host: hostname
port: <span class="m">27017</span>
database: metadatastore-production-v1
timezone: US/Eastern

<span class="c1"># /etc/filestore.yml</span>
host: hostname
port: <span class="m">27017</span>
database: filestore-production-v1
</pre></div>
</div>
</div>
<div class="section" id="new-user">
<h2>New User<a class="headerlink" href="#new-user" title="Permalink to this headline">¶</a></h2>
<div class="section" id="one-time-configuration">
<h3>One-time configuration<a class="headerlink" href="#one-time-configuration" title="Permalink to this headline">¶</a></h3>
<p>Add the following to the user’s <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">http_proxy</span><span class="o">=</span>http://proxy:8888
<span class="nb">export</span> <span class="nv">https_proxy</span><span class="o">=</span>http://proxy:8888
<span class="nb">export</span> <span class="nv">no_proxy</span><span class="o">=</span>cs.nsls2.local
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/opt/conda/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>The first three lines are local NSLS-II controls network configuration. They
should already be set at the system level but in practice they are often not.</p>
<p>Conda has already been installed on all NSLS-II workstations (ws) and servers
(srv) in a shared location. The last line adds conda to the user’s PATH so that
it overrides any system-installed Python, IPython, etc.</p>
</div>
<div class="section" id="convenience-script-bsui">
<h3>Convenience Script <code class="docutils literal notranslate"><span class="pre">bsui</span></code><a class="headerlink" href="#convenience-script-bsui" title="Permalink to this headline">¶</a></h3>
<p>The script <code class="docutils literal notranslate"><span class="pre">bsui</span></code></p>
</div>
<div class="section" id="custom-user-environments">
<h3>Custom User Environments<a class="headerlink" href="#custom-user-environments" title="Permalink to this headline">¶</a></h3>
<p>Any user can create a conda environment, a set of binaries and Python packages
completely under their control. User conda environments are stored under
<code class="docutils literal notranslate"><span class="pre">~/conda_envs/&lt;environment-name&gt;</span></code>.</p>
<p>This command creates a new environment called <code class="docutils literal notranslate"><span class="pre">my-env</span></code> with all the versions
of the collection software used for the second operating cycle of 2017.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda create -c nsls2-tag -n my-env collection-17Q2
</pre></div>
</div>
<p>To test the new environment, activate it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> activate my-env
</pre></div>
</div>
<p>Troubleshooting: Check that <code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">ipython</span></code> points to a path with the word
<code class="docutils literal notranslate"><span class="pre">my-env</span></code> it in (not <code class="docutils literal notranslate"><span class="pre">/usr/bin/python</span></code>, as a counterexample). To
troubleshoot, you might need to refresh bash with the command <code class="docutils literal notranslate"><span class="pre">hash</span> <span class="pre">-r</span></code>.</p>
<p>To get “development” versions that are maybe less stable but contain the latest
bug fixes and features, use the <code class="docutils literal notranslate"><span class="pre">nsls2-dev</span></code> channel in place of
<code class="docutils literal notranslate"><span class="pre">nsls2-tag</span></code>.</p>
</div>
<div class="section" id="creating-or-updating-shared-root-environments">
<h3>Creating or Updating Shared (Root) Environments<a class="headerlink" href="#creating-or-updating-shared-root-environments" title="Permalink to this headline">¶</a></h3>
<p>Administrators with sudo access can create or update conda environments that
users can use (“activate”) but only administrators can edit. These environments
are located in <code class="docutils literal notranslate"><span class="pre">/opt/conda_envs</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To review the detailed conda configuration, refer to
<code class="docutils literal notranslate"><span class="pre">/opt/conda/.condarc</span></code>, where you can see the list of default channels and
the search path for environments.</p>
</div>
</div>
</div>
<div class="section" id="installing-on-a-personal-computer">
<h2>Installing on a Personal Computer<a class="headerlink" href="#installing-on-a-personal-computer" title="Permalink to this headline">¶</a></h2>
<p>You can install these packages on your personal laptop outside the controls
network. Install miniconda or Anaconda, and create user environments as
described above. All of the packages are mirrored on anaconda.org, outside of
the NSLS-II firewall, where you will be able to access them. The channels are
called <code class="docutils literal notranslate"><span class="pre">lightsource2-tag</span></code> and <code class="docutils literal notranslate"><span class="pre">lightsource2-dev</span></code> instead of <code class="docutils literal notranslate"><span class="pre">nsls2-tag</span></code>
and <code class="docutils literal notranslate"><span class="pre">nsls2-dev</span></code> respectively. The following serves as a step by step guide:</p>
<ol class="arabic">
<li><dl class="first docutils">
<dt>Follow the instructions in the link below to install minconda or anaconda.</dt>
<dd><p class="first last"><a class="reference external" href="https://conda.io/docs/user-guide/install/index.html">https://conda.io/docs/user-guide/install/index.html</a></p>
</dd>
</dl>
</li>
<li><p class="first">Open a terminal and run the following commands to install the enviroments.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda create -n collection-2018-2.1 -c lightsource2-tag collection
conda create -n analysis-2018-2.1 -c lightsource2-tag analysis
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<blockquote>
<div><p>If you get the error</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The remote server could not find the noarch directory for the requested channel with url: https://conda.anaconda.org/nsls2-tag&#39;
</pre></div>
</div>
<p>then you are not on the controls network, replace <code class="docutils literal notranslate"><span class="pre">nsls2-tag</span></code> with
<code class="docutils literal notranslate"><span class="pre">lightsource2-tag</span></code> in the command.</p>
</div></blockquote>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">collection-2018-2.1</span></code> or <code class="docutils literal notranslate"><span class="pre">analysis-2018-2.1</span></code> part of these
commands relates to the released versions from the second cycle of 2018;
you can use any version here.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There is a conda channel named <code class="docutils literal notranslate"><span class="pre">lightsource2</span></code> that it no longer
maintained. If you use it, you will find very old versions of some of
the packages used at NSLS-II. Use <code class="docutils literal notranslate"><span class="pre">lightsource2-tag</span></code> instead.</p>
</div>
</li>
<li><p class="first">Check this worked by running the command below:
.. code-block:: bash</p>
<blockquote>
<div><p>conda env list</p>
</div></blockquote>
<p>You should see collection-2018-2.1 listed (or whichever version you installed).</p>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="resources.html" class="btn btn-neutral float-right" title="Recommended Resources" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="conda.html" class="btn btn-neutral" title="Software Deployment with Conda" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>