

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Interruptions &mdash; bluesky 0.8.0+4.ge4b535e documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="bluesky 0.8.0+4.ge4b535e documentation" href="index.html"/>
        <link rel="next" title="bluesky.suspenders.SuspendBoolHigh" href="bluesky.suspenders.SuspendBoolHigh.html"/>
        <link rel="prev" title="Live Visualization and Processing" href="callbacks.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> bluesky
          

          
          </a>

          
            
            
              <div class="version">
                0.8.0+4.ge4b535e
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">User Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="plans_intro.html">Basic Usage &amp; Intro to Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="documents.html">Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Recording Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="plans.html">Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="callbacks.html">Live Visualization and Processing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Interruptions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pausing-interactively">Pausing Interactively</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pause-now-ctrl-c-twice">Pause Now: Ctrl+C twice</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pause-soon-ctrl-c-once">Pause Soon: Ctrl+C once</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-to-do-after-pausing">What to do after pausing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#resume">Resume</a></li>
<li class="toctree-l4"><a class="reference internal" href="#abort">Abort</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stop">Stop</a></li>
<li class="toctree-l4"><a class="reference internal" href="#halt">Halt</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#interactively-interrupt-execution">Interactively Interrupt Execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-a-paused-state">From a paused state</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#automated-suspension">Automated Suspension</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installing-suspenders">Installing Suspenders</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-suspend-a-plan-if-the-beam-current-dips-low">Example: Suspend a plan if the beam current dips low</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#built-in-suspenders">Built-in Suspenders</a><ul>
<li class="toctree-l4"><a class="reference internal" href="bluesky.suspenders.SuspendBoolHigh.html">bluesky.suspenders.SuspendBoolHigh</a></li>
<li class="toctree-l4"><a class="reference internal" href="bluesky.suspenders.SuspendBoolLow.html">bluesky.suspenders.SuspendBoolLow</a></li>
<li class="toctree-l4"><a class="reference internal" href="bluesky.suspenders.SuspendFloor.html">bluesky.suspenders.SuspendFloor</a></li>
<li class="toctree-l4"><a class="reference internal" href="bluesky.suspenders.SuspendCeil.html">bluesky.suspenders.SuspendCeil</a></li>
<li class="toctree-l4"><a class="reference internal" href="bluesky.suspenders.SuspendInBand.html">bluesky.suspenders.SuspendInBand</a></li>
<li class="toctree-l4"><a class="reference internal" href="bluesky.suspenders.SuspendOutBand.html">bluesky.suspenders.SuspendOutBand</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#checkpoints">Checkpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="#planned-pauses">Planned Pauses</a></li>
<li class="toctree-l2"><a class="reference internal" href="#associated-runengine-interface">Associated RunEngine Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#state">State</a></li>
<li class="toctree-l3"><a class="reference internal" href="#suspender-related-methods">Suspender-related Methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#request-methods">Request Methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-requesting-a-pause-from-the-asyncio-event-loop">Example: Requesting a pause from the asyncio event loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#experimental-record-interruptions">Experimental: Record Interruptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="event_descriptors.html">Event Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="async.html">Asynchronous Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging and Logging</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">How Bluesky Interfaces with Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="msg.html">Message Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="run_engine.html">The RunEngine run loop</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_changes.html">Release Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">bluesky</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Interruptions</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/state-machine.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="interruptions">
<h1>Interruptions<a class="headerlink" href="#interruptions" title="Permalink to this headline">¶</a></h1>
<p>The RunEngine can be safely interrupted and resumed. All plans get this
feature &#8220;for free.&#8221;</p>
<div class="section" id="pausing-interactively">
<span id="id1"></span><h2>Pausing Interactively<a class="headerlink" href="#pausing-interactively" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Looking for a quick refresher on pausing, resuming, or aborting
interactively? Skip to the <a class="reference internal" href="#interactive-pause-summary"><span class="std std-ref">Summary</span></a>.</p>
</div>
<p>While the RunEngine is executing a plan, it captures SIGINT (Ctrl+C).</p>
<div class="section" id="pause-now-ctrl-c-twice">
<h3>Pause Now: Ctrl+C twice<a class="headerlink" href="#pause-now-ctrl-c-twice" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">LiveTable</span><span class="p">([</span><span class="n">motor</span><span class="p">,</span> <span class="n">det</span><span class="p">]))</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>   <span class="n">seq_num</span> <span class="o">|</span>       <span class="n">time</span> <span class="o">|</span>      <span class="n">motor</span> <span class="o">|</span>        <span class="n">det</span> <span class="o">|</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.2</span> <span class="o">|</span>    <span class="o">-</span><span class="mf">10.000</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">2</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.3</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">8.571</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">3</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.4</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">7.143</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">^</span><span class="n">C</span><span class="o">^</span><span class="n">C</span>
<span class="n">Pausing</span><span class="o">...</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
</pre></div>
</div>
<p>Before returning the prompt the user, the RunEngine ensures that all motors
that it has touched are stopped. It also performs any device-specific cleanup
defined in the device&#8217;s (optional) <code class="docutils literal"><span class="pre">pause()</span></code> method.</p>
<p>If execution is later resumed, the RunEngine will &#8220;rewind&#8221; through the plan to
the most recent <a class="reference internal" href="#checkpoints"><span class="std std-ref">checkpoint</span></a>, the last safe place to restart.</p>
</div>
<div class="section" id="pause-soon-ctrl-c-once">
<h3>Pause Soon: Ctrl+C once<a class="headerlink" href="#pause-soon-ctrl-c-once" title="Permalink to this headline">¶</a></h3>
<p>Pause at the next <a class="reference internal" href="#checkpoints"><span class="std std-ref">checkpoint</span></a>: typically, the next step in
a step scan. We call this &#8220;deferred pause.&#8221; It avoids having to repeat any work
when the plan is resumed.</p>
<p>Notice that this time when Ctrl+C (^C) is hit, the current step (4) is allowed
to complete before execution is paused.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">LiveTable</span><span class="p">([</span><span class="n">motor</span><span class="p">,</span> <span class="n">det</span><span class="p">]))</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>   <span class="n">seq_num</span> <span class="o">|</span>       <span class="n">time</span> <span class="o">|</span>      <span class="n">motor</span> <span class="o">|</span>        <span class="n">det</span> <span class="o">|</span>
<span class="o">+-----------+------------+------------+------------+</span>
<span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.2</span> <span class="o">|</span>    <span class="o">-</span><span class="mf">10.000</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">2</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.3</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">8.571</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">3</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.4</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">7.143</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">^</span><span class="n">C</span>
<span class="n">A</span> <span class="s1">&#39;deferred pause&#39;</span> <span class="n">has</span> <span class="n">been</span> <span class="n">requested</span><span class="o">.</span> <span class="n">The</span> <span class="n">RunEngine</span> <span class="n">will</span> <span class="n">pause</span> <span class="n">at</span> <span class="n">the</span> <span class="nb">next</span>
<span class="n">checkpoint</span><span class="o">.</span> <span class="n">To</span> <span class="n">pause</span> <span class="n">immediately</span><span class="p">,</span> <span class="n">hit</span> <span class="n">Ctrl</span><span class="o">+</span><span class="n">C</span> <span class="n">again</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">next</span> <span class="mi">10</span> <span class="n">seconds</span><span class="o">.</span>
<span class="n">Deferred</span> <span class="n">pause</span> <span class="n">acknowledged</span><span class="o">.</span> <span class="n">Continuing</span> <span class="n">to</span> <span class="n">checkpoint</span><span class="o">.</span>
<span class="o">|</span>         <span class="mi">4</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.5</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">5.728</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="n">Pausing</span><span class="o">...</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
</pre></div>
</div>
</div>
<div class="section" id="what-to-do-after-pausing">
<h3>What to do after pausing<a class="headerlink" href="#what-to-do-after-pausing" title="Permalink to this headline">¶</a></h3>
<p>After being paused, the RunEngine holds on to information that it might need in
order to resume later. It &#8220;knows&#8221; that it is in a paused state, and you can
check that at any time:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">RE</span><span class="o">.</span><span class="n">state</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;paused&#39;</span>
</pre></div>
</div>
<p>During the pause, we can do anything: check readings, move motors, etc. It will
not allow you to execute a new plan until the current one is either resumed or
terminated. Your options are:</p>
<div class="section" id="resume">
<h4>Resume<a class="headerlink" href="#resume" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">RE</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
<span class="o">|</span>         <span class="mi">4</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.5</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">5.714</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">5</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.5</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">4.286</span> <span class="o">|</span>      <span class="mf">0.000</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">6</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.6</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">2.857</span> <span class="o">|</span>      <span class="mf">0.017</span> <span class="o">|</span>
<span class="o">|</span>         <span class="mi">7</span> <span class="o">|</span> <span class="mo">07</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">29.7</span> <span class="o">|</span>     <span class="o">-</span><span class="mf">1.429</span> <span class="o">|</span>      <span class="mf">0.360</span> <span class="o">|</span>
<span class="p">(</span><span class="n">etc</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>
<p>Depending on the plan, it may &#8220;rewind&#8221; to safely continue on and ensure all
data is collected correctly.</p>
</div>
<div class="section" id="abort">
<h4>Abort<a class="headerlink" href="#abort" title="Permalink to this headline">¶</a></h4>
<p>Allow the plan to perform any final cleanup. For example, some plans move
motors back to their starting positions. Mark the data as having been aborted,
so that this fact can be noted (if desired) in later analysis. All of the data
collected up this point will be saved regardless.</p>
<p>From a paused state:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">RE</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
<span class="n">Aborting</span><span class="o">...</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="p">[</span><span class="s1">&#39;8ef9388c-75d3-498c-a800-3b0bd24b88ed&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="stop">
<h4>Stop<a class="headerlink" href="#stop" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">RE.stop()</span></code> is functionally identical to <code class="docutils literal"><span class="pre">RE.abort()</span></code>. The only
difference is that aborted runs are marked with <code class="docutils literal"><span class="pre">exit_status:</span> <span class="pre">'abort'</span></code>
instead of <code class="docutils literal"><span class="pre">exit_status:</span> <span class="pre">'success'</span></code>. This distinction may be a useful
distinction during analysis`.</p>
</div>
<div class="section" id="halt">
<h4>Halt<a class="headerlink" href="#halt" title="Permalink to this headline">¶</a></h4>
<p>Aborting or stopping allows the plan to perform cleanup. We already mentioned
the example of a plan moving motors back to their starting positions at the
end.</p>
<p>In some situations, you may wish to prevent the plan from doing <em>anything</em>
&#8212; you want to halt immediately, skipping cleanup. For this, use
<code class="docutils literal"><span class="pre">RE.halt()</span></code>.</p>
</div>
</div>
<div class="section" id="summary">
<span id="interactive-pause-summary"></span><h3>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h3>
<div class="section" id="interactively-interrupt-execution">
<h4>Interactively Interrupt Execution<a class="headerlink" href="#interactively-interrupt-execution" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="68%" />
<col width="32%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command</th>
<th class="head">Outcome</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Ctrl+C</td>
<td>Pause soon.</td>
</tr>
<tr class="row-odd"><td>Ctrl+C twice</td>
<td>Pause now.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="from-a-paused-state">
<h4>From a paused state<a class="headerlink" href="#from-a-paused-state" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="73%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command</th>
<th class="head">Outcome</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>RE.resume()</td>
<td>Safely resume plan.</td>
</tr>
<tr class="row-odd"><td>RE.abort()</td>
<td>Perform cleanup. Mark as aborted.</td>
</tr>
<tr class="row-even"><td>RE.stop()</td>
<td>Perform cleanup. Mark as success.</td>
</tr>
<tr class="row-odd"><td>RE.halt()</td>
<td>Do not perform cleanup &#8212; just stop.</td>
</tr>
<tr class="row-even"><td>RE.state</td>
<td>Check if &#8216;paused&#8217; or &#8216;idle&#8217;.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="automated-suspension">
<h2>Automated Suspension<a class="headerlink" href="#automated-suspension" title="Permalink to this headline">¶</a></h2>
<p>It can also be useful to interrupt execution automatically in response some
condition (e.g., shutter closed, beam dumped, temperature exceed some limit).
We use the word <em>suspension</em> to mean an unplanned pause initialized by some
agent running the background. The agent (a &#8220;suspender&#8221;) monitors some condition
and, if it detects a problem, it suspends execution. When it detects that
conditions have returned to normal, it gives the RunEngine permission to resume
after some interval. This can operate unattended.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">LiveTable</span><span class="p">([</span><span class="n">motor</span><span class="p">,</span> <span class="n">det</span><span class="p">]))</span>
<span class="go">+------------+-------------------+----------------+----------------+</span>
<span class="go">|   seq_num  |             time  |         motor  |           det  |</span>
<span class="go">+------------+-------------------+----------------+----------------+</span>
<span class="go">|         1  |  16:46:08.953815  |          0.03  |        290.00  |</span>
<span class="go">Suspending....To get prompt hit Ctrl-C to pause the scan</span>
<span class="go">|         2  |  16:46:20.868445  |          0.09  |        279.00  |</span>
<span class="go">|         3  |  16:46:29.077690  |          0.16  |        284.00  |</span>
<span class="go">|         4  |  16:46:33.540643  |          0.23  |        278.00  |</span>
<span class="go">+------------+-------------------+----------------+----------------+</span>
</pre></div>
</div>
<p>A <em>suspended</em> plan does not return the prompt to the user. Like a paused plan,
it stops executing new instructions and rewinds to the most recent checkpoint.
But unlike a paused plan, it resumes execution automatically when conditions
return to normal.</p>
<p>To take manual control of a suspended plan, pause it by hitting Ctrl+C twice.
You will be given the prompt. When conditions are good again, you may manually
resume using <code class="docutils literal"><span class="pre">RE.resume()</span></code>.</p>
<div class="section" id="installing-suspenders">
<span id="id2"></span><h3>Installing Suspenders<a class="headerlink" href="#installing-suspenders" title="Permalink to this headline">¶</a></h3>
<p>Bluesky includes several &#8220;suspenders&#8221; that work with ophyd Signals to monitor
conditions and suspend execution. It&#8217;s also possible to write suspenders
from scratch to monitor anything at all.</p>
<p>We&#8217;ll start with an example.</p>
<div class="section" id="example-suspend-a-plan-if-the-beam-current-dips-low">
<h4>Example: Suspend a plan if the beam current dips low<a class="headerlink" href="#example-suspend-a-plan-if-the-beam-current-dips-low" title="Permalink to this headline">¶</a></h4>
<p>This defines a suspender and installs it on the RunEngine. With this, plans
will be automatically suspended when the <code class="docutils literal"><span class="pre">beam_current</span></code> signal goes below 2
and resume once it exceeds 3.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">EpicsSignal</span>
<span class="kn">from</span> <span class="nn">bluesky.suspenders</span> <span class="kn">import</span> <span class="n">SuspendFloor</span>

<span class="n">beam_current</span> <span class="o">=</span> <span class="n">EpicsSignal</span><span class="p">(</span><span class="s1">&#39;...PV string...&#39;</span><span class="p">)</span>
<span class="n">sus</span> <span class="o">=</span> <span class="n">SuspendFloor</span><span class="p">(</span><span class="n">beam_current</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">RE</span><span class="o">.</span><span class="n">install_suspender</span><span class="p">(</span><span class="n">sus</span><span class="p">)</span>
</pre></div>
</div>
<p>In the following example, the beam current dipped below 2 in the middle of
taking the second data point. It later recovered.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [2]: </span><span class="n">RE</span><span class="p">(</span><span class="n">my_scan</span><span class="p">)</span>
<span class="go">+------------+-------------------+----------------+----------------+</span>
<span class="go">|   seq_num  |             time  |         theta  |    sclr_chan4  |</span>
<span class="go">+------------+-------------------+----------------+----------------+</span>
<span class="go">|         1  |  16:46:08.953815  |          0.03  |        290.00  |</span>
<span class="go">Suspending....To get prompt hit Ctrl-C to pause the scan</span>
<span class="go">|         2  |  16:46:20.868445  |          0.09  |        279.00  |</span>
<span class="go">|         3  |  16:46:29.077690  |          0.16  |        284.00  |</span>
<span class="go">|         4  |  16:46:33.540643  |          0.23  |        278.00  |</span>
<span class="go">+------------+-------------------+----------------+----------------+</span>
</pre></div>
</div>
<p>Notice that the plan was suspended and then resumed. When it resumed, it went
back to the last checkpoint and re-took the second data point cleanly.</p>
<p>See the API documentation (follow the links in the table below) for other
suspender types and options, including a waiting period and cleanup
procedures to run pre-suspend and pre-resume.</p>
</div>
</div>
<div class="section" id="built-in-suspenders">
<h3>Built-in Suspenders<a class="headerlink" href="#built-in-suspenders" title="Permalink to this headline">¶</a></h3>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="bluesky.suspenders.SuspendBoolHigh.html#bluesky.suspenders.SuspendBoolHigh" title="bluesky.suspenders.SuspendBoolHigh"><code class="xref py py-obj docutils literal"><span class="pre">bluesky.suspenders.SuspendBoolHigh</span></code></a></td>
<td>Suspend when a boolean signal goes high; resume when it goes low.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="bluesky.suspenders.SuspendBoolLow.html#bluesky.suspenders.SuspendBoolLow" title="bluesky.suspenders.SuspendBoolLow"><code class="xref py py-obj docutils literal"><span class="pre">bluesky.suspenders.SuspendBoolLow</span></code></a></td>
<td>Suspend when a boolean signal goes low; resume when it goes high.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="bluesky.suspenders.SuspendFloor.html#bluesky.suspenders.SuspendFloor" title="bluesky.suspenders.SuspendFloor"><code class="xref py py-obj docutils literal"><span class="pre">bluesky.suspenders.SuspendFloor</span></code></a></td>
<td>Suspend when a scalar falls below a threshold.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="bluesky.suspenders.SuspendCeil.html#bluesky.suspenders.SuspendCeil" title="bluesky.suspenders.SuspendCeil"><code class="xref py py-obj docutils literal"><span class="pre">bluesky.suspenders.SuspendCeil</span></code></a></td>
<td>Suspend when a scalar rises above a threshold.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="bluesky.suspenders.SuspendInBand.html#bluesky.suspenders.SuspendInBand" title="bluesky.suspenders.SuspendInBand"><code class="xref py py-obj docutils literal"><span class="pre">bluesky.suspenders.SuspendInBand</span></code></a></td>
<td>Suspend when a scalar signal leaves a given band of values.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="bluesky.suspenders.SuspendOutBand.html#bluesky.suspenders.SuspendOutBand" title="bluesky.suspenders.SuspendOutBand"><code class="xref py py-obj docutils literal"><span class="pre">bluesky.suspenders.SuspendOutBand</span></code></a></td>
<td>Suspend when a scalar signal enters a given band of values.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="checkpoints">
<span id="id3"></span><h2>Checkpoints<a class="headerlink" href="#checkpoints" title="Permalink to this headline">¶</a></h2>
<p>Plan are specified as a sequence of <a class="reference internal" href="msg.html#msg"><span class="std std-ref">messages</span></a>, granular
instructions like &#8216;read&#8217; and &#8216;set&#8217;. The messages can optionally include one
or more &#8216;checkpoint&#8217; messages, indicating a place where it safe to resume after
an interruption. For example, checkpoints are placed before each step of a
<a class="reference internal" href="bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal"><span class="pre">bluesky.plans.scan()</span></code></a>.</p>
<p>Some experiments are not resumable: for example, the sample may be melting or
aging. Incorporating <a class="reference internal" href="bluesky.plans.clear_checkpoint.html#bluesky.plans.clear_checkpoint" title="bluesky.plans.clear_checkpoint"><code class="xref py py-func docutils literal"><span class="pre">bluesky.plans.clear_checkpoint()</span></code></a> in a plan makes it
un-resuming. If a pause or suspension are requested, the plan will abort
instead.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Some details about checkpoints and when they are allowed:</p>
<p class="last">It is not legal to create checkpoint in the middle of a data point (between
&#8216;create&#8217; and &#8216;save&#8217;) Checkpoints are implicitly created after actions that
it is not safe to replay: staging a device, adding a monitor, or adding a
subscription.</p>
</div>
</div>
<div class="section" id="planned-pauses">
<h2>Planned Pauses<a class="headerlink" href="#planned-pauses" title="Permalink to this headline">¶</a></h2>
<p>It&#8217;s possible to write a custom <em>plan</em> that pauses at certain points, requiring
the user to manually resume or abort.</p>
<p>See the <a class="reference internal" href="plans.html#planned-pauses"><span class="std std-ref">Planned Pauses</span></a> subsection of the documentation on <em>Plans</em>.</p>
</div>
<div class="section" id="associated-runengine-interface">
<h2>Associated RunEngine Interface<a class="headerlink" href="#associated-runengine-interface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="state">
<h3>State<a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h3>
<p>The RunEngine has a state machine defining its phases of operation and the
allowed transitions between them. As illustrated above, it can be inspected via
the <code class="docutils literal"><span class="pre">state</span></code> property.</p>
<p>The states are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">'idle'</span></code>: RunEngine is waiting for instructions.</li>
<li><code class="docutils literal"><span class="pre">'running'</span></code>: RunEngine is executing instructions.</li>
<li><code class="docutils literal"><span class="pre">'paused'</span></code>: RunEngine is waiting for user input. It can be</li>
</ul>
</div>
<div class="section" id="suspender-related-methods">
<h3>Suspender-related Methods<a class="headerlink" href="#suspender-related-methods" title="Permalink to this headline">¶</a></h3>
<dl class="method">
<dt id="bluesky.run_engine.RunEngine.install_suspender">
<code class="descclassname">RunEngine.</code><code class="descname">install_suspender</code><span class="sig-paren">(</span><em>suspender</em><span class="sig-paren">)</span><a class="headerlink" href="#bluesky.run_engine.RunEngine.install_suspender" title="Permalink to this definition">¶</a></dt>
<dd><p>Install a &#8216;suspender&#8217;, which can suspend and resume execution.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>suspender</strong> (<cite>bluesky.suspenders.SuspenderBase</cite>) &#8211; </td>
</tr>
</tbody>
</table>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><cite>RunEngine.remove_suspender</cite>
<cite>RunEngine.clear_suspenders</cite></p>
</div>
</dd></dl>

<dl class="method">
<dt id="bluesky.run_engine.RunEngine.remove_suspender">
<code class="descclassname">RunEngine.</code><code class="descname">remove_suspender</code><span class="sig-paren">(</span><em>suspender</em><span class="sig-paren">)</span><a class="headerlink" href="#bluesky.run_engine.RunEngine.remove_suspender" title="Permalink to this definition">¶</a></dt>
<dd><p>Uninstall a suspender.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>suspender</strong> (<cite>bluesky.suspenders.SuspenderBase</cite>) &#8211; </td>
</tr>
</tbody>
</table>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><cite>RunEngine.install_suspender</cite>
<cite>RunEngine.clear_suspenders</cite></p>
</div>
</dd></dl>

<p>The RunEngine also has a <code class="docutils literal"><span class="pre">suspenders</span></code> property, a collection of the
currently-installed suspenders.</p>
</div>
<div class="section" id="request-methods">
<h3>Request Methods<a class="headerlink" href="#request-methods" title="Permalink to this headline">¶</a></h3>
<p>This method is called when Ctrl+C is pressed or when a &#8216;pause&#8217; Message is
processed. It can also be called by user-defined agents. See the next example.</p>
<dl class="method">
<dt id="bluesky.run_engine.RunEngine.request_pause">
<code class="descclassname">RunEngine.</code><code class="descname">request_pause</code><span class="sig-paren">(</span><em>defer=False</em><span class="sig-paren">)</span><a class="headerlink" href="#bluesky.run_engine.RunEngine.request_pause" title="Permalink to this definition">¶</a></dt>
<dd><p>Command the Run Engine to pause.</p>
<p>This function is called by &#8216;pause&#8217; Messages. It can also be called
by other threads. It cannot be called on the main thread during a run,
but it is called by SIGINT (i.e., Ctrl+C).</p>
<p>If there current run has no checkpoint (via the &#8216;clear_checkpoint&#8217;
message), this will cause the run to abort.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>defer</strong> (<em>bool</em><em>, </em><em>optional</em>) &#8211; If False, pause immediately before processing any new messages.
If True, pause at the next checkpoint.
False by default.</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>This method is used by the <code class="docutils literal"><span class="pre">PVSuspend*</span></code> classes above. It can also be called
by user-defined agents.</p>
<dl class="method">
<dt id="bluesky.run_engine.RunEngine.request_suspend">
<code class="descclassname">RunEngine.</code><code class="descname">request_suspend</code><span class="sig-paren">(</span><em>fut</em>, <em>*</em>, <em>pre_plan=None</em>, <em>post_plan=None</em>, <em>justification=None</em><span class="sig-paren">)</span><a class="headerlink" href="#bluesky.run_engine.RunEngine.request_suspend" title="Permalink to this definition">¶</a></dt>
<dd><p>Request that the run suspend itself until the future is finished.</p>
<p>The two plans will be run before and after waiting for the future.
This enable doing things like opening and closing shutters and
resetting cameras around a suspend.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>fut</strong> (<em>asyncio.Future</em>) &#8211; </li>
<li><strong>pre_plan</strong> (<em>iterable</em><em>, </em><em>optional</em>) &#8211; Plan to execute just before suspending</li>
<li><strong>post_plan</strong> (<em>iterable</em><em>, </em><em>optional</em>) &#8211; Plan to execute just before resuming</li>
<li><strong>justification</strong> (<em>str</em><em>, </em><em>optional</em>) &#8211; explanation of why the suspension has been requested</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="example-requesting-a-pause-from-the-asyncio-event-loop">
<h3>Example: Requesting a pause from the asyncio event loop<a class="headerlink" href="#example-requesting-a-pause-from-the-asyncio-event-loop" title="Permalink to this headline">¶</a></h3>
<p>Since the user does not control of the prompt, calls to <code class="docutils literal"><span class="pre">RE.request_pause</span></code>
must be planned in advance. Here is a example that pauses the plan after 5
seconds.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="kn">import</span> <span class="n">null</span>

<span class="k">def</span> <span class="nf">loop_forever</span><span class="p">():</span>
    <span class="s2">&quot;a silly plan&quot;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">null</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="c1"># Request a pause 5 seconds from now.</span>
<span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">RE</span><span class="o">.</span><span class="n">request_pause</span><span class="p">)</span>

<span class="c1"># Execute the plan.</span>
<span class="n">RE</span><span class="p">(</span><span class="n">loop_forever</span><span class="p">())</span>

<span class="c1"># Five seconds after ``call_later`` was run, the plan is paused.</span>
<span class="c1"># Observe that the RunEngine is in a &#39;paused&#39; state.</span>
<span class="n">RE</span><span class="o">.</span><span class="n">state</span>
</pre></div>
</div>
<p>Above, we passed <code class="docutils literal"><span class="pre">True</span></code> to <code class="docutils literal"><span class="pre">RE.request_pause</span></code> to request a deferred pause.</p>
</div>
</div>
<div class="section" id="experimental-record-interruptions">
<h2>Experimental: Record Interruptions<a class="headerlink" href="#experimental-record-interruptions" title="Permalink to this headline">¶</a></h2>
<p>In the analysis stage, it can be useful to know if and when a run was
interrupted.  This experimental feature creates a special event stream
recording the time and nature of any interruptions.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is an experimental feature. It is tested but not yet widely used. It
might be changed or removed in the future.</p>
</div>
<p>Activate this feature by setting</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">record_interruptions</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>In this mode, the RunEngine emits a special event descriptor after opening a
new run. This name field in the descriptor is &#8216;interruptions&#8217;. It has a single
data key:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;interruptions&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;RunEngine&#39;</span><span class="p">}}</span>
</pre></div>
</div>
<p>Each time the RunEngine is paused, suspended, or resumed during the run, an
Event document for that descriptor is created. The data payload
<code class="docutils literal"><span class="pre">event['data']['interruptions']</span></code> is <code class="docutils literal"><span class="pre">'pause'</span></code>, <code class="docutils literal"><span class="pre">'suspend'</span></code>, or
<code class="docutils literal"><span class="pre">'resume'</span></code>. The associated time notes when the interruptions/resume was
processed.</p>
<p>To see this in action, try this example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="kn">import</span> <span class="n">pchain</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pause</span>
<span class="kn">from</span> <span class="nn">bluesky.examples</span> <span class="kn">import</span> <span class="n">det</span>

<span class="n">RE</span><span class="o">.</span><span class="n">record_interruptions</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">RE</span><span class="p">(</span><span class="n">pchain</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">]),</span> <span class="n">pause</span><span class="p">(),</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])),</span> <span class="k">print</span><span class="p">)</span>
<span class="c1"># ... RunEngine pauses</span>
<span class="n">RE</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
</pre></div>
</div>
<p>In the text that <code class="docutils literal"><span class="pre">print</span></code> dumps to the screen, look for the special
&#8216;interruptions&#8217; event descriptor and associated events.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bluesky.suspenders.SuspendBoolHigh.html" class="btn btn-neutral float-right" title="bluesky.suspenders.SuspendBoolHigh" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="callbacks.html" class="btn btn-neutral" title="Live Visualization and Processing" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Brookhaven National Lab.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.8.0+4.ge4b535e',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>