

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bluesky.bundlers &mdash; bluesky 1.6.6.post30+g43efe51 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> bluesky
          

          
          </a>

          
            
            
              <div class="version">
                1.6.6.post30+g43efe51
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plans.html">Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documents.html">Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metadata.html">Recording Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks.html">Live Visualization and Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../state-machine.html">Interruptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulation.html">Simulation and Error Checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../progress-bar.html">Progress Bar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../event_descriptors.html">Event Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../async.html">Asynchronous Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multi_run_plans.html">Multi-Run Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging.html">Debugging and Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../run_engine_api.html">RunEngine API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">Utility classes and functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../magics.html">IPython ‘Magics’ [Experimental]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../from-pyepics-to-bluesky.html">Translating Direct PyEpics Code to Bluesky Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../comparison-with-spec.html">Comparison with SPEC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">Appendix</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hardware.html">How Bluesky Interfaces with Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../msg.html">Message Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../run_engine.html">The RunEngine run loop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_changes.html">Release History</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/amostra">amostra</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/datamuxer">datamuxer</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/suitcase">suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluesky</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bluesky.bundlers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bluesky.bundlers</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">tee</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">ttime</span>
<span class="kn">from</span> <span class="nn">event_model</span> <span class="kn">import</span> <span class="n">DocumentNames</span>
<span class="kn">from</span> <span class="nn">.log</span> <span class="kn">import</span> <span class="n">doc_logger</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">new_uid</span><span class="p">,</span>
    <span class="n">IllegalMessageSequence</span><span class="p">,</span>
    <span class="n">_rearrange_into_parallel_dicts</span><span class="p">,</span>
    <span class="n">short_uid</span><span class="p">,</span>
    <span class="n">Msg</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="RunBundler"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.html#bluesky.bundlers.RunBundler">[docs]</a><span class="k">class</span> <span class="nc">RunBundler</span><span class="p">:</span>
<div class="viewcode-block" id="RunBundler.__init__"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.html#bluesky.bundlers.RunBundler.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">record_interruptions</span><span class="p">,</span> <span class="n">emit</span><span class="p">,</span> <span class="n">emit_sync</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
        <span class="c1"># state stolen from the RE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># if we are in the middle of bundling readings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle_name</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># name given to event descriptor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># The (future) runstart uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objs_read</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># objects read in one Event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># cache of obj.read() in one Event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># cache of obj.collect_asset_docs()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_describe_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># cache of all obj.describe() output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_desc_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># &quot; obj.describe_configuration()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_values_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># &quot; obj.read_configuration() values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_ts_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># &quot; obj.read_configuration() timestamps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># cache of {name: (objs_frozen_set, doc)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># a seq_num counter per stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_teed_sequence_counters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># for if we redo data-points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># cache of {obj: (cb, kwargs)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_is_open</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uncollected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># objects after kickoff(), before collect()</span>
        <span class="c1"># we expect the RE to take care of the composition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_md</span> <span class="o">=</span> <span class="n">md</span>
        <span class="c1"># this is state on the RE, mirror it here rather than refer to</span>
        <span class="c1"># the parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_interruptions</span> <span class="o">=</span> <span class="n">record_interruptions</span>
        <span class="c1"># this is RE.emit, but lifted to this context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="n">emit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit_sync</span> <span class="o">=</span> <span class="n">emit_sync</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span></div>

<div class="viewcode-block" id="RunBundler.open_run"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.open_run.html#bluesky.bundlers.RunBundler.open_run">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">open_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_is_open</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_desc_uid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># uid for a special Event Desc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># seq_num, special Event stream</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_md</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[start] document is emitted (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                         <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">})</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_checkpoint_state_coro</span><span class="p">()</span>

        <span class="c1"># Emit an Event Descriptor for recording any interruptions as Events.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_interruptions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_desc_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>
            <span class="n">dk</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;RunEngine&quot;</span><span class="p">}</span>
            <span class="n">interruptions_desc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">uid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_desc_uid</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;interruptions&quot;</span><span class="p">,</span>
                <span class="n">data_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;interruption&quot;</span><span class="p">:</span> <span class="n">dk</span><span class="p">},</span>
                <span class="n">run_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">interruptions_desc</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span></div>

<div class="viewcode-block" id="RunBundler.close_run"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.close_run.html#bluesky.bundlers.RunBundler.close_run">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">close_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instruct the RunEngine to write the RunStop document</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;close_run&#39;, None, exit_status=None, reason=None)</span>

<span class="sd">        if *exit_stats* and *reason* are not provided, use the values</span>
<span class="sd">        stashed on the RE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_is_open</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span>
                <span class="s2">&quot;A &#39;close_run&#39; message was received but there is no run &quot;</span>
                <span class="s2">&quot;open. If this occurred after a pause/resume, add &quot;</span>
                <span class="s2">&quot;a &#39;checkpoint&#39; message after the &#39;close_run&#39; message.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping run </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">)</span>
        <span class="c1"># Clear any uncleared monitoring callbacks.</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">clear_sub</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="c1"># Count the number of Events in each stream.</span>
        <span class="n">num_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">bundle_name</span><span class="p">,</span> <span class="n">counter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">bundle_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># rare but possible via Msg(&#39;create&#39;, name=&#39;primary&#39;)</span>
                <span class="k">continue</span>
            <span class="n">num_events</span><span class="p">[</span><span class="n">bundle_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">exit_status</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exit_status&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;success&quot;</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">run_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">uid</span><span class="o">=</span><span class="n">new_uid</span><span class="p">(),</span>
            <span class="n">exit_status</span><span class="o">=</span><span class="n">exit_status</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
            <span class="n">num_events</span><span class="o">=</span><span class="n">num_events</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[stop] document is emitted (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                         <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">})</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_checkpoint_state_coro</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_is_open</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;run_start&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="RunBundler.create"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.create.html#bluesky.bundlers.RunBundler.create">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trigger the run engine to start bundling future obj.read() calls for</span>
<span class="sd">         an Event document</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;create&#39;, None, name=&#39;primary&#39;)</span>
<span class="sd">            Msg(&#39;create&#39;, name=&#39;primary&#39;)</span>

<span class="sd">        Note that the `name` kwarg will be the &#39;name&#39; field of the resulting</span>
<span class="sd">        descriptor. So descriptor[&#39;name&#39;] = msg.kwargs[&#39;name&#39;].</span>

<span class="sd">        Also note that changing the &#39;name&#39; of the Event will create a new</span>
<span class="sd">        Descriptor document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span>
                <span class="s2">&quot;A second &#39;create&#39; message is not &quot;</span>
                <span class="s2">&quot;allowed until the current event &quot;</span>
                <span class="s2">&quot;bundle is closed with a &#39;save&#39; or &quot;</span>
                <span class="s2">&quot;&#39;drop&#39; message.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objs_read</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">command</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bundle_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bundle_name</span><span class="p">,</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Msg(&#39;create&#39;) now requires a stream name, given as &quot;</span>
                    <span class="s2">&quot;Msg(&#39;create&#39;, name) or Msg(&#39;create&#39;, name=name)&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="RunBundler.read"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.read.html#bluesky.bundlers.RunBundler.read">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reading</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a reading to the open event bundle.</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;read&#39;, obj)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span>
            <span class="c1"># if the object is not in the _describe_cache, cache it</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_describe_cache</span><span class="p">:</span>
                <span class="c1"># Validate that there is no data key name collision.</span>
                <span class="n">data_keys</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_describe_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_keys</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config_desc_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">describe_configuration</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache_config</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="c1"># check that current read collides with nothing else in</span>
            <span class="c1"># current event</span>
            <span class="n">cur_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_describe_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">read_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objs_read</span><span class="p">:</span>
                <span class="c1"># that is, field names</span>
                <span class="n">known_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_describe_cache</span><span class="p">[</span><span class="n">read_obj</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">known_keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cur_keys</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Data keys (field names) from </span><span class="si">{</span><span class="n">obj</span><span class="si">!r}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;collide with those from </span><span class="si">{</span><span class="n">read_obj</span><span class="si">!r}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;The colliding keys are </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">known_keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cur_keys</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># add this object to the cache of things we have read</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_objs_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="c1"># Stash the results, which will be emitted the next time _save is</span>
            <span class="c1"># called --- or never emitted if _drop is called instead.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span>
            <span class="c1"># Ask the object for any resource or datum documents is has cached</span>
            <span class="c1"># and cache them as well. Likewise, these will be emitted if and</span>
            <span class="c1"># when _save is called.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;collect_asset_docs&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">collect_asset_docs</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">reading</span></div>

    <span class="k">def</span> <span class="nf">_cache_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="s2">&quot;Read the object&#39;s configuration and cache it.&quot;</span>
        <span class="n">config_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">config_ts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">read_configuration</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">config_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="n">config_ts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_values_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_ts_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_ts</span>

<div class="viewcode-block" id="RunBundler.monitor"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.monitor.html#bluesky.bundlers.RunBundler.monitor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitor a signal. Emit event documents asynchronously.</span>

<span class="sd">        A descriptor document is emitted immediately. Then, a closure is</span>
<span class="sd">        defined that emits Event documents associated with that descriptor</span>
<span class="sd">        from a separate thread. This process is not related to the main</span>
<span class="sd">        bundling process (create/read/save).</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;monitor&#39;, obj, **kwargs)</span>
<span class="sd">            Msg(&#39;monitor&#39;, obj, name=&#39;event-stream-name&#39;, **kwargs)</span>

<span class="sd">        where kwargs are passed through to ``obj.subscribe()``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;monitor&#39; Msg does not accept positional &quot;</span> <span class="s2">&quot;arguments.&quot;</span>
            <span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">short_uid</span><span class="p">(</span><span class="s2">&quot;monitor&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span>
                <span class="s2">&quot;A &#39;monitor&#39; message was sent for </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;which is already monitored&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">descriptor_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>
        <span class="n">data_keys</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span> <span class="p">{}}}</span>
        <span class="n">config</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;data_keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">describe_configuration</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">read_configuration</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">config</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="n">config</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;timestamps&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
        <span class="n">object_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_keys</span><span class="p">)}</span>
        <span class="n">hints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;hints&quot;</span><span class="p">):</span>
            <span class="n">hints</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">hints</span><span class="p">})</span>
        <span class="n">desc_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">run_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">data_keys</span><span class="o">=</span><span class="n">data_keys</span><span class="p">,</span>
            <span class="n">uid</span><span class="o">=</span><span class="n">descriptor_uid</span><span class="p">,</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">object_keys</span><span class="o">=</span><span class="n">object_keys</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[descriptor] document is emitted with name </span><span class="si">%r</span><span class="s2"> containing &quot;</span>
                         <span class="s2">&quot;data keys </span><span class="si">%r</span><span class="s2"> (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                         <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;descriptor&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                                <span class="s1">&#39;data_keys&#39;</span><span class="p">:</span> <span class="n">data_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>
        <span class="n">seq_num_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">emit_event</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Ignore the inputs. Use this call as a signal to call read on the</span>
            <span class="c1"># object, a crude way to be sure we get all the info we need.</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">timestamps</span> <span class="o">=</span> <span class="n">_rearrange_into_parallel_dicts</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor_uid</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="n">timestamps</span><span class="p">,</span>
                <span class="n">seq_num</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">seq_num_counter</span><span class="p">),</span>
                <span class="n">uid</span><span class="o">=</span><span class="n">new_uid</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit_sync</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">emit_event</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">desc_doc</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">emit_event</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.record_interruption"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.record_interruption.html#bluesky.bundlers.RunBundler.record_interruption">[docs]</a>    <span class="k">def</span> <span class="nf">record_interruption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit an event in the &#39;interruptions&#39; event stream.</span>

<span class="sd">        If we are not inside a run or if self.record_interruptions is False,</span>
<span class="sd">        nothing is done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_desc_uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We are inside a run and self.record_interruptions is True.</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">descriptor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_desc_uid</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">uid</span><span class="o">=</span><span class="n">new_uid</span><span class="p">(),</span>
                <span class="n">seq_num</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_counter</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;interruption&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">},</span>
                <span class="n">timestamps</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;interruption&quot;</span><span class="p">:</span> <span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">()},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit_sync</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.rewind"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.rewind.html#bluesky.bundlers.RunBundler.rewind">[docs]</a>    <span class="k">def</span> <span class="nf">rewind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_teed_sequence_counters</span><span class="p">)</span>
        <span class="c1"># This is needed to &#39;cancel&#39; an open bundling (e.g. create) if</span>
        <span class="c1"># the pause happens after a &#39;checkpoint&#39;, after a &#39;create&#39;, but</span>
        <span class="c1"># before the paired &#39;save&#39;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RunBundler.unmonitor"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.unmonitor.html#bluesky.bundlers.RunBundler.unmonitor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">unmonitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop monitoring; i.e., remove the callback emitting event documents.</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;unmonitor&#39;, obj)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot &#39;unmonitor&#39; </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">; it is not &quot;</span> <span class="s2">&quot;being monitored.&quot;</span>
            <span class="p">)</span>
        <span class="n">cb</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">clear_sub</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_checkpoint_state_coro</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunBundler.save"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.save.html#bluesky.bundlers.RunBundler.save">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the event that is currently being bundled</span>

<span class="sd">        Create and emit an Event document containing the data read from devices</span>
<span class="sd">        in self._objs_read. Emit any Resource and Datum documents cached by</span>
<span class="sd">        those devices before emitting the Event document. If this is the first</span>
<span class="sd">        Event of its stream then create and emit the Event Descriptor document</span>
<span class="sd">        before emitting Resource, Datum, and Event documents.</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;save&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span>
                <span class="s2">&quot;A &#39;create&#39; message must be sent, to &quot;</span>
                <span class="s2">&quot;open an event bundle, before that &quot;</span>
                <span class="s2">&quot;bundle can be saved with &#39;save&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Short-circuit if nothing has been read. (Do not create empty Events.)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objs_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bundle_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="c1"># The Event Descriptor is uniquely defined by the set of objects</span>
        <span class="c1"># read in this Event grouping.</span>
        <span class="n">objs_read</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_objs_read</span><span class="p">)</span>

        <span class="c1"># Event Descriptor key</span>
        <span class="n">desc_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bundle_name</span>

        <span class="c1"># This is a separate check because it can be reset on resume.</span>
        <span class="n">seq_num_key</span> <span class="o">=</span> <span class="n">desc_key</span>
        <span class="k">if</span> <span class="n">seq_num_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">counter_copy1</span><span class="p">,</span> <span class="n">counter_copy2</span> <span class="o">=</span> <span class="n">tee</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="p">[</span><span class="n">seq_num_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter_copy1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_teed_sequence_counters</span><span class="p">[</span><span class="n">seq_num_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter_copy2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">d_objs</span><span class="p">,</span> <span class="n">descriptor_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">desc_key</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">d_objs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d_objs</span> <span class="o">!=</span> <span class="n">objs_read</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Mismatched objects read, expected </span><span class="si">{!s}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;got </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d_objs</span><span class="p">,</span> <span class="n">objs_read</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">descriptor_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We do not have an Event Descriptor for this set</span>
            <span class="c1"># so one must be created.</span>
            <span class="n">data_keys</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">object_keys</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">hints</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs_read</span><span class="p">:</span>
                <span class="n">dks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_describe_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
                <span class="n">obj_name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># dks is an OrderedDict. Record that order as a list.</span>
                <span class="n">object_keys</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dks</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">dk</span> <span class="ow">in</span> <span class="n">dks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">dk</span><span class="p">[</span><span class="s2">&quot;object_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_name</span>
                <span class="n">data_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dks</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="n">obj_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">config</span><span class="p">[</span><span class="n">obj_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_values_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
                <span class="n">config</span><span class="p">[</span><span class="n">obj_name</span><span class="p">][</span><span class="s2">&quot;timestamps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_ts_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
                <span class="n">config</span><span class="p">[</span><span class="n">obj_name</span><span class="p">][</span><span class="s2">&quot;data_keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_desc_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;hints&quot;</span><span class="p">):</span>
                    <span class="n">hints</span><span class="p">[</span><span class="n">obj_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">hints</span>
            <span class="n">descriptor_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>
            <span class="n">descriptor_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">run_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">data_keys</span><span class="o">=</span><span class="n">data_keys</span><span class="p">,</span>
                <span class="n">uid</span><span class="o">=</span><span class="n">descriptor_uid</span><span class="p">,</span>
                <span class="n">configuration</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">desc_key</span><span class="p">,</span>
                <span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">,</span>
                <span class="n">object_keys</span><span class="o">=</span><span class="n">object_keys</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">descriptor_doc</span><span class="p">)</span>
            <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;[descriptor] document emitted with name </span><span class="si">%r</span><span class="s2"> containing &quot;</span>
                <span class="s2">&quot;data keys </span><span class="si">%r</span><span class="s2"> (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">obj_name</span><span class="p">,</span>
                <span class="n">data_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;descriptor&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                    <span class="s1">&#39;data_keys&#39;</span><span class="p">:</span> <span class="n">data_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">[</span><span class="n">desc_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">objs_read</span><span class="p">,</span> <span class="n">descriptor_doc</span><span class="p">)</span>

        <span class="n">descriptor_uid</span> <span class="o">=</span> <span class="n">descriptor_doc</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span>

        <span class="c1"># Resource and Datum documents</span>
        <span class="k">for</span> <span class="n">resource_or_datum_name</span><span class="p">,</span> <span class="n">resource_or_datum_doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="p">:</span>
            <span class="c1"># Add a &#39;run_start&#39; field to resource documents on their way out</span>
            <span class="c1"># since this field could not have been set correctly before this point.</span>
            <span class="k">if</span> <span class="n">resource_or_datum_name</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
                <span class="n">resource_or_datum_doc</span><span class="p">[</span><span class="s2">&quot;run_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span>

            <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] document emitted </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">resource_or_datum_name</span><span class="p">,</span>
                <span class="n">resource_or_datum_doc</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;doc_name&quot;</span><span class="p">:</span> <span class="n">resource_or_datum_name</span><span class="p">,</span>
                    <span class="s2">&quot;run_uid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                    <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="n">resource_or_datum_doc</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                <span class="n">DocumentNames</span><span class="p">(</span><span class="n">resource_or_datum_name</span><span class="p">),</span>
                <span class="n">resource_or_datum_doc</span>
            <span class="p">)</span>

        <span class="c1"># Event document</span>
        <span class="n">seq_num</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="p">[</span><span class="n">seq_num_key</span><span class="p">])</span>
        <span class="n">event_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>
        <span class="c1"># Merge list of readings into single dict.</span>
        <span class="n">readings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_cache</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">timestamps</span> <span class="o">=</span> <span class="n">_rearrange_into_parallel_dicts</span><span class="p">(</span><span class="n">readings</span><span class="p">)</span>
        <span class="c1"># Mark all externally-stored data as not filled so that consumers</span>
        <span class="c1"># know that the corresponding data are identifiers, not dereferenced</span>
        <span class="c1"># data.</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">[</span><span class="n">desc_key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;data_keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;external&quot;</span> <span class="ow">in</span> <span class="n">v</span>
        <span class="p">}</span>
        <span class="n">event_doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor_uid</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">timestamps</span><span class="o">=</span><span class="n">timestamps</span><span class="p">,</span>
            <span class="n">seq_num</span><span class="o">=</span><span class="n">seq_num</span><span class="p">,</span>
            <span class="n">uid</span><span class="o">=</span><span class="n">event_uid</span><span class="p">,</span>
            <span class="n">filled</span><span class="o">=</span><span class="n">filled</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">event_doc</span><span class="p">)</span>
        <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;[event] document emitted with data keys </span><span class="si">%r</span><span class="s2"> (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span>
                <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                <span class="s1">&#39;data_keys&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.clear_monitors"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.clear_monitors.html#bluesky.bundlers.RunBundler.clear_monitors">[docs]</a>    <span class="k">def</span> <span class="nf">clear_monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">clear_sub</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to stop monitoring </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span></div>

<div class="viewcode-block" id="RunBundler.reset_checkpoint_state"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.reset_checkpoint_state.html#bluesky.bundlers.RunBundler.reset_checkpoint_state">[docs]</a>    <span class="k">def</span> <span class="nf">reset_checkpoint_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Keep a safe separate copy of the sequence counters to use if we</span>
        <span class="c1"># rewind and retake some data points.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">counter</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">counter_copy1</span><span class="p">,</span> <span class="n">counter_copy2</span> <span class="o">=</span> <span class="n">tee</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter_copy1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_teed_sequence_counters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter_copy2</span></div>

<div class="viewcode-block" id="RunBundler.reset_checkpoint_state_coro"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.reset_checkpoint_state_coro.html#bluesky.bundlers.RunBundler.reset_checkpoint_state_coro">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset_checkpoint_state_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_checkpoint_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunBundler.suspend_monitors"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.suspend_monitors.html#bluesky.bundlers.RunBundler.suspend_monitors">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">suspend_monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">clear_sub</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.restore_monitors"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.restore_monitors.html#bluesky.bundlers.RunBundler.restore_monitors">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">restore_monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.clear_checkpoint"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.clear_checkpoint.html#bluesky.bundlers.RunBundler.clear_checkpoint">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">clear_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_teed_sequence_counters</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunBundler.drop"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.drop.html#bluesky.bundlers.RunBundler.drop">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drop the event that is currently being bundled</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;drop&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span>
                <span class="s2">&quot;A &#39;create&#39; message must be sent, to &quot;</span>
                <span class="s2">&quot;open an event bundle, before that &quot;</span>
                <span class="s2">&quot;bundle can be dropped with &#39;drop&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bundling</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dropped open event bundle&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.kickoff"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.kickoff.html#bluesky.bundlers.RunBundler.kickoff">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start a flyscan object.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">        If `flyer_object` has a `kickoff` function that takes no arguments::</span>

<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object)</span>
<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object, group=&lt;name&gt;)</span>

<span class="sd">        If *flyer_object* has a ``kickoff`` function that takes</span>
<span class="sd">        ``(start, stop, steps)`` as its function arguments::</span>

<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object, start, stop, step)</span>
<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object, start, stop, step, group=&lt;name&gt;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uncollected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.complete"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.complete.html#bluesky.bundlers.RunBundler.complete">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell a flyer, &#39;stop collecting, whenever you are ready&#39;.</span>

<span class="sd">        The flyer returns a status object. Some flyers respond to this</span>
<span class="sd">        command by stopping collection and returning a finished status</span>
<span class="sd">        object immediately. Other flyers finish their given course and</span>
<span class="sd">        finish whenever they finish, irrespective of when this command is</span>
<span class="sd">        issued.</span>

<span class="sd">        Expected message object is::</span>

<span class="sd">            Msg(&#39;complete&#39;, flyer, group=&lt;GROUP&gt;)</span>

<span class="sd">        where &lt;GROUP&gt; is a hashable identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div>

<div class="viewcode-block" id="RunBundler.collect"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.collect.html#bluesky.bundlers.RunBundler.collect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect data cached by a flyer and emit documents.</span>

<span class="sd">        Expect message object is</span>

<span class="sd">            Msg(&#39;collect&#39;, collect_obj)</span>
<span class="sd">            Msg(&#39;collect&#39;, flyer_object, stream=True, return_payload=False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">collect_obj</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_is_open</span><span class="p">:</span>
            <span class="c1"># sanity check -- &#39;kickoff&#39; should catch this and make this</span>
            <span class="c1"># code path impossible</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span>
                <span class="s2">&quot;A &#39;collect&#39; message was sent but no run is open.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uncollected</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">collect_obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">collect_obj</span><span class="p">,</span> <span class="s2">&quot;collect_asset_docs&quot;</span><span class="p">):</span>
            <span class="c1"># Resource and Datum documents</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">collect_obj</span><span class="o">.</span><span class="n">collect_asset_docs</span><span class="p">():</span>
                <span class="c1"># Add a &#39;run_start&#39; field to the resource document on its way out.</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
                    <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;run_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">doc</span><span class="p">)</span>

        <span class="n">collect_obj_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">collect_obj</span><span class="p">,</span> <span class="s2">&quot;read_configuration&quot;</span><span class="p">):</span>
            <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;reading configuration from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">collect_obj</span><span class="p">)</span>
            <span class="n">collect_obj_config</span><span class="p">[</span><span class="n">collect_obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;data_keys&quot;</span><span class="p">:</span> <span class="n">collect_obj</span><span class="o">.</span><span class="n">describe_configuration</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">config_key</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">collect_obj</span><span class="o">.</span><span class="n">read_configuration</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">collect_obj_config</span><span class="p">[</span><span class="n">collect_obj</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">config_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="n">collect_obj_config</span><span class="p">[</span><span class="n">collect_obj</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;timestamps&quot;</span><span class="p">][</span><span class="n">config_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no read_configuration method&quot;</span><span class="p">,</span> <span class="n">collect_obj</span><span class="p">)</span>

        <span class="n">bulk_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">local_descriptors</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># hashed on objs_read, not (name, objs_read)</span>
        <span class="c1"># collect_obj.describe_collect() returns a dictionary like this:</span>
        <span class="c1">#     {name_for_desc1: data_keys_for_desc1,</span>
        <span class="c1">#      name_for_desc2: data_keys_for_desc2, ...}</span>
        <span class="k">for</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">stream_data_keys</span> <span class="ow">in</span> <span class="n">collect_obj</span><span class="o">.</span><span class="n">describe_collect</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">stream_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">:</span>
                <span class="c1"># We do not have an Event Descriptor for this set.</span>
                <span class="n">descriptor_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>
                <span class="n">hints</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">collect_obj</span><span class="p">,</span> <span class="s2">&quot;hints&quot;</span><span class="p">):</span>
                    <span class="n">hints</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">collect_obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">collect_obj</span><span class="o">.</span><span class="n">hints</span><span class="p">})</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">run_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                    <span class="n">data_keys</span><span class="o">=</span><span class="n">stream_data_keys</span><span class="p">,</span>
                    <span class="n">uid</span><span class="o">=</span><span class="n">descriptor_uid</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">stream_name</span><span class="p">,</span>
                    <span class="n">configuration</span><span class="o">=</span><span class="n">collect_obj_config</span><span class="p">,</span>
                    <span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">,</span>
                    <span class="n">object_keys</span><span class="o">=</span><span class="p">{</span><span class="n">collect_obj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">stream_data_keys</span><span class="p">)},</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[descriptor] document is emitted with name </span><span class="si">%r</span><span class="s2"> &quot;</span>
                                 <span class="s2">&quot;containing data keys </span><span class="si">%r</span><span class="s2"> (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span>
                                 <span class="n">stream_data_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                                 <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;descriptor&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                                        <span class="s1">&#39;data_keys&#39;</span><span class="p">:</span> <span class="n">stream_data_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">[</span><span class="n">stream_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_data_keys</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="p">[</span><span class="n">stream_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objs_read</span><span class="p">,</span> <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">[</span><span class="n">stream_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stream_data_keys</span> <span class="o">!=</span> <span class="n">objs_read</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Mismatched objects read, &quot;</span>
                        <span class="s2">&quot;expected </span><span class="si">{!s}</span><span class="s2">, &quot;</span>
                        <span class="s2">&quot;got </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_data_keys</span><span class="p">,</span> <span class="n">objs_read</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="n">descriptor_uid</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span>
            <span class="n">local_descriptors</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">stream_data_keys</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">descriptor_uid</span><span class="p">)</span>

            <span class="n">bulk_data</span><span class="p">[</span><span class="n">descriptor_uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If stream is True, run &#39;event&#39; subscription per document.</span>
        <span class="c1"># If stream is False, run &#39;bulk_events&#39; subscription once.</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># If True, accumulate all the Events in memory and return them at the</span>
        <span class="c1"># end, providing the plan access to the Events. If False, do not</span>
        <span class="c1"># accumulate, and return None.</span>
        <span class="n">return_payload</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_payload&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">collect_obj</span><span class="o">.</span><span class="n">collect</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">return_payload</span><span class="p">:</span>
                <span class="n">payload</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>

            <span class="n">objs_read</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
            <span class="n">stream_name</span><span class="p">,</span> <span class="n">descriptor_uid</span> <span class="o">=</span> <span class="n">local_descriptors</span><span class="p">[</span><span class="n">objs_read</span><span class="p">]</span>
            <span class="n">seq_num</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence_counters</span><span class="p">[</span><span class="n">stream_name</span><span class="p">])</span>

            <span class="n">event_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>

            <span class="n">reading</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
                <span class="n">reading</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">reading</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reading</span>
            <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;descriptor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">descriptor_uid</span>
            <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;seq_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_num</span>
            <span class="n">ev</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_uid</span>

            <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
                <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[event] document is emitted with data keys </span><span class="si">%r</span><span class="s2"> (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
                                 <span class="n">ev</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                                 <span class="n">event_uid</span><span class="p">,</span>
                                 <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                                        <span class="s1">&#39;data_keys&#39;</span><span class="p">:</span> <span class="n">ev</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bulk_data</span><span class="p">[</span><span class="n">descriptor_uid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">DocumentNames</span><span class="o">.</span><span class="n">bulk_events</span><span class="p">,</span> <span class="n">bulk_data</span><span class="p">)</span>
            <span class="n">doc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[bulk events] document is emitted for descriptors (run_uid=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">,</span>
                             <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;doc_name&#39;</span><span class="p">:</span> <span class="s1">&#39;bulk_events&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;run_uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uid</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">return_payload</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">payload</span></div>

<div class="viewcode-block" id="RunBundler.backstop_collect"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.backstop_collect.html#bluesky.bundlers.RunBundler.backstop_collect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">backstop_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uncollected</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">Msg</span><span class="p">(</span><span class="s2">&quot;collect&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to collect </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunBundler.configure"><a class="viewcode-back" href="../../generated/bluesky.bundlers.RunBundler.configure.html#bluesky.bundlers.RunBundler.configure">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure an object</span>

<span class="sd">        Expected message object is ::</span>

<span class="sd">            Msg(&#39;configure&#39;, object, *args, **kwargs)</span>

<span class="sd">        which results in this call ::</span>

<span class="sd">            object.configure(*args, **kwargs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span>
        <span class="c1"># Invalidate any event descriptors that include this object.</span>
        <span class="c1"># New event descriptors, with this new configuration, will</span>
        <span class="c1"># be created for any future event documents.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">):</span>
            <span class="n">obj_set</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">obj_set</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_config</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015, Brookhaven National Lab

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>