

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Recording Metadata &mdash; bluesky 1.6.0rc2.post85+g383ed1d documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'1.6.0rc2.post85+g383ed1d',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Live Visualization and Processing" href="callbacks.html" />
    <link rel="prev" title="Documents" href="documents.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> bluesky
          

          
          </a>

          
            
            
              <div class="version">
                1.6.0rc2.post85+g383ed1d
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="plans.html">Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="documents.html">Documents</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Recording Metadata</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#interactively-for-one-use">1. Interactively, for One Use</a></li>
<li class="toctree-l2"><a class="reference internal" href="#through-a-plan">2. Through a plan</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automatically">3. Automatically</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interactively-for-repeated-use">4. Interactively, for Repeated Use</a></li>
<li class="toctree-l2"><a class="reference internal" href="#persistence-between-sessions">Persistence Between Sessions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#allowed-data-types">Allowed Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="#special-fields">Special Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="#required-fields">Required Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="#metadata-validator">Metadata Validator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="callbacks.html">Live Visualization and Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="state-machine.html">Interruptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulation.html">Simulation and Error Checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="progress-bar.html">Progress Bar</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_descriptors.html">Event Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="async.html">Asynchronous Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging and Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="run_engine_api.html">RunEngine API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="magics.html">IPython ‘Magics’ [Experimental]</a></li>
<li class="toctree-l1"><a class="reference internal" href="from-pyepics-to-bluesky.html">Translating Direct PyEpics Code to Bluesky Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="comparison-with-spec.html">Comparison with SPEC</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">How Bluesky Interfaces with Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="msg.html">Message Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="run_engine.html">The RunEngine run loop</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_changes.html">Release History</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/amostra">amostra</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/datamuxer">datamuxer</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/suitcase">suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">bluesky</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Recording Metadata</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/metadata.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="recording-metadata">
<h1>Recording Metadata<a class="headerlink" href="#recording-metadata" title="Permalink to this headline">¶</a></h1>
<p>Capturing useful metadata is the main objective of bluesky. The more
information you can provide about what you are doing and why you are doing it,
the more useful bluesky and downstream data search and analysis tools can be.</p>
<p>When the RunEngine executes a plan, it attaches metadata to the data it
collects. It captures metadata that has been:</p>
<ol class="arabic simple">
<li>entered interactively by the user at execution time</li>
<li>provided in the code of the <em>plan</em></li>
<li>automatically inferred</li>
<li>entered by user once and stashed for reuse on all future plans</li>
</ol>
<p>If there is a conflict between these sources, the first entry in this list
wins.</p>
<div class="section" id="interactively-for-one-use">
<h2>1. Interactively, for One Use<a class="headerlink" href="#interactively-for-one-use" title="Permalink to this headline">¶</a></h2>
<p>Suppose we are executing some custom plan called <code class="docutils literal"><span class="pre">plan</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">())</span>
</pre></div>
</div>
<p>If we give arbitrary extra keyword arguments to <code class="docutils literal"><span class="pre">RE</span></code>, they will be
interpreted as metadata.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;calibration&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="documents.html#run-overview"><span class="std std-ref">run(s)</span></a> — i.e., datasets — generated by <code class="docutils literal"><span class="pre">plan()</span></code>
will include the custom metadata:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;calibration&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">plan</span></code> generates more that one run, all the runs will get this metadata.
For example, this plan generates three different runs.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">scan</span>
<span class="kn">from</span> <span class="nn">ophyd.sim</span> <span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">,</span> <span class="n">motor</span>  <span class="c1"># simulated detectors, motor</span>

<span class="k">def</span> <span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
</pre></div>
</div>
<p>If executed as above:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;calibration&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>each run will get a copy of the sample_id, purpose and operator metadata.</p>
</div>
<div class="section" id="through-a-plan">
<h2>2. Through a plan<a class="headerlink" href="#through-a-plan" title="Permalink to this headline">¶</a></h2>
<p>Revisiting the previous example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
</pre></div>
</div>
<p>we can pass different metadata for each run. Every
<a class="reference internal" href="plans.html#preassembled-plans"><span class="std std-ref">built-in pre-assembled plan</span></a> accepts a parameter
<code class="docutils literal"><span class="pre">md</span></code>, which you can use to inject metadata that applies only to that plan.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;calibration&#39;</span><span class="p">})</span>  <span class="c1"># one</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;good data&#39;</span><span class="p">})</span>  <span class="c1"># two</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;sanity check&#39;</span><span class="p">})</span>  <span class="c1"># three</span>
</pre></div>
</div>
<p>The metadata passed into <code class="docutils literal"><span class="pre">RE</span></code> is combined with the metadata passed in to each
plan. Thus, calling</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>generates these three sets of metadata:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># one</span>
<span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;calibration&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>

<span class="c1"># two</span>
<span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;good data&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>

<span class="c1"># three</span>
<span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;sanity check&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>
</pre></div>
</div>
<p>If there is a conflict, <code class="docutils literal"><span class="pre">RE</span></code> keywords takes precedence. So</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>would override the individual ‘purpose’ metadata from the plan, marking all
three as purpose=test.</p>
<p>For more on injecting metadata via plans, refer to
<a class="reference internal" href="tutorial.html#tutorial-plan-metadata"><span class="std std-ref">this section</span></a> of the tutorial.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>All of the built-in plans provide certain metadata automatically. Custom
plans are not <em>required</em> to provide any of this, but it is a nice pattern
to follow.</p>
<ul class="simple">
<li>plan_name — e.g., <code class="docutils literal"><span class="pre">'scan'</span></code></li>
<li>detectors — a list of the names of the detectors</li>
<li>motors — a list of the names of the motors</li>
<li>plan_args — dict of keyword arguments passed to the plan</li>
<li>plan_pattern – function used to create the trajectory</li>
<li>plan_pattern_module — Python module where <code class="docutils literal"><span class="pre">plan_pattern</span></code> is defined</li>
<li>plan_pattern_args — dict of keyword arguments passed to
<code class="docutils literal"><span class="pre">plan_pattern</span></code> to create the trajectory</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">plan_name</span></code> and <code class="docutils literal"><span class="pre">plan_args</span></code> together should provide sufficient
information to recreate the plan. The <code class="docutils literal"><span class="pre">detectors</span></code> and <code class="docutils literal"><span class="pre">motors</span></code> are
convenient keys to search on later.</p>
<p>The <code class="docutils literal"><span class="pre">plan_pattern*</span></code> entries provide lower-level, more explicit
information about the <em>trajectory</em> (“pattern”) generated by the plan,
separate from the specific detectors and motors involved. For complex
trajectories like spirals, this is especially useful. As a simple example,
here is the pattern-related metadata for <a class="reference internal" href="generated/bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal"><span class="pre">scan()</span></code></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="s1">&#39;plan_pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;linspace&#39;</span><span class="p">,</span>
<span class="s1">&#39;plan_pattern_module&#39;</span><span class="p">:</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
<span class="s1">&#39;plan_pattern_args&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Thus, one can re-create the “pattern” (trajectory) like so:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="automatically">
<h2>3. Automatically<a class="headerlink" href="#automatically" title="Permalink to this headline">¶</a></h2>
<p>For each run, the RunEngine automatically records:</p>
<ul class="simple">
<li>‘time’ — In this context, the start time. (Other times are also recorded.)</li>
<li>‘uid’ — a globally unique ID for this run</li>
<li>‘plan_name’ — the function or class name of <code class="docutils literal"><span class="pre">plan</span></code> (e.g., ‘count’)</li>
<li>‘plan_type’— e.g., the Python type of <code class="docutils literal"><span class="pre">plan</span></code> (e.g., ‘generator’)</li>
</ul>
<p>The last two can be overridden by any of the methods above. The first two
cannot be overridden by the user.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If some custom plan does not specify a ‘plan_name’ and ‘plan_type’, the
RunEngine infers them as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">plan_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
<span class="n">plan_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">These may be more or less informative depending on what <code class="docutils literal"><span class="pre">plan</span></code> is. They
are just heuristics to provide <em>some</em> information by default if the plan
itself and the user do not provide it.</p>
</div>
</div>
<div class="section" id="interactively-for-repeated-use">
<h2>4. Interactively, for Repeated Use<a class="headerlink" href="#interactively-for-repeated-use" title="Permalink to this headline">¶</a></h2>
<p>Each time a plan is executed, the current contents of <code class="docutils literal"><span class="pre">RE.md</span></code> are copied into
the metadata for all runs generated by the plan.  To enter metadata once to
reuse on all plans, add it to <code class="docutils literal"><span class="pre">RE.md</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;proposal_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123456</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flying cars&#39;</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>View its current contents,</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span>
</pre></div>
</div>
<p>delete a key you want to stop using,</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>   <span class="c1"># delete a key</span>
</pre></div>
</div>
<p>or use any of the standard methods that apply to
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#typesmapping">dictionaries in Python</a>.</p>
<p>The <code class="docutils literal"><span class="pre">scan_id</span></code>, an integer that the RunEngine automatically increments at the
beginning of each scan, is stored in <code class="docutils literal"><span class="pre">RE.md['scan_id']</span></code>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Clearing all keys, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># clear *all* keys</span>
</pre></div>
</div>
<p>will reset the <code class="docutils literal"><span class="pre">scan_id</span></code>. The next time a plan is executed, the
RunEngine will start with a <code class="docutils literal"><span class="pre">scan_id</span></code> of 1 and set</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;scan_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Some readers may prefer to reset the scan ID to 1 at the beginning of a new
experiment; others way wish to maintain a single unbroken sequence of scan
IDs forever.</p>
<p class="last">From a technical standpoint, it is fine to have duplicate scan IDs. All
runs also have randomly-generated ‘uid’ (“unique ID”) which is globally
unique forever.</p>
</div>
</div>
<div class="section" id="persistence-between-sessions">
<h2>Persistence Between Sessions<a class="headerlink" href="#persistence-between-sessions" title="Permalink to this headline">¶</a></h2>
<p>We provide a way to save the contents of the metadata stash <code class="docutils literal"><span class="pre">RE.md</span></code> between
sessions (e.g., exiting and re-opening IPython).</p>
<p>In general, the <code class="docutils literal"><span class="pre">RE.md</span></code> attribute may be anything that supports the
dictionary interface. The simplest is just a plain Python dictionary.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
<p>To persist metadata between sessions, bluesky recommends
<code class="xref py py-class docutils literal"><span class="pre">bluesky.utils.PersistentDict</span></code> — a Python dictionary synced with a
directory of files on disk. Any changes made to <code class="docutils literal"><span class="pre">RE.md</span></code> are synced to the
file, so the contents of <code class="docutils literal"><span class="pre">RE.md</span></code> can persist between sessions.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.utils</span> <span class="kn">import</span> <span class="n">PersistentDict</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">PersistentDict</span><span class="p">(</span><span class="s1">&#39;some/path/here&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Bluesky does not provide a strong recommendation on that path; that a detail
left to the local deployment.</p>
<p>Bluesky formerly recommended using <code class="xref py py-class docutils literal"><span class="pre">HistoryDict</span></code> — a
Python dictionary backed by a sqlite database file. This approach proved
problematic with the threading introduced in bluesky v1.6.0, so it is no longer
recommended. If you have been following that recommendation, you should migrate
your metadata from <cite>~historydict.HistoryDict</cite> to
<code class="xref py py-class docutils literal"><span class="pre">PersistentDict</span></code>. First, update your configuration to
make <code class="docutils literal"><span class="pre">RE.md</span></code> a <code class="xref py py-class docutils literal"><span class="pre">PersistentDict</span></code> as shown above. Then,
migrate like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">old_md</span> <span class="o">=</span> <span class="n">get_history</span><span class="p">()</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_md</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>The <code class="docutils literal"><span class="pre">RE.md</span></code> object can also be set when the RunEngine is instantiated:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># This:</span>
<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># is equivalent to this:</span>
<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">({})</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
</div>
<p class="last">As we stated
<a class="reference internal" href="tutorial.html#tutorial-run-engine-setup"><span class="std std-ref">at the start of the tutorial</span></a>, if you are
using bluesky at a user facility or with shared configuration, your
<code class="docutils literal"><span class="pre">RE</span></code> may already be configured, and defining a new <code class="docutils literal"><span class="pre">RE</span></code> as above can
result in data loss! If you aren’t sure, it’s safer to use <code class="docutils literal"><span class="pre">RE.md</span> <span class="pre">=</span> <span class="pre">...</span></code>.</p>
</div>
</div>
<div class="section" id="allowed-data-types">
<h2>Allowed Data Types<a class="headerlink" href="#allowed-data-types" title="Permalink to this headline">¶</a></h2>
<p>Custom metadata keywords can be mapped to:</p>
<ul class="simple">
<li>strings — e.g., <code class="docutils literal"><span class="pre">task='calibration'</span></code></li>
<li>numbers — e.g., <code class="docutils literal"><span class="pre">attempt=5</span></code></li>
<li>lists or tuples — e.g., <code class="docutils literal"><span class="pre">dimensions=[1,</span> <span class="pre">3]</span></code></li>
<li>(nested) dictionaries — e.g., <code class="docutils literal"><span class="pre">dimensions={'width':</span> <span class="pre">1,</span> <span class="pre">'height':</span> <span class="pre">3}</span></code></li>
</ul>
</div>
<div class="section" id="special-fields">
<h2>Special Fields<a class="headerlink" href="#special-fields" title="Permalink to this headline">¶</a></h2>
<p>Arbitrary custom fields are allowed — you can invent any names that are
useful to you.</p>
<p>But certain fields are given special significance by bluesky’s document model,
and are either disallowed are required to be a certain type.</p>
<p>The fields:</p>
<ul class="simple">
<li><strong>owner</strong></li>
<li><strong>group</strong></li>
<li><strong>project</strong></li>
</ul>
<p>are optional but, to facilitate searchability, if they are not blank they must
be strings. A non-string, like <code class="docutils literal"><span class="pre">owner=5</span></code> will produce an error that will
interrupt scan execution immediately after it starts.</p>
<p>Similarly, the keyword <strong>sample</strong> has special significance. It must be either a
string or a dictionary.</p>
<p>The <strong>scan_id</strong> field is expected to be an integer, and it is automatically
incremented between runs. If a scan_id is not provided by the user or stashed
in the persistent metadata from the previous run, it defaults to 1.</p>
<p>The fields:</p>
<ul class="simple">
<li><strong>uid</strong></li>
<li><strong>time</strong></li>
</ul>
<p>are reserved by the document model and cannot be set by the user.</p>
</div>
<div class="section" id="required-fields">
<h2>Required Fields<a class="headerlink" href="#required-fields" title="Permalink to this headline">¶</a></h2>
<p>In current versions of bluesky, <strong>no fields are universally required by bluesky
itself</strong>. It is possible specify your own required fields in local
configuration. See <a class="reference internal" href="#md-validator"><span class="std std-ref">Metadata Validator</span></a>. (At NSLS-II, there are facility-wide
requirements coming soon.)</p>
</div>
<div class="section" id="metadata-validator">
<span id="md-validator"></span><h2>Metadata Validator<a class="headerlink" href="#metadata-validator" title="Permalink to this headline">¶</a></h2>
<p>Additional, customized metadata validation can be added to the RunEngine.
For example, to ensure that a run will not be executed unless the parameter
‘sample_number’ is specified, define a function that accepts a dictionary
argument and raises if ‘sample_number’ is not found.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ensure_sample_number</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;sample_number&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You forgot the sample number.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Apply this function by setting</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md_validator</span> <span class="o">=</span> <span class="n">ensure_sample_number</span>
</pre></div>
</div>
<p>The function will be executed immediately before each new run in opened.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="callbacks.html" class="btn btn-neutral float-right" title="Live Visualization and Processing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="documents.html" class="btn btn-neutral float-left" title="Documents" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>