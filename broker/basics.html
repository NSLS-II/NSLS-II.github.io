
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>DataBroker Basics &mdash; NSLS-II Controls Docs 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bnl-styles.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="NSLS-II Controls Docs 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="Installation" href="../install.html" />
    <link rel="prev" title="Simple Python Interface to The Olog" href="../pyolog/pyolog.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          NSLS-II Controls Docs</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ophyd/cli_api.html">Command line interface to Ophyd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ophyd/scan_api.html">Step Scan Interface to Ophyd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyolog/pyolog.html">Simple Python Interface to The Olog</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">DataBroker Basics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filestore/index.html">Introduction to File Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch/arch.html">NSLS-II Beamline Controls Architecture</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">DataBroker Basics</a><ul>
<li><a class="reference internal" href="#what-is-the-data-broker">What is the Data Broker?</a></li>
<li><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li><a class="reference internal" href="#basic-example-plotting-the-most-recent-scan">Basic Example: Plotting The Most Recent Scan</a><ul>
<li><a class="reference internal" href="#looking-at-a-scan">Looking at a Scan</a></li>
<li><a class="reference internal" href="#getting-the-data-in-its-rawest-form">Getting the Data in its Rawest Form</a></li>
<li><a class="reference internal" href="#putting-the-data-into-a-more-useful-form">Putting the Data into a More Useful Form</a></li>
<li><a class="reference internal" href="#exporting-the-data-for-use-outside-of-python">Exporting the Data for Use Outside of Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#more-ways-to-look-up-scans">More Ways to Look Up Scans</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../pyolog/pyolog.html" title="Previous Chapter: Simple Python Interface to The Olog"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Simple Python In...</span>
    </a>
  </li>
  <li>
    <a href="../install.html" title="Next Chapter: Installation"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Installation &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/broker/basics.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="databroker-basics">
<h1>DataBroker Basics<a class="headerlink" href="#databroker-basics" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-the-data-broker">
<h2>What is the Data Broker?<a class="headerlink" href="#what-is-the-data-broker" title="Permalink to this headline">¶</a></h2>
<p>The Data Broker prodives one interface for retrieving data from all sources.</p>
<p>You, the user, don&#8217;t have to know where the data is stored or in what format
it is stored. The Data Broker returns all the data in one simply-structured
bundle. All measurements are given as standard Python data types (integer,
float, or string) or numpy arrays.</p>
</div>
<div class="section" id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>This demonstrates the basic usage with minimal explanation. To understand what
is being done, read the next section.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [1]: </span><span class="kn">from</span> <span class="nn">dataportal.broker</span> <span class="kn">import</span> <span class="n">DataBroker</span>

<span class="gp">In [2]: </span><span class="kn">from</span> <span class="nn">dataportal.muxer</span> <span class="kn">import</span> <span class="n">DataMuxer</span>

<span class="gp">In [3]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># get most recent run</span>

<span class="gp">In [4]: </span><span class="n">events</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="o">.</span><span class="n">fetch_events</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

<span class="gp">In [5]: </span><span class="n">dm</span> <span class="o">=</span> <span class="n">DataMuxer</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

<span class="gp">In [6]: </span><span class="n">dm</span><span class="o">.</span><span class="n">sources</span>  <span class="c"># to review list of data sources</span>
<span class="gh">Out[6]: </span><span class="go">{u&#39;Tsam&#39;: u&#39;PV:ES:Tsam&#39;, u&#39;point_det&#39;: u&#39;PV:ES:PointDet&#39;}</span>
</pre></div>
</div>
<p>You can plot individual data sources against time...</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [7]: </span><span class="n">dm</span><span class="p">[</span><span class="s">&#39;Tsam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>  <span class="c"># or the name of any data source</span>
<span class="gh">Out[7]: </span><span class="go">&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fce7d209cd0&gt;</span>
</pre></div>
</div>
<p>Or bin the data to plot sources against each other...</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [8]: </span><span class="n">binned_data</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">bin_on</span><span class="p">(</span><span class="s">&#39;point_det&#39;</span><span class="p">)</span>

<span class="gp">In [9]: </span><span class="n">binned_data</span>
<span class="gh">Out[9]: </span><span class="go"></span>
<span class="go">                Tsam       point_det</span>
<span class="go">                 val count   val_raw</span>
<span class="go">-0.004225   0.176405     1  0.441227</span>
<span class="go"> 1.009964        NaN     0 -0.330870</span>
<span class="go"> 2.007124        NaN     0  2.430771</span>
<span class="go"> 3.000591        NaN     0 -0.252092</span>
<span class="go"> 3.996367        NaN     0  0.109610</span>
<span class="go"> 5.000033        NaN     0  1.582481</span>
<span class="go"> 5.998941        NaN     0 -0.909232</span>
<span class="go"> 7.007931        NaN     0 -0.591637</span>
<span class="go"> 7.993684        NaN     0  0.187603</span>
<span class="go"> 8.999938        NaN     0 -0.329870</span>
<span class="go"> 9.998989        NaN     0 -1.192765</span>
<span class="go"> 10.999477  1.145427     1 -0.204877</span>
<span class="go"> 12.002492       NaN     0 -0.358829</span>
<span class="go"> 13.001977       NaN     0  0.603472</span>
<span class="go"> 14.013348       NaN     0 -1.664789</span>
<span class="go"> 14.999131       NaN     0 -0.700179</span>
<span class="go"> 16.015615  2.149408     1  1.151391</span>
<span class="go"> 16.996941       NaN     0  1.857331</span>
<span class="go"> 17.995223       NaN     0 -1.511180</span>
<span class="go"> 19.001007       NaN     0  0.644848</span>
<span class="go"> 20.003554       NaN     0 -0.980608</span>
<span class="go"> 21.002696       NaN     0 -0.856853</span>
<span class="go"> 22.012920       NaN     0 -0.871879</span>

<span class="gp">In [10]: </span><span class="n">binned_data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&#39;Tsam&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&#39;point_det&#39;</span><span class="p">)</span>
<span class="gh">Out[10]: </span><span class="go">&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fce7d1c4450&gt;</span>
</pre></div>
</div>
<p>And you can easily export to common formats. Among them:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [11]: </span><span class="n">binned_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">&#39;myfile.csv&#39;</span><span class="p">)</span>

<span class="gp">In [12]: </span><span class="n">binned_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s">&#39;myfile.xlsx&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="basic-example-plotting-the-most-recent-scan">
<h2>Basic Example: Plotting The Most Recent Scan<a class="headerlink" href="#basic-example-plotting-the-most-recent-scan" title="Permalink to this headline">¶</a></h2>
<div class="section" id="looking-at-a-scan">
<h3>Looking at a Scan<a class="headerlink" href="#looking-at-a-scan" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s inspect the most recent run. To get the Nth most recent run,
type <tt class="docutils literal"><span class="pre">DataBroker[-N]</span></tt>.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [13]: </span><span class="kn">from</span> <span class="nn">dataportal.broker</span> <span class="kn">import</span> <span class="n">DataBroker</span>

<span class="gp">In [14]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>What we get is a Header, a dictionary-like (for C programmers, struct-like)
object with all the information pertaining to a run. We can explore its
contents by typing <tt class="docutils literal"><span class="pre">header.</span></tt> &lt;tab&gt; or using the built-in Python function
<tt class="docutils literal"><span class="pre">vars</span></tt>.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [15]: </span><span class="nb">vars</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
<span class="gh">Out[15]: </span><span class="go"></span>
<span class="go">{&#39;_fields&#39;: {&#39;beamline_config&#39;,</span>
<span class="go">  &#39;beamline_id&#39;,</span>
<span class="go">  &#39;event_descriptors&#39;,</span>
<span class="go">  &#39;exit_reason&#39;,</span>
<span class="go">  &#39;exit_status&#39;,</span>
<span class="go">  &#39;group&#39;,</span>
<span class="go">  &#39;owner&#39;,</span>
<span class="go">  &#39;project&#39;,</span>
<span class="go">  &#39;run_start_id&#39;,</span>
<span class="go">  &#39;run_start_uid&#39;,</span>
<span class="go">  &#39;run_stop_id&#39;,</span>
<span class="go">  &#39;run_stop_uid&#39;,</span>
<span class="go">  &#39;sample&#39;,</span>
<span class="go">  &#39;scan_id&#39;,</span>
<span class="go">  &#39;start_datetime&#39;,</span>
<span class="go">  &#39;start_time&#39;,</span>
<span class="go">  &#39;stop_datetime&#39;,</span>
<span class="go">  &#39;stop_time&#39;},</span>
<span class="go"> &#39;_name&#39;: &#39;Header&#39;,</span>
<span class="go"> &#39;beamline_config&#39;: &lt;BeamlineConfig Document&gt;,</span>
<span class="go"> &#39;beamline_id&#39;: u&#39;example&#39;,</span>
<span class="go"> &#39;event_descriptors&#39;: [&lt;EventDescriptor Document&gt;, &lt;EventDescriptor Document&gt;],</span>
<span class="go"> &#39;exit_reason&#39;: None,</span>
<span class="go"> &#39;exit_status&#39;: u&#39;success&#39;,</span>
<span class="go"> &#39;group&#39;: None,</span>
<span class="go"> &#39;owner&#39;: u&#39;nedbrainard&#39;,</span>
<span class="go"> &#39;project&#39;: None,</span>
<span class="go"> &#39;run_start_id&#39;: &#39;5501cd8e431b4944f240b7ea&#39;,</span>
<span class="go"> &#39;run_start_uid&#39;: u&#39;c5fa9005-f215-4321-9d71-f778f8c5ab84&#39;,</span>
<span class="go"> &#39;run_stop_id&#39;: &#39;5501cd8e431b4944f240b807&#39;,</span>
<span class="go"> &#39;run_stop_uid&#39;: u&#39;ff7310b9-994c-4c5d-8d0b-9c3930225a13&#39;,</span>
<span class="go"> &#39;sample&#39;: {},</span>
<span class="go"> &#39;scan_id&#39;: 5,</span>
<span class="go"> &#39;start_datetime&#39;: datetime.datetime(1969, 12, 31, 19, 0, 4),</span>
<span class="go"> &#39;start_time&#39;: 4.0,</span>
<span class="go"> &#39;stop_datetime&#39;: datetime.datetime(1969, 12, 31, 19, 0, 22, 12920),</span>
<span class="go"> &#39;stop_time&#39;: 22.012919633833878}</span>
</pre></div>
</div>
<p>For example, to inspect the owner of the run,</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [16]: </span><span class="n">header</span><span class="o">.</span><span class="n">owner</span>
<span class="gh">Out[16]: </span><span class="go">u&#39;nedbrainard&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-the-data-in-its-rawest-form">
<h3>Getting the Data in its Rawest Form<a class="headerlink" href="#getting-the-data-in-its-rawest-form" title="Permalink to this headline">¶</a></h3>
<p>The Header does not contain any of the actual measurements from a run. To get
the data itself, pass <tt class="docutils literal"><span class="pre">header</span></tt> (or a list of several Headers) to <tt class="docutils literal"><span class="pre">fetch_events</span></tt>:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [17]: </span><span class="n">events</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="o">.</span><span class="n">fetch_events</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
</pre></div>
</div>
<p>The result is a list of Events, each one representing a measurement or
measurements that took place at a given time. (Exactly what we mean
by &#8220;Event&#8221; and &#8220;a given time&#8221; is documented elsewhere in both medium and
excruciating detail.)</p>
<p>Consider this an intermediate step. The data is structured in a generic way
that is wonderfully fleixble but not especially convenient. To get a more
useful view of the data, read on.</p>
</div>
<div class="section" id="putting-the-data-into-a-more-useful-form">
<h3>Putting the Data into a More Useful Form<a class="headerlink" href="#putting-the-data-into-a-more-useful-form" title="Permalink to this headline">¶</a></h3>
<p>One level above the DataBroker sits the DataMuxer, an object for merging and
aligning streams of Events from mamy sources into a table. Build a DataMuxer
like so:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [18]: </span><span class="kn">from</span> <span class="nn">dataportal.muxer</span> <span class="kn">import</span> <span class="n">DataMuxer</span>

<span class="gp">In [19]: </span><span class="n">dm</span> <span class="o">=</span> <span class="n">DataMuxer</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">events</span></tt> can be from one scan or from many scans together. Then, the
simplest task is to simply look at the data from one source &#8211; say, sample
temperature.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [20]: </span><span class="n">dm</span><span class="p">[</span><span class="s">&#39;Tsam&#39;</span><span class="p">]</span>
<span class="gh">Out[20]: </span><span class="go"></span>
<span class="go">epoch_time</span>
<span class="go">16            2.149408</span>
<span class="go">11            1.145427</span>
<span class="go">0             0.176405</span>
<span class="go">Name: Tsam, dtype: float64</span>
</pre></div>
</div>
<p>Incidentally, to save a litte typing, <tt class="docutils literal"><span class="pre">dm.Tsam</span></tt> accomplishes the same thing.
At any rate, the output gives the measured data at each time.</p>
<p>Next, let&#8217;s obtain a table showing data from multiple sources. Strictly
speaking, measurements recorded by different equipment are not in general
synchronized, but in practice one usually ignores small differences in time.
For instance, we might want to plot &#8220;temperature&#8221; versus &#8220;intensity&#8221; even if
the temperature and intesity sensors never happened to take a simultaneous
measurement. Doing so, we would be implicitly <em>binning</em> those measurements
in time.</p>
<p>Therefore, plotting one dependent variable against another usually requires
binning to effectively &#8220;align&#8221; the measurements against each other in time.
This is the problem that DataMuxer is designed to solve. On the simplest level,
it takes the stream of events and creates the table of data you probably
expected in the first place. But it is also capable of fully exploiting the
asynchronous stream of measurements, grouping them in different ways to answer
different questions.</p>
<p>To begin, we bin the data by centering one bin at each  <tt class="docutils literal"><span class="pre">point_det</span></tt>
measurement.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [21]: </span><span class="n">binned_data</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">bin_on</span><span class="p">(</span><span class="s">&#39;point_det&#39;</span><span class="p">)</span>

<span class="gp">In [22]: </span><span class="n">binned_data</span>
<span class="gh">Out[22]: </span><span class="go"></span>
<span class="go">                Tsam       point_det</span>
<span class="go">                 val count   val_raw</span>
<span class="go">-0.004225   0.176405     1  0.441227</span>
<span class="go"> 1.009964        NaN     0 -0.330870</span>
<span class="go"> 2.007124        NaN     0  2.430771</span>
<span class="go"> 3.000591        NaN     0 -0.252092</span>
<span class="go"> 3.996367        NaN     0  0.109610</span>
<span class="go"> 5.000033        NaN     0  1.582481</span>
<span class="go"> 5.998941        NaN     0 -0.909232</span>
<span class="go"> 7.007931        NaN     0 -0.591637</span>
<span class="go"> 7.993684        NaN     0  0.187603</span>
<span class="go"> 8.999938        NaN     0 -0.329870</span>
<span class="go"> 9.998989        NaN     0 -1.192765</span>
<span class="go"> 10.999477  1.145427     1 -0.204877</span>
<span class="go"> 12.002492       NaN     0 -0.358829</span>
<span class="go"> 13.001977       NaN     0  0.603472</span>
<span class="go"> 14.013348       NaN     0 -1.664789</span>
<span class="go"> 14.999131       NaN     0 -0.700179</span>
<span class="go"> 16.015615  2.149408     1  1.151391</span>
<span class="go"> 16.996941       NaN     0  1.857331</span>
<span class="go"> 17.995223       NaN     0 -1.511180</span>
<span class="go"> 19.001007       NaN     0  0.644848</span>
<span class="go"> 20.003554       NaN     0 -0.980608</span>
<span class="go"> 21.002696       NaN     0 -0.856853</span>
<span class="go"> 22.012920       NaN     0 -0.871879</span>
</pre></div>
</div>
<p>Wherever there is <tt class="docutils literal"><span class="pre">point_det</span></tt> measurement but no <tt class="docutils literal"><span class="pre">Tsam</span></tt> measurement within
the time window, NaN indicates the missing data. (You may object that &#8220;NaN&#8221;
is not really the same as &#8220;missing.&#8221; This is a convention borrowed from the
widely-used pandas package, and the reasons for using NaN to mean &#8220;missing&#8221;
have to do with the limitations of numpy in handling missing data.)</p>
<p>The <tt class="docutils literal"><span class="pre">count</span></tt> sub-column indicates the number of <tt class="docutils literal"><span class="pre">Tsam</span></tt> measurements in
each bin. There is exactly one <tt class="docutils literal"><span class="pre">point_det</span></tt> measurement in every bin, by
definition, so no <tt class="docutils literal"><span class="pre">count</span></tt> is shown there.</p>
<p>Sometimes, one can interpolate the missing values according to some rule, such
as linear interpolation.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [23]: </span><span class="n">binned_data</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">bin_on</span><span class="p">(</span><span class="s">&#39;point_det&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Tsam&#39;</span><span class="p">:</span> <span class="s">&#39;linear&#39;</span><span class="p">})</span>

<span class="gp">In [24]: </span><span class="n">binned_data</span>
<span class="gh">Out[24]: </span><span class="go"></span>
<span class="go">                 Tsam       point_det</span>
<span class="go">           val_linear count   val_raw</span>
<span class="go">-0.004225    0.176405     1  0.441227</span>
<span class="go"> 1.009964    0.265376     0 -0.330870</span>
<span class="go"> 2.007124    0.353219     0  2.430771</span>
<span class="go"> 3.000591    0.440736     0 -0.252092</span>
<span class="go"> 3.996367    0.528457     0  0.109610</span>
<span class="go"> 5.000033    0.616873     0  1.582481</span>
<span class="go"> 5.998941    0.704869     0 -0.909232</span>
<span class="go"> 7.007931    0.793754     0 -0.591637</span>
<span class="go"> 7.993684    0.880592     0  0.187603</span>
<span class="go"> 8.999938    0.969236     0 -0.329870</span>
<span class="go"> 9.998989    1.057245     0 -1.192765</span>
<span class="go"> 10.999477   1.145427     1 -0.204877</span>
<span class="go"> 12.002492   1.346724     0 -0.358829</span>
<span class="go"> 13.001977   1.547416     0  0.603472</span>
<span class="go"> 14.013348   1.750496     0 -1.664789</span>
<span class="go"> 14.999131   1.948437     0 -0.700179</span>
<span class="go"> 16.015615   2.149408     1  1.151391</span>
<span class="go"> 16.996941        NaN     0  1.857331</span>
<span class="go"> 17.995223        NaN     0 -1.511180</span>
<span class="go"> 19.001007        NaN     0  0.644848</span>
<span class="go"> 20.003554        NaN     0 -0.980608</span>
<span class="go"> 21.002696        NaN     0 -0.856853</span>
<span class="go"> 22.012920        NaN     0 -0.871879</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">count</span></tt> column, still present, indicates which values are measured (1)
and which are interpolated (0).</p>
<p>If instead we bin the other way, defining one bin per <tt class="docutils literal"><span class="pre">Tsam</span></tt> data point,
we must provide a rule for combining multiple <tt class="docutils literal"><span class="pre">point_det</span></tt> measurements in
the same bin into one representative value. Now, along with the <tt class="docutils literal"><span class="pre">count</span></tt>
sub-column, other summary statistics are automatically generated.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [25]: </span><span class="n">binned_data</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">bin_on</span><span class="p">(</span><span class="s">&#39;Tsam&#39;</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;point_det&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">})</span>

<span class="gp">In [26]: </span><span class="n">binned_data</span>
<span class="gh">Out[26]: </span><span class="go"></span>
<span class="go">        Tsam                             point_det                            \</span>
<span class="go">     val_raw val_&lt;function mean at 0x7fce86c65c80&gt; count       std       max   </span>
<span class="go">0   0.176405                              0.663521     6  1.109149  2.430771   </span>
<span class="go">11  1.145427                             -0.349517     8  0.573342  0.603472   </span>
<span class="go">16  2.149408                             -0.325769     9  1.236804  1.857331   </span>

<span class="go">              </span>
<span class="go">         min  </span>
<span class="go">0  -0.330870  </span>
<span class="go">11 -1.192765  </span>
<span class="go">16 -1.664789  </span>
</pre></div>
</div>
<p>To discard the extra statistics and keep the values only, use this syntax.
(<tt class="docutils literal"><span class="pre">xs</span></tt> stands for cross-section, a sophisticated pandas method.)</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [27]: </span><span class="n">binned_data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-27-86beb7b60a6d&gt;</span> in <span class="ni">&lt;module&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">binned_data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/core/generic.pyc</span> in <span class="ni">xs</span><span class="nt">(self, key, axis, level, copy, drop_level)</span>
<span class="g-Whitespace">   </span><span class="mi">1417</span>         <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="g-Whitespace">   </span><span class="mi">1418</span>             <span class="n">loc</span><span class="p">,</span> <span class="n">new_ax</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">get_loc_level</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">1419</span>                                                <span class="n">drop_level</span><span class="o">=</span><span class="n">drop_level</span><span class="p">)</span>
<span class="g-Whitespace">   </span><span class="mi">1420</span> 
<span class="g-Whitespace">   </span><span class="mi">1421</span>             <span class="c"># convert to a label indexer if needed</span>

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/core/index.pyc</span> in <span class="ni">get_loc_level</span><span class="nt">(self, key, level, drop_level)</span>
<span class="g-Whitespace">   </span><span class="mi">4303</span>                                                    <span class="n">drop_level</span><span class="p">)</span>
<span class="g-Whitespace">   </span><span class="mi">4304</span>         <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">4305</span>             <span class="n">indexer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_level_indexer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
<span class="g-Whitespace">   </span><span class="mi">4306</span>             <span class="k">return</span> <span class="n">indexer</span><span class="p">,</span> <span class="n">_maybe_drop_levels</span><span class="p">(</span><span class="n">indexer</span><span class="p">,</span> <span class="p">[</span><span class="n">level</span><span class="p">],</span> <span class="n">drop_level</span><span class="p">)</span>
<span class="g-Whitespace">   </span><span class="mi">4307</span> 

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/core/index.pyc</span> in <span class="ni">_get_level_indexer</span><span class="nt">(self, key, level)</span>
<span class="g-Whitespace">   </span><span class="mi">4357</span>         <span class="k">else</span><span class="p">:</span>
<span class="g-Whitespace">   </span><span class="mi">4358</span> 
<span class="ne">-&gt; </span><span class="mi">4359</span>             <span class="n">loc</span> <span class="o">=</span> <span class="n">level_index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="g-Whitespace">   </span><span class="mi">4360</span>             <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexsort_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="g-Whitespace">   </span><span class="mi">4361</span>                 <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">loc</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/core/index.pyc</span> in <span class="ni">get_loc</span><span class="nt">(self, key)</span>
<span class="g-Whitespace">   </span><span class="mi">1400</span>         <span class="n">loc</span> <span class="p">:</span> <span class="nb">int</span> <span class="k">if</span> <span class="n">unique</span> <span class="n">index</span><span class="p">,</span> <span class="n">possibly</span> <span class="nb">slice</span> <span class="ow">or</span> <span class="n">mask</span> <span class="k">if</span> <span class="ow">not</span>
<span class="g-Whitespace">   </span><span class="mi">1401</span>         <span class="s">&quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1402</span><span class="s">         return self._engine.get_loc(_values_from_object(key))</span>
<span class="g-Whitespace">   </span><span class="mi">1403</span><span class="s"> </span>
<span class="g-Whitespace">   </span><span class="mi">1404</span><span class="s">     def get_value(self, series, key):</span>

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/index.so</span> in <span class="ni">pandas.index.IndexEngine.get_loc (pandas/index.c:3807)</span><span class="nt">()</span>

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/index.so</span> in <span class="ni">pandas.index.IndexEngine.get_loc (pandas/index.c:3687)</span><span class="nt">()</span>

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/hashtable.so</span> in <span class="ni">pandas.hashtable.PyObjectHashTable.get_item (pandas/hashtable.c:12310)</span><span class="nt">()</span>

<span class="nn">/home/tcaswell/.virtualenvs/dd_py2k/lib/python2.7/site-packages/pandas/hashtable.so</span> in <span class="ni">pandas.hashtable.PyObjectHashTable.get_item (pandas/hashtable.c:12261)</span><span class="nt">()</span>

<span class="ne">KeyError</span>: &#39;val&#39;
</pre></div>
</div>
</div>
<div class="section" id="exporting-the-data-for-use-outside-of-python">
<h3>Exporting the Data for Use Outside of Python<a class="headerlink" href="#exporting-the-data-for-use-outside-of-python" title="Permalink to this headline">¶</a></h3>
<p>The tabular results from the DataMuxer are DataFrames, objects from the widely-
used and well-documented package pandas, and there are many convenient
methods for exporting them to common formats. For example:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [28]: </span><span class="n">binned_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">&#39;myfile.csv&#39;</span><span class="p">)</span>

<span class="gp">In [29]: </span><span class="n">binned_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s">&#39;myfile.xlsx&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>More methods are described in the pandas documention, and can easily be
explored by typing <tt class="docutils literal"><span class="pre">binned_data.to_</span></tt> &lt;tab&gt;.</p>
<p>This quick-and-dirty export is really only useful if the data of interest
is scalar (e.g., not images) and not very large. For other applications,
different tools should be used. As of this writing, these tools are in
development and not yet documented.</p>
</div>
</div>
<div class="section" id="more-ways-to-look-up-scans">
<h2>More Ways to Look Up Scans<a class="headerlink" href="#more-ways-to-look-up-scans" title="Permalink to this headline">¶</a></h2>
<p>To quickly look up recent scans, use the standard Python slicing syntax for
indexing from the end of a list.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [30]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># most recent scan</span>

<span class="gp">In [31]: </span><span class="n">header</span><span class="o">.</span><span class="n">scan_id</span>
<span class="gh">Out[31]: </span><span class="go">5</span>

<span class="gp">In [32]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c"># next to last scan</span>

<span class="gp">In [33]: </span><span class="n">header</span><span class="o">.</span><span class="n">scan_id</span>
<span class="gh">Out[33]: </span><span class="go">5</span>

<span class="gp">In [34]: </span><span class="n">headers</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>  <span class="c"># all of the last five scans</span>

<span class="gp">In [35]: </span><span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">scan_id</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">]</span>
<span class="gh">Out[35]: </span><span class="go">[5, 5, 4, 4, 3]</span>

<span class="gp">In [36]: </span><span class="n">headers</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">::</span><span class="mi">100</span><span class="p">]</span>  <span class="c"># sample every 100th of the last (up to) 1000 scans</span>
</pre></div>
</div>
<p>Or give the scan ID, which is always a positive integer.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [37]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c"># scan ID 4</span>

<span class="gp">In [38]: </span><span class="n">header</span><span class="o">.</span><span class="n">scan_id</span>
<span class="gh">Out[38]: </span><span class="go">4</span>
</pre></div>
</div>
<p>For advanced searches, use <tt class="docutils literal"><span class="pre">find_headers</span></tt>.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [39]: </span><span class="n">neds_headers</span> <span class="o">=</span> <span class="n">DataBroker</span><span class="o">.</span><span class="n">find_headers</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="s">&#39;nedbrainard&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Any of these results, whether a single Header or a list of Headers, can be
passed to <tt class="docutils literal"><span class="pre">DataBroker.fetch_events()</span></tt> as shown in the previous sections above.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, Stuart B. Wilkins.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>