<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installation instructions &mdash; sirepo-bluesky 0.post1+gbf47eb7 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Notebooks (old API)" href="notebooks-old-api.html" />
    <link rel="prev" title="sirepo-bluesky Documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> sirepo-bluesky
          </a>
              <div class="version">
                0.post1+gbf47eb7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation instructions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-sirepo">Starting Sirepo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-mongo">Starting Mongo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-of-databroker">Configuration of databroker</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#run-tests">Run tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-documentation">Build documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="notebooks-old-api.html">Notebooks (old API)</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks-new-api.html">Notebooks (new API)</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulations.html">List of predefined simulations in Sirepo</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-history.html">Release History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">sirepo-bluesky</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Installation instructions</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/installation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="installation-instructions">
<h1>Installation instructions<a class="headerlink" href="#installation-instructions" title="Permalink to this headline">¶</a></h1>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>Clone the repository to run the prerequisites:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/NSLS-II/sirepo-bluesky.git
$ <span class="nb">cd</span> sirepo-bluesky/
</pre></div>
</div>
</section>
<section id="starting-sirepo">
<span id="sirepo-startup"></span><h2>Starting Sirepo<a class="headerlink" href="#starting-sirepo" title="Permalink to this headline">¶</a></h2>
<p>To make use of the package, we need to run Sirepo as a service. We run Sirepo
using <a class="reference external" href="https://www.docker.com/">Docker</a> images (<a class="reference external" href="https://podman.io/">Podman</a>
can be used as well) from <a class="reference external" href="https://hub.docker.com/r/radiasoft/sirepo">DockerHub</a>.  We can start Sirepo locally
using the convenience script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ bash scripts/start_sirepo.sh -it
</pre></div>
</div>
<p>which runs a Docker container as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

# set -vxeuo pipefail
set -e

error_msg=&quot;Specify &#39;-it&#39; or &#39;-d&#39; on the command line as a first argument.&quot;

arg=&quot;${1:-}&quot;

if [ -z &quot;${arg}&quot; ]; then
    echo &quot;${error_msg}&quot;
    exit 1
elif [ &quot;${arg}&quot; != &quot;-it&quot; -a &quot;${arg}&quot; != &quot;-d&quot; ]; then
    echo &quot;${error_msg} Specified argument: ${arg}&quot;
    exit 2
fi

unset cmd _cmd docker_image SIREPO_DOCKER_CONTAINER_ID

month=$(date +&quot;%m&quot;)
day=$(date +&quot;%d&quot;)
year=$(date +&quot;%Y&quot;)

today=&quot;${HOME}/tmp/data/${year}/${month}/${day}&quot;

if [ -d &quot;${today}&quot; ]; then
    echo &quot;Directory ${today} exists.&quot;
else
    echo &quot;Creating Directory ${today}&quot;
    mkdir -p &quot;${today}&quot;
fi

docker_image=&quot;radiasoft/sirepo:beta&quot;
docker_binary=${DOCKER_BINARY:-&quot;docker&quot;}

${docker_binary} pull ${docker_image}

${docker_binary} images

in_docker_cmd=&quot;mkdir -v -p /sirepo/ &amp;&amp; cp -Rv /SIREPO_SRDB_ROOT/* /sirepo/ &amp;&amp; sirepo service http&quot;
cmd=&quot;${docker_binary} run ${arg} --init --rm --name sirepo \
       -e SIREPO_AUTH_METHODS=bluesky:guest \
       -e SIREPO_AUTH_BLUESKY_SECRET=bluesky \
       -e SIREPO_SRDB_ROOT=/sirepo \
       -e SIREPO_COOKIE_IS_SECURE=false \
       -p 8000:8000 \
       -v $PWD/sirepo_bluesky/tests/SIREPO_SRDB_ROOT:/SIREPO_SRDB_ROOT:ro,z \
       ${docker_image} bash -l -c \&quot;${in_docker_cmd}\&quot;&quot;

echo -e &quot;Command to run:\n\n${cmd}\n&quot;
if [ &quot;${arg}&quot; == &quot;-d&quot; ]; then
    SIREPO_DOCKER_CONTAINER_ID=$(eval ${cmd})
    export SIREPO_DOCKER_CONTAINER_ID
    echo &quot;Container ID: ${SIREPO_DOCKER_CONTAINER_ID}&quot;
    ${docker_binary} ps -a
    ${docker_binary} logs ${SIREPO_DOCKER_CONTAINER_ID}
else
    eval ${cmd}
fi
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One can use the <code class="docutils literal notranslate"><span class="pre">-d</span></code> option instead of <code class="docutils literal notranslate"><span class="pre">-it</span></code> to run the container in the
daemon mode.</p>
</div>
</section>
<section id="starting-mongo">
<h2>Starting Mongo<a class="headerlink" href="#starting-mongo" title="Permalink to this headline">¶</a></h2>
<p>Accessing the simualted data using Databroker requires us to have Mongo running.
We can similarly run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ bash scripts/start_mongo.sh -it
</pre></div>
</div>
<p>or more explicitly</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

set -vxeuo pipefail

error_msg=&quot;Specify &#39;-it&#39; or &#39;-d&#39; on the command line as a first argument.&quot;

arg=&quot;${1:-}&quot;

if [ -z &quot;${arg}&quot; ]; then
    echo &quot;${error_msg}&quot;
    exit 1
elif [ &quot;${arg}&quot; != &quot;-it&quot; -a &quot;${arg}&quot; != &quot;-d&quot; ]; then
    echo &quot;${error_msg} Specified argument: ${arg}&quot;
    exit 2
fi

docker_image=&quot;mongo&quot;
docker_binary=${DOCKER_BINARY:-&quot;docker&quot;}

${docker_binary} pull ${docker_image}
${docker_binary} images
${docker_binary} run ${arg} --rm -p 27017:27017 --name mongo ${docker_image}
</pre></div>
</div>
<p>Likewise, the <code class="docutils literal notranslate"><span class="pre">-d</span></code> option can be used instead of <code class="docutils literal notranslate"><span class="pre">-it</span></code> to run the container
in the daemon mode.</p>
</section>
<section id="configuration-of-databroker">
<h2>Configuration of databroker<a class="headerlink" href="#configuration-of-databroker" title="Permalink to this headline">¶</a></h2>
<p>To to access the collected data with the <a class="reference external" href="https://blueskyproject.io/databroker">databroker</a> library, we need to configure it. For
that, please copy the <a class="reference external" href="https://github.com/NSLS-II/sirepo-bluesky/blob/master/examples/local.yml">local.yml</a>
configuration file to the <code class="docutils literal notranslate"><span class="pre">~/.config/databroker/</span></code> directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">description</span><span class="p">:</span> <span class="s1">&#39;local databroker store&#39;</span>
<span class="n">metadatastore</span><span class="p">:</span>
  <span class="n">module</span><span class="p">:</span> <span class="s1">&#39;databroker.headersource.mongo&#39;</span>
  <span class="n">class</span><span class="p">:</span> <span class="s1">&#39;MDS&#39;</span>
  <span class="n">config</span><span class="p">:</span>
    <span class="n">host</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">27017</span>
    <span class="n">database</span><span class="p">:</span> <span class="s1">&#39;some_example_database&#39;</span>
    <span class="n">timezone</span><span class="p">:</span> <span class="s1">&#39;US/Eastern&#39;</span>
<span class="n">assets</span><span class="p">:</span>
  <span class="n">module</span><span class="p">:</span> <span class="s1">&#39;databroker.assets.mongo&#39;</span>
  <span class="n">class</span><span class="p">:</span> <span class="s1">&#39;Registry&#39;</span>
  <span class="n">config</span><span class="p">:</span>
    <span class="n">host</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">27017</span>
    <span class="n">database</span><span class="p">:</span> <span class="s1">&#39;some_example_database&#39;</span>
</pre></div>
</div>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The installation requires the SRW and Shadow3 packages to be installed to make
use of all features of the library, however the packages are not available on
PyPI for all versions of Python we support (e.g. the <code class="docutils literal notranslate"><span class="pre">srwpy</span></code> package’s
wheels are only available for Python versions up to 3.8, and the <code class="docutils literal notranslate"><span class="pre">shadow3</span></code>
package’s wheels have issues with installation/usage). Those packages are
primarily used by the corresponding handlers to be able to load the data from
the package-specific formats.  That is why we hightly recommend using the
packages from the <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code> conda channel:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://anaconda.org/conda-forge/srwpy">https://anaconda.org/conda-forge/srwpy</a></p></li>
<li><p><a class="reference external" href="https://anaconda.org/conda-forge/shadow3">https://anaconda.org/conda-forge/shadow3</a></p></li>
</ul>
</div>
<p>Start with creating a conda environment. If you do not have conda installation,
one of the packages from <a class="reference external" href="https://github.com/conda-forge/miniforge">https://github.com/conda-forge/miniforge</a> can be used to quickly install the
appropriate conda infrastructure.</p>
<p>At the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda create -n sirepo-bluesky -c conda-forge -y <span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9 srwpy shadow3
$ conda activate sirepo-bluesky
</pre></div>
</div>
<p>Then, to install the released version, run one of the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install sirepo-bluesky        <span class="c1"># to install from PyPI, OR</span>
$ conda install -c conda-forge sirepo-bluesky  <span class="c1"># to install from conda-forge</span>
</pre></div>
</div>
<p>If you would like to run examples, it is recommended to use the development mode
installation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/NSLS-II/sirepo-bluesky.git
$ <span class="nb">cd</span> sirepo-bluesky/
$ python3 -m pip install -ve .
</pre></div>
</div>
<p>If you wish to run <code class="docutils literal notranslate"><span class="pre">pytest</span></code> tests or build the documentation, please install
the development requirements, such as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install -r requirements-dev.txt
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may need to install the <a class="reference external" href="https://pandoc.org">Pandoc</a> library. Please
follow the instructions at <a class="reference external" href="https://pandoc.org/installing.html">https://pandoc.org/installing.html</a> to install it.</p>
</div>
<section id="run-tests">
<h3>Run tests<a class="headerlink" href="#run-tests" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pytest -vv -s -x --pdb
</pre></div>
</div>
</section>
<section id="build-documentation">
<h3>Build documentation<a class="headerlink" href="#build-documentation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ make -C docs/ html
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="sirepo-bluesky Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="notebooks-old-api.html" class="btn btn-neutral float-right" title="Notebooks (old API)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>