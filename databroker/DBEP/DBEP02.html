


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Promote Resource / Datum to first-class documents &mdash; databroker 1.0.0.post27+gdec4195 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Mobile files" href="DBEP01.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> databroker
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0.post27+gdec4195
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../data-access-overview.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../v2/index.html">Version 2 Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../v1/index.html">Version 1 Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">Release History</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Databroker Enhancement Proposals</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="template.html">DBEP Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="DBEP01.html">Mobile files</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Promote Resource / Datum to first-class documents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#branches-and-pull-requests">Branches and Pull requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l3"><a class="reference internal" href="#detailed-description">Detailed description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementation">Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#event-model">event-model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#databroker">databroker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ophyd">ophyd</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bluesky">bluesky</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#backward-compatibility">Backward Compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#alternatives">Alternatives</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#eliminate-resource-and-datum-as-stand-alone-documents">Eliminate <em>Resource</em> and <em>Datum</em> as stand alone documents</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Bluesky Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io">Homepage</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky">GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://gitter.im/NSLS-II/DAMA">Gitter</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">databroker</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Databroker Enhancement Proposals</a> &raquo;</li>
        
      <li>Promote Resource / Datum to first-class documents</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/DBEP/DBEP02.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="promote-resource-datum-to-first-class-documents">
<h1>Promote Resource / Datum to first-class documents<a class="headerlink" href="#promote-resource-datum-to-first-class-documents" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#status" id="id1">Status</a></p></li>
<li><p><a class="reference internal" href="#branches-and-pull-requests" id="id2">Branches and Pull requests</a></p></li>
<li><p><a class="reference internal" href="#abstract" id="id3">Abstract</a></p></li>
<li><p><a class="reference internal" href="#detailed-description" id="id4">Detailed description</a></p></li>
<li><p><a class="reference internal" href="#implementation" id="id5">Implementation</a></p>
<ul>
<li><p><a class="reference internal" href="#event-model" id="id6">event-model</a></p></li>
<li><p><a class="reference internal" href="#databroker" id="id7">databroker</a></p></li>
<li><p><a class="reference internal" href="#ophyd" id="id8">ophyd</a></p></li>
<li><p><a class="reference internal" href="#bluesky" id="id9">bluesky</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#backward-compatibility" id="id10">Backward Compatibility</a></p></li>
<li><p><a class="reference internal" href="#alternatives" id="id11">Alternatives</a></p>
<ul>
<li><p><a class="reference internal" href="#eliminate-resource-and-datum-as-stand-alone-documents" id="id12">Eliminate <em>Resource</em> and <em>Datum</em> as stand alone documents</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="status">
<h2><a class="toc-backref" href="#id1">Status</a><a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p><strong>Discussion</strong></p>
</div>
<div class="section" id="branches-and-pull-requests">
<h2><a class="toc-backref" href="#id2">Branches and Pull requests</a><a class="headerlink" href="#branches-and-pull-requests" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="abstract">
<h2><a class="toc-backref" href="#id3">Abstract</a><a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Currently <em>Resource</em> and <em>Datum</em> are directly inserted into the
<em>AssetRegistry</em> by <em>ophyd</em>.  This breaks the document abstractions
by making a specific consumer ‘special’.</p>
</div>
<div class="section" id="detailed-description">
<h2><a class="toc-backref" href="#id4">Detailed description</a><a class="headerlink" href="#detailed-description" title="Permalink to this headline">¶</a></h2>
<p>An odd asymmetry in how databroker works is that the documents for
<em>HeaderSource</em> and <em>EventSource</em> are emitted by the <em>RunEngine</em> and
can be subscribed to by one or more consumers.  Each consumer is
notionally independent, each receive all of the documents, and do not
need to coordinate in any way (or even be aware of one another’s
existence). In contrast, the <em>Resource</em> and <em>Datum</em> documents are
inserted directly into an <em>AssetRegistry</em> by the <em>ophyd</em> objects.
This breaks the separation we have between the data collection process
/ hardware, the generation of the documents, and the consumers of
those documents and leads to several unfortunate situations:</p>
<blockquote>
<div><ul class="simple">
<li><p><em>ohpyd</em> objects hold an instance of an <em>AssetRegisty</em></p></li>
<li><p>we need to keep track of <strong>which</strong> <em>AssertRegistry</em> things were
inserted into</p></li>
<li><p>consumers that want access to the asset documents need to also have
a handle to the database that the objects are inserting into</p></li>
</ul>
</div></blockquote>
<p>The proposed solution is to promote <em>Resource</em> and <em>Datum</em> documents
to be peer documents with <em>Start</em>, <em>Stop</em>, <em>Descriptor</em> and <em>Event</em>.
They will appear in the document stream and be inserted into
<em>DataBroker</em> via <code class="docutils literal notranslate"><span class="pre">db.insert</span></code>.  This eliminates the ‘special’
side-band communication and brings all consumers back to the same
footing.  This will require coordinated changes to <em>event-model</em>,
<em>databroker</em>, <em>bluesky</em>, and <em>ophyd</em>.</p>
</div>
<div class="section" id="implementation">
<h2><a class="toc-backref" href="#id5">Implementation</a><a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>Currently, <em>ophyd</em> is responsible for collecting all of the values for
the <em>Resource</em> and <em>Datum</em> documents except for the uids.  The uids
are generated by calls to <code class="docutils literal notranslate"><span class="pre">reg.register_*</span></code> and the datum uids are
subsequently returned to the <em>RunEngine</em> via <code class="docutils literal notranslate"><span class="pre">obj.read</span></code>.  The
proposed change is:</p>
<blockquote>
<div><ol class="arabic">
<li><p><em>ophyd</em> objects would be responsible for generating the full <em>Resource</em>
and <em>Datum</em> documents and providing them to the <em>RunEngine</em> to be
emitted.  <em>ophyd</em> may provide some helpers to make generating compliant
documents easy.</p>
<ol class="loweralpha simple">
<li><p>Similar to the current documents, a <em>Resource</em> must be emitted
before any <em>Datum</em> that refers to it.  A <em>Datum</em> can only refer
to a <em>Resource</em> that as been emitted after the most recent
<em>Start</em> and before the <em>Stop</em> for the most recent <em>Start</em>.</p></li>
<li><p>an identical (including uid) <em>Resource</em> and <em>Datum</em> maybe
emitted more than once, the consumers will need to handle this.</p></li>
<li><p>The <em>Datum</em> documents must be yielded only in the first
<code class="docutils literal notranslate"><span class="pre">collect_asset_docs</span></code> for which there UID is in <code class="docutils literal notranslate"><span class="pre">read</span></code>.</p></li>
<li><p>The <em>Resource</em> documents must only be yielded in the first
<code class="docutils literal notranslate"><span class="pre">collect_asset_docs</span></code> which includes a <em>Datum</em> that refers to
it.</p></li>
<li><p>Calls to <code class="docutils literal notranslate"><span class="pre">read</span></code> and <code class="docutils literal notranslate"><span class="pre">collect_asset_docs</span></code> must be
idempotent.</p></li>
</ol>
<p>Identical <em>Resource</em> and <em>Datum</em> documents are to support a single
<em>Resource</em> that may span many runs, such as background images, and
still ensure that with in the scope of a <em>Start</em> / <em>Stop</em> pair a
consumer will see all of the documents required.</p>
</li>
<li><p>in <code class="docutils literal notranslate"><span class="pre">save</span></code> before the <em>Event</em> document is emitted the <em>RunEngine</em>
will acquire and emit any <em>AssetRegistry</em> Documents.</p>
<ol class="loweralpha">
<li><p>in <code class="docutils literal notranslate"><span class="pre">save</span></code> the <em>RunEngine</em> knows what objects in the bundle, call
<code class="docutils literal notranslate"><span class="pre">collect_asset_docs</span></code> method</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">collect_asset_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>which will yield the <code class="docutils literal notranslate"><span class="pre">(name,</span> <span class="pre">doc)</span></code> pairs for anything that
was just read.</p>
</li>
<li><p>these documents will be emitted <strong>before</strong> the <em>Event</em></p></li>
</ol>
</li>
<li><p>consumers will now have access to all relevant documents and can
do what ever they want with them (insert into an asset registry,
live processing / display, copy files else where)</p></li>
</ol>
</div></blockquote>
<div class="section" id="event-model">
<h3><a class="toc-backref" href="#id6">event-model</a><a class="headerlink" href="#event-model" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic simple">
<li><p>add schema for <em>Resource</em> and <em>Datum</em></p></li>
<li><p>assert that datum_id must be of the form <code class="docutils literal notranslate"><span class="pre">{resource_id}/{N}</span></code>.
This is required to support columnar stores where the <em>Datum</em>
documents are group by <em>Resource</em> id.</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="databroker">
<h3><a class="toc-backref" href="#id7">databroker</a><a class="headerlink" href="#databroker" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic simple">
<li><p>teach <code class="docutils literal notranslate"><span class="pre">insert</span></code> how to deal with the additional documents.</p></li>
<li><p>revert API changes to use <code class="docutils literal notranslate"><span class="pre">register_*</span></code> which generate the uids.</p></li>
<li><p>helper tools for generating <em>Resource</em> and <em>Datum</em> documents
(maybe in ohpyd?)</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="ophyd">
<h3><a class="toc-backref" href="#id8">ophyd</a><a class="headerlink" href="#ophyd" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic simple">
<li><p>implement new document generation methods on all devices that have
external data.</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="bluesky">
<h3><a class="toc-backref" href="#id9">bluesky</a><a class="headerlink" href="#bluesky" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic simple">
<li><p>implement above logic in <code class="docutils literal notranslate"><span class="pre">RunEngine._save</span></code></p></li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="backward-compatibility">
<h2><a class="toc-backref" href="#id10">Backward Compatibility</a><a class="headerlink" href="#backward-compatibility" title="Permalink to this headline">¶</a></h2>
<p>This will break all of the devices that currently use <em>AssetRegistry</em>,
however it will not change anything on the retrieve side.  The
constraints on the <em>datum_id</em> can not be applied retro-actively, but
can be applied to all future data.</p>
<p>This excludes the option of having IOCs directly insert <em>Resource</em> and
<em>Datum</em> documents and expose <em>datum_id</em> values to the EPICS layer.  We
only have one experimental use of this (GeRM caproto IOC).  This level
of flexibility is not worth non-uniformity at the document level.  If
we want to have the IOC generate all of the values (including the
uids), then they should expose those values to EPICs and the <em>ophyd</em>
object will only be responsible for marshaling those values.</p>
</div>
<div class="section" id="alternatives">
<h2><a class="toc-backref" href="#id11">Alternatives</a><a class="headerlink" href="#alternatives" title="Permalink to this headline">¶</a></h2>
<div class="section" id="eliminate-resource-and-datum-as-stand-alone-documents">
<h3><a class="toc-backref" href="#id12">Eliminate <em>Resource</em> and <em>Datum</em> as stand alone documents</a><a class="headerlink" href="#eliminate-resource-and-datum-as-stand-alone-documents" title="Permalink to this headline">¶</a></h3>
<p>An alternative considered was to eliminate the <em>Resource</em> and <em>Datum</em>
documents all together by merging <em>Resource</em> into <em>Descriptor</em> and
<em>Datum</em> into <em>Event</em>.  However, this would break several long-standing
design principles:</p>
<blockquote>
<div><ul class="simple">
<li><p>all values in <code class="docutils literal notranslate"><span class="pre">ev['data']</span></code> are unstructured (scalar, strings, arrays)</p></li>
<li><p><em>Descriptors</em> are immutable</p></li>
</ul>
</div></blockquote>
<p>In addition to breaking the insert side, this would also be a major
change on the retrieval side and would require maintaining either two
implementations forever or to migrate all existing data.</p>
<p>This would also require the <em>ophyd</em> objects having a way to notify the
<code class="docutils literal notranslate"><span class="pre">RunEngine</span></code> that it’s configuration / resource was stale so that the
<em>Descriptor</em> cache could be invalidated.  (this is probably a good
idea anyway).</p>
<p>Despite being superficially simpler, the fallout from this alternative
would be far greater.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="DBEP01.html" class="btn btn-neutral float-left" title="Mobile files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>