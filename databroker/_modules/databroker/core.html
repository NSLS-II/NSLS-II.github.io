


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>databroker.core &mdash; databroker 1.0.6 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> databroker
          

          
          </a>

          
            
            
              <div class="version">
                1.0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../data-access-overview.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../v2/index.html">Version 2 Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../v1/index.html">Version 1 Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats_new.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DBEP/index.html">Databroker Enhancement Proposals</a></li>
</ul>
<p class="caption"><span class="caption-text">Bluesky Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io">Homepage</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky">GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Help</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://gitter.im/NSLS-II/DAMA">Gitter</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">databroker</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>databroker.core</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for databroker.core</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">entrypoints</span>
<span class="kn">import</span> <span class="nn">event_model</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">dask.bag</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">cachetools</span>
<span class="kn">from</span> <span class="nn">dask.base</span> <span class="kn">import</span> <span class="n">tokenize</span>
<span class="kn">import</span> <span class="nn">intake.catalog.base</span>
<span class="kn">import</span> <span class="nn">intake.catalog.local</span>
<span class="kn">import</span> <span class="nn">intake.container.base</span>
<span class="kn">from</span> <span class="nn">intake.compat</span> <span class="kn">import</span> <span class="n">unpack_kwargs</span>
<span class="kn">import</span> <span class="nn">msgpack</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.compat</span> <span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">xarray</span>

<span class="kn">from</span> <span class="nn">.intake_xarray_core.base</span> <span class="kn">import</span> <span class="n">DataSourceMixin</span>
<span class="kn">from</span> <span class="nn">.intake_xarray_core.xarray_container</span> <span class="kn">import</span> <span class="n">RemoteXarray</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">LazyMap</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">dask.base</span> <span class="kn">import</span> <span class="n">normalize_token</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NotMutable</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="o">...</span>


<div class="viewcode-block" id="Document"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.Document">[docs]</a><span class="k">class</span> <span class="nc">Document</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Document is an immutable dict subclass.</span>

<span class="sd">    It is immutable to help consumer code avoid accidentally corrupting data</span>
<span class="sd">    that another part of the cosumer code was expected to use unchanged.</span>

<span class="sd">    Subclasses of Document must define __dask_tokenize__. The tokenization</span>
<span class="sd">    schemes typically uniquely identify the document based on only a subset of</span>
<span class="sd">    its contents, and mutating the contents can thereby create situations where</span>
<span class="sd">    two unequal objects have colliding tokens. Immutability helps guard against</span>
<span class="sd">    this too.</span>

<span class="sd">    Note that Documents are not *recursively* immutable. Just as it is possible</span>
<span class="sd">    create a tuple (immutable) of lists (mutable) and mutate the lists, it is</span>
<span class="sd">    possible to mutate the internal contents of a Document, but this should not</span>
<span class="sd">    be done. It is safer to use the to_dict() method to create a mutable deep</span>
<span class="sd">    copy.</span>

<span class="sd">    This is implemented as a dict subclass in order to satisfy certain</span>
<span class="sd">    consumers that expect an object that satisfies isinstance(obj, dict).</span>
<span class="sd">    This implementation detail may change in the future.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;__not_a_real_dict&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># This lets pickle recognize that this is not a literal dict and that</span>
        <span class="c1"># it should respect its custom __setstate__.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__not_a_real_dict</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># same as dict, but wrapped in the class name so the eval round-trips</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A multi-line but eval-able text repr with readable indentation</span>

<span class="sd">        This hooks into IPython/Jupyter&#39;s display mechanism</span>
<span class="sd">        This is *not* invoked by print() or repr(), but it is invoked by</span>
<span class="sd">        IPython.display.display() which is called in this common scenario::</span>

<span class="sd">            In [1]: doc = Document(...)</span>
<span class="sd">            In [2]: doc</span>
<span class="sd">            &lt;pretty representation will show here&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: IPython&#39;s pretty-prettying mechanism is custom and complex.</span>
        <span class="c1"># The `text` method used below is a direct and blunt way to engage it</span>
        <span class="c1"># and seems widely used in the IPython code base. There are other</span>
        <span class="c1"># specific mechanisms for displaying collections like dicts, but they</span>
        <span class="c1"># can *truncate* which I think we want to avoid and they would require</span>
        <span class="c1"># more investment to understand how to use.</span>
        <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">pformat</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__not_a_real_dict</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NotMutable</span><span class="p">(</span>
            <span class="s2">&quot;Documents are not mutable. Call the method to_dict() to make a &quot;</span>
            <span class="s2">&quot;fully independent and mutable deep copy.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__not_a_real_dict</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># This path is necessary to support un-pickling.</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__readonly</span><span class="p">()</span>

    <span class="fm">__delitem__</span> <span class="o">=</span> <span class="n">__readonly</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">__readonly</span>
    <span class="n">popitem</span> <span class="o">=</span> <span class="n">__readonly</span>
    <span class="n">clear</span> <span class="o">=</span> <span class="n">__readonly</span>
    <span class="n">setdefault</span> <span class="o">=</span> <span class="n">__readonly</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">__readonly</span>

<div class="viewcode-block" id="Document.to_dict"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.Document.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a mutable deep copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert to dict and then make a deep copy to ensure that if the user</span>
        <span class="c1"># mutates any internally nested dicts there is no spooky action at a</span>
        <span class="c1"># distance.</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="c1"># Without this, copy.deepcopy(Document(...)) fails because deepcopy</span>
        <span class="c1"># creates a new, empty Document instance and then tries to add items to</span>
        <span class="c1"># it.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<span class="c1"># We must use dask&#39;s registration mechanism to tell it to treat Document</span>
<span class="c1"># specially. Dask&#39;s tokenization dispatch mechanism discovers that Docuemnt is</span>
<span class="c1"># a dict subclass and treats it as a dict, ignoring its __dask_tokenize__</span>
<span class="c1"># method. To force it to respect our cutsom tokenization, we must explicitly</span>
<span class="c1"># register it.</span>


<span class="nd">@normalize_token</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Document</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tokenize_document</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">__dask_tokenize__</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Start</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Stop</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Descriptor</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;descriptor&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">EventPage</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;event_page&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Datum</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;datum&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">DatumPage</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;datum_page&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">PartitionIndexError</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">Entry</span><span class="p">(</span><span class="n">intake</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">LocalCatalogEntry</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;never&#39;</span>

    <span class="nd">@_pmode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># This might never come up, but just to be safe....</span>
        <span class="k">if</span> <span class="s1">&#39;entry&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The args cannot contain &#39;entry&#39;. It is reserved.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># This cache holds datasources, the result of calling super().get(...)</span>
        <span class="c1"># with potentially different arguments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created Entry named </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span>

    <span class="k">def</span> <span class="nf">_make_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cachetools</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_open_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_parameters</span><span class="p">):</span>
        <span class="n">plugin</span><span class="p">,</span> <span class="n">open_args</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_create_open_args</span><span class="p">(</span><span class="n">user_parameters</span><span class="p">)</span>
        <span class="c1"># Inject self into arguments passed to instanitate the driver. This</span>
        <span class="c1"># enables the driver instance to know which Entry created it.</span>
        <span class="n">open_args</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">open_args</span>

    <span class="k">def</span> <span class="nf">cache_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datasource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Entry cache found </span><span class="si">%s</span><span class="s2"> named </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">datasource</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">datasource</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">datasource</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">datasource</span>
        <span class="k">return</span> <span class="n">datasource</span>

    <span class="c1"># def __dask_tokenize__(self):</span>
    <span class="c1">#     print(&#39;bob&#39;)</span>
    <span class="c1">#     metadata = self.describe()[&#39;metadata&#39;]</span>
    <span class="c1">#     return (&#39;Entry&#39;, metadata[&#39;start&#39;][&#39;uid&#39;])</span>


<span class="k">class</span> <span class="nc">StreamEntry</span><span class="p">(</span><span class="n">Entry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a temporary fix that is being proposed to include in intake.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_make_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># def __dask_tokenize__(self):</span>
    <span class="c1">#     print(&#39;bill&#39;)</span>
    <span class="c1">#     metadata = self.describe()[&#39;metadata&#39;]</span>
    <span class="c1">#     print(self.describe())</span>
    <span class="c1">#     return (&#39;Stream&#39;, metadata[&#39;start&#39;][&#39;uid&#39;], self.name)</span>


<span class="k">def</span> <span class="nf">to_event_pages</span><span class="p">(</span><span class="n">get_event_cursor</span><span class="p">,</span> <span class="n">page_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that changes get_event_cursor to get_event_pages.</span>

<span class="sd">    get_event_cursor yields events, get_event_pages yields event_pages.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    get_event_cursor : function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    get_event_pages : function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">get_event_cursor</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_event_pages</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">event_cursor</span> <span class="o">=</span> <span class="n">get_event_cursor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">event_cursor</span><span class="p">,</span> <span class="n">page_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">event_model</span><span class="o">.</span><span class="n">pack_event_page</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">get_event_pages</span>


<span class="k">def</span> <span class="nf">to_datum_pages</span><span class="p">(</span><span class="n">get_datum_cursor</span><span class="p">,</span> <span class="n">page_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that changes get_datum_cursor to get_datum_pages.</span>

<span class="sd">    get_datum_cursor yields datum, get_datum_pages yields datum_pages.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    get_datum_cursor : function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    get_datum_pages : function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">get_datum_cursor</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_datum_pages</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">datum_cursor</span> <span class="o">=</span> <span class="n">get_datum_cursor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">datum_cursor</span><span class="p">,</span> <span class="n">page_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">event_model</span><span class="o">.</span><span class="n">pack_datum_page</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">get_datum_pages</span>


<span class="k">def</span> <span class="nf">retry</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that retries a Catalog function once.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    function: function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_function: function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">new_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force_reload</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_function</span>


<span class="k">def</span> <span class="nf">_flatten_event_page_gen</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an event_page generator to an event generator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gen : generator</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    event_generator : generator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">event_model</span><span class="o">.</span><span class="n">unpack_event_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_interlace_event_pages</span><span class="p">(</span><span class="o">*</span><span class="n">gens</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take event_page generators and interlace their results by timestamp.</span>
<span class="sd">    This is a modification of https://github.com/bluesky/databroker/pull/378/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gens : generators</span>
<span class="sd">        Generators of (name, dict) pairs where the dict contains a &#39;time&#39; key.</span>
<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    val : tuple</span>
<span class="sd">        The next (name, dict) pair in time order</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">]</span>
    <span class="n">heap</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">safe_next</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iters</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">)):</span>
        <span class="n">safe_next</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">heap</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">heap</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">val</span>
        <span class="n">safe_next</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_interlace_event_page_chunks</span><span class="p">(</span><span class="o">*</span><span class="n">gens</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take event_page generators and interlace their results by timestamp.</span>

<span class="sd">    This is a modification of https://github.com/bluesky/databroker/pull/378/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gens : generators</span>
<span class="sd">        Generators of (name, dict) pairs where the dict contains a &#39;time&#39; key.</span>
<span class="sd">    chunk_size : integer</span>
<span class="sd">        Size of pages to yield</span>
<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    val : tuple</span>
<span class="sd">        The next (name, dict) pair in time order</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">event_model</span><span class="o">.</span><span class="n">rechunk_event_pages</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">))</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">]</span>
    <span class="k">yield from</span> <span class="n">_interlace_event_pages</span><span class="p">(</span><span class="o">*</span><span class="n">iters</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_interlace</span><span class="p">(</span><span class="o">*</span><span class="n">gens</span><span class="p">,</span> <span class="n">strict_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take event_page generators and interlace their results by timestamp.</span>

<span class="sd">    This is a modification of https://github.com/bluesky/databroker/pull/378/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gens : generators</span>
<span class="sd">        Generators of (name, dict) pairs where the dict contains a &#39;time&#39; key.</span>
<span class="sd">    strict_order : bool, optional</span>
<span class="sd">        documents are strictly yielded in ascending time order. Defaults to</span>
<span class="sd">        True.</span>
<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    val : tuple</span>
<span class="sd">        The next (name, dict) pair in time order</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">]</span>
    <span class="n">heap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fifo</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

    <span class="c1"># Gets the next event/event_page from the iterator iters[index], while</span>
    <span class="c1"># appending documents that are not events/event_pages to the fifo.</span>
    <span class="k">def</span> <span class="nf">get_next</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">doc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iters</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;event&#39;</span><span class="p">:</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)))</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;event_page&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">strict_order</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">event_model</span><span class="o">.</span><span class="n">unpack_event_page</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
                        <span class="n">event_page</span> <span class="o">=</span> <span class="n">event_model</span><span class="o">.</span><span class="n">pack_event_page</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="p">(</span><span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;event_page&#39;</span><span class="p">,</span> <span class="n">event_page</span><span class="p">)))</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)))</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">]:</span>
                    <span class="n">fifo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">))</span>

    <span class="c1"># Put the next event/event_page from each generator in the heap.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">)):</span>
        <span class="n">get_next</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># First yield docs that are not events or event pages from the fifo queue,</span>
    <span class="c1"># and then yield from the heap.  We can improve this by keeping a count of</span>
    <span class="c1"># the number of documents from each stream in the heap, and only calling</span>
    <span class="c1"># get_next when the count is 0. As is the heap could potentially get very</span>
    <span class="c1"># large.</span>
    <span class="k">while</span> <span class="n">heap</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">fifo</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">fifo</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">heap</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">doc</span>
        <span class="n">get_next</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Yield any remaining items in the fifo queue.</span>
    <span class="k">while</span> <span class="n">fifo</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">fifo</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_unfilled_partitions</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">datum_gens</span><span class="p">,</span>
                         <span class="n">event_gens</span><span class="p">,</span> <span class="n">partition_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a Bluesky run, in order, packed into partitions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : dict</span>
<span class="sd">        Bluesky run_start document</span>
<span class="sd">    descriptors: list</span>
<span class="sd">        List of Bluesky descriptor documents</span>
<span class="sd">    resources: list</span>
<span class="sd">        List of Bluesky resource documents</span>
<span class="sd">    stop: dict</span>
<span class="sd">        Bluesky run_stop document</span>
<span class="sd">    datum_gens : generators</span>
<span class="sd">        Generators of datum_pages.</span>
<span class="sd">    event_gens : generators</span>
<span class="sd">        Generators of (name, dict) pairs where the dict contains a &#39;time&#39; key.</span>
<span class="sd">    partition_size : integer</span>
<span class="sd">        Size of partitions to yield</span>
<span class="sd">    chunk_size : integer</span>
<span class="sd">        Size of pages to yield</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    partition : list</span>
<span class="sd">        List of lists of (name, dict) pair in time order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The first partition is the &quot;header&quot;</span>
    <span class="k">yield</span> <span class="p">([(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)]</span>
           <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;descriptor&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">]</span>
           <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">])</span>

    <span class="c1"># Use rechunk datum pages to make them into pages of size &quot;partition_size&quot;</span>
    <span class="c1"># and yield one page per partition.</span>
    <span class="k">for</span> <span class="n">datum_gen</span> <span class="ow">in</span> <span class="n">datum_gens</span><span class="p">:</span>
        <span class="n">partition</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;datum_page&#39;</span><span class="p">,</span> <span class="n">datum_page</span><span class="p">)</span> <span class="k">for</span> <span class="n">datum_page</span> <span class="ow">in</span>
                     <span class="n">event_model</span><span class="o">.</span><span class="n">rechunk_datum_pages</span><span class="p">(</span><span class="n">datum_gen</span><span class="p">,</span> <span class="n">partition_size</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">partition</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">partition</span>

    <span class="c1"># Rechunk the event pages and interlace them in timestamp order, then pack</span>
    <span class="c1"># them into a partition.</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">partition</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">event_page</span> <span class="ow">in</span> <span class="n">_interlace_event_pages</span><span class="p">(</span><span class="o">*</span><span class="n">event_gens</span><span class="p">):</span>
        <span class="n">partition</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;event_page&#39;</span><span class="p">,</span> <span class="n">event_page</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">partition_size</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">partition</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">partition</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Add the stop document onto the last partition.</span>
    <span class="n">partition</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
    <span class="k">yield</span> <span class="n">partition</span>


<span class="k">def</span> <span class="nf">_fill</span><span class="p">(</span><span class="n">filler</span><span class="p">,</span>
          <span class="n">event</span><span class="p">,</span>
          <span class="n">lookup_resource_for_datum</span><span class="p">,</span>
          <span class="n">get_resource</span><span class="p">,</span>
          <span class="n">get_datum_pages</span><span class="p">,</span>
          <span class="n">last_datum_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">filled_event</span> <span class="o">=</span> <span class="n">filler</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filled_event</span>
    <span class="k">except</span> <span class="n">event_model</span><span class="o">.</span><span class="n">UnresolvableForeignKeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">datum_id</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">key</span>
        <span class="k">if</span> <span class="n">datum_id</span> <span class="o">==</span> <span class="n">last_datum_id</span><span class="p">:</span>
            <span class="c1"># We tried to fetch this Datum on the last trip</span>
            <span class="c1"># trip through this method, and apparently it did not</span>
            <span class="c1"># work. We are in an infinite loop. Bail!</span>
            <span class="k">raise</span>

        <span class="c1"># try to fast-path looking up the resource uid if this works</span>
        <span class="c1"># it saves us a a database hit (to get the datum document)</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">datum_id</span><span class="p">:</span>
            <span class="n">resource_uid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">datum_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># otherwise do it the standard way</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource_uid</span> <span class="o">=</span> <span class="n">lookup_resource_for_datum</span><span class="p">(</span><span class="n">datum_id</span><span class="p">)</span>

        <span class="c1"># but, it might be the case that the key just happens to have</span>
        <span class="c1"># a &#39;/&#39; in it and it does not have any semantic meaning so we</span>
        <span class="c1"># optimistically try</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">get_resource</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">resource_uid</span><span class="p">)</span>
        <span class="c1"># and then fall back to the standard way to be safe</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">get_resource</span><span class="p">(</span><span class="n">lookup_resource_for_datum</span><span class="p">(</span><span class="n">datum_id</span><span class="p">))</span>

        <span class="n">filler</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
        <span class="c1"># Pre-fetch all datum for this resource.</span>
        <span class="k">for</span> <span class="n">datum_page</span> <span class="ow">in</span> <span class="n">get_datum_pages</span><span class="p">(</span><span class="n">resource_uid</span><span class="o">=</span><span class="n">resource_uid</span><span class="p">):</span>
            <span class="n">filler</span><span class="p">(</span><span class="s2">&quot;datum_page&quot;</span><span class="p">,</span> <span class="n">datum_page</span><span class="p">)</span>
        <span class="c1"># TODO -- When to clear the datum cache in filler?</span>

        <span class="c1"># Re-enter and try again now that the Filler has consumed the</span>
        <span class="c1"># missing Datum. There might be another missing Datum in this same</span>
        <span class="c1"># Event document (hence this re-entrant structure) or might be good</span>
        <span class="c1"># to go.</span>
        <span class="k">return</span> <span class="n">_fill</span><span class="p">(</span>
            <span class="n">filler</span><span class="p">,</span>
            <span class="n">event</span><span class="p">,</span>
            <span class="n">lookup_resource_for_datum</span><span class="p">,</span>
            <span class="n">get_resource</span><span class="p">,</span>
            <span class="n">get_datum_pages</span><span class="p">,</span>
            <span class="n">last_datum_id</span><span class="o">=</span><span class="n">datum_id</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_documents_to_xarray</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">start_doc</span><span class="p">,</span> <span class="n">stop_doc</span><span class="p">,</span> <span class="n">descriptor_docs</span><span class="p">,</span>
                         <span class="n">get_event_pages</span><span class="p">,</span> <span class="n">filler</span><span class="p">,</span> <span class="n">get_resource</span><span class="p">,</span>
                         <span class="n">lookup_resource_for_datum</span><span class="p">,</span> <span class="n">get_datum_pages</span><span class="p">,</span>
                         <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent the data in one Event stream as an xarray.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_doc: dict</span>
<span class="sd">        RunStart Document</span>
<span class="sd">    stop_doc : dict</span>
<span class="sd">        RunStop Document</span>
<span class="sd">    descriptor_docs : list</span>
<span class="sd">        EventDescriptor Documents</span>
<span class="sd">    filler : event_model.Filler</span>
<span class="sd">    get_resource : callable</span>
<span class="sd">        Expected signature ``get_resource(resource_uid) -&gt; Resource``</span>
<span class="sd">    lookup_resource_for_datum : callable</span>
<span class="sd">        Expected signature ``lookup_resource_for_datum(datum_id) -&gt; resource_uid``</span>
<span class="sd">    get_datum_pages : callable</span>
<span class="sd">        Expected signature ``get_datum_pages(resource_uid) -&gt; generator``</span>
<span class="sd">        where ``generator`` yields datum_page documents</span>
<span class="sd">    get_event_pages : callable</span>
<span class="sd">        Expected signature ``get_event_pages(descriptor_uid) -&gt; generator``</span>
<span class="sd">        where ``generator`` yields event_page documents</span>
<span class="sd">    include : list, optional</span>
<span class="sd">        Fields (&#39;data keys&#39;) to include. By default all are included. This</span>
<span class="sd">        parameter is mutually exclusive with ``exclude``.</span>
<span class="sd">    exclude : list, optional</span>
<span class="sd">        Fields (&#39;data keys&#39;) to exclude. By default none are excluded. This</span>
<span class="sd">        parameter is mutually exclusive with ``include``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dataset : xarray.Dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">include</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include</span> <span class="ow">and</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The parameters `include` and `exclude` are mutually exclusive.&quot;</span><span class="p">)</span>
    <span class="c1"># Data keys must not change within one stream, so we can safely sample</span>
    <span class="c1"># just the first Event Descriptor.</span>
    <span class="k">if</span> <span class="n">descriptor_docs</span><span class="p">:</span>
        <span class="n">data_keys</span> <span class="o">=</span> <span class="n">descriptor_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;data_keys&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data_keys</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">include</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data_keys</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_keys</span><span class="p">)</span>

    <span class="c1"># Collect a Dataset for each descriptor. Merge at the end.</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dim_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">event_dim_labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">config_dim_labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">descriptor_docs</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_flatten_event_page_gen</span><span class="p">(</span><span class="n">get_event_pages</span><span class="p">(</span><span class="n">descriptor</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">data_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;external&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">):</span>
            <span class="n">filler</span><span class="p">(</span><span class="s1">&#39;descriptor&#39;</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">)</span>
            <span class="n">filled_events</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">filled_event</span> <span class="o">=</span> <span class="n">_fill</span><span class="p">(</span>
                    <span class="n">filler</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">lookup_resource_for_datum</span><span class="p">,</span> <span class="n">get_resource</span><span class="p">,</span>
                    <span class="n">get_datum_pages</span><span class="p">)</span>
                <span class="n">filled_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filled_event</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filled_events</span> <span class="o">=</span> <span class="n">events</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
        <span class="n">seq_nums</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span><span class="p">[</span><span class="s1">&#39;seq_num&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
        <span class="n">data_table</span> <span class="o">=</span> <span class="n">_transpose</span><span class="p">(</span><span class="n">filled_events</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="c1"># external_keys = [k for k in data_keys if &#39;external&#39; in data_keys[k]]</span>

        <span class="c1"># Collect a DataArray for each field in Event, each field in</span>
        <span class="c1"># configuration, and &#39;seq_num&#39;. The Event &#39;time&#39; will be the</span>
        <span class="c1"># default coordinate.</span>
        <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Make DataArrays for Event data.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">field_metadata</span> <span class="o">=</span> <span class="n">data_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1"># if the EventDescriptor doesn&#39;t provide names for the</span>
            <span class="c1"># dimensions (it&#39;s optional) use the same default dimension</span>
            <span class="c1"># names that xarray would.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">field_metadata</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_metadata</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
                <span class="c1"># Reuse dim labels.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="n">event_dim_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dim_</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="n">dim_counter</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>
                    <span class="n">event_dim_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span>
            <span class="n">data_arrays</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data_table</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">dims</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">},</span>
                <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Make DataArrays for configuration data.</span>
        <span class="k">for</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data_keys</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_keys&#39;</span><span class="p">]</span>
            <span class="c1"># For configuration, label the dimension specially to</span>
            <span class="c1"># avoid key collisions.</span>
            <span class="n">scoped_data_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scoped_data_keys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">include</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scoped_data_keys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">scoped_data_keys</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">scoped_key</span> <span class="ow">in</span> <span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field_metadata</span> <span class="o">=</span> <span class="n">data_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_metadata</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
                <span class="c1"># if the EventDescriptor doesn&#39;t provide names for the</span>
                <span class="c1"># dimensions (it&#39;s optional) use the same default dimension</span>
                <span class="c1"># names that xarray would.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">field_metadata</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dims</span> <span class="o">=</span> <span class="n">config_dim_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dim_</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="n">dim_counter</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>
                        <span class="n">config_dim_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span>
                <span class="n">data_arrays</span><span class="p">[</span><span class="n">scoped_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="c1"># TODO Once we know we have one Event Descriptor</span>
                    <span class="c1"># per stream we can be more efficient about this.</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span>
                                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),)</span> <span class="o">+</span> <span class="n">ndim</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">dims</span><span class="p">,</span>
                    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">},</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Finally, make DataArrays for &#39;seq_num&#39; and &#39;uid&#39;.</span>
        <span class="n">data_arrays</span><span class="p">[</span><span class="s1">&#39;seq_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">seq_nums</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;seq_num&#39;</span><span class="p">)</span>
        <span class="n">data_arrays</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">uids</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span>

        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="o">=</span><span class="n">data_arrays</span><span class="p">))</span>
    <span class="c1"># Merge Datasets from all Event Descriptors into one representing the</span>
    <span class="c1"># whole stream. (In the future we may simplify to one Event Descriptor</span>
    <span class="c1"># per stream, but as of this writing we must account for the</span>
    <span class="c1"># possibility of multiple.)</span>
    <span class="k">return</span> <span class="n">xarray</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_canonical</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">strict_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields documents from this Run in chronological order.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_doc : dict</span>
<span class="sd">        RunStart Document</span>
<span class="sd">    stop_doc : dict</span>
<span class="sd">        RunStop Document</span>
<span class="sd">    entries : dict</span>
<span class="sd">        A dict of the BlueskyRun&#39;s entries.</span>
<span class="sd">    fill: {&#39;yes&#39;, &#39;no&#39;}</span>
<span class="sd">        If fill is &#39;yes&#39;, any external data referenced by Event documents</span>
<span class="sd">        will be filled in (e.g. images as numpy arrays). This is typically</span>
<span class="sd">        the desired option for *using* the data.</span>
<span class="sd">        If fill is &#39;no&#39;, the Event documents will contain foreign keys as</span>
<span class="sd">        placeholders for the data. This option is useful for exporting</span>
<span class="sd">        copies of the documents.</span>
<span class="sd">    strict_order : bool, optional</span>
<span class="sd">        documents are strictly yielded in ascending time order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">history</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">FILL_OPTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;delayed&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">fill</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FILL_OPTIONS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid fill option: </span><span class="si">{</span><span class="n">fill</span><span class="si">}</span><span class="s2">, fill must be: </span><span class="si">{</span><span class="n">FILL_OPTIONS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stream_gen</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">partition</span> <span class="o">=</span> <span class="n">entry</span><span class="p">()</span><span class="o">.</span><span class="n">read_partition</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;fill&#39;</span><span class="p">:</span> <span class="n">fill</span><span class="p">,</span>
                                                <span class="s1">&#39;partition_size&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">partition</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">yield from</span> <span class="n">partition</span>

    <span class="n">streams</span> <span class="o">=</span> <span class="p">[</span><span class="n">stream_gen</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

    <span class="c1"># This following code filters out duplicate documents.</span>
    <span class="c1"># This is needed because we dont know which EventStream, that resource</span>
    <span class="c1"># or datum documents belong to, so each stream has these documents.</span>
    <span class="c1"># Without this filter we would get multiple of the same resource and</span>
    <span class="c1"># datum documents.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">_interlace</span><span class="p">(</span><span class="o">*</span><span class="n">streams</span><span class="p">,</span> <span class="n">strict_order</span><span class="o">=</span><span class="n">strict_order</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;datum&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="n">history</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;datum_page&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="n">history</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;resource&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="n">history</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>


<div class="viewcode-block" id="RemoteBlueskyRun"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.RemoteBlueskyRun">[docs]</a><span class="k">class</span> <span class="nc">RemoteBlueskyRun</span><span class="p">(</span><span class="n">intake</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">RemoteCatalog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Catalog representing one Run.</span>

<span class="sd">    This is a client-side proxy to a BlueskyRun stored on a remote server.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url: str</span>
<span class="sd">        Address of the server</span>
<span class="sd">    headers: dict</span>
<span class="sd">        HTTP headers to sue in calls</span>
<span class="sd">    name: str</span>
<span class="sd">        handle to reference this data</span>
<span class="sd">    parameters: dict</span>
<span class="sd">        To pass to the server when it instantiates the data source</span>
<span class="sd">    metadata: dict</span>
<span class="sd">        Additional info</span>
<span class="sd">    kwargs: ignored</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bluesky-run&#39;</span>

    <span class="c1"># opt-out of the persistence features of intake</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_been_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Does not support intake persistence&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RemoteBlueskyRun.persist"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.RemoteBlueskyRun.persist">[docs]</a>    <span class="k">def</span> <span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;never&#39;</span>

    <span class="nd">@pmode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="c1"># def __dask_tokenize__(self):</span>
    <span class="c1">#     print(&#39;baz&#39;)</span>
    <span class="c1">#     return (&#39;RemoteBlueskyRun&#39;, self.metadata[&#39;start&#39;][&#39;uid&#39;])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">http_args</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_args</span> <span class="o">=</span> <span class="n">http_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">http_args</span><span class="o">=</span><span class="n">http_args</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                         <span class="n">source_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_id</span><span class="p">)</span>
        <span class="c1"># turn off any attempts at persistence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmode</span> <span class="o">=</span> <span class="s2">&quot;never&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npartitions</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;npartitions&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Schema</span><span class="p">(</span>
            <span class="n">datashape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">npartitions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npartitions</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_source_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;/v1/source&#39;</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">use_bin_type</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">http_args</span><span class="p">)</span>
            <span class="n">req</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">unpack_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">_load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span>

    <span class="k">def</span> <span class="nf">_get_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">intake</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_partition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_args</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_source_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
                                                   <span class="n">partition</span><span class="p">)</span>

<div class="viewcode-block" id="RemoteBlueskyRun.read"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.RemoteBlueskyRun.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Reading the BlueskyRun itself is not supported. Instead read one &quot;</span>
            <span class="s2">&quot;its entries, representing individual Event Streams.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RemoteBlueskyRun.to_dask"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.RemoteBlueskyRun.to_dask">[docs]</a>    <span class="k">def</span> <span class="nf">to_dask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Reading the BlueskyRun itself is not supported. Instead read one &quot;</span>
            <span class="s2">&quot;its entries, representing individual Event Streams.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bag</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">canonical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">strict_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Special case for &#39;delayed&#39; since it *is* supported in the local mode</span>
        <span class="c1"># of usage.</span>
        <span class="k">if</span> <span class="n">fill</span> <span class="o">==</span> <span class="s1">&#39;delayed&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Delayed access is not yet supported via the client--server &quot;</span>
                <span class="s2">&quot;usage.&quot;</span><span class="p">)</span>

        <span class="k">yield from</span> <span class="n">_canonical</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span>
                              <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">],</span>
                              <span class="n">entries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">,</span>
                              <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
                              <span class="n">strict_order</span><span class="o">=</span><span class="n">strict_order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_canonical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The method read_canonical has been renamed canonical. This alias &quot;</span>
            <span class="s2">&quot;may be removed in a future release.&quot;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> uid=</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> *REPR RENDERING FAILURE* </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BlueskyRun</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  uid=</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  exit_status=</span><span class="si">{</span><span class="n">stop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_status&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">_ft</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> -- </span><span class="si">{</span><span class="n">_ft</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  Streams:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * </span><span class="si">{</span><span class="n">stream_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> *REPR_RENDERING_FAILURE* </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot search within one run.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BlueskyRun"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyRun">[docs]</a><span class="k">class</span> <span class="nc">BlueskyRun</span><span class="p">(</span><span class="n">intake</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">Catalog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Catalog representing one Run.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    get_run_start: callable</span>
<span class="sd">        Expected signature ``get_run_start() -&gt; RunStart``</span>
<span class="sd">    get_run_stop : callable</span>
<span class="sd">        Expected signature ``get_run_stop() -&gt; RunStop``</span>
<span class="sd">    get_event_descriptors : callable</span>
<span class="sd">        Expected signature ``get_event_descriptors() -&gt; List[EventDescriptors]``</span>
<span class="sd">    get_event_pages : callable</span>
<span class="sd">        Expected signature ``get_event_pages(descriptor_uid) -&gt; generator``</span>
<span class="sd">        where ``generator`` yields Event documents</span>
<span class="sd">    get_event_count : callable</span>
<span class="sd">        Expected signature ``get_event_count(descriptor_uid) -&gt; int``</span>
<span class="sd">    get_resource : callable</span>
<span class="sd">        Expected signature ``get_resource(resource_uid) -&gt; Resource``</span>
<span class="sd">    get_resources: callable</span>
<span class="sd">        Expected signature ``get_resources() -&gt; Resources``</span>
<span class="sd">    lookup_resource_for_datum : callable</span>
<span class="sd">        Expected signature ``lookup_resource_for_datum(datum_id) -&gt; resource_uid``</span>
<span class="sd">    get_datum_pages : callable</span>
<span class="sd">        Expected signature ``get_datum_pages(resource_uid) -&gt; generator``</span>
<span class="sd">        where ``generator`` yields Datum documents</span>
<span class="sd">    get_filler : callable</span>
<span class="sd">        Expected signature ``get_filler() -&gt; event_model.Filler``</span>
<span class="sd">    transforms : Dict[str, Callable]</span>
<span class="sd">        A dict that maps any subset of the keys {start, stop, resource, descriptor}</span>
<span class="sd">        to a function that accepts a document of the corresponding type and</span>
<span class="sd">        returns it, potentially modified. This feature is for patching up</span>
<span class="sd">        erroneous metadata. It is intended for quick, temporary fixes that</span>
<span class="sd">        may later be applied permanently to the data at rest</span>
<span class="sd">        (e.g., via a database migration).</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        Additional keyword arguments are passed through to the base class,</span>
<span class="sd">        Catalog.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># opt-out of the persistence features of intake</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_been_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Does not support intake persistence&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BlueskyRun.persist"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyRun.persist">[docs]</a>    <span class="k">def</span> <span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;never&#39;</span>

    <span class="nd">@pmode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="c1"># def __dask_tokenize__(self):</span>
    <span class="c1">#     print(&#39;baz&#39;)</span>
    <span class="c1">#     return (&#39;BlueksyRun&#39;, self.metadata[&#39;start&#39;][&#39;uid&#39;])</span>

    <span class="n">container</span> <span class="o">=</span> <span class="s1">&#39;bluesky-run&#39;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;0.0.1&#39;</span>
    <span class="n">partition_access</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">PARTITION_SIZE</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">get_run_start</span><span class="p">,</span>
                 <span class="n">get_run_stop</span><span class="p">,</span>
                 <span class="n">get_event_descriptors</span><span class="p">,</span>
                 <span class="n">get_event_pages</span><span class="p">,</span>
                 <span class="n">get_event_count</span><span class="p">,</span>
                 <span class="n">get_resource</span><span class="p">,</span>
                 <span class="n">get_resources</span><span class="p">,</span>
                 <span class="n">lookup_resource_for_datum</span><span class="p">,</span>
                 <span class="n">get_datum_pages</span><span class="p">,</span>
                 <span class="n">get_filler</span><span class="p">,</span>
                 <span class="n">entry</span><span class="p">,</span>
                 <span class="n">transforms</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Set the name here, earlier than the base class does, so that the log</span>
        <span class="c1"># message in self._load has access to it.</span>
        <span class="c1"># All **kwargs are passed up to base class. TODO: spell them out</span>
        <span class="c1"># explicitly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urlpath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># TODO Not sure why I had to add this.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_start</span> <span class="o">=</span> <span class="n">get_run_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_stop</span> <span class="o">=</span> <span class="n">get_run_stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_descriptors</span> <span class="o">=</span> <span class="n">get_event_descriptors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_pages</span> <span class="o">=</span> <span class="n">get_event_pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_count</span> <span class="o">=</span> <span class="n">get_event_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource</span> <span class="o">=</span> <span class="n">get_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span> <span class="o">=</span> <span class="n">get_resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_resource_for_datum</span> <span class="o">=</span> <span class="n">lookup_resource_for_datum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_datum_pages</span> <span class="o">=</span> <span class="n">get_datum_pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">[</span><span class="s1">&#39;yes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_filler</span><span class="p">(</span><span class="n">coerce</span><span class="o">=</span><span class="s1">&#39;force_numpy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_model</span><span class="o">.</span><span class="n">NoFiller</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">[</span><span class="s1">&#39;yes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">handler_registry</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">[</span><span class="s1">&#39;delayed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_filler</span><span class="p">(</span><span class="n">coerce</span><span class="o">=</span><span class="s1">&#39;delayed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entry</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;persist_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;never&#39;</span><span class="p">})</span>
        <span class="c1"># turn off any attempts at persistence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmode</span> <span class="o">=</span> <span class="s2">&quot;never&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Created </span><span class="si">%s</span><span class="s2"> named </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> uid=</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> *REPR RENDERING FAILURE* </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BlueskyRun</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  uid=</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  exit_status=</span><span class="si">{</span><span class="n">stop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_status&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">_ft</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> -- </span><span class="si">{</span><span class="n">_ft</span><span class="p">(</span><span class="n">stop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  Streams:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    * </span><span class="si">{</span><span class="n">stream_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> *REPR_RENDERING_FAILURE* </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_entries_container</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">LazyMap</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_doc</span> <span class="o">=</span> <span class="n">Start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run_start</span><span class="p">()))</span>

        <span class="c1"># get_run_stop() may return None if the document was never created due</span>
        <span class="c1"># to a critical failure or simply not yet emitted during a Run that is</span>
        <span class="c1"># still in progress. If it returns None, pass that through.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="o">=</span> <span class="n">stop</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="o">=</span> <span class="n">Stop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">](</span><span class="n">stop</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_doc</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span><span class="p">})</span>

        <span class="c1"># TODO Add driver API to allow us to fetch just the stream names not</span>
        <span class="c1"># all the descriptors. We don&#39;t need them until BlueskyEventStream.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">](</span><span class="n">descriptor</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_descriptors</span><span class="p">()]</span>

        <span class="c1"># Count the total number of documents in this run.</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">descriptor_uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptor_uids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_count</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Schema</span><span class="p">(</span>
            <span class="n">datashape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">count</span><span class="p">,),</span>
            <span class="n">npartitions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npartitions</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># Make a BlueskyEventStream for each stream_name.</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;EventDescriptor </span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> has no &#39;name&#39;, likely &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;because it was generated using an old version of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;bluesky. The name &#39;primary&#39; will be used.&quot;</span><span class="p">)</span>
        <span class="n">stream_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">)</span>
        <span class="n">new_stream_names</span> <span class="o">=</span> <span class="n">stream_names</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">stream_name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">StreamEntry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">stream_name</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="p">{},</span>  <span class="c1"># TODO</span>
                               <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;databroker.core.BlueskyEventStream&#39;</span><span class="p">,</span>
                               <span class="n">direct_access</span><span class="o">=</span><span class="s1">&#39;forbid&#39;</span><span class="p">,</span>
                               <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                               <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># What does this do?</span>
                               <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                               <span class="n">catalog_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">getenv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">getshell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">catalog</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># We employ OrderedDict in several places in this loop. The motivation</span>
        <span class="c1"># is to speed up dask tokenization. When dask tokenizes a plain dict,</span>
        <span class="c1"># it sorts the keys, and it turns out that this sort operation</span>
        <span class="c1"># dominates the call time, even for very small dicts. Using an</span>
        <span class="c1"># OrderedDict steers dask toward a different and faster tokenization.</span>
        <span class="n">new_entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">stream_name</span> <span class="ow">in</span> <span class="n">new_stream_names</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]})</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
                <span class="n">stream_name</span><span class="o">=</span><span class="n">stream_name</span><span class="p">,</span>
                <span class="n">get_run_stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run_stop</span><span class="p">,</span>
                <span class="n">get_event_descriptors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_event_descriptors</span><span class="p">,</span>
                <span class="n">get_event_pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_event_pages</span><span class="p">,</span>
                <span class="n">get_event_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_event_count</span><span class="p">,</span>
                <span class="n">get_resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resource</span><span class="p">,</span>
                <span class="n">get_resources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">,</span>
                <span class="n">lookup_resource_for_datum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lookup_resource_for_datum</span><span class="p">,</span>
                <span class="n">get_datum_pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_datum_pages</span><span class="p">,</span>
                <span class="n">fillers</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">),</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

            <span class="n">new_entries</span><span class="p">[</span><span class="n">stream_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span>
                                                         <span class="n">metadata</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_entries</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Loaded </span><span class="si">%s</span><span class="s2"> named </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="BlueskyRun.configure_new"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyRun.configure_new">[docs]</a>    <span class="k">def</span> <span class="nf">configure_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return self or, if args are provided, some new instance of type(self).</span>

<span class="sd">        This is here so that the user does not have to remember whether a given</span>
<span class="sd">        variable is a BlueskyRun or an *Entry* with a Bluesky Run. In either</span>
<span class="sd">        case, ``obj()`` will return a BlueskyRun.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="n">get</span> <span class="o">=</span> <span class="fm">__call__</span> <span class="o">=</span> <span class="n">configure_new</span>

    <span class="k">def</span> <span class="nf">canonical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">strict_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_canonical</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span>
                              <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">],</span>
                              <span class="n">entries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">,</span>
                              <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
                              <span class="n">strict_order</span><span class="o">=</span><span class="n">strict_order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_canonical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The method read_canonical has been renamed canonical. This alias &quot;</span>
            <span class="s2">&quot;may be removed in a future release.&quot;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BlueskyRun.get_file_list"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyRun.get_file_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch filepaths of external files associated with this Run.</span>

<span class="sd">        This method is not defined on RemoteBlueskyRun because the filepaths</span>
<span class="sd">        may not be meaningful on a remote machine.</span>

<span class="sd">        This method should be considered experimental. It may be changed or</span>
<span class="sd">        removed in a future release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">[</span><span class="s1">&#39;yes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_handler</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">datum_kwarg_gen</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datum_pages</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">event_model</span><span class="o">.</span><span class="n">unpack_datum_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">datum</span><span class="p">[</span><span class="s1">&#39;datum_kwargs&#39;</span><span class="p">]</span>

        <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">get_file_list</span><span class="p">(</span><span class="n">datum_kwarg_gen</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">files</span></div>

<div class="viewcode-block" id="BlueskyRun.read"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyRun.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Reading the BlueskyRun itself is not supported. Instead read one &quot;</span>
            <span class="s2">&quot;its entries, representing individual Event Streams. You can see &quot;</span>
            <span class="s2">&quot;the entries using list(YOUR_VARIABLE_HERE). Tab completion may &quot;</span>

            <span class="s2">&quot;also help, if available.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BlueskyRun.to_dask"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyRun.to_dask">[docs]</a>    <span class="k">def</span> <span class="nf">to_dask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Reading the BlueskyRun itself is not supported. Instead read one &quot;</span>
            <span class="s2">&quot;its entries, representing individual Event Streams. You can see &quot;</span>
            <span class="s2">&quot;the entries using list(YOUR_VARIABLE_HERE). Tab completion may &quot;</span>
            <span class="s2">&quot;also help, if available.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BlueskyEventStream"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyEventStream">[docs]</a><span class="k">class</span> <span class="nc">BlueskyEventStream</span><span class="p">(</span><span class="n">DataSourceMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Catalog representing one Event Stream from one Run.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream_name : string</span>
<span class="sd">        Stream name, such as &#39;primary&#39;.</span>
<span class="sd">    get_run_stop : callable</span>
<span class="sd">        Expected signature ``get_run_stop() -&gt; RunStop``</span>
<span class="sd">    get_event_descriptors : callable</span>
<span class="sd">        Expected signature ``get_event_descriptors() -&gt; List[EventDescriptors]``</span>
<span class="sd">    get_event_pages : callable</span>
<span class="sd">        Expected signature ``get_event_pages(descriptor_uid) -&gt; generator``</span>
<span class="sd">        where ``generator`` yields event_page documents</span>
<span class="sd">    get_event_count : callable</span>
<span class="sd">        Expected signature ``get_event_count(descriptor_uid) -&gt; int``</span>
<span class="sd">    get_resource : callable</span>
<span class="sd">        Expected signature ``get_resource(resource_uid) -&gt; Resource``</span>
<span class="sd">    get_resources: callable</span>
<span class="sd">        Expected signature ``get_resources() -&gt; Resources``</span>
<span class="sd">    lookup_resource_for_datum : callable</span>
<span class="sd">        Expected signature ``lookup_resource_for_datum(datum_id) -&gt; resource_uid``</span>
<span class="sd">    get_datum_pages : callable</span>
<span class="sd">        Expected signature ``get_datum_pages(resource_uid) -&gt; generator``</span>
<span class="sd">        where ``generator`` yields datum_page documents</span>
<span class="sd">    fillers : dict of Fillers</span>
<span class="sd">    transforms : Dict[str, Callable]</span>
<span class="sd">        A dict that maps any subset of the keys {start, stop, resource, descriptor}</span>
<span class="sd">        to a function that accepts a document of the corresponding type and</span>
<span class="sd">        returns it, potentially modified. This feature is for patching up</span>
<span class="sd">        erroneous metadata. It is intended for quick, temporary fixes that</span>
<span class="sd">        may later be applied permanently to the data at rest</span>
<span class="sd">        (e.g., via a database migration).</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        passed through to base class</span>
<span class="sd">    include : list, optional</span>
<span class="sd">        Fields (&#39;data keys&#39;) to include. By default all are included. This</span>
<span class="sd">        parameter is mutually exclusive with ``exclude``.</span>
<span class="sd">    exclude : list, optional</span>
<span class="sd">        Fields (&#39;data keys&#39;) to exclude. By default none are excluded. This</span>
<span class="sd">        parameter is mutually exclusive with ``include``.</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        Additional keyword arguments are passed through to the base class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># def __dask_tokenize__(self):</span>
    <span class="c1">#     print(&#39;bill&#39;)</span>
    <span class="c1">#     intake_desc = self.describe()</span>
    <span class="c1">#     return (&#39;Stream&#39;, intake_desc[&#39;metadata&#39;][&#39;start&#39;][&#39;uid&#39;], metadata[&#39;name&#39;])</span>
    <span class="c1"># opt-out of the persistence features of intake</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_been_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_persisted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Does not support intake persistence&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BlueskyEventStream.persist"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyEventStream.persist">[docs]</a>    <span class="k">def</span> <span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;never&#39;</span>

    <span class="nd">@_pmode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_pmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="n">container</span> <span class="o">=</span> <span class="s1">&#39;bluesky-event-stream&#39;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;0.0.1&#39;</span>
    <span class="n">partition_access</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">stream_name</span><span class="p">,</span>
                 <span class="n">get_run_stop</span><span class="p">,</span>
                 <span class="n">get_event_descriptors</span><span class="p">,</span>
                 <span class="n">get_event_pages</span><span class="p">,</span>
                 <span class="n">get_event_count</span><span class="p">,</span>
                 <span class="n">get_resources</span><span class="p">,</span>
                 <span class="n">get_resource</span><span class="p">,</span>
                 <span class="n">lookup_resource_for_datum</span><span class="p">,</span>
                 <span class="n">get_datum_pages</span><span class="p">,</span>
                 <span class="n">fillers</span><span class="p">,</span>
                 <span class="n">transforms</span><span class="p">,</span>
                 <span class="n">metadata</span><span class="p">,</span>
                 <span class="n">entry</span><span class="p">,</span>
                 <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span> <span class="o">=</span> <span class="n">stream_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_descriptors</span> <span class="o">=</span> <span class="n">get_event_descriptors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_stop</span> <span class="o">=</span> <span class="n">get_run_stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_pages</span> <span class="o">=</span> <span class="n">get_event_pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_count</span> <span class="o">=</span> <span class="n">get_event_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span> <span class="o">=</span> <span class="n">get_resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource</span> <span class="o">=</span> <span class="n">get_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_resource_for_datum</span> <span class="o">=</span> <span class="n">lookup_resource_for_datum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_datum_pages</span> <span class="o">=</span> <span class="n">get_datum_pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span> <span class="o">=</span> <span class="n">fillers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urlpath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># TODO Not sure why I had to add this.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># set by _open_dataset below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partitions</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># turn off any attempts at persistence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmode</span> <span class="o">=</span> <span class="s2">&quot;never&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_doc</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_header</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Created </span><span class="si">%s</span><span class="s2"> for stream name </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO Add driver API to fetch only the descriptors of interest instead</span>
        <span class="c1"># of fetching all of them and then filtering.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span> <span class="o">=</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">Descriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">](</span><span class="n">descriptor</span><span class="p">))</span>
                                 <span class="k">for</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_descriptors</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;descriptors&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>
        <span class="c1"># TODO Should figure out a way so that self._resources doesn&#39;t have to</span>
        <span class="c1"># be all of the Run&#39;s resources.</span>
        <span class="c1"># TDOO Should we expose this in metadata as well? Since</span>
        <span class="c1"># _get_resources() only discovers new-style Resources that have a</span>
        <span class="c1"># run_start in them, leave it private for now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="p">[</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">](</span><span class="n">resource</span><span class="p">))</span>
                           <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">()]</span>

        <span class="c1"># get_run_stop() may return None if the document was never created due</span>
        <span class="c1"># to a critical failure or simply not yet emitted during a Run that is</span>
        <span class="c1"># still in progress. If it returns None, pass that through.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_run_stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Stop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">](</span><span class="n">stop</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">})</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Loaded </span><span class="si">%s</span><span class="s2"> for stream name </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="si">!r}</span><span class="s2"> &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;from Run </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...&gt;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> *REPR_RENDERING_FAILURE* </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">_documents_to_xarray</span><span class="p">(</span>
            <span class="n">start_doc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_doc</span><span class="p">,</span>
            <span class="n">stop_doc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span><span class="p">,</span>
            <span class="n">descriptor_docs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">,</span>
            <span class="n">get_event_pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_event_pages</span><span class="p">,</span>
            <span class="n">filler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">[</span><span class="s1">&#39;delayed&#39;</span><span class="p">],</span>
            <span class="n">get_resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resource</span><span class="p">,</span>
            <span class="n">lookup_resource_for_datum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lookup_resource_for_datum</span><span class="p">,</span>
            <span class="n">get_datum_pages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_datum_pages</span><span class="p">,</span>
            <span class="n">include</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">include</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">)</span>

<div class="viewcode-block" id="BlueskyEventStream.read"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyEventStream.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return data from this Event Stream as an xarray.Dataset.</span>

<span class="sd">        This loads all of the data into memory. For delayed (&quot;lazy&quot;), chunked</span>
<span class="sd">        access to the data, see :meth:`to_dask`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Implemented just so we can put in a docstring</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="BlueskyEventStream.to_dask"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyEventStream.to_dask">[docs]</a>    <span class="k">def</span> <span class="nf">to_dask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return data from this Event Stream as an xarray.Dataset backed by dask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Implemented just so we can put in a docstring</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_dask</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_load_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_header</span><span class="p">()</span>
        <span class="n">datum_gens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_datum_pages</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>
                      <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="p">]</span>
        <span class="n">event_gens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_event_pages</span><span class="p">(</span><span class="n">descriptor</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]))</span>
                      <span class="k">for</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partitions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">_unfilled_partitions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_doc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptors</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_stop_doc</span><span class="p">,</span>
                                 <span class="n">datum_gens</span><span class="p">,</span> <span class="n">event_gens</span><span class="p">,</span> <span class="n">partition_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npartitions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_partitions</span><span class="p">)</span>

<div class="viewcode-block" id="BlueskyEventStream.read_partition"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.BlueskyEventStream.read_partition">[docs]</a>    <span class="k">def</span> <span class="nf">read_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch one chunk of documents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read_partition</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span>

        <span class="c1"># Unpack partition</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">filler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillers</span><span class="p">[</span><span class="n">partition</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filler</span> <span class="o">=</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span>

        <span class="c1"># Partition size is the number of pages in the partition.</span>
        <span class="k">if</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;partition_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">partition_size</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition</span><span class="p">[</span><span class="s1">&#39;partition_size&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">partition_size</span> <span class="o">=</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;partition_size&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid partition_size </span><span class="si">{</span><span class="n">partition</span><span class="p">[</span><span class="s1">&#39;partition_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partitions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_partitions</span><span class="p">(</span><span class="n">partition_size</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">filler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partitions</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">except</span> <span class="n">event_model</span><span class="o">.</span><span class="n">UnresolvableForeignKeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># Slow path: This error should only happen if there is an old style</span>
                <span class="c1"># resource document that doesn&#39;t have a run_start key.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partitions</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_missing_datum</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">partition_size</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">filler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partitions</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">_missing_datum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datum_id</span><span class="p">,</span> <span class="n">partition_size</span><span class="p">):</span>
        <span class="c1"># Get the resource from the datum_id.</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">datum_id</span><span class="p">:</span>
            <span class="n">resource_uid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">datum_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_resource_for_datum</span><span class="p">(</span><span class="n">datum_id</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">resource_uid</span><span class="p">)</span>

        <span class="c1"># Use rechunk datum pages to make them into pages of size &quot;partition_size&quot;</span>
        <span class="c1"># and yield one page per partition.  Rechunk might be slow.</span>
        <span class="n">datum_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datum_pages</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>
        <span class="n">partitions</span> <span class="o">=</span> <span class="p">[[(</span><span class="s1">&#39;datum_page&#39;</span><span class="p">,</span> <span class="n">datum_page</span><span class="p">)]</span> <span class="k">for</span> <span class="n">datum_page</span> <span class="ow">in</span>
                      <span class="n">event_model</span><span class="o">.</span><span class="n">rechunk_datum_pages</span><span class="p">(</span><span class="n">datum_gen</span><span class="p">,</span> <span class="n">partition_size</span><span class="p">)]</span>

        <span class="c1"># Check that the datum_id from the exception has been added.</span>
        <span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">partition</span> <span class="ow">in</span> <span class="n">partitions</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">datum_page</span> <span class="ow">in</span> <span class="n">partition</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">datum_id</span> <span class="ow">in</span> <span class="n">datum_page</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">():</span>
            <span class="k">raise</span>

        <span class="c1"># Add the resource to the begining of the first partition.</span>
        <span class="n">partitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="p">)]</span> <span class="o">+</span> <span class="n">partitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npartitions</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">partitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">partitions</span>

    <span class="k">def</span> <span class="nf">_get_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">intake</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">get_partition</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_source_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
            <span class="n">partition</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">RemoteBlueskyEventStream</span><span class="p">(</span><span class="n">RemoteXarray</span><span class="p">):</span>
    <span class="c1"># Because of the container_map, when working in remote mode, when accessing</span>
    <span class="c1"># a BlueskyRun or BlueskyEventStream, you will get a RemoteBlueskyRun or a</span>
    <span class="c1"># RemoteBlueskyEventStream on the client side. Canonical of the RemoteBlueskyRun,</span>
    <span class="c1"># calls read_partition of the RemoteBlueskyEventStream, where there</span>
    <span class="c1"># partition argument is a dict. The inherited read_partition method only</span>
    <span class="c1"># accepts an integer for the partition argument, so read_partition needs to</span>
    <span class="c1"># be overridden.</span>
    <span class="k">def</span> <span class="nf">read_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_metadata</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_partition</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream_name</span><span class="si">!r}</span><span class="s2"> &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;from Run </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...&gt;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> *REPR_RENDERING_FAILURE* </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>
        <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">DocumentCache</span><span class="p">(</span><span class="n">event_model</span><span class="o">.</span><span class="n">DocumentRouter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_pages</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datum_pages_by_resource</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_uid_by_datum_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_doc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_doc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_doc</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_doc</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="nf">event_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_pages</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">datum_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datum_pages_by_resource</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">datum_id</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource_uid_by_datum_id</span><span class="p">[</span><span class="n">datum_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="nf">resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">doc</span>


<span class="k">class</span> <span class="nc">SingleRunCache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect the document from one Run and, when complete, provide a BlueskyRun.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    handler_registry: dict, optional</span>
<span class="sd">        This is passed to the Filler or whatever class is given in the</span>
<span class="sd">        filler_class parameter below.</span>

<span class="sd">        Maps each &#39;spec&#39; (a string identifying a given type or external</span>
<span class="sd">        resource) to a handler class.</span>

<span class="sd">        A &#39;handler class&#39; may be any callable with the signature::</span>

<span class="sd">            handler_class(resource_path, root, **resource_kwargs)</span>

<span class="sd">        It is expected to return an object, a &#39;handler instance&#39;, which is also</span>
<span class="sd">        callable and has the following signature::</span>

<span class="sd">            handler_instance(**datum_kwargs)</span>

<span class="sd">        As the names &#39;handler class&#39; and &#39;handler instance&#39; suggest, this is</span>
<span class="sd">        typically implemented using a class that implements ``__init__`` and</span>
<span class="sd">        ``__call__``, with the respective signatures. But in general it may be</span>
<span class="sd">        any callable-that-returns-a-callable.</span>
<span class="sd">    root_map: dict, optional</span>
<span class="sd">        This is passed to Filler or whatever class is given in the filler_class</span>
<span class="sd">        parameter below.</span>

<span class="sd">        str -&gt; str mapping to account for temporarily moved/copied/remounted</span>
<span class="sd">        files.  Any resources which have a ``root`` in ``root_map`` will be</span>
<span class="sd">        loaded using the mapped ``root``.</span>
<span class="sd">    filler_class: type</span>
<span class="sd">        This is Filler by default. It can be a Filler subclass,</span>
<span class="sd">        ``functools.partial(Filler, ...)``, or any class that provides the same</span>
<span class="sd">        methods as ``DocumentRouter``.</span>
<span class="sd">    transforms: dict</span>
<span class="sd">        A dict that maps any subset of the keys {start, stop, resource, descriptor}</span>
<span class="sd">        to a function that accepts a document of the corresponding type and</span>
<span class="sd">        returns it, potentially modified. This feature is for patching up</span>
<span class="sd">        erroneous metadata. It is intended for quick, temporary fixes that</span>
<span class="sd">        may later be applied permanently to the data at rest</span>
<span class="sd">        (e.g., via a database migration).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Subscribe to a document stream from within a plan.</span>
<span class="sd">    &gt;&gt;&gt; def plan():</span>
<span class="sd">    ...     src = SingleRunCache()</span>
<span class="sd">    ...</span>
<span class="sd">    ...     @bluesky.preprocessors.subs_decorator(src.callback)</span>
<span class="sd">    ...     def inner_plan():</span>
<span class="sd">    ...         yield from bluesky.plans.rel_scan(...)</span>
<span class="sd">    ...         run = src.retrieve()</span>
<span class="sd">    ...         table = run.primary.read().to_dataframe()</span>
<span class="sd">    ...         ...</span>
<span class="sd">    ...</span>
<span class="sd">    ...     yield from inner_plan()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">handler_registry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">filler_class</span><span class="o">=</span><span class="n">event_model</span><span class="o">.</span><span class="n">Filler</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_root_map</span> <span class="o">=</span> <span class="n">root_map</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filler_class</span> <span class="o">=</span> <span class="n">filler_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span> <span class="o">=</span> <span class="n">parse_transforms</span><span class="p">(</span><span class="n">transforms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handler_registry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handler_registry</span> <span class="o">=</span> <span class="n">discover_handlers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handler_registry</span> <span class="o">=</span> <span class="n">parse_handler_registry</span><span class="p">(</span><span class="n">handler_registry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler_registry</span> <span class="o">=</span> <span class="n">event_model</span><span class="o">.</span><span class="n">HandlerRegistryView</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handler_registry</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_filler</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filler_class</span><span class="p">,</span>
            <span class="n">handler_registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handler_registry</span><span class="p">,</span>
            <span class="n">root_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_map</span><span class="p">,</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># will contain (name, doc) pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complete</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># set to Run Start uid when stop doc is received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Cache BlueskyRun instance here.</span>

    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subscribe to a document stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Already received &#39;stop&#39; document. Expected one Run only.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_complete</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;run_start&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a BlueskyRun. If one is not ready, return None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">gen_func</span><span class="p">():</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span>

            <span class="c1"># TODO in a future PR:</span>
            <span class="c1"># We have to mock up an Entry.</span>
            <span class="c1"># Can we avoid this after the Entry refactor?</span>
            <span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">start_doc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="p">))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">start_doc</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">=</span> <span class="n">BlueskyRunFromGenerator</span><span class="p">(</span>
                <span class="n">gen_func</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{},</span> <span class="n">get_filler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_filler</span><span class="p">,</span>
                <span class="n">transforms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Either &lt;SingleRunCache in progress&gt;</span>
        <span class="c1"># or &lt;SingleRunCache uid=&quot;...&quot;&gt;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;SingleRunCache uid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_complete</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;SingleRunCache in progress&gt;&quot;</span>


<span class="k">class</span> <span class="nc">BlueskyRunFromGenerator</span><span class="p">(</span><span class="n">BlueskyRun</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen_func</span><span class="p">,</span> <span class="n">gen_args</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="p">,</span> <span class="n">get_filler</span><span class="p">,</span>
                 <span class="n">transforms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">document_cache</span> <span class="o">=</span> <span class="n">DocumentCache</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gen_func</span><span class="p">(</span><span class="o">*</span><span class="n">gen_args</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">):</span>
            <span class="n">document_cache</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">document_cache</span><span class="o">.</span><span class="n">start_doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">get_run_start</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">document_cache</span><span class="o">.</span><span class="n">start_doc</span>

        <span class="k">def</span> <span class="nf">get_run_stop</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">document_cache</span><span class="o">.</span><span class="n">stop_doc</span>

        <span class="k">def</span> <span class="nf">get_event_descriptors</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">document_cache</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">get_event_pages</span><span class="p">(</span><span class="n">descriptor_uid</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">skip</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">return</span> <span class="n">document_cache</span><span class="o">.</span><span class="n">event_pages</span><span class="p">[</span><span class="n">descriptor_uid</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_event_count</span><span class="p">(</span><span class="n">descriptor_uid</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s1">&#39;seq_num&#39;</span><span class="p">])</span>
                       <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="p">(</span><span class="n">document_cache</span><span class="o">.</span><span class="n">event_pages</span><span class="p">[</span><span class="n">descriptor_uid</span><span class="p">]))</span>

        <span class="k">def</span> <span class="nf">get_resource</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">document_cache</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_resources</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">document_cache</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">lookup_resource_for_datum</span><span class="p">(</span><span class="n">datum_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">document_cache</span><span class="o">.</span><span class="n">resource_uid_by_datum_id</span><span class="p">[</span><span class="n">datum_id</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_datum_pages</span><span class="p">(</span><span class="n">resource_uid</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">skip</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">return</span> <span class="n">document_cache</span><span class="o">.</span><span class="n">datum_pages_by_resource</span><span class="p">[</span><span class="n">resource_uid</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">get_run_start</span><span class="o">=</span><span class="n">get_run_start</span><span class="p">,</span>
            <span class="n">get_run_stop</span><span class="o">=</span><span class="n">get_run_stop</span><span class="p">,</span>
            <span class="n">get_event_descriptors</span><span class="o">=</span><span class="n">get_event_descriptors</span><span class="p">,</span>
            <span class="n">get_event_pages</span><span class="o">=</span><span class="n">get_event_pages</span><span class="p">,</span>
            <span class="n">get_event_count</span><span class="o">=</span><span class="n">get_event_count</span><span class="p">,</span>
            <span class="n">get_resource</span><span class="o">=</span><span class="n">get_resource</span><span class="p">,</span>
            <span class="n">get_resources</span><span class="o">=</span><span class="n">get_resources</span><span class="p">,</span>
            <span class="n">lookup_resource_for_datum</span><span class="o">=</span><span class="n">lookup_resource_for_datum</span><span class="p">,</span>
            <span class="n">get_datum_pages</span><span class="o">=</span><span class="n">get_datum_pages</span><span class="p">,</span>
            <span class="n">get_filler</span><span class="o">=</span><span class="n">get_filler</span><span class="p">,</span>
            <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_transpose</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn a list of dicts into dict of lists</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    in_data : list</span>
<span class="sd">        A list of dicts which contain at least one dict.</span>
<span class="sd">        All of the inner dicts must have at least the keys</span>
<span class="sd">        in `keys`</span>

<span class="sd">    keys : list</span>
<span class="sd">        The list of keys to extract</span>

<span class="sd">    field : str</span>
<span class="sd">        The field in the outer dict to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transpose : dict</span>
<span class="sd">        The transpose of the data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_data</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># compatibility with dask &lt; 2</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="c1"># There are data structured that dask auto-chunking cannot handle,</span>
            <span class="c1"># such as an list of list of variable length. For now, let these go</span>
            <span class="c1"># out as plain numpy arrays. In the future we might make them dask</span>
            <span class="c1"># arrays with manual chunks.</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># TEMPORARY EMERGENCY FALLBACK</span>
            <span class="c1"># If environment variable is set to anything but 0, work around</span>
            <span class="c1"># dask and return a numpy array.</span>
            <span class="n">switch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATABROKER_ARRAY_FALLBACK&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">switch</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Creating a dask array raised an error. Because the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;environment variable DATABROKER_ARRAY_FALLBACK was set &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;to </span><span class="si">{</span><span class="n">switch</span><span class="si">}</span><span class="s2"> we have caught the error and fallen &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;back to returning a numpy array instead. This may be &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;very slow. The underlying issue should be resolved. The &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;error was </span><span class="si">{</span><span class="n">err</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">_ft</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="s2">&quot;format timestamp&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timestamp</span>
    <span class="c1"># Truncate microseconds to miliseconds. Do not bother to round.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_xarray_to_event_gen</span><span class="p">(</span><span class="n">data_xarr</span><span class="p">,</span> <span class="n">ts_xarr</span><span class="p">,</span> <span class="n">page_size</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">start_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_xarr</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span> <span class="n">page_size</span><span class="p">):</span>
        <span class="n">stop_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">page_size</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">values</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span>
                <span class="n">data_xarr</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">)})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">}</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">values</span>
              <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span>
              <span class="n">ts_xarr</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">)})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
              <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">}</span>
        <span class="n">event_page</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seq_num</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;seq_num&#39;</span><span class="p">)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;seq_num&#39;</span><span class="p">)</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">)</span>
        <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_xarr</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">start_idx</span><span class="p">:</span><span class="n">stop_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uids</span>
        <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;seq_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_num</span>
        <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">yield</span> <span class="n">event_page</span>


<div class="viewcode-block" id="discover_handlers"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.discover_handlers">[docs]</a><span class="k">def</span> <span class="nf">discover_handlers</span><span class="p">(</span><span class="n">entrypoint_group_name</span><span class="o">=</span><span class="s1">&#39;databroker.handlers&#39;</span><span class="p">,</span>
                      <span class="n">skip_failures</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover handlers via entrypoints.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    entrypoint_group_name: str</span>
<span class="sd">        Default is &#39;databroker.handlers&#39;, the &quot;official&quot; databroker entrypoint</span>
<span class="sd">        for handlers.</span>
<span class="sd">    skip_failures: boolean</span>
<span class="sd">        True by default. Errors loading a handler class are converted to</span>
<span class="sd">        warnings if this is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    handler_registry: dict</span>
<span class="sd">        A suitable default handler registry</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">entrypoints</span><span class="o">.</span><span class="n">get_group_named</span><span class="p">(</span><span class="n">entrypoint_group_name</span><span class="p">)</span>
    <span class="n">group_all</span> <span class="o">=</span> <span class="n">entrypoints</span><span class="o">.</span><span class="n">get_group_all</span><span class="p">(</span><span class="n">entrypoint_group_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_all</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
        <span class="c1"># There are some name collisions. Let&#39;s go digging for them.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">matches</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_all</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ep</span><span class="p">:</span> <span class="n">ep</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">winner</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2"> entrypoints for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;databroker handler spec </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;They are </span><span class="si">{</span><span class="n">matches</span><span class="si">}</span><span class="s2">. The match </span><span class="si">{</span><span class="n">winner</span><span class="si">}</span><span class="s2"> has won the race.&quot;</span><span class="p">)</span>
    <span class="n">handler_registry</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">entrypoint</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler_class</span> <span class="o">=</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skip_failures</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">entrypoint</span><span class="si">!r}</span><span class="s2"> which failed to load. &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;Exception: </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="n">handler_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler_class</span>

    <span class="k">return</span> <span class="n">handler_registry</span></div>


<div class="viewcode-block" id="parse_handler_registry"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.parse_handler_registry">[docs]</a><span class="k">def</span> <span class="nf">parse_handler_registry</span><span class="p">(</span><span class="n">handler_registry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse mapping of spec name to &#39;import path&#39; into mapping to class itself.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    handler_registry : dict</span>
<span class="sd">        Values may be string &#39;import paths&#39; to classes or actual classes.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Pass in name; get back actual class.</span>

<span class="sd">    &gt;&gt;&gt; parse_handler_registry({&#39;my_spec&#39;: &#39;package.module.ClassName&#39;})</span>
<span class="sd">    {&#39;my_spec&#39;: &lt;package.module.ClassName&gt;}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">handler_str</span> <span class="ow">in</span> <span class="n">handler_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">module_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">handler_str</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">),</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="n">handler_str</span>
        <span class="n">result</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="parse_transforms"><a class="viewcode-back" href="../../v2/developer/reference.html#databroker.core.parse_transforms">[docs]</a><span class="k">def</span> <span class="nf">parse_transforms</span><span class="p">(</span><span class="n">transforms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse mapping of spec name to &#39;import path&#39; into mapping to class itself.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transforms : collections.abc.Mapping or None</span>
<span class="sd">        A collections.abc.Mapping or subclass, that maps any subset of the</span>
<span class="sd">        keys {start, stop, resource, descriptor} to a function (or a string</span>
<span class="sd">        import path) that accepts a document of the corresponding type and</span>
<span class="sd">        returns it, potentially modified. This feature is for patching up</span>
<span class="sd">        erroneous metadata. It is intended for quick, temporary fixes that</span>
<span class="sd">        may later be applied permanently to the data at rest (e.g via a</span>
<span class="sd">        database migration).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Pass in name; get back actual class.</span>

<span class="sd">    &gt;&gt;&gt; parse_transforms({&#39;descriptor&#39;: &#39;package.module.function_name&#39;})</span>
<span class="sd">    {&#39;descriptor&#39;: &lt;package.module.function_name&gt;}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformable</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="s1">&#39;descriptor&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">transforms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">_no_op</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">transformable</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transforms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">transformable</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transforms for </span><span class="si">{</span><span class="n">transforms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">transformable</span><span class="si">}</span><span class="s2"> &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;are not supported.&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">transformable</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">module_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">),</span> <span class="n">class_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="n">_no_op</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="n">transform</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid transforms argument </span><span class="si">{</span><span class="n">transforms</span><span class="si">}</span><span class="s2">. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;transforms must be None or a dictionary.&quot;</span><span class="p">)</span></div>


<span class="c1"># This determines the type of the class that you get on the</span>
<span class="c1"># client side.</span>
<span class="n">intake</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">register_container</span><span class="p">(</span><span class="s1">&#39;bluesky-run&#39;</span><span class="p">,</span> <span class="n">RemoteBlueskyRun</span><span class="p">)</span>
<span class="n">intake</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">register_container</span><span class="p">(</span>
    <span class="s1">&#39;bluesky-event-stream&#39;</span><span class="p">,</span> <span class="n">RemoteBlueskyEventStream</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_concat_dataarray_pages</span><span class="p">(</span><span class="n">dataarray_pages</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines a iterable of dataarray_pages to a single dataarray_page.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataarray_pages: Iterabile</span>
<span class="sd">        An iterable of event_pages with xarray.dataArrays in the data,</span>
<span class="sd">        timestamp, and filled fields.</span>
<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    event_page : dict</span>
<span class="sd">        A single event_pages with xarray.dataArrays in the data,</span>
<span class="sd">        timestamp, and filled fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataarray_pages</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">array_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;seq_num&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>
    <span class="n">data_keys</span> <span class="o">=</span> <span class="n">dataarray_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;descriptor&#39;</span><span class="p">:</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;descriptor&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">page</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">]))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">array_keys</span><span class="p">},</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">page</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">],</span>
                                        <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;concat_dim&#39;</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">},</span>
            <span class="s1">&#39;timestamps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">page</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                                              <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;concat_dim&#39;</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">},</span>
            <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">page</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                                          <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;concat_dim&#39;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">}}</span>


<span class="k">def</span> <span class="nf">_event_page_to_dataarray_page</span><span class="p">(</span><span class="n">event_page</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the event_page&#39;s data, timestamps, and filled to xarray.DataArray.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event_page: dict</span>
<span class="sd">        A EventPage document</span>
<span class="sd">    dims: tuple</span>
<span class="sd">        Tuple of dimension names associated with the array</span>
<span class="sd">    coords: dict-like</span>
<span class="sd">        Dictionary-like container of coordinate arrays</span>
<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    event_page : dict</span>
<span class="sd">        An event_pages with xarray.dataArrays in the data,</span>
<span class="sd">        timestamp, and filled fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]}</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)</span>

    <span class="n">array_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;seq_num&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>
    <span class="n">data_keys</span> <span class="o">=</span> <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;descriptor&#39;</span><span class="p">:</span> <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">event_page</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">array_keys</span><span class="p">},</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                            <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">},</span>
            <span class="s1">&#39;timestamps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                            <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">},</span>
            <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                            <span class="n">event_page</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">}}</span>


<span class="k">def</span> <span class="nf">_dataarray_page_to_dataset_page</span><span class="p">(</span><span class="n">dataarray_page</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the dataarray_page&#39;s data, timestamps, and filled to xarray.DataSet.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataarray_page: dict</span>
<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    dataset_page : dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;seq_num&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;descriptor&#39;</span><span class="p">:</span> <span class="n">dataarray_page</span><span class="p">[</span><span class="s1">&#39;descriptor&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">dataarray_page</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">array_keys</span><span class="p">},</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataarray_page</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;timestamps&#39;</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataarray_page</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataarray_page</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())}</span>


<span class="k">def</span> <span class="nf">coerce_dask</span><span class="p">(</span><span class="n">handler_class</span><span class="p">,</span> <span class="n">filler_state</span><span class="p">):</span>
    <span class="c1"># If the handler has its own delayed logic, defer to that.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler_class</span><span class="p">,</span> <span class="s1">&#39;return_type&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">handler_class</span><span class="o">.</span><span class="n">return_type</span><span class="p">[</span><span class="s1">&#39;delayed&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">handler_class</span>

    <span class="c1"># Otherwise, provide best-effort dask support by wrapping each datum</span>
    <span class="c1"># payload in dask.array.from_delayed. This means that each datum will be</span>
    <span class="c1"># one dask task---it cannot be rechunked into multiple tasks---but that</span>
    <span class="c1"># may be sufficient for many handlers.</span>
    <span class="k">class</span> <span class="nc">Subclass</span><span class="p">(</span><span class="n">handler_class</span><span class="p">):</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">filler_state</span><span class="o">.</span><span class="n">descriptor</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">filler_state</span><span class="o">.</span><span class="n">key</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">extract_shape</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">extract_dtype</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">load_chunk</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">from_delayed</span><span class="p">(</span><span class="n">load_chunk</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Subclass</span>


<span class="c1"># This adds a &#39;delayed&#39; option to event_model.Filler&#39;s `coerce` parameter.</span>
<span class="c1"># By adding it via plugin, we avoid adding a dask.array dependency to</span>
<span class="c1"># event-model and we keep the fiddly hacks into extract_shape here in</span>
<span class="c1"># databroker, a faster-moving and less fundamental library than event-model.</span>
<span class="n">event_model</span><span class="o">.</span><span class="n">register_coersion</span><span class="p">(</span><span class="s1">&#39;delayed&#39;</span><span class="p">,</span> <span class="n">coerce_dask</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">extract_shape</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Work around bug in https://github.com/bluesky/ophyd/pull/746</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ideally this code would just be</span>
    <span class="c1"># descriptor[&#39;data_keys&#39;][key][&#39;shape&#39;]</span>
    <span class="c1"># but we have to do some heuristics to make up for errors in the reporting.</span>

    <span class="c1"># Broken ophyd reports (x, y, 0). We want (num_images, y, x).</span>
    <span class="n">data_key</span> <span class="o">=</span> <span class="n">descriptor</span><span class="p">[</span><span class="s1">&#39;data_keys&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_key</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">data_key</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">object_keys</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;object_keys&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">data_keys</span> <span class="ow">in</span> <span class="n">object_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not figure out shape of </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">descriptor</span><span class="p">[</span><span class="s1">&#39;configuration&#39;</span><span class="p">][</span><span class="n">object_name</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;num_images&#39;</span><span class="p">):</span>
                <span class="n">num_images</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_images</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data_key</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">descriptor</span><span class="p">[</span><span class="s1">&#39;data_keys&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">shape</span>


<span class="k">def</span> <span class="nf">extract_dtype</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Work around the fact that we currently report jsonschema data types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reported</span> <span class="o">=</span> <span class="n">descriptor</span><span class="p">[</span><span class="s1">&#39;data_keys&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">reported</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span>  <span class="c1"># guess!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reported</span>


<span class="k">def</span> <span class="nf">_no_op</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">doc</span>


<span class="c1"># This comes from the old databroker.core from before intake-bluesky was merged</span>
<span class="c1"># in. It apparently was useful for back-compat at some point.</span>
<span class="kn">from</span> <span class="nn">databroker._core</span> <span class="kn">import</span> <span class="n">Header</span>  <span class="c1"># noqa: 401, 402</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>