


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Assets &mdash; databroker 0.13.0.post2+gbf9ed98 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Creating a New Database" href="creating.html" />
    <link rel="prev" title="Configuration" href="configuration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> databroker
          

          
          </a>

          
            
            
              <div class="version">
                0.13.0.post2+gbf9ed98
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Assets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example-1-retrieving-lines-from-a-csv-file">Example 1: Retrieving Lines from a CSV File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#write-a-handler">Write a Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-a-record-of-the-data">Make a Record of the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-payoff-retrieving-data-is-dead-simple">The Payoff: Retrieving Data Is Dead Simple</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-2-retrieving-datasets-from-an-hdf5-file">Example 2: Retrieving Datasets from an HDF5 File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Write a Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Make a Record of the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#retrieve-the-data">Retrieve the Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-3-retrieving-portions-of-datasets-from-an-hdf5-file">Example 3: Retrieving Portions of Datasets from an HDF5 File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">Write a Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Make a Record of the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Retrieve the Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-4-retrieving-the-moon-phase">Example 4: Retrieving the Moon Phase</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">Write a Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">Make a Record of the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#retrieve-data">Retrieve Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="creating.html">Creating a New Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="archiver.html">Connection with Archiver Appliance</a></li>
<li class="toctree-l1"><a class="reference internal" href="whats_new.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="DBEP/index.html">Databroker Enhancement Proposals</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">databroker</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Assets</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/assets.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="assets">
<h1>Assets<a class="headerlink" href="#assets" title="Permalink to this headline">¶</a></h1>
<p>The databroker includes an “asset registry” for interfacing transparently to
externally-stored data. Here’s how it works.</p>
<ol class="arabic simple">
<li><p>You (or your hardware) save data wherever you want, whenever you want, in
whatever format makes sense for your application.</p></li>
<li><p>At some point, you notify the Registry about this data. You provide two
pieces of information.</p>
<ol class="arabic simple">
<li><p>How to access and open the file (or, generically, “resource”)</p></li>
<li><p>How to retrieve a given piece of data within that file</p></li>
</ol>
</li>
<li><p>In return, the Registry gives you a token —  a unique identifier — which
you can use to retrieve each piece of data.</p></li>
</ol>
<p>This admittedly abstract way of doing things has some powerful advantages.</p>
<ul class="simple">
<li><p><em>Any</em> file format is supported, and retrieved data always comes back as a
simple numpy array.</p></li>
<li><p>It does not matter whether pieces of data are stored in one file or in many
separate files.</p></li>
<li><p>The registry does not get between the detector and the storage. It is
not in the business of storing data; you merely <em>tell it about the data</em>, and
you may do so before, during, or after the data is actually created or
stored.</p></li>
</ul>
<p>The following examples illustrate how this works in practice.</p>
<div class="section" id="example-1-retrieving-lines-from-a-csv-file">
<h2>Example 1: Retrieving Lines from a CSV File<a class="headerlink" href="#example-1-retrieving-lines-from-a-csv-file" title="Permalink to this headline">¶</a></h2>
<p>Suppose my detector just saved a data file called <code class="docutils literal notranslate"><span class="pre">example.csv</span></code>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="o">!</span>cat example.csv
<span class="go">x,y</span>
<span class="go">1,1</span>
<span class="go">2,4</span>
<span class="go">3,9</span>
<span class="go">4,16</span>
<span class="go">5,25</span>
</pre></div>
</div>
<p>First, decide how fine-grained your access to the data should be. Would you
always want the whole file, or would like to be able to request data from
each line individually? Or each pair of lines? The “unit” of data is
completely flexible; it can be anything from a scalar to an N-dimensional
volume.</p>
<p>For this example, suppose we want to retrieve individual lines of data.</p>
<div class="section" id="write-a-handler">
<h3>Write a Handler<a class="headerlink" href="#write-a-handler" title="Permalink to this headline">¶</a></h3>
<p>A Handler is a class with two required methods,
an <code class="docutils literal notranslate"><span class="pre">__init__</span></code> that accesses a file and a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> that returns nuggets of
data from that file. In our case, since we want to access individual lines of
the file, <code class="docutils literal notranslate"><span class="pre">__call__</span></code> will return a line’s worth of data.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [2]: </span><span class="k">class</span> <span class="nc">CSVLineHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ...: </span>     <span class="s2">&quot;Read data stored as lines in a text file.&quot;</span>
<span class="gp">   ...: </span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="gp">   ...: </span>         <span class="s2">&quot;Each instance of a Handler accesses a given file.&quot;</span>
<span class="gp">   ...: </span>         <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="gp">   ...: </span>         <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="gp">   ...: </span>     <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_no</span><span class="p">):</span>
<span class="gp">   ...: </span>         <span class="s2">&quot;Get a piece of data.&quot;</span>
<span class="gp">   ...: </span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">line_no</span><span class="p">]</span>
<span class="gp">   ...: </span>
</pre></div>
</div>
</div>
<div class="section" id="make-a-record-of-the-data">
<h3>Make a Record of the Data<a class="headerlink" href="#make-a-record-of-the-data" title="Permalink to this headline">¶</a></h3>
<p>During data collection, we make a record of this file by calling
<code class="docutils literal notranslate"><span class="pre">insert_resource</span></code>. When you read “resource,” you can think “file”, but
other resources are also possible. Handlers can access URLs, URIs, or
even generate their results on the fly with no reference to external
information (e.g., synthetic testing data).</p>
<p>The arguments to <code class="docutils literal notranslate"><span class="pre">insert_resource</span></code> are</p>
<ul class="simple">
<li><p>A ‘spec’ labeling this data format so we know how to read it later — we’ll
use <code class="docutils literal notranslate"><span class="pre">'csv'</span></code></p></li>
<li><p>A filepath</p></li>
<li><p>A dictionary of any additional keyword argument needed by <cite>__init__`</cite> above
to locate and open the file. In our case, there are none, so we pass an empty
dictionary <code class="docutils literal notranslate"><span class="pre">{}</span></code>.</p></li>
</ul>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="kn">from</span> <span class="nn">databroker</span> <span class="kn">import</span> <span class="n">Broker</span>

<span class="gp">In [4]: </span><span class="n">db</span> <span class="o">=</span> <span class="n">Broker</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span>  <span class="c1"># builds an example db we can play with</span>

<span class="gp">In [5]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_resource</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;example.csv&#39;</span><span class="p">,</span> <span class="p">{})</span>

<span class="gp">In [6]: </span><span class="n">resource_id</span>
<span class="gh">Out[6]: </span><span class="go"></span>
<span class="go">{&#39;spec&#39;: &#39;csv&#39;,</span>
<span class="go"> &#39;resource_path&#39;: &#39;example.csv&#39;,</span>
<span class="go"> &#39;root&#39;: &#39;&#39;,</span>
<span class="go"> &#39;resource_kwargs&#39;: {},</span>
<span class="go"> &#39;path_semantics&#39;: &#39;posix&#39;,</span>
<span class="go"> &#39;uid&#39;: &#39;3e38550a-f199-468a-9a90-f0b1af39109f&#39;,</span>
<span class="go"> &#39;id&#39;: &#39;3e38550a-f199-468a-9a90-f0b1af39109f&#39;}</span>
</pre></div>
</div>
<p>Now, we create a record for each piece of data we’d like to retrieve. We
assign each one a unique ID, which we can use later to retrieve it.</p>
<p>The arguments here are the <code class="docutils literal notranslate"><span class="pre">resource_id</span></code> returned by <code class="docutils literal notranslate"><span class="pre">insert_resource</span></code>
above, the unique ID we’ll use to retrieve each piece of data, and finally the
arguments needed by <code class="docutils literal notranslate"><span class="pre">__call__</span></code> to read that data from the file. In our
case, <code class="docutils literal notranslate"><span class="pre">__call__</span></code> needs just one argument, <code class="docutils literal notranslate"><span class="pre">line_no</span></code>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [7]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id1&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="gh">Out[7]: </span><span class="go"></span>
<span class="go">{&#39;resource&#39;: &#39;3e38550a-f199-468a-9a90-f0b1af39109f&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id1&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;line_no&#39;: 1}}</span>

<span class="gp">In [8]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id2&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="go">                                                                                                                        Out[8]: </span>
<span class="go">{&#39;resource&#39;: &#39;3e38550a-f199-468a-9a90-f0b1af39109f&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id2&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;line_no&#39;: 2}}</span>

<span class="gp">In [9]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id3&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="go">                                                                                                                                                                                                                                                Out[9]: </span>
<span class="go">{&#39;resource&#39;: &#39;3e38550a-f199-468a-9a90-f0b1af39109f&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id3&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;line_no&#39;: 3}}</span>

<span class="gp">In [10]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id4&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
<span class="go">                                                                                                                                                                                                                                                                                                                                                                        Out[10]: </span>
<span class="go">{&#39;resource&#39;: &#39;3e38550a-f199-468a-9a90-f0b1af39109f&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id4&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;line_no&#39;: 4}}</span>

<span class="gp">In [11]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id5&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;line_no&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="go">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Out[11]: </span>
<span class="go">{&#39;resource&#39;: &#39;3e38550a-f199-468a-9a90-f0b1af39109f&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id5&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;line_no&#39;: 5}}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-payoff-retrieving-data-is-dead-simple">
<h3>The Payoff: Retrieving Data Is Dead Simple<a class="headerlink" href="#the-payoff-retrieving-data-is-dead-simple" title="Permalink to this headline">¶</a></h3>
<p>When we called <code class="docutils literal notranslate"><span class="pre">insert_resource</span></code>, we recorded the nickname <code class="docutils literal notranslate"><span class="pre">'csv'</span></code>. To read
that data, we have to associate <code class="docutils literal notranslate"><span class="pre">'csv'</span></code> and our Handler, <code class="docutils literal notranslate"><span class="pre">CSVLineHandler</span></code>,
like so.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [12]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">CSVLineHandler</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we are ready to retrieve that data. All we need is the unique ID.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="s1">&#39;some_id2&#39;</span><span class="p">)</span>
<span class="gh">Out[13]: </span><span class="go">&#39;2,4\n&#39;</span>
</pre></div>
</div>
<p>The Registry now knows to use the <code class="docutils literal notranslate"><span class="pre">CSVLineHandler</span></code> class, it knows to
instantiate it with <code class="docutils literal notranslate"><span class="pre">example.csv</span></code>, and it knows to call it with the argument
<code class="docutils literal notranslate"><span class="pre">line_no=2</span></code>.</p>
</div>
</div>
<div class="section" id="example-2-retrieving-datasets-from-an-hdf5-file">
<h2>Example 2: Retrieving Datasets from an HDF5 File<a class="headerlink" href="#example-2-retrieving-datasets-from-an-hdf5-file" title="Permalink to this headline">¶</a></h2>
<p>Suppose three 5x5 images are stored as Datasets in an one HDF5 file, named
<code class="docutils literal notranslate"><span class="pre">'A'</span></code>, <code class="docutils literal notranslate"><span class="pre">'B'</span></code>, <code class="docutils literal notranslate"><span class="pre">'C'</span></code>. We will treat the file as a “resource” and each HDF5
Dataset as a “datum”.</p>
<div class="section" id="id1">
<h3>Write a Handler<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [14]: </span><span class="kn">import</span> <span class="nn">h5py</span>

<span class="gp">In [15]: </span><span class="k">class</span> <span class="nc">HDF5DatasetHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">key</span><span class="p">][()]</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Make a Record of the Data<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [16]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_resource</span><span class="p">(</span><span class="s1">&#39;hdf5-by-dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;example.h5&#39;</span><span class="p">,</span> <span class="p">{})</span>

<span class="gp">In [17]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id10&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>
<span class="gh">Out[17]: </span><span class="go"></span>
<span class="go">{&#39;resource&#39;: &#39;2d92c4e6-371a-4525-b4e5-008189945dc5&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id10&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;key&#39;: &#39;A&#39;}}</span>

<span class="gp">In [18]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id11&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">})</span>
<span class="go">                                                                                                                        Out[18]: </span>
<span class="go">{&#39;resource&#39;: &#39;2d92c4e6-371a-4525-b4e5-008189945dc5&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id11&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;key&#39;: &#39;B&#39;}}</span>

<span class="gp">In [19]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id12&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">})</span>
<span class="go">                                                                                                                                                                                                                                                Out[19]: </span>
<span class="go">{&#39;resource&#39;: &#39;2d92c4e6-371a-4525-b4e5-008189945dc5&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id12&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;key&#39;: &#39;C&#39;}}</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieve-the-data">
<h3>Retrieve the Data<a class="headerlink" href="#retrieve-the-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [20]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="s1">&#39;hdf5-by-dataset&#39;</span><span class="p">,</span> <span class="n">HDF5DatasetHandler</span><span class="p">)</span>

<span class="gp">In [21]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="s1">&#39;some_id11&#39;</span><span class="p">)</span>
<span class="gh">Out[21]: </span><span class="go"></span>
<span class="go">array([[5, 5, 2, 4, 3],</span>
<span class="go">       [7, 2, 1, 5, 8],</span>
<span class="go">       [1, 5, 6, 4, 6],</span>
<span class="go">       [3, 0, 5, 4, 8],</span>
<span class="go">       [8, 1, 2, 1, 1]])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="example-3-retrieving-portions-of-datasets-from-an-hdf5-file">
<h2>Example 3: Retrieving Portions of Datasets from an HDF5 File<a class="headerlink" href="#example-3-retrieving-portions-of-datasets-from-an-hdf5-file" title="Permalink to this headline">¶</a></h2>
<p>Suppose several 5x5 images are stored as a single Nx5x5 Dataset in an HDF5
file. The Dataset is named <code class="docutils literal notranslate"><span class="pre">'my-dataset-name</span></code>. We will make the file a
“resource” and each 5x5 frame a “datum”.</p>
<div class="section" id="id3">
<h3>Write a Handler<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [22]: </span><span class="kn">import</span> <span class="nn">h5py</span>

<span class="gp">In [23]: </span><span class="k">class</span> <span class="nc">HDF5DatasetSliceHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">][()]</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_no</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">frame_no</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Make a Record of the Data<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Each 5x5 frame get a separate record.</p>
<p>Notice that, in this example, <code class="docutils literal notranslate"><span class="pre">__init__</span></code> requires more than just the
filename. Additional arguments, in this case <code class="docutils literal notranslate"><span class="pre">dataset_name</span></code>, are passed
in a dictionary.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [24]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_resource</span><span class="p">(</span><span class="s1">&#39;hdf5-slice-single-dataset&#39;</span><span class="p">,</span>
<span class="gp">   ....: </span>                                     <span class="s1">&#39;example.h5&#39;</span><span class="p">,</span>
<span class="gp">   ....: </span>                                     <span class="p">{</span><span class="s1">&#39;dataset_name&#39;</span><span class="p">:</span> <span class="s1">&#39;my-dataset-name&#39;</span><span class="p">})</span>
<span class="gp">   ....: </span>

<span class="gp">In [25]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id20&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;frame_no&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="gh">Out[25]: </span><span class="go"></span>
<span class="go">{&#39;resource&#39;: &#39;78198f59-1f47-44ba-8d8f-d78c2e319246&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id20&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;frame_no&#39;: 0}}</span>

<span class="gp">In [26]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id21&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;frame_no&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="go">                                                                                                                           Out[26]: </span>
<span class="go">{&#39;resource&#39;: &#39;78198f59-1f47-44ba-8d8f-d78c2e319246&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id21&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;frame_no&#39;: 1}}</span>

<span class="gp">In [27]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id22&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;frame_no&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="go">                                                                                                                                                                                                                                                      Out[27]: </span>
<span class="go">{&#39;resource&#39;: &#39;78198f59-1f47-44ba-8d8f-d78c2e319246&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id22&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;frame_no&#39;: 2}}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>Retrieve the Data<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [28]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="s1">&#39;hdf5-slice-single-dataset&#39;</span><span class="p">,</span> <span class="n">HDF5DatasetSliceHandler</span><span class="p">)</span>

<span class="gp">In [29]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="s1">&#39;some_id21&#39;</span><span class="p">)</span>
<span class="gh">Out[29]: </span><span class="go"></span>
<span class="go">array([[8, 1, 8],</span>
<span class="go">       [5, 3, 6],</span>
<span class="go">       [1, 5, 4],</span>
<span class="go">       [0, 8, 1],</span>
<span class="go">       [5, 4, 0]])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="example-4-retrieving-the-moon-phase">
<h2>Example 4: Retrieving the Moon Phase<a class="headerlink" href="#example-4-retrieving-the-moon-phase" title="Permalink to this headline">¶</a></h2>
<p>This example illustrates the general power of this design, beyond reading
simple files. Any “resource,” include a web-based data source, can be
accessed with a Handler.</p>
<div class="section" id="id6">
<h3>Write a Handler<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>When we retrieve data from this handler, it builds a URL that requests the
weather forcast (or historical record) from the web service forecast.io.
From this data it extracts the phase of the moon at a given time.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [30]: </span><span class="kn">import</span> <span class="nn">json</span>

<span class="gp">In [31]: </span><span class="kn">import</span> <span class="nn">os</span>

<span class="gp">In [32]: </span><span class="kn">import</span> <span class="nn">requests</span>

<span class="gp">In [33]: </span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://api.forecast.io/forecast/{api_key}/{lat},{long},{time}&quot;</span>

<span class="gp">In [34]: </span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FORECAST_IO_API_KEY&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="gp">In [35]: </span><span class="k">class</span> <span class="nc">MoonPhaseHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="s2">&quot;This handler does not require a filename.&quot;</span>
<span class="gp">   ....: </span>        <span class="k">pass</span>
<span class="gp">   ....: </span>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<span class="gp">   ....: </span>             <span class="k">return</span> <span class="s1">&#39;Waxing&#39;</span>
<span class="gp">   ....: </span>        <span class="n">text</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="gp">   ....: </span>                                       <span class="n">time</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">)))</span><span class="o">.</span><span class="n">text</span>
<span class="gp">   ....: </span>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;moonPhase&#39;</span><span class="p">]</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>Make a Record of the Data<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Notably, in this case, we are making a record of data that we haven’t seen yet.
The data itself will only be obtained for the first time when it retrieved.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [36]: </span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_resource</span><span class="p">(</span><span class="s1">&#39;moon&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">{})</span>
</pre></div>
</div>
<p>Let’s register a piece of data giving today’s moon phase.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [37]: </span><span class="kn">import</span> <span class="nn">time</span>

<span class="gp">In [38]: </span><span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="gp">In [39]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">insert_datum</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s1">&#39;some_id31&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
<span class="gh">Out[39]: </span><span class="go"></span>
<span class="go">{&#39;resource&#39;: &#39;a517f72f-34a1-4f96-b2bb-393db4b4f2b6&#39;,</span>
<span class="go"> &#39;datum_id&#39;: &#39;some_id31&#39;,</span>
<span class="go"> &#39;datum_kwargs&#39;: {&#39;time&#39;: 1560879204.7074747}}</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieve-data">
<h3>Retrieve Data<a class="headerlink" href="#retrieve-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [40]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="s1">&#39;moon&#39;</span><span class="p">,</span> <span class="n">MoonPhaseHandler</span><span class="p">)</span>

<span class="gp">In [41]: </span><span class="n">db</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="s1">&#39;some_id31&#39;</span><span class="p">)</span>
<span class="gh">Out[41]: </span><span class="go">0.55</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="creating.html" class="btn btn-neutral float-right" title="Creating a New Database" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configuration.html" class="btn btn-neutral float-left" title="Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>