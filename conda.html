


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Software Deployment with Conda &mdash; NSLS-II Software Documentation  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installation at a Beamline" href="fresh-installation.html" />
    <link rel="prev" title="History of Changes" href="history.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> NSLS-II Software Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture-overview.html">Event-Based Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="cookbook/index.html">Cookbook (Examples)</a></li>
<li class="toctree-l1"><a class="reference internal" href="remote-access.html">Remote Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="sandbox.html">Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History of Changes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Software Deployment with Conda</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#intro">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environments">Environments</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#activating-the-root-environments">Activating the root environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-custom-user-environments">Creating custom user environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#access-custom-user-environments-in-nsls-ii-s-jupyterhub">Access custom user environments in NSLS-II’s JupyterHub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#internal-anaconda-server">Internal Anaconda Server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="fresh-installation.html">Installation at a Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Recommended Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal_index.html">Internal Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_docs.html">NSLS-II Deployment Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="meetings/index.html">Meetings</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/caproto">caproto</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/suitcase">suitcase</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://scikit-beam.github.io/scikit-beam">scikit-beam</a></li>
</ul>
<p class="caption"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/wishlist/issues">Wish List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NSLS-II Software Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Software Deployment with Conda</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/conda.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="software-deployment-with-conda">
<h1>Software Deployment with Conda<a class="headerlink" href="#software-deployment-with-conda" title="Permalink to this headline">¶</a></h1>
<div class="section" id="intro">
<h2>Intro<a class="headerlink" href="#intro" title="Permalink to this headline">¶</a></h2>
<p>Conda is an open source package management system and environment management
system for installing multiple versions of software packages and their
dependencies and switching easily between them. See the
<a class="reference external" href="http://conda.pydata.org/docs/">conda documentation</a> for more.</p>
</div>
<div class="section" id="environments">
<h2>Environments<a class="headerlink" href="#environments" title="Permalink to this headline">¶</a></h2>
<div class="section" id="activating-the-root-environments">
<h3>Activating the root environments<a class="headerlink" href="#activating-the-root-environments" title="Permalink to this headline">¶</a></h3>
<p>Every beamline workstation has some standard conda environments. All users can
access them, but they can only be installed or updated with root privileges.
You can list the names and locations of the available environments like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda env list
<span class="c1"># conda environments:</span>
<span class="c1">#</span>
analysis-17Q2.0          /opt/conda_envs/analysis-17Q2.0
collection-17Q2.0        /opt/conda_envs/collection-17Q2.0
root                  *  /opt/conda
</pre></div>
</div>
<p>To use an environment, active it.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> activate analysis-17Q2.0
discarding /opt/conda/bin from PATH
prepending /opt/conda_envs/analysis-17Q2.0/bin to PATH
</pre></div>
</div>
<p>You can inspect the packages installed in the current environment using the
command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda list
<span class="c1"># packages in environment at /opt/conda_envs/analysis-17Q2.0:</span>
<span class="c1">#</span>
amostra                   <span class="m">0</span>.2                      py36_0
anaconda-client           <span class="m">1</span>.6.2                    py36_0
analysis                  17Q2.0                   py36_4
attrs                     <span class="m">16</span>.3.0                   py36_1
bleach                    <span class="m">1</span>.5.0                    py36_0
bluesky                   <span class="m">0</span>.9.0                    py36_0
&lt;snip&gt;
</pre></div>
</div>
</div>
<div class="section" id="creating-custom-user-environments">
<h3>Creating custom user environments<a class="headerlink" href="#creating-custom-user-environments" title="Permalink to this headline">¶</a></h3>
<p>If the standard system conda environments are missing some packges that you
want to use, you can create your own.</p>
<p>You can copy one of the standard system environments and add some packages.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda create -n myenv --clone analysis some_package another_package
</pre></div>
</div>
<p>Or, you can create a new environment from scratch. (If you plan to use the
environment with Jupyter, you must include the <code class="docutils literal notranslate"><span class="pre">ipykernel</span></code> package along with
any others you want.)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda create -n myenv ipykernel some_package another_package
</pre></div>
</div>
<p>Activate the environment.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> activate myenv
</pre></div>
</div>
<p>If the package is available from pip but not conda, you can use pip. Make
sure you have activated the environment first, as we did just above.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install some_other_package
</pre></div>
</div>
</div>
<div class="section" id="access-custom-user-environments-in-nsls-ii-s-jupyterhub">
<h3>Access custom user environments in NSLS-II’s JupyterHub<a class="headerlink" href="#access-custom-user-environments-in-nsls-ii-s-jupyterhub" title="Permalink to this headline">¶</a></h3>
<p>Users can connect to their own user-created conda environments through
JupyterHub.</p>
<ol class="arabic">
<li><p class="first">Activate your custom environment.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> activate myenv
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Create a new Jupyter kernel for the environment.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python -m ipykernel install --user --name myenv --display-name <span class="s2">&quot;Python (myenv)&quot;</span>
Installed kernelspec myenv in /home/dallan/.local/share/jupyter/kernels/myenv
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--name</span></code> value is used by Jupyter internally. These commands will
overwrite any existing kernel with the same name. <code class="docutils literal notranslate"><span class="pre">--display-name</span></code> is
what you see in the notebook menus. For details see
<a class="reference external" href="https://ipython.readthedocs.io/en/latest/install/kernel_install.html#kernels-for-different-environments">this section of the IPython documentation</a></p>
</div></blockquote>
</li>
<li><p class="first">Specify a host in the kernel file.</p>
<blockquote>
<div><p>The kernel requires one simple customization to work on NSLS-II’s
JupyterHub deployment. We need to specify which host to run the kernel on.</p>
<p>You can check the hostname of the current machine like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ hostname
xf23id1-srv1
</pre></div>
</div>
<p>Open the kernel file that we generated above. You can get its location from
the output displayed by our kernel creation command in the previous step.
In our example, recall you that it showed</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Installed kernelspec myenv in /home/dallan/.local/share/jupyter/kernels/myenv
</pre></div>
</div>
<p>so we will open the file <code class="docutils literal notranslate"><span class="pre">kernel.json</span></code> in that directory.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="nt">&quot;argv&quot;</span><span class="p">:</span> <span class="p">[</span>
 <span class="s2">&quot;/home/dallan/conda_envs/myenv/bin/python&quot;</span><span class="p">,</span>
 <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
 <span class="s2">&quot;ipykernel_launcher&quot;</span><span class="p">,</span>
 <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
 <span class="s2">&quot;{connection_file}&quot;</span>
 <span class="p">],</span>
 <span class="nt">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Python (myenv)&quot;</span><span class="p">,</span>
 <span class="nt">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Add a new item, <code class="docutils literal notranslate"><span class="pre">&quot;host&quot;</span></code> mapped to the hostname of the machine to run
this kernel on.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="nt">&quot;argv&quot;</span><span class="p">:</span> <span class="p">[</span>
 <span class="s2">&quot;/home/dallan/conda_envs/myenv/bin/python&quot;</span><span class="p">,</span>
 <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
 <span class="s2">&quot;ipykernel_launcher&quot;</span><span class="p">,</span>
 <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
 <span class="s2">&quot;{connection_file}&quot;</span>
 <span class="p">],</span>
 <span class="nt">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Python (myenv)&quot;</span><span class="p">,</span>
 <span class="nt">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
 <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;xf23id1-srv1&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that we added a comma on the second-to-last line, after <code class="docutils literal notranslate"><span class="pre">&quot;python&quot;</span></code>.
There is no comma after the last entry. JSON files are strict about this.
(This often trips up Python users, because Python tolerates trailing commas
in lists.)</p>
</div></blockquote>
</li>
</ol>
<p>Now, when you create a new notebook in JupyterHub, your new kernel should
appear in the menu. (You may need to refresh the browser, but you should not
need to log out of JupyterHub or restart your server.)</p>
</div>
</div>
<div class="section" id="internal-anaconda-server">
<h2>Internal Anaconda Server<a class="headerlink" href="#internal-anaconda-server" title="Permalink to this headline">¶</a></h2>
<p>We run an internal anaconda server at <a class="reference external" href="https://conda.nsls2.bnl.gov">https://conda.nsls2.bnl.gov</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">anaconda</span></code> channel contains the “official” packages distributed by
Continuum Analytics, including widely-used packages like numpy. When
Continuum releases new version of packages, we can vet them before we make
them available to users on this channel. The <code class="docutils literal notranslate"><span class="pre">defaults</span></code> channel is not
vetted by us; it should never be used internally.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">nsls2-tag</span></code> channel is where we put the latest tagged stable versions of
every package not officially distributed by Continuum. This includes in-house
packages like ophyd and bluesky and other dependencies that don’t happen to be
packaged by Continuum yet.  The <code class="docutils literal notranslate"><span class="pre">nsls2-dev</span></code> channel is where we put
bleeding-edge development versions of these packages.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="fresh-installation.html" class="btn btn-neutral float-right" title="Installation at a Beamline" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="history.html" class="btn btn-neutral" title="History of Changes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Brookhaven National Lab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>